---
title: "aaaHybrid anslutning med 2-nivåprogram | Microsoft Docs"
description: "Lär dig hur toodeploy virtuella installationer och UDR toocreate en flernivåapp miljö i Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 53599862289dbf9c6ab3289b0cb8dda6430f20f7
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="3b511-103">Virtuella utrustningsscenario</span><span class="sxs-lookup"><span data-stu-id="3b511-103">Virtual appliance scenario</span></span>
<span data-ttu-id="3b511-104">Ett vanligt scenario bland större Azure kunden är hello måste tooprovide två skikt program som exponeras-toohello Internet, samtidigt som toohello tillbaka åtkomstnivå från ett lokalt datacenter.</span><span class="sxs-lookup"><span data-stu-id="3b511-104">A common scenario among larger Azure customer is hello need tooprovide a two-tiered application exposed toohello Internet, while allowing access toohello back tier from an on-premises datacenter.</span></span> <span data-ttu-id="3b511-105">Det här dokumentet vägleder dig genom ett scenario med användaren användardefinierade vägar (UDR), en VPN-Gateway och nätverket virtuella installationer toodeploy en tvålagers-miljö som uppfyller hello följande krav:</span><span class="sxs-lookup"><span data-stu-id="3b511-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances toodeploy a two-tier environment that meets hello following requirements:</span></span>

* <span data-ttu-id="3b511-106">Webbprogrammet måste vara tillgänglig från hello offentliga Internet.</span><span class="sxs-lookup"><span data-stu-id="3b511-106">Web application must be accessible from hello public Internet only.</span></span>
* <span data-ttu-id="3b511-107">Server värd hello webbprogrammet måste vara kan tooaccess en backend-programserver.</span><span class="sxs-lookup"><span data-stu-id="3b511-107">Web server hosting hello application must be able tooaccess a backend application server.</span></span>
* <span data-ttu-id="3b511-108">All trafik från hello Internet toohello webbprogram måste gå via en virtuell brandväggsinstallation.</span><span class="sxs-lookup"><span data-stu-id="3b511-108">All traffic from hello Internet toohello web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="3b511-109">Den här virtuella installations ska användas för Internet-trafiken.</span><span class="sxs-lookup"><span data-stu-id="3b511-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="3b511-110">All trafik toohello programservern måste gå via en virtuell brandväggsinstallation.</span><span class="sxs-lookup"><span data-stu-id="3b511-110">All traffic going toohello application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="3b511-111">Den här virtuella installations används för åtkomst till backend-servern toohello slut och åtkomst kommer från hello lokalt nätverk via en VPN-Gateway.</span><span class="sxs-lookup"><span data-stu-id="3b511-111">This virtual appliance will be used for access toohello backend end server, and access coming in from hello on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="3b511-112">Administratörer måste vara kan toomanage hello brandväggen virtuella installationer från sina lokala datorer, med hjälp av en tredje brandväggen virtuell installation som uteslutande används för hanteringsändamål.</span><span class="sxs-lookup"><span data-stu-id="3b511-112">Administrators must be able toomanage hello firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="3b511-113">Det här är ett standard DMZ-scenario med en DMZ och ett skyddat nätverk.</span><span class="sxs-lookup"><span data-stu-id="3b511-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="3b511-114">Detta scenario kan konstrueras i Azure med hjälp av NSG: er, virtuella installationer av brandväggen eller en kombination av båda.</span><span class="sxs-lookup"><span data-stu-id="3b511-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="3b511-115">hello tabellen nedan visas några av hello- och nackdelar mellan NSG: er och virtuella installationer i brandväggen.</span><span class="sxs-lookup"><span data-stu-id="3b511-115">hello table below shows some of hello pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="3b511-116">Tekniker</span><span class="sxs-lookup"><span data-stu-id="3b511-116">Pros</span></span> | <span data-ttu-id="3b511-117">Nackdelar</span><span class="sxs-lookup"><span data-stu-id="3b511-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3b511-118">NSG</span><span class="sxs-lookup"><span data-stu-id="3b511-118">NSG</span></span> |<span data-ttu-id="3b511-119">Utan kostnad.</span><span class="sxs-lookup"><span data-stu-id="3b511-119">No cost.</span></span> <br/><span data-ttu-id="3b511-120">Integrerat i Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="3b511-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="3b511-121">Regler kan skapas i ARM-mallar.</span><span class="sxs-lookup"><span data-stu-id="3b511-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="3b511-122">Komplexitet kan variera i större miljöer.</span><span class="sxs-lookup"><span data-stu-id="3b511-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="3b511-123">Brandvägg</span><span class="sxs-lookup"><span data-stu-id="3b511-123">Firewall</span></span> |<span data-ttu-id="3b511-124">Fullständig kontroll över dataplan.</span><span class="sxs-lookup"><span data-stu-id="3b511-124">Full control over data plane.</span></span> <br/><span data-ttu-id="3b511-125">Central hantering via brandväggen-konsolen.</span><span class="sxs-lookup"><span data-stu-id="3b511-125">Central management through firewall console.</span></span> |<span data-ttu-id="3b511-126">Kostnaden för brandväggsinstallation.</span><span class="sxs-lookup"><span data-stu-id="3b511-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="3b511-127">Inte integrerat med Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="3b511-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="3b511-128">hello lösningen nedan använder brandväggen virtuella installationer tooimplement en DMZ/skyddad scenariot.</span><span class="sxs-lookup"><span data-stu-id="3b511-128">hello solution below uses firewall virtual appliances tooimplement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="3b511-129">Överväganden</span><span class="sxs-lookup"><span data-stu-id="3b511-129">Considerations</span></span>
<span data-ttu-id="3b511-130">Du kan distribuera hello miljön som beskrivs ovan i Azure med hjälp av olika funktioner som är tillgängliga i dag, enligt följande.</span><span class="sxs-lookup"><span data-stu-id="3b511-130">You can deploy hello environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="3b511-131">**Virtuella nätverk (VNet)**.</span><span class="sxs-lookup"><span data-stu-id="3b511-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="3b511-132">Ett virtuellt Azure-nätverk fungerar på liknande sätt tooan lokala nätverk och kan vara upp i en eller flera undernät tooprovide trafikisolering och avgränsning av säkerhetsskäl.</span><span class="sxs-lookup"><span data-stu-id="3b511-132">An Azure VNet acts in similar fashion tooan on-premises network, and can be segmented into one or more subnets tooprovide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="3b511-133">**Virtuell installation**.</span><span class="sxs-lookup"><span data-stu-id="3b511-133">**Virtual appliance**.</span></span> <span data-ttu-id="3b511-134">Flera partners erbjuda virtuella installationer i hello Azure Marketplace som kan användas för hello tre brandväggar som beskrivs ovan.</span><span class="sxs-lookup"><span data-stu-id="3b511-134">Several partners provide virtual appliances in hello Azure Marketplace that can be used for hello three firewalls described above.</span></span> 
* <span data-ttu-id="3b511-135">**Användardefinierade vägar (UDR)**.</span><span class="sxs-lookup"><span data-stu-id="3b511-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="3b511-136">Routningstabeller kan innehålla udr: er som används av Azure nätverk toocontrol hello flödet av paket i ett virtuellt nätverk.</span><span class="sxs-lookup"><span data-stu-id="3b511-136">Route tables can contain UDRs used by Azure networking toocontrol hello flow of packets within a VNet.</span></span> <span data-ttu-id="3b511-137">Dessa routningstabeller kan vara tillämpade toosubnets.</span><span class="sxs-lookup"><span data-stu-id="3b511-137">These route tables can be applied toosubnets.</span></span> <span data-ttu-id="3b511-138">En av hello nyaste funktionerna i Azure är hello möjlighet tooapply en väg tabell toohello GatewaySubnet, tillhandahåller hello möjlighet tooforward all trafik som kommer till hello Azure VNet från hybrid anslutning tooa virtuell utrustning.</span><span class="sxs-lookup"><span data-stu-id="3b511-138">One of hello newest features in Azure is hello ability tooapply a route table toohello GatewaySubnet, providing hello ability tooforward all traffic coming into hello Azure VNet from a hybrid connection tooa virtual appliance.</span></span>
* <span data-ttu-id="3b511-139">**IP-vidarebefordring**.</span><span class="sxs-lookup"><span data-stu-id="3b511-139">**IP Forwarding**.</span></span> <span data-ttu-id="3b511-140">Som standard hello Azure nätverk motorn vidarebefordra paket toovirtual nätverkskort (NIC) endast om hello paket IP-adressen matchar hello NIC IP-adress.</span><span class="sxs-lookup"><span data-stu-id="3b511-140">By default, hello Azure networking engine forward packets toovirtual network interface cards (NICs) only if hello packet destination IP address matches hello NIC IP address.</span></span> <span data-ttu-id="3b511-141">Om en UDR definierar att ett paket måste skickas tooa angivna virtuell installation, skulle därför hello Azure nätverk motorn släppa paketets.</span><span class="sxs-lookup"><span data-stu-id="3b511-141">Therefore, if a UDR defines that a packet must be sent tooa given virtual appliance, hello Azure networking engine would drop that packet.</span></span> <span data-ttu-id="3b511-142">tooensure hello paketet levereras tooa VM (i det här fallet en virtuell installation) som inte är hello faktiska mål för hello-paket måste du tooenable IP-vidarebefordring för hello virtuell installation.</span><span class="sxs-lookup"><span data-stu-id="3b511-142">tooensure hello packet is delivered tooa VM (in this case a virtual appliance) that is not hello actual destination for hello packet, you need tooenable IP Forwarding for hello virtual appliance.</span></span>
* <span data-ttu-id="3b511-143">**Nätverkssäkerhetsgrupper (NSG: er)**.</span><span class="sxs-lookup"><span data-stu-id="3b511-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="3b511-144">hello exemplet nedan gör inte användning av NSG: er, men du kan använda NSG: er används toohello undernät och/eller nätverkskort i den här lösningen toofurther filter hello trafiken till och från dessa undernät och nätverkskort.</span><span class="sxs-lookup"><span data-stu-id="3b511-144">hello example below does not make use of NSGs, but you could use NSGs applied toohello subnets and/or NICs in this solution toofurther filter hello traffic in and out of those subnets and NICs.</span></span>

![IPv6-anslutning](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="3b511-146">I det här exemplet finns det en prenumeration som innehåller hello följande:</span><span class="sxs-lookup"><span data-stu-id="3b511-146">In this example there is a subscription that contains hello following:</span></span>

* <span data-ttu-id="3b511-147">2 resursgrupper, visas inte i hello diagram.</span><span class="sxs-lookup"><span data-stu-id="3b511-147">2 resource groups, not shown in hello diagram.</span></span> 
  * <span data-ttu-id="3b511-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="3b511-148">**ONPREMRG**.</span></span> <span data-ttu-id="3b511-149">Innehåller alla resurser nödvändiga toosimulate ett lokalt nätverk.</span><span class="sxs-lookup"><span data-stu-id="3b511-149">Contains all resources necessary toosimulate an on-premises network.</span></span>
  * <span data-ttu-id="3b511-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="3b511-150">**AZURERG**.</span></span> <span data-ttu-id="3b511-151">Innehåller alla resurser som behövs för hello virtuella Azure-nätverksmiljö.</span><span class="sxs-lookup"><span data-stu-id="3b511-151">Contains all resources necessary for hello Azure virtual network environment.</span></span> 
* <span data-ttu-id="3b511-152">Ett VNet med namnet **onpremvnet** används toomimic som ett lokalt datacenter segmenterat enligt nedan.</span><span class="sxs-lookup"><span data-stu-id="3b511-152">A VNet named **onpremvnet** used toomimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="3b511-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="3b511-153">**onpremsn1**.</span></span> <span data-ttu-id="3b511-154">Undernät som innehåller en virtuell dator (VM) som kör Ubuntu toomimic en lokal server.</span><span class="sxs-lookup"><span data-stu-id="3b511-154">Subnet containing a virtual machine (VM) running Ubuntu toomimic an on-premises server.</span></span>
  * <span data-ttu-id="3b511-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="3b511-155">**onpremsn2**.</span></span> <span data-ttu-id="3b511-156">Undernät som innehåller en virtuell dator som kör Ubuntu toomimic en lokal dator som används av en administratör.</span><span class="sxs-lookup"><span data-stu-id="3b511-156">Subnet containing a VM running Ubuntu toomimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="3b511-157">Det finns en virtuell brandväggsinstallation med namnet **OPFW** på **onpremvnet** används toomaintain en tunnel för**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="3b511-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used toomaintain a tunnel too**azurevnet**.</span></span>
* <span data-ttu-id="3b511-158">Ett VNet med namnet **azurevnet** segmenterat enligt nedan.</span><span class="sxs-lookup"><span data-stu-id="3b511-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="3b511-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="3b511-159">**azsn1**.</span></span> <span data-ttu-id="3b511-160">Extern brandvägg undernät som används endast för hello extern brandvägg.</span><span class="sxs-lookup"><span data-stu-id="3b511-160">External firewall subnet used exclusively for hello external firewall.</span></span> <span data-ttu-id="3b511-161">Alla Internet-trafiken kommer via det här undernätet.</span><span class="sxs-lookup"><span data-stu-id="3b511-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="3b511-162">Det här undernätet innehåller endast en extern brandvägg NIC länkade toohello.</span><span class="sxs-lookup"><span data-stu-id="3b511-162">This subnet only contains a NIC linked toohello external firewall.</span></span>
  * <span data-ttu-id="3b511-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="3b511-163">**azsn2**.</span></span> <span data-ttu-id="3b511-164">Klientdelens undernät som värd för en virtuell dator som körs som en server som ska kunna nås från hello Internet.</span><span class="sxs-lookup"><span data-stu-id="3b511-164">Front end subnet hosting a VM running as a web server that will be accessed from hello Internet.</span></span>
  * <span data-ttu-id="3b511-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="3b511-165">**azsn3**.</span></span> <span data-ttu-id="3b511-166">Backend-undernät som värd för en virtuell dator som kör en backend-programserver som ska användas av hello frontend-webbserver.</span><span class="sxs-lookup"><span data-stu-id="3b511-166">Backend subnet hosting a VM running a backend application server that will be accessed by hello front end web server.</span></span>
  * <span data-ttu-id="3b511-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="3b511-167">**azsn4**.</span></span> <span data-ttu-id="3b511-168">Hantering av undernät användas uteslutande tooprovide management åtkomst tooall brandväggen virtuella installationer.</span><span class="sxs-lookup"><span data-stu-id="3b511-168">Management subnet used exclusively tooprovide management access tooall firewall virtual appliances.</span></span> <span data-ttu-id="3b511-169">Det här undernätet innehåller bara ett nätverkskort för varje virtuell brandväggsinstallation som används i hello lösningar.</span><span class="sxs-lookup"><span data-stu-id="3b511-169">This subnet only contains a NIC for each firewall virtual appliance used in hello solution.</span></span>
  * <span data-ttu-id="3b511-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="3b511-170">**GatewaySubnet**.</span></span> <span data-ttu-id="3b511-171">Hybridrapportering i Azure-anslutningen undernät som krävs för ExpressRoute- och VPN-Gateway tooprovide-anslutning mellan Azure Vnet och andra nätverk.</span><span class="sxs-lookup"><span data-stu-id="3b511-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway tooprovide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="3b511-172">Det finns 3 brandväggen virtuella installationer i hello **azurevnet** nätverk.</span><span class="sxs-lookup"><span data-stu-id="3b511-172">There are 3 firewall virtual appliances in hello **azurevnet** network.</span></span> 
  * <span data-ttu-id="3b511-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="3b511-173">**AZF1**.</span></span> <span data-ttu-id="3b511-174">Extern brandvägg exponeras toohello offentliga Internet med hjälp av en offentlig IP-adressresurs i Azure.</span><span class="sxs-lookup"><span data-stu-id="3b511-174">External firewall exposed toohello public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="3b511-175">Du måste tooensure som du har en mall från hello Marketplace eller direkt från leverantören av enheten, som tillhandahåller en 3-NIC virtuell installation.</span><span class="sxs-lookup"><span data-stu-id="3b511-175">You need tooensure you have a template from hello Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="3b511-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="3b511-176">**AZF2**.</span></span> <span data-ttu-id="3b511-177">Intern brandvägg används toocontrol trafik mellan **azsn2** och **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="3b511-177">Internal firewall used toocontrol traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="3b511-178">Det här är en virtuell 3-NIC-installation.</span><span class="sxs-lookup"><span data-stu-id="3b511-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="3b511-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="3b511-179">**AZF3**.</span></span> <span data-ttu-id="3b511-180">Hantering av brandvägg tillgänglig tooadministrators från hello lokalt datacenter och anslutna tooa management undernät används toomanage alla brandväggsenheter.</span><span class="sxs-lookup"><span data-stu-id="3b511-180">Management firewall accessible tooadministrators from hello on-premises datacenter, and connected tooa management subnet used toomanage all firewall appliances.</span></span> <span data-ttu-id="3b511-181">Du kan hitta 2-NIC virtuell installation mallar i hello Marketplace eller be en direkt från leverantören av enheten.</span><span class="sxs-lookup"><span data-stu-id="3b511-181">You can find 2-NIC virtual appliance templates in hello Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="3b511-182">Användardefinierad routning (UDR)</span><span class="sxs-lookup"><span data-stu-id="3b511-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="3b511-183">Varje undernät i Azure kan vara länkad tooa UDR tabell som används för toodefine hur omdirigeras trafik som initieras i det undernätet.</span><span class="sxs-lookup"><span data-stu-id="3b511-183">Each subnet in Azure can be linked tooa UDR table used toodefine how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="3b511-184">Om inga udr: er har definierats använder Azure standard vägar tooallow trafik tooflow från ett undernät tooanother.</span><span class="sxs-lookup"><span data-stu-id="3b511-184">If no UDRs are defined, Azure uses default routes tooallow traffic tooflow from one subnet tooanother.</span></span> <span data-ttu-id="3b511-185">toobetter förstå udr: er, besök [vad är användardefinierade vägar och IP-vidarebefordran](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="3b511-185">toobetter understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="3b511-186">tooensure kommunikation görs via hello rätt brandväggsinstallation utifrån hello senaste kravet ovan måste du toocreate hello följande som innehåller udr: er i routningstabellen **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="3b511-186">tooensure communication is done through hello right firewall appliance, based on hello last requirement above, you need toocreate hello following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="3b511-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="3b511-187">azgwudr</span></span>
<span data-ttu-id="3b511-188">I det här scenariot hello endast trafik som flödar från lokala tooAzure kommer att använda toomanage hello brandväggar genom att ansluta för**AZF3**, och att trafik måste gå igenom hello intern brandvägg, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="3b511-188">In this scenario, hello only traffic flowing from on-premises tooAzure will be used toomanage hello firewalls by connecting too**AZF3**, and that traffic must go through hello internal firewall, **AZF2**.</span></span> <span data-ttu-id="3b511-189">Därför bara en väg är nödvändigt i hello **GatewaySubnet** enligt nedan.</span><span class="sxs-lookup"><span data-stu-id="3b511-189">Therefore, only one route is necessary in hello **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="3b511-190">Mål</span><span class="sxs-lookup"><span data-stu-id="3b511-190">Destination</span></span> | <span data-ttu-id="3b511-191">Nästa hopp</span><span class="sxs-lookup"><span data-stu-id="3b511-191">Next hop</span></span> | <span data-ttu-id="3b511-192">Förklaring</span><span class="sxs-lookup"><span data-stu-id="3b511-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3b511-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="3b511-193">10.0.4.0/24</span></span> |<span data-ttu-id="3b511-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="3b511-194">10.0.3.11</span></span> |<span data-ttu-id="3b511-195">Tillåter lokal trafik tooreach management brandväggen **AZF3**</span><span class="sxs-lookup"><span data-stu-id="3b511-195">Allows on-premises traffic tooreach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="3b511-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="3b511-196">azsn2udr</span></span>
| <span data-ttu-id="3b511-197">Mål</span><span class="sxs-lookup"><span data-stu-id="3b511-197">Destination</span></span> | <span data-ttu-id="3b511-198">Nästa hopp</span><span class="sxs-lookup"><span data-stu-id="3b511-198">Next hop</span></span> | <span data-ttu-id="3b511-199">Förklaring</span><span class="sxs-lookup"><span data-stu-id="3b511-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3b511-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="3b511-200">10.0.3.0/24</span></span> |<span data-ttu-id="3b511-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="3b511-201">10.0.2.11</span></span> |<span data-ttu-id="3b511-202">Tillåter trafik toohello backend-undernät på värdservern hello program via **AZF2**</span><span class="sxs-lookup"><span data-stu-id="3b511-202">Allows traffic toohello backend subnet hosting hello application server through **AZF2**</span></span> |
| <span data-ttu-id="3b511-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="3b511-203">0.0.0.0/0</span></span> |<span data-ttu-id="3b511-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="3b511-204">10.0.2.10</span></span> |<span data-ttu-id="3b511-205">Gör alla andra trafik toobe dirigeras via **AZF1**</span><span class="sxs-lookup"><span data-stu-id="3b511-205">Allows all other traffic toobe routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="3b511-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="3b511-206">azsn3udr</span></span>
| <span data-ttu-id="3b511-207">Mål</span><span class="sxs-lookup"><span data-stu-id="3b511-207">Destination</span></span> | <span data-ttu-id="3b511-208">Nästa hopp</span><span class="sxs-lookup"><span data-stu-id="3b511-208">Next hop</span></span> | <span data-ttu-id="3b511-209">Förklaring</span><span class="sxs-lookup"><span data-stu-id="3b511-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3b511-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="3b511-210">10.0.2.0/24</span></span> |<span data-ttu-id="3b511-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="3b511-211">10.0.3.10</span></span> |<span data-ttu-id="3b511-212">Tillåter trafik för**azsn2** tooflow från appen server toohello webbserver via **AZF2**</span><span class="sxs-lookup"><span data-stu-id="3b511-212">Allows traffic too**azsn2** tooflow from app server toohello webserver through **AZF2**</span></span> |

<span data-ttu-id="3b511-213">Du måste också toocreate routningstabeller för hello undernäten i **onpremvnet** toomimic hello lokalt datacenter.</span><span class="sxs-lookup"><span data-stu-id="3b511-213">You also need toocreate route tables for hello subnets in **onpremvnet** toomimic hello on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="3b511-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="3b511-214">onpremsn1udr</span></span>
| <span data-ttu-id="3b511-215">Mål</span><span class="sxs-lookup"><span data-stu-id="3b511-215">Destination</span></span> | <span data-ttu-id="3b511-216">Nästa hopp</span><span class="sxs-lookup"><span data-stu-id="3b511-216">Next hop</span></span> | <span data-ttu-id="3b511-217">Förklaring</span><span class="sxs-lookup"><span data-stu-id="3b511-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3b511-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="3b511-218">192.168.2.0/24</span></span> |<span data-ttu-id="3b511-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="3b511-219">192.168.1.4</span></span> |<span data-ttu-id="3b511-220">Tillåter trafik för**onpremsn2** via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="3b511-220">Allows traffic too**onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="3b511-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="3b511-221">onpremsn2udr</span></span>
| <span data-ttu-id="3b511-222">Mål</span><span class="sxs-lookup"><span data-stu-id="3b511-222">Destination</span></span> | <span data-ttu-id="3b511-223">Nästa hopp</span><span class="sxs-lookup"><span data-stu-id="3b511-223">Next hop</span></span> | <span data-ttu-id="3b511-224">Förklaring</span><span class="sxs-lookup"><span data-stu-id="3b511-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3b511-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="3b511-225">10.0.3.0/24</span></span> |<span data-ttu-id="3b511-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="3b511-226">192.168.2.4</span></span> |<span data-ttu-id="3b511-227">Tillåter trafik toohello säkerhetskopieras undernät i Azure via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="3b511-227">Allows traffic toohello backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="3b511-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="3b511-228">192.168.1.0/24</span></span> |<span data-ttu-id="3b511-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="3b511-229">192.168.2.4</span></span> |<span data-ttu-id="3b511-230">Tillåter trafik för**onpremsn1** via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="3b511-230">Allows traffic too**onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="3b511-231">IP-vidarebefordran</span><span class="sxs-lookup"><span data-stu-id="3b511-231">IP Forwarding</span></span>
<span data-ttu-id="3b511-232">UDR och IP-vidarebefordran är funktioner som du kan använda i kombination tooallow virtuella installationer toobe används toocontrol trafikflöde i ett Azure VNet.</span><span class="sxs-lookup"><span data-stu-id="3b511-232">UDR and IP Forwarding are features that you can use in combination tooallow virtual appliances toobe used toocontrol traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="3b511-233">En virtuell installation finns inget mer än en virtuell dator som kör ett program som används för toohandle nätverkstrafik på något sätt, till exempel en brandvägg eller NAT-enhet.</span><span class="sxs-lookup"><span data-stu-id="3b511-233">A virtual appliance is nothing more than a VM that runs an application used toohandle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="3b511-234">Den här virtuella installations VM måste vara kan tooreceive inkommande trafik som är adresserad inte tooitself.</span><span class="sxs-lookup"><span data-stu-id="3b511-234">This virtual appliance VM must be able tooreceive incoming traffic that is not addressed tooitself.</span></span> <span data-ttu-id="3b511-235">tooallow en tooreceive VM-trafik adresserad tooother mål, måste du aktivera IP-vidarebefordring för hello VM.</span><span class="sxs-lookup"><span data-stu-id="3b511-235">tooallow a VM tooreceive traffic addressed tooother destinations, you must enable IP Forwarding for hello VM.</span></span> <span data-ttu-id="3b511-236">Det här är en Azure-inställning, inte en inställning i hello gästoperativsystemet.</span><span class="sxs-lookup"><span data-stu-id="3b511-236">This is an Azure setting, not a setting in hello guest operating system.</span></span> <span data-ttu-id="3b511-237">Din virtuella enhet fortfarande behov toorun vissa typ av program toohandle hello inkommande trafik och vidarebefordra korrekt.</span><span class="sxs-lookup"><span data-stu-id="3b511-237">Your virtual appliance still needs toorun some type of application toohandle hello incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="3b511-238">toolearn mer om IP-vidarebefordran finns [vad är användardefinierade vägar och IP-vidarebefordran](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="3b511-238">toolearn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="3b511-239">Exempel anta att du har hello efter installationen i ett Azure-vnet:</span><span class="sxs-lookup"><span data-stu-id="3b511-239">As an example, imagine you have hello following setup in an Azure vnet:</span></span>

* <span data-ttu-id="3b511-240">Undernät **onpremsn1** innehåller en virtuell dator med namnet **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="3b511-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="3b511-241">Undernät **onpremsn2** innehåller en virtuell dator med namnet **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="3b511-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="3b511-242">En virtuell installation med namnet **OPFW** är ansluten för**onpremsn1** och **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="3b511-242">A virtual appliance named **OPFW** is connected too**onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="3b511-243">En användardefinierad väg för länkad**onpremsn1** anger att all trafik för**onpremsn2** måste skickas för**OPFW**.</span><span class="sxs-lookup"><span data-stu-id="3b511-243">A user defined route linked too**onpremsn1** specifies that all traffic too**onpremsn2** must be sent too**OPFW**.</span></span>

<span data-ttu-id="3b511-244">AT som detta pekar, om **onpremvm1** försöker tooestablish en anslutning med **onpremvm2**hello UDR används och trafik skickas för**OPFW** som hello nästa hopp.</span><span class="sxs-lookup"><span data-stu-id="3b511-244">At this point, if **onpremvm1** tries tooestablish a connection with **onpremvm2**, hello UDR will be used and traffic will be sent too**OPFW** as hello next hop.</span></span> <span data-ttu-id="3b511-245">Tänk på att hello faktiska paketets mål inte ändras, det är fortfarande **onpremvm2** är hello mål.</span><span class="sxs-lookup"><span data-stu-id="3b511-245">Keep in mind that hello actual packet destination is not being changed, it still says **onpremvm2** is hello destination.</span></span> 

<span data-ttu-id="3b511-246">Utan IP-vidarebefordran aktiverad för **OPFW**hello Azure virtuella nätverk logik släpper hälsningspaket, eftersom det bara tillåter att paket toobe skickas tooa VM om hello Virtuella datorns IP-adressen är hello mål för hello-paket.</span><span class="sxs-lookup"><span data-stu-id="3b511-246">Without IP Forwarding enabled for **OPFW**, hello Azure virtual networking logic will drop hello packets, since it only allows packets toobe sent tooa VM if hello VM’s IP address is hello destination for hello packet.</span></span>

<span data-ttu-id="3b511-247">Med IP-vidarebefordran vidarebefordrar hello virtuella Azure-nätverket logik hello paket tooOPFW utan att ändra dess ursprungliga måladressen.</span><span class="sxs-lookup"><span data-stu-id="3b511-247">With IP Forwarding, hello Azure virtual network logic will forward hello packets tooOPFW, without changing its original destination address.</span></span> <span data-ttu-id="3b511-248">**OPFW** måste hantera hälsningspaket och avgöra vilka toodo med dem..</span><span class="sxs-lookup"><span data-stu-id="3b511-248">**OPFW** must handle hello packets and determine what toodo with them.</span></span>

<span data-ttu-id="3b511-249">Hello scenariot ovan toowork måste du aktivera IP-vidarebefordring på hello nätverkskort för **OPFW**, **AZF1**, **AZF2**, och **AZF3** som används för routning (alla NIC utom hello de länkade toohello management undernät).</span><span class="sxs-lookup"><span data-stu-id="3b511-249">For hello scenario above toowork, you must enable IP Forwarding on hello NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except hello ones linked toohello management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="3b511-250">Brandväggsregler</span><span class="sxs-lookup"><span data-stu-id="3b511-250">Firewall Rules</span></span>
<span data-ttu-id="3b511-251">Enligt beskrivningen ovan, garanterar IP-vidarebefordran endast paket skickas toohello virtuella installationer.</span><span class="sxs-lookup"><span data-stu-id="3b511-251">As described above, IP Forwarding only ensures packets are sent toohello virtual appliances.</span></span> <span data-ttu-id="3b511-252">Din enhet måste fortfarande toodecide vilka toodo med dessa paket.</span><span class="sxs-lookup"><span data-stu-id="3b511-252">Your appliance still needs toodecide what toodo with those packets.</span></span> <span data-ttu-id="3b511-253">Du behöver toocreate hello följande regler i dina installationer i hello scenariot ovan:</span><span class="sxs-lookup"><span data-stu-id="3b511-253">In hello scenario above, you will need toocreate hello following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="3b511-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="3b511-254">OPFW</span></span>
<span data-ttu-id="3b511-255">OPFW representerar en lokal enhet som innehåller hello följande regler:</span><span class="sxs-lookup"><span data-stu-id="3b511-255">OPFW represents an on-premises device containing hello following rules:</span></span>

* <span data-ttu-id="3b511-256">**Väg**: All trafik too10.0.0.0/16 (**azurevnet**) måste skickas via tunnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="3b511-256">**Route**: All traffic too10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="3b511-257">**Principen**: alla dubbelriktad trafik mellan **port2** och **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="3b511-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="3b511-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="3b511-258">AZF1</span></span>
<span data-ttu-id="3b511-259">AZF1 representerar en Azure virtuell installation som innehåller hello följande regler:</span><span class="sxs-lookup"><span data-stu-id="3b511-259">AZF1 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="3b511-260">**Principen**: alla dubbelriktad trafik mellan **port1** och **port2**.</span><span class="sxs-lookup"><span data-stu-id="3b511-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="3b511-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="3b511-261">AZF2</span></span>
<span data-ttu-id="3b511-262">AZF2 representerar en Azure virtuell installation som innehåller hello följande regler:</span><span class="sxs-lookup"><span data-stu-id="3b511-262">AZF2 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="3b511-263">**Väg**: All trafik too10.0.0.0/16 (**onpremvnet**) måste användas för att skicka toohello Azure gateway IP-adress (d.v.s. 10.0.0.1) **port1**.</span><span class="sxs-lookup"><span data-stu-id="3b511-263">**Route**: All traffic too10.0.0.0/16 (**onpremvnet**) must be sent toohello Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="3b511-264">**Principen**: alla dubbelriktad trafik mellan **port1** och **port2**.</span><span class="sxs-lookup"><span data-stu-id="3b511-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="3b511-265">Nätverkssäkerhetsgrupper (NSG: er)</span><span class="sxs-lookup"><span data-stu-id="3b511-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="3b511-266">I det här scenariot används inte NSG: er.</span><span class="sxs-lookup"><span data-stu-id="3b511-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="3b511-267">Du kan dock använda NSG: er tooeach toorestrict inkommande och utgående undernätstrafik.</span><span class="sxs-lookup"><span data-stu-id="3b511-267">However, you could apply NSGs tooeach subnet toorestrict incoming and outgoing traffic.</span></span> <span data-ttu-id="3b511-268">Exempelvis kan du använda hello följande NSG-regler toohello externa FW undernät.</span><span class="sxs-lookup"><span data-stu-id="3b511-268">For instance, you could apply hello following NSG rules toohello external FW subnet.</span></span>

<span data-ttu-id="3b511-269">**Inkommande**</span><span class="sxs-lookup"><span data-stu-id="3b511-269">**Incoming**</span></span>

* <span data-ttu-id="3b511-270">Tillåt alla TCP-trafik från hello Internet tooport 80 på någon virtuell dator i hello undernät.</span><span class="sxs-lookup"><span data-stu-id="3b511-270">Allow all TCP traffic from hello Internet tooport 80 on any VM in hello subnet.</span></span>
* <span data-ttu-id="3b511-271">Neka all annan trafik från hello Internet.</span><span class="sxs-lookup"><span data-stu-id="3b511-271">Deny all other traffic from hello Internet.</span></span>

<span data-ttu-id="3b511-272">**Utgående**</span><span class="sxs-lookup"><span data-stu-id="3b511-272">**Outgoing**</span></span>

* <span data-ttu-id="3b511-273">Neka alla trafik toohello Internet.</span><span class="sxs-lookup"><span data-stu-id="3b511-273">Deny all traffic toohello Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="3b511-274">Hög nivå steg</span><span class="sxs-lookup"><span data-stu-id="3b511-274">High level steps</span></span>
<span data-ttu-id="3b511-275">toodeploy det här scenariot, följ hello hög nivå stegen nedan.</span><span class="sxs-lookup"><span data-stu-id="3b511-275">toodeploy this scenario, follow hello high level steps below.</span></span>

1. <span data-ttu-id="3b511-276">Inloggningen tooyour Azure-prenumeration.</span><span class="sxs-lookup"><span data-stu-id="3b511-276">Login tooyour Azure Subscription.</span></span>
2. <span data-ttu-id="3b511-277">Om du vill toodeploy ett VNet toomimic hello lokalt nätverk, etablera hello-resurser som ingår i **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="3b511-277">If you want toodeploy a VNet toomimic hello on-premises network, provision hello resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="3b511-278">Etablera hello-resurser som ingår i **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="3b511-278">Provision hello resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="3b511-279">Etablera hello tunnel från **onpremvnet** för**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="3b511-279">Provision hello tunnel from **onpremvnet** too**azurevnet**.</span></span>
5. <span data-ttu-id="3b511-280">När alla resurser etableras, logga in för**onpremvm2** och ping 10.0.3.101 tootest anslutningen mellan **onpremsn2** och **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="3b511-280">Once all resources are provisioned, log on too**onpremvm2** and ping 10.0.3.101 tootest connectivity between **onpremsn2** and **azsn3**.</span></span>

