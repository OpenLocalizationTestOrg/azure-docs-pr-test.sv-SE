---
title: "aaaDesigning hög tillgängliga program med hjälp av Azure Geo-Redundant lagring med läsbehörighet (RA-GRS) | Microsoft Docs"
description: "Hur toouse Azure RA-GRS lagring tooarchitect en högtillgänglig programmet flexibla tillräckligt med toohandle avbrott."
services: storage
documentationcenter: .net
author: robinsh
manager: timlt
editor: tysonn
ms.assetid: 8f040b0f-8926-4831-ac07-79f646f31926
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 1/19/2017
ms.author: robinsh
ms.openlocfilehash: e4a9fe7ef33eecd894408b3c1ef59920a248d1bd
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="designing-highly-available-applications-using-ra-grs"></a><span data-ttu-id="8584b-103">Designa hög tillgängliga program med hjälp av RA-GRS</span><span class="sxs-lookup"><span data-stu-id="8584b-103">Designing Highly Available Applications using RA-GRS</span></span>

<span data-ttu-id="8584b-104">En vanlig funktion för molnbaserad infrastruktur är att de ger en plattform för hög tillgänglighet som värd för program.</span><span class="sxs-lookup"><span data-stu-id="8584b-104">A common feature of cloud-based infrastructures is that they provide a highly available platform for hosting applications.</span></span> <span data-ttu-id="8584b-105">Utvecklare av molnbaserade program måste du överväga att noggrant hur tooleverage den här plattformen toodeliver högtillgänglig program tootheir användare.</span><span class="sxs-lookup"><span data-stu-id="8584b-105">Developers of cloud-based applications must consider carefully how tooleverage this platform toodeliver highly available applications tootheir users.</span></span> <span data-ttu-id="8584b-106">Den här artikeln fokuserar särskilt på hur utvecklare kan använda hello Azure Storage Geo-Redundant lagring med läsbehörighet (RA-GRS) toomake sina fler tillgängliga program.</span><span class="sxs-lookup"><span data-stu-id="8584b-106">This article focuses specifically on how developers can use hello Azure Storage Read Access Geo Redundant Storage (RA-GRS) toomake their applications more available.</span></span>

<span data-ttu-id="8584b-107">Det finns fyra alternativ för redundans – LRS (lokalt Redundant lagring), ZRS (zonen Redundant lagring), GRS (Geo-Redundant lagring) och RA-GRS (Geo-Redundant lagring med läsbehörighet).</span><span class="sxs-lookup"><span data-stu-id="8584b-107">There are four choices for redundancy – LRS (Locally Redundant Storage), ZRS (Zone Redundant Storage), GRS (Geo-Redundant Storage), and RA-GRS (Read Access Geo-Redundant Storage).</span></span> <span data-ttu-id="8584b-108">Vi toodiscuss GRS och RA-GRS i den här artikeln.</span><span class="sxs-lookup"><span data-stu-id="8584b-108">We are going toodiscuss GRS and RA-GRS in this article.</span></span> <span data-ttu-id="8584b-109">Med GRS sparas tre kopior av dina data i hello primära region som du valde när du ställer in hello storage-konto.</span><span class="sxs-lookup"><span data-stu-id="8584b-109">With GRS, three copies of your data are kept in hello primary region you selected when setting up hello storage account.</span></span> <span data-ttu-id="8584b-110">Tre ytterligare kopior underhålls asynkront i en sekundär region som anges av Azure.</span><span class="sxs-lookup"><span data-stu-id="8584b-110">Three additional copies are maintained asynchronously in a secondary region specified by Azure.</span></span> <span data-ttu-id="8584b-111">RA-GRS är hello samma sak som GRS förutom att du har läsbehörighet toohello sekundär kopia.</span><span class="sxs-lookup"><span data-stu-id="8584b-111">RA-GRS is hello same thing as GRS except that you have read access toohello secondary copy.</span></span> <span data-ttu-id="8584b-112">Mer information om alternativ för hello olika Azure Storage redundans finns [Azure Storage-replikering](https://docs.microsoft.com/en-us/azure/storage/storage-redundancy).</span><span class="sxs-lookup"><span data-stu-id="8584b-112">For more information about hello different Azure Storage redundancy options, see [Azure Storage replication](https://docs.microsoft.com/en-us/azure/storage/storage-redundancy).</span></span> <span data-ttu-id="8584b-113">hello replikering artikeln beskriver också hello pairings hello primära och sekundära regioner.</span><span class="sxs-lookup"><span data-stu-id="8584b-113">hello replication article also shows hello pairings of hello primary and secondary regions.</span></span>

<span data-ttu-id="8584b-114">Det finns kodstycken som ingår i den här artikeln och en länk tooa fullständigt exempel hello slutet som du kan hämta och köra.</span><span class="sxs-lookup"><span data-stu-id="8584b-114">There are code snippets included in this article, and a link tooa complete sample at hello end that you can download and run.</span></span>

## <a name="key-features-of-ra-grs"></a><span data-ttu-id="8584b-115">Viktiga funktioner i RA-GRS</span><span class="sxs-lookup"><span data-stu-id="8584b-115">Key features of RA-GRS</span></span>

<span data-ttu-id="8584b-116">Innan vi berättar hur toouse RA-GRS lagring, vi pratar om dess egenskaper och beteende.</span><span class="sxs-lookup"><span data-stu-id="8584b-116">Before we talk about how toouse RA-GRS storage, let's talk about its properties and behavior.</span></span>

* <span data-ttu-id="8584b-117">Azure Storage upprätthåller en skrivskyddad kopia av hello data som du lagrar i din primära region i en sekundär region. som nämnts ovan anger hello lagringstjänsten hello platsen för hello sekundär region.</span><span class="sxs-lookup"><span data-stu-id="8584b-117">Azure Storage maintains a read-only copy of hello data you store in your primary region in a secondary region; as noted above, hello storage service determines hello location of hello secondary region.</span></span>

* <span data-ttu-id="8584b-118">hello skrivskyddad kopia är [överensstämmelse](https://en.wikipedia.org/wiki/Eventual_consistency) med hello data i hello primär region.</span><span class="sxs-lookup"><span data-stu-id="8584b-118">hello read-only copy is [eventually consistent](https://en.wikipedia.org/wiki/Eventual_consistency) with hello data in hello primary region.</span></span>

* <span data-ttu-id="8584b-119">För blobbar, tabeller och köer, kan du fråga hello sekundär region för en *tid för senaste synkronisering* värde som anger när Hej senaste replikeringen från hello primära toohello sekundär region inträffade.</span><span class="sxs-lookup"><span data-stu-id="8584b-119">For blobs, tables, and queues, you can query hello secondary region for a *Last Sync Time* value that tells you when hello last replication from hello primary toohello secondary region occurred.</span></span> <span data-ttu-id="8584b-120">(Detta stöds inte för Azure File storage som saknar RA-GRS redundans just nu.)</span><span class="sxs-lookup"><span data-stu-id="8584b-120">(This is not supported for Azure File storage, which doesn't have RA-GRS redundancy at this time.)</span></span>

* <span data-ttu-id="8584b-121">Du kan använda hello Storage-klientbibliotek toointeract med hello data i antingen hello primär eller sekundär region.</span><span class="sxs-lookup"><span data-stu-id="8584b-121">You can use hello Storage Client Library toointeract with hello data in either hello primary or secondary region.</span></span> <span data-ttu-id="8584b-122">Du kan också omdirigera Läs begär automatiskt toohello sekundär region om tidsgränsen uppnås för en läsbegäran toohello primär region.</span><span class="sxs-lookup"><span data-stu-id="8584b-122">You can also redirect read requests automatically toohello secondary region if a read request toohello primary region times out.</span></span>

* <span data-ttu-id="8584b-123">Om det finns ett större problem som påverkar tillgängligheten hello hello data i hello primär region, kan hello Azure-teamet utlösa en geo-redundans, då hello DNS-poster pekar toohello primära regionen kommer att vara ändrade toopoint toohello sekundär region.</span><span class="sxs-lookup"><span data-stu-id="8584b-123">If there is a major issue affecting hello accessibility of hello data in hello primary region, hello Azure team may trigger a geo-failover, at which point hello DNS entries pointing toohello primary region will be changed toopoint toohello secondary region.</span></span>

* <span data-ttu-id="8584b-124">Om det uppstår geo-redundans, kommer Azure Markera en ny sekundär plats och replikera hello Dataplats toothat och peka hello sekundär DNS-poster tooit.</span><span class="sxs-lookup"><span data-stu-id="8584b-124">If a geo-failover occurs, Azure will select a new secondary location and replicate hello data toothat location, then point hello secondary DNS entries tooit.</span></span> <span data-ttu-id="8584b-125">sekundär slutpunkt för hello blir otillgänglig tills hello storage-konto är klar replikeras.</span><span class="sxs-lookup"><span data-stu-id="8584b-125">hello secondary endpoint will be unavailable until hello storage account has finished replicating.</span></span> <span data-ttu-id="8584b-126">Mer information finns [vilka toodo om ett Azure Storage-avbrott inträffar](https://docs.microsoft.com/en-us/azure/storage/storage-disaster-recovery-guidance).</span><span class="sxs-lookup"><span data-stu-id="8584b-126">For more information, please see [What toodo if an Azure Storage outage occurs](https://docs.microsoft.com/en-us/azure/storage/storage-disaster-recovery-guidance).</span></span>

## <a name="application-design-considerations-when-using-ra-grs"></a><span data-ttu-id="8584b-127">Designöverväganden för programmet när du använder RA-GRS</span><span class="sxs-lookup"><span data-stu-id="8584b-127">Application design considerations when using RA-GRS</span></span>

<span data-ttu-id="8584b-128">hello Huvudsyftet med den här artikeln är tooshow du hur toodesign ett program som kommer att fortsätta toofunction (i en begränsad kapacitet) ens vid hello en större katastrof på hello primära data center.</span><span class="sxs-lookup"><span data-stu-id="8584b-128">hello main purpose of this article is tooshow you how toodesign an application that will continue toofunction (albeit in a limited capacity) even in hello event of a major disaster at hello primary data center.</span></span> <span data-ttu-id="8584b-129">Det gör du genom att ditt program toohandle tillfälligt eller långvariga problem genom att växla tooread från hello sekundär region när det finns ett problem och växla tillbaka när hello primära region som är tillgänglig igen.</span><span class="sxs-lookup"><span data-stu-id="8584b-129">You do this by having your application toohandle transient or long-running issues by switching tooread from hello secondary region while there is a problem, and switching back when hello primary region is available again.</span></span>

### <a name="using-eventually-consistent-data"></a><span data-ttu-id="8584b-130">Med hjälp av överensstämmelse data</span><span class="sxs-lookup"><span data-stu-id="8584b-130">Using eventually consistent data</span></span>

<span data-ttu-id="8584b-131">Den här föreslagna lösningen förutsätter att det är bra tooreturn vad kan vara inaktuella data toohello anropande programmet.</span><span class="sxs-lookup"><span data-stu-id="8584b-131">This proposed solution assumes that it is okay tooreturn what could be stale data toohello calling application.</span></span> <span data-ttu-id="8584b-132">Eftersom hello sekundära data är överensstämmelse, är det möjligt att hello data skrevs toohello primära men hello uppdatering toohello sekundära inte hade slutförts replikera när hello primär region blev inte tillgänglig.</span><span class="sxs-lookup"><span data-stu-id="8584b-132">Because hello secondary data is eventually consistent, it is possible that hello data was written toohello primary but hello update toohello secondary had not finished replicating when hello primary region became inaccessible.</span></span>

<span data-ttu-id="8584b-133">Till exempel kunden kunde skicka en uppdatering som lyckas och sedan hello primära kunde kraschar innan hello uppdateras spridda toohello sekundär.</span><span class="sxs-lookup"><span data-stu-id="8584b-133">For example, your customer could submit an update that is successful, and then hello primary could go down before hello update is propagated toohello secondary.</span></span> <span data-ttu-id="8584b-134">I det här fallet får hello kunden ber sedan tillbaka tooread hello data, han hello inaktuella data i stället för hello uppdaterade data.</span><span class="sxs-lookup"><span data-stu-id="8584b-134">In this case, if hello customer then asks tooread hello data back, he receives hello stale data instead of hello updated data.</span></span> <span data-ttu-id="8584b-135">Du måste bestämma om detta är acceptabelt och i så fall, hur du kommer meddelandet hello kunden.</span><span class="sxs-lookup"><span data-stu-id="8584b-135">You must decide if this is acceptable, and if so, how you will message hello customer.</span></span> <span data-ttu-id="8584b-136">Du ser hur toocheck hello tid för senaste synkronisering på hello sekundära data senare i den här artikeln toosee om hello sekundära är uppdaterad.</span><span class="sxs-lookup"><span data-stu-id="8584b-136">You'll see how toocheck hello Last Sync Time on hello secondary data later in this article toosee if hello secondary is up-to-date.</span></span>

### <a name="handling-services-separately-or-all-together"></a><span data-ttu-id="8584b-137">Hantera tjänster separat eller alla tillsammans</span><span class="sxs-lookup"><span data-stu-id="8584b-137">Handling services separately or all together</span></span>

<span data-ttu-id="8584b-138">Även inte troligt är det möjligt för en tjänst toobecome inte tillgänglig medan hello andra tjänster är fortfarande fungerar.</span><span class="sxs-lookup"><span data-stu-id="8584b-138">While not likely, it is possible for one service toobecome unavailable while hello other services are still fully functional.</span></span> <span data-ttu-id="8584b-139">Du kan hantera hello återförsök och skrivskyddat läge för varje service separat (BLOB, köer, tabeller) eller kan du hantera försök Allmänt för alla hello lagringstjänster tillsammans.</span><span class="sxs-lookup"><span data-stu-id="8584b-139">You can handle hello retries and read-only mode for each service separately (blobs, queues, tables), or you can handle retries generically for all hello storage services together.</span></span>

<span data-ttu-id="8584b-140">Om du använder köer och blobbar i ditt program, kan du till exempel bestämma tooput separat kod toohandle återförsökbart fel för var och en av dessa.</span><span class="sxs-lookup"><span data-stu-id="8584b-140">For example, if you use queues and blobs in your application, you may decide tooput in separate code toohandle retryable errors for each of these.</span></span> <span data-ttu-id="8584b-141">Sedan om du får ett nytt försök från hello blob-tjänsten, men hello kötjänsten fortfarande fungerar, att endast hello del av programmet hanterar BLOB påverkas.</span><span class="sxs-lookup"><span data-stu-id="8584b-141">Then if you get a retry from hello blob service, but hello queue service is still working, only hello part of your application that handles blobs will be impacted.</span></span> <span data-ttu-id="8584b-142">Om du väljer toohandle alla lagringstjänsten återförsök Allmänt och anropet toohello blob-tjänsten returnerar ett återförsökbart fel sedan begäranden tooboth hello blob-tjänsten och hello kötjänsten påverkas.</span><span class="sxs-lookup"><span data-stu-id="8584b-142">If you decide toohandle all storage service retries generically and a call toohello blob service returns a retryable error, then requests tooboth hello blob service and hello queue service will be impacted.</span></span>

<span data-ttu-id="8584b-143">Slutligen beror detta på hello komplexiteten i ditt program.</span><span class="sxs-lookup"><span data-stu-id="8584b-143">Ultimately, this depends on hello complexity of your application.</span></span> <span data-ttu-id="8584b-144">Kan du välja inte toohandle hello fel av tjänsten, men i stället tooredirect läsförfrågningar för alla storage services toohello sekundär region och kör programmet hello i skrivskyddat läge när du upptäcker ett problem med storage-tjänst i hello primära region.</span><span class="sxs-lookup"><span data-stu-id="8584b-144">You may decide not toohandle hello failures by service, but instead tooredirect read requests for all storage services toohello secondary region and run hello application in read-only mode when you detect a problem with any storage service in hello primary region.</span></span>

### <a name="other-considerations"></a><span data-ttu-id="8584b-145">Andra överväganden</span><span class="sxs-lookup"><span data-stu-id="8584b-145">Other considerations</span></span>

<span data-ttu-id="8584b-146">Dessa hello andra överväganden som diskuteras i hello resten av den här artikeln.</span><span class="sxs-lookup"><span data-stu-id="8584b-146">These are hello other considerations we will discuss in hello rest of this article.</span></span>

*   <span data-ttu-id="8584b-147">Hantera återförsök för läsbegäranden hello strömbrytare mönster</span><span class="sxs-lookup"><span data-stu-id="8584b-147">Handling retries of read requests using hello Circuit Breaker pattern</span></span>

*   <span data-ttu-id="8584b-148">Slutligen konsekventa data och hello tid för senaste synkronisering</span><span class="sxs-lookup"><span data-stu-id="8584b-148">Eventually-consistent data and hello Last Sync Time</span></span>

*   <span data-ttu-id="8584b-149">Testning</span><span class="sxs-lookup"><span data-stu-id="8584b-149">Testing</span></span>

## <a name="running-your-application-in-read-only-mode"></a><span data-ttu-id="8584b-150">Kör ditt program i skrivskyddat läge</span><span class="sxs-lookup"><span data-stu-id="8584b-150">Running your application in read-only mode</span></span>

<span data-ttu-id="8584b-151">toouse RA-GRS lagring, du måste vara kan toohandle både kunde inte läsa begäranden och misslyckade uppdateringsbegäranden (med uppdatering i det här fallet innebörd infogningar, uppdateringar och borttagningar).</span><span class="sxs-lookup"><span data-stu-id="8584b-151">toouse RA-GRS storage, you must be able toohandle both failed read requests and failed update requests (with update in this case meaning inserts, updates, and deletions).</span></span> <span data-ttu-id="8584b-152">Om hello primära data center misslyckas, läsa begäranden kan vara omdirigerade toohello sekundära datacenter, men begäranden om att uppdatera inte eftersom hello sekundära är skrivskyddad.</span><span class="sxs-lookup"><span data-stu-id="8584b-152">If hello primary data center fails, read requests can be redirected toohello secondary data center, but update requests cannot because hello secondary is read only.</span></span> <span data-ttu-id="8584b-153">Därför måste vissa sätt toorun ditt program i skrivskyddat läge.</span><span class="sxs-lookup"><span data-stu-id="8584b-153">For this reason, you need some way toorun your application in read-only mode.</span></span>

<span data-ttu-id="8584b-154">Du kan till exempel ange en flagga som ska kontrolleras innan du skickar alla begäranden toohello lagring uppdateringstjänsten.</span><span class="sxs-lookup"><span data-stu-id="8584b-154">For example, you can set a flag that will be checked before submitting any update requests toohello storage service.</span></span> <span data-ttu-id="8584b-155">När en av begäranden om att uppdatera hello kommer kan du hoppa över den och returnera en lämplig respons toohello kund.</span><span class="sxs-lookup"><span data-stu-id="8584b-155">When one of hello update requests comes through, you can skip it and return an appropriate response toohello customer.</span></span> <span data-ttu-id="8584b-156">Du kanske även vill toodisable vissa funktioner helt och hållet förrän hello problemet har lösts och meddela användarna att dessa funktioner är inte tillgänglig för tillfället.</span><span class="sxs-lookup"><span data-stu-id="8584b-156">You may even want toodisable certain features altogether until hello problem is resolved and notify users that those features are temporarily unavailable.</span></span>

<span data-ttu-id="8584b-157">Om du väljer toohandle fel för varje service separat, måste du också toohandle hello möjlighet toorun ditt program i skrivskyddat läge av tjänsten.</span><span class="sxs-lookup"><span data-stu-id="8584b-157">If you decide toohandle errors for each service separately, you will also need toohandle hello ability toorun your application in read-only mode by service.</span></span> <span data-ttu-id="8584b-158">Du kan ha skrivskyddad flaggor för varje tjänst som kan aktiveras och inaktiveras och referensen hello lämpliga flaggan i hello lämpliga platser i din kod.</span><span class="sxs-lookup"><span data-stu-id="8584b-158">You could have read-only flags for each service that can be enabled and disabled and handle hello appropriate flag in hello appropriate places in your code.</span></span>

<span data-ttu-id="8584b-159">Som kan toorun ditt program i skrivskyddat läge har en annan sida fördel – den ger dig hello möjlighet tooensure begränsade funktioner under en Programuppgradering för viktiga.</span><span class="sxs-lookup"><span data-stu-id="8584b-159">Being able toorun your application in read-only mode has another side benefit – it gives you hello ability tooensure limited functionality during a major application upgrade.</span></span> <span data-ttu-id="8584b-160">Du kan utlösa ditt program toorun i skrivskyddat läge och punkt toohello sekundära datacenter, se till att ingen kommer åt hello data på hello primär region medan du gör uppgraderingar.</span><span class="sxs-lookup"><span data-stu-id="8584b-160">You can trigger your application toorun in read-only mode and point toohello secondary data center, ensuring nobody is accessing hello data in hello primary region while you're making upgrades.</span></span>

## <a name="handling-updates-when-running-in-read-only-mode"></a><span data-ttu-id="8584b-161">Hantera uppdateringar när den körs i skrivskyddat läge</span><span class="sxs-lookup"><span data-stu-id="8584b-161">Handling updates when running in read-only mode</span></span>

<span data-ttu-id="8584b-162">Det finns många sätt toohandle uppdatering begäranden när den körs i skrivskyddat läge.</span><span class="sxs-lookup"><span data-stu-id="8584b-162">There are many ways toohandle update requests when running in read-only mode.</span></span> <span data-ttu-id="8584b-163">Vi kommer inte täcker detta utförligt, men i allmänhet det finns ett par av mönster som du vill.</span><span class="sxs-lookup"><span data-stu-id="8584b-163">We won't cover this comprehensively, but generally, there are a couple of patterns that you consider.</span></span>

1.  <span data-ttu-id="8584b-164">Du kan svara tooyour användare och informera dem om du för närvarande inte accepterar uppdateringar.</span><span class="sxs-lookup"><span data-stu-id="8584b-164">You can respond tooyour user and tell them you are not currently accepting updates.</span></span> <span data-ttu-id="8584b-165">Kontakta hanteringssystemet kan aktivera kunder tooaccess kontaktinformation men inte göra uppdateringar.</span><span class="sxs-lookup"><span data-stu-id="8584b-165">For example, a contact management system could enable customers tooaccess contact information but not make updates.</span></span>

2.  <span data-ttu-id="8584b-166">Du kan placera dina uppdateringar i en annan region.</span><span class="sxs-lookup"><span data-stu-id="8584b-166">You can enqueue your updates in another region.</span></span> <span data-ttu-id="8584b-167">I detta fall skulle du skriva väntar på att uppdatera begäranden tooa kön i en annan region och sedan har en sätt tooprocess autentiseringsbegäranden när hello primära Datacenter är online igen.</span><span class="sxs-lookup"><span data-stu-id="8584b-167">In this case, you would write your pending update requests tooa queue in a different region, and then have a way tooprocess those requests after hello primary data center comes online again.</span></span> <span data-ttu-id="8584b-168">I det här scenariot bör du låta hello kunder vet att hello update begärt kö för senare bearbetning.</span><span class="sxs-lookup"><span data-stu-id="8584b-168">In this scenario, you should let hello customer know that hello update requested is queued for later processing.</span></span>

3.  <span data-ttu-id="8584b-169">Du kan skriva dina uppdateringar tooa storage-konto i en annan region.</span><span class="sxs-lookup"><span data-stu-id="8584b-169">You can write your updates tooa storage account in another region.</span></span> <span data-ttu-id="8584b-170">Sedan kan hello primära Datacenter är online igen du ha en sätt toomerge uppdateringarna i hello primära data, beroende på hello datastrukturen hello.</span><span class="sxs-lookup"><span data-stu-id="8584b-170">Then when hello primary data center comes back online, you can have a way toomerge those updates into hello primary data, depending on hello structure of hello data.</span></span> <span data-ttu-id="8584b-171">Om du skapar separata filer med en stämpel för datum/tid i hello namn, kan du kopiera dessa filer tillbaka toohello primär region.</span><span class="sxs-lookup"><span data-stu-id="8584b-171">For example, if you are creating separate files with a date/time stamp in hello name, you can copy those files back toohello primary region.</span></span> <span data-ttu-id="8584b-172">Detta fungerar för vissa arbetsbelastningar som till exempel loggnings- och iOT-data.</span><span class="sxs-lookup"><span data-stu-id="8584b-172">This works for some workloads such as logging and iOT data.</span></span>

## <a name="handling-retries"></a><span data-ttu-id="8584b-173">Hantera nya försök</span><span class="sxs-lookup"><span data-stu-id="8584b-173">Handling retries</span></span>

<span data-ttu-id="8584b-174">Hur vill du veta vilka fel återförsökbart?</span><span class="sxs-lookup"><span data-stu-id="8584b-174">How do you know which errors are retryable?</span></span> <span data-ttu-id="8584b-175">Detta bestäms av hello storage-klientbiblioteket.</span><span class="sxs-lookup"><span data-stu-id="8584b-175">This is determined by hello storage client library.</span></span> <span data-ttu-id="8584b-176">Ett 404-fel (Det gick inte att hitta resurs) är exempelvis inte återförsökbart eftersom du försöker den inte är sannolikt tooresult i lyckades.</span><span class="sxs-lookup"><span data-stu-id="8584b-176">For example, a 404 error (resource not found) is not retryable because retrying it is not likely tooresult in success.</span></span> <span data-ttu-id="8584b-177">På hello däremot 500 fel är återförsökbart eftersom det är ett serverfel och det kan vara ett övergående problem.</span><span class="sxs-lookup"><span data-stu-id="8584b-177">On hello other hand, a 500 error is retryable because it is a server error, and it may simply be a transient issue.</span></span> <span data-ttu-id="8584b-178">Mer information finns på hello [öppna källkoden för hello ExponentialRetry klassen](https://github.com/Azure/azure-storage-net/blob/87b84b3d5ee884c7adc10e494e2c7060956515d0/Lib/Common/RetryPolicies/ExponentialRetry.cs) i hello .NET storage-klientbiblioteket.</span><span class="sxs-lookup"><span data-stu-id="8584b-178">For more details, check out hello [open source code for hello ExponentialRetry class](https://github.com/Azure/azure-storage-net/blob/87b84b3d5ee884c7adc10e494e2c7060956515d0/Lib/Common/RetryPolicies/ExponentialRetry.cs) in hello .NET storage client library.</span></span> <span data-ttu-id="8584b-179">(Leta efter hello ShouldRetry metod).</span><span class="sxs-lookup"><span data-stu-id="8584b-179">(Look for hello ShouldRetry method.)</span></span>

### <a name="read-requests"></a><span data-ttu-id="8584b-180">Läs begäranden</span><span class="sxs-lookup"><span data-stu-id="8584b-180">Read requests</span></span>

<span data-ttu-id="8584b-181">Läs begäranden kan vara omdirigerade toosecondary lagring om det är problem med primär lagring.</span><span class="sxs-lookup"><span data-stu-id="8584b-181">Read requests can be redirected toosecondary storage if there is a problem with primary storage.</span></span> <span data-ttu-id="8584b-182">Som beskrivs ovan i [med slutligen konsekventa Data](#using-eventually-consistent-data), det måste vara godkänd för ditt program toopotentially läsa inaktuella data.</span><span class="sxs-lookup"><span data-stu-id="8584b-182">As noted above in [Using Eventually Consistent Data](#using-eventually-consistent-data), it must be acceptable for your application toopotentially read stale data.</span></span> <span data-ttu-id="8584b-183">Om du använder hello lagring klienten biblioteket tooaccess RA-GRS data, kan du ange hello försök beteendet för en läsbegäran genom att ange ett värde för hello **LocationMode** egenskapen tooone av hello följande:</span><span class="sxs-lookup"><span data-stu-id="8584b-183">If you are using hello storage client library tooaccess RA-GRS data, you can specify hello retry behavior of a read request by setting a value for hello **LocationMode** property tooone of hello following:</span></span>

*   <span data-ttu-id="8584b-184">**PrimaryOnly** (hello standard)</span><span class="sxs-lookup"><span data-stu-id="8584b-184">**PrimaryOnly** (hello default)</span></span>

*   <span data-ttu-id="8584b-185">**PrimaryThenSecondary**</span><span class="sxs-lookup"><span data-stu-id="8584b-185">**PrimaryThenSecondary**</span></span>

*   <span data-ttu-id="8584b-186">**SecondaryOnly**</span><span class="sxs-lookup"><span data-stu-id="8584b-186">**SecondaryOnly**</span></span>

*   <span data-ttu-id="8584b-187">**SecondaryThenPrimary**</span><span class="sxs-lookup"><span data-stu-id="8584b-187">**SecondaryThenPrimary**</span></span>

<span data-ttu-id="8584b-188">När du anger hello **LocationMode** för**PrimaryThenSecondary**om hello inledande läsa begäran toohello primära slutpunkten misslyckas med ett återförsökbart fel, hello klienten gör automatiskt en annan Läs sekundär slutpunkt för toohello-begäran.</span><span class="sxs-lookup"><span data-stu-id="8584b-188">When you set hello **LocationMode** too**PrimaryThenSecondary**, if hello initial read request toohello primary endpoint fails with a retryable error, hello client automatically makes another read request toohello secondary endpoint.</span></span> <span data-ttu-id="8584b-189">Om hello fel är en tidsgräns för servern, kommer hello klienten ha toowait för hello timeout tooexpire innan den får ett återförsökbart fel från hello-tjänsten.</span><span class="sxs-lookup"><span data-stu-id="8584b-189">If hello error is a server timeout, then hello client will have toowait for hello timeout tooexpire before it receives a retryable error from hello service.</span></span>

<span data-ttu-id="8584b-190">Det finns två scenarier tooconsider när du bestämmer hur toorespond tooa återförsökbart fel:</span><span class="sxs-lookup"><span data-stu-id="8584b-190">There are basically two scenarios tooconsider when you are deciding how toorespond tooa retryable error:</span></span>

*   <span data-ttu-id="8584b-191">Det här är en isolerad problem och primär slutpunkt för efterföljande förfrågningar toohello kommer inte att returnera ett återförsökbart fel inträffade.</span><span class="sxs-lookup"><span data-stu-id="8584b-191">This is an isolated problem and subsequent requests toohello primary endpoint will not return a retryable error.</span></span> <span data-ttu-id="8584b-192">Ett exempel på där detta kan inträffa är när det är ett tillfälligt fel.</span><span class="sxs-lookup"><span data-stu-id="8584b-192">An example of where this might happen is when there is a transient network error.</span></span>

    <span data-ttu-id="8584b-193">I det här scenariot, det finns inga betydande prestandaproblem i med **LocationMode** ställa in också**PrimaryThenSecondary** som det här inträffar bara sällan.</span><span class="sxs-lookup"><span data-stu-id="8584b-193">In this scenario, there is no significant performance penalty in having **LocationMode** set too**PrimaryThenSecondary** as this only happens infrequently.</span></span>

*   <span data-ttu-id="8584b-194">Detta är ett problem med minst en av hello lagringstjänster i hello primär region och alla efterföljande förfrågningar toothat tjänst i hello primära regionen är sannolikt tooreturn återförsökbart fel under en tidsperiod.</span><span class="sxs-lookup"><span data-stu-id="8584b-194">This is a problem with at least one of hello storage services in hello primary region and all subsequent requests toothat service in hello primary region are likely tooreturn retryable errors for a period of time.</span></span> <span data-ttu-id="8584b-195">Ett exempel på detta är om hello primära region inte är helt tillgänglig.</span><span class="sxs-lookup"><span data-stu-id="8584b-195">An example of this is if hello primary region is completely inaccessible.</span></span>

    <span data-ttu-id="8584b-196">I det här scenariot finns det en prestandaförsämring eftersom alla skrivskyddade förfrågningar kommer först försöka hello primära slutpunkt, vänta tills hello timeout tooexpire och sedan växla toohello sekundär slutpunkt.</span><span class="sxs-lookup"><span data-stu-id="8584b-196">In this scenario, there is a performance penalty because all your read requests will try hello primary endpoint first, wait for hello timeout tooexpire, then switch toohello secondary endpoint.</span></span>

<span data-ttu-id="8584b-197">För dessa scenarier kan du identifiera att det är ett pågående problem med hello primära slutpunkt och skicka alla Läs begäranden direkt toohello sekundära slutpunkten genom att ange hello **LocationMode** egenskapen för **SecondaryOnly**.</span><span class="sxs-lookup"><span data-stu-id="8584b-197">For these scenarios, you should identify that there is an ongoing issue with hello primary endpoint and send all read requests directly toohello secondary endpoint by setting hello **LocationMode** property too**SecondaryOnly**.</span></span> <span data-ttu-id="8584b-198">För tillfället bör du också ändra hello programmet toorun i skrivskyddat läge.</span><span class="sxs-lookup"><span data-stu-id="8584b-198">At this time, you should also change hello application toorun in read-only mode.</span></span> <span data-ttu-id="8584b-199">Den här metoden kallas hello [strömbrytare mönster](https://msdn.microsoft.com/library/dn589784.aspx).</span><span class="sxs-lookup"><span data-stu-id="8584b-199">This approach is known as hello [Circuit Breaker Pattern](https://msdn.microsoft.com/library/dn589784.aspx).</span></span>

### <a name="update-requests"></a><span data-ttu-id="8584b-200">Begäranden om att uppdatera</span><span class="sxs-lookup"><span data-stu-id="8584b-200">Update requests</span></span>

<span data-ttu-id="8584b-201">hello strömbrytare mönster kan också vara tillämpade tooupdate begäranden.</span><span class="sxs-lookup"><span data-stu-id="8584b-201">hello Circuit Breaker pattern can also be applied tooupdate requests.</span></span> <span data-ttu-id="8584b-202">Begäranden om att uppdatera måste omdirigerade toosecondary lagringen, vilket är skrivskyddad.</span><span class="sxs-lookup"><span data-stu-id="8584b-202">However, update requests cannot be redirected toosecondary storage, which is read-only.</span></span> <span data-ttu-id="8584b-203">För sådana begäranden, bör du lämna hello **LocationMode** egenskapsuppsättning för**PrimaryOnly** (hello standard).</span><span class="sxs-lookup"><span data-stu-id="8584b-203">For these requests, you should leave hello **LocationMode** property set too**PrimaryOnly** (hello default).</span></span> <span data-ttu-id="8584b-204">toohandle felen, du kan tillämpa en mått toothese begäranden – till exempel 10 fel i en rad – och när din tröskeln uppfylls växla hello program i skrivskyddat läge.</span><span class="sxs-lookup"><span data-stu-id="8584b-204">toohandle these errors, you can apply a metric toothese requests – such as 10 failures in a row – and when your threshold is met, switch hello application into read-only mode.</span></span> <span data-ttu-id="8584b-205">Du kan använda hello samma metoder för att returnera tooupdate läge som de som beskrivs nedan i hello nästa avsnitt om hello strömbrytare mönster.</span><span class="sxs-lookup"><span data-stu-id="8584b-205">You can use hello same methods for returning tooupdate mode as those described below in hello next section about hello Circuit Breaker pattern.</span></span>

## <a name="circuit-breaker-pattern"></a><span data-ttu-id="8584b-206">Mönster för strömbrytare</span><span class="sxs-lookup"><span data-stu-id="8584b-206">Circuit Breaker pattern</span></span>

<span data-ttu-id="8584b-207">Med hjälp av hello strömbrytare mönster i ditt program kan förhindra att den du försöker en åtgärd som är sannolikt toofail upprepade gånger.</span><span class="sxs-lookup"><span data-stu-id="8584b-207">Using hello Circuit Breaker pattern in your application can prevent it from retrying an operation that is likely toofail repeatedly.</span></span> <span data-ttu-id="8584b-208">Det gör hello programmet toocontinue toorun snarare än tar tid medan hello åtgärden försöks exponentiellt.</span><span class="sxs-lookup"><span data-stu-id="8584b-208">It allows hello application toocontinue toorun rather than taking up time while hello operation is retried exponentially.</span></span> <span data-ttu-id="8584b-209">Dessutom upptäcks när hello-fel har åtgärdats där programmet hello kan försöka hello igen.</span><span class="sxs-lookup"><span data-stu-id="8584b-209">It also detects when hello fault has been fixed, at which time hello application can try hello operation again.</span></span>

### <a name="how-tooimplement-hello-circuit-breaker-pattern"></a><span data-ttu-id="8584b-210">Hur tooimplement hello strömbrytare mönster</span><span class="sxs-lookup"><span data-stu-id="8584b-210">How tooimplement hello circuit breaker pattern</span></span>

<span data-ttu-id="8584b-211">tooidentify att det finns en pågående problem med en primär slutpunkt kan du övervaka hur ofta hello klienten påträffar ett återförsökbart fel.</span><span class="sxs-lookup"><span data-stu-id="8584b-211">tooidentify that there is an ongoing problem with a primary endpoint, you can monitor how frequently hello client encounters retryable errors.</span></span> <span data-ttu-id="8584b-212">Eftersom varje fall skiljer sig, har du toodecide på hello tröskelvärde du vill toouse för hello beslut tooswitch toohello sekundär slutpunkt och köra programmet hello i skrivskyddat läge.</span><span class="sxs-lookup"><span data-stu-id="8584b-212">Because each case is different, you have toodecide on hello threshold you want toouse for hello decision tooswitch toohello secondary endpoint and run hello application in read-only mode.</span></span> <span data-ttu-id="8584b-213">Du kan till exempel bestämma tooperform hello växel om det finns 10 fel i en rad med ingen lyckade försök.</span><span class="sxs-lookup"><span data-stu-id="8584b-213">For example, you could decide tooperform hello switch if there are 10 failures in a row with no successes.</span></span> <span data-ttu-id="8584b-214">Ett annat exempel är tooswitch om 90% av hello begäranden under en 2-minutersperiod misslyckas.</span><span class="sxs-lookup"><span data-stu-id="8584b-214">Another example is tooswitch if 90% of hello requests in a 2-minute period fail.</span></span>

<span data-ttu-id="8584b-215">Du kan bara ha ett antal hello fel och om det finns en fungerande innan det nådde hello maximala, Ställ in hello antal tillbaka toozero hello första scenariot.</span><span class="sxs-lookup"><span data-stu-id="8584b-215">For hello first scenario, you can simply keep a count of hello failures, and if there is a success before reaching hello maximum, set hello count back toozero.</span></span> <span data-ttu-id="8584b-216">Hello andra scenariot hello enkelriktade tooimplement är det toouse MemoryCache-objekt (i .NET).</span><span class="sxs-lookup"><span data-stu-id="8584b-216">For hello second scenario, one way tooimplement it is toouse hello MemoryCache object (in .NET).</span></span> <span data-ttu-id="8584b-217">För varje begäran att lägga till en CacheItem toohello cache, ange hello värdet toosuccess (1) eller misslyckas (0) och ange hello Förfallodatum tid too2 minuter från nu (eller vad den tid begränsningen är).</span><span class="sxs-lookup"><span data-stu-id="8584b-217">For each request, add a CacheItem toohello cache, set hello value toosuccess (1) or fail (0), and set hello expiration time too2 minutes from now (or whatever your time constraint is).</span></span> <span data-ttu-id="8584b-218">När en post giltighetstid har uppnåtts, tas hello-posten bort automatiskt.</span><span class="sxs-lookup"><span data-stu-id="8584b-218">When an entry's expiration time is reached, hello entry is automatically removed.</span></span> <span data-ttu-id="8584b-219">Detta ger ett rullande fönster 2 minuter.</span><span class="sxs-lookup"><span data-stu-id="8584b-219">This will give you a rolling 2-minute window.</span></span> <span data-ttu-id="8584b-220">Varje gång du gör en begäran toohello lagringstjänst använda du först en Linq-fråga över hello MemoryCache objektet toocalculate hello procent lyckades genom att summera värdena för hello och dividera med hello antal.</span><span class="sxs-lookup"><span data-stu-id="8584b-220">Each time you make a request toohello storage service, you first use a Linq query across hello MemoryCache object toocalculate hello percent success by summing hello values and dividing by hello count.</span></span> <span data-ttu-id="8584b-221">När hello procent lyckade hamnar under tröskelvärdet för (till exempel 10%), ange hello **LocationMode** -egenskapen för diskläsningsbegäranden för**SecondaryOnly** och växla hello program i skrivskyddat läge innan fortsätter.</span><span class="sxs-lookup"><span data-stu-id="8584b-221">When hello percent success drops below some threshold (such as 10%), set hello **LocationMode** property for read requests too**SecondaryOnly** and switch hello application into read-only mode before continuing.</span></span>

<span data-ttu-id="8584b-222">hello tröskelvärde för fel används toodetermine när toomake hello växeln kan skilja sig från tjänsten tooservice i ditt program, så du bör överväga att göra dem till parametrar.</span><span class="sxs-lookup"><span data-stu-id="8584b-222">hello threshold of errors used toodetermine when toomake hello switch may vary from service tooservice in your application, so you should consider making them configurable parameters.</span></span> <span data-ttu-id="8584b-223">Detta är även om du beslutar toohandle återförsökbart fel från varje service separat eller som en, vilket beskrivs ovan.</span><span class="sxs-lookup"><span data-stu-id="8584b-223">This is also where you decide toohandle retryable errors from each service separately or as one, as discussed previously.</span></span>

<span data-ttu-id="8584b-224">Ett annat övervägande är hur toohandle flera instanser av ett program, och vilka toodo när du identifiera återförsökbart fel i varje instans.</span><span class="sxs-lookup"><span data-stu-id="8584b-224">Another consideration is how toohandle multiple instances of an application, and what toodo when you detect retryable errors in each instance.</span></span> <span data-ttu-id="8584b-225">Du kan till exempel ha 20 virtuella datorer som körs med hello samma program lästes in.</span><span class="sxs-lookup"><span data-stu-id="8584b-225">For example, you may have 20 VMs running with hello same application loaded.</span></span> <span data-ttu-id="8584b-226">Ska du hantera varje instans separat?</span><span class="sxs-lookup"><span data-stu-id="8584b-226">Do you handle each instance separately?</span></span> <span data-ttu-id="8584b-227">Om en instans startar problem, vill du toolimit hello svar toojust som en instans eller vill du tootry toohave alla instanser svara i hello samma sätt när en instans har ett problem?</span><span class="sxs-lookup"><span data-stu-id="8584b-227">If one instance starts having problems, do you want toolimit hello response toojust that one instance, or do you want tootry toohave all instances respond in hello same way when one instance has a problem?</span></span> <span data-ttu-id="8584b-228">Hantera hello instanser separat är mycket enklare än om du försöker toocoordinate hello svar över dem, men hur du gör detta beror på ditt program arkitektur.</span><span class="sxs-lookup"><span data-stu-id="8584b-228">Handling hello instances separately is much simpler than trying toocoordinate hello response across them, but how you do this depends on your application's architecture.</span></span>

### <a name="options-for-monitoring-hello-error-frequency"></a><span data-ttu-id="8584b-229">Alternativ för att övervaka hello frekvens för fel</span><span class="sxs-lookup"><span data-stu-id="8584b-229">Options for monitoring hello error frequency</span></span>

<span data-ttu-id="8584b-230">Det finns tre huvudsakliga alternativ för att övervaka hello frekvensen för återförsök i hello primära region i ordning toodetermine när tooswitch över toohello sekundär region och ändrar hello programmet toorun i skrivskyddat läge.</span><span class="sxs-lookup"><span data-stu-id="8584b-230">You have three main options for monitoring hello frequency of retries in hello primary region in order toodetermine when tooswitch over toohello secondary region and change hello application toorun in read-only mode.</span></span>

*   <span data-ttu-id="8584b-231">Lägger till en hanterare för hello [ **försöker på nytt** ](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.retrying.aspx) händelse på hello [ **OperationContext** ](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.aspx) objekt du skickar begäranden för lagring av tooyour – detta är hello metoden visas i den här artikeln och används i hello tillhörande exempel.</span><span class="sxs-lookup"><span data-stu-id="8584b-231">Add a handler for hello [**Retrying**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.retrying.aspx) event on hello [**OperationContext**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.aspx) object you pass tooyour storage requests – this is hello method displayed in this article and used in hello accompanying sample.</span></span> <span data-ttu-id="8584b-232">Dessa händelser eller när hello klientens en begäran, vilket gör att du tootrack hur ofta hello klienten påträffar återförsökbart fel på en primär slutpunkt.</span><span class="sxs-lookup"><span data-stu-id="8584b-232">These events fire whenever hello client retries a request, enabling you tootrack how often hello client encounters retryable errors on a primary endpoint.</span></span>

    ```csharp 
    operationContext.Retrying += (sender, arguments) =>
    {
        // Retrying in hello primary region
        if (arguments.Request.Host == primaryhostname)
            ...
    };
    ```

*   <span data-ttu-id="8584b-233">I hello [ **Evaluate** ](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.retrypolicies.iextendedretrypolicy.evaluate.aspx) metod i en egen återförsöksprincip du kan köra anpassad kod när ett nytt försök görs.</span><span class="sxs-lookup"><span data-stu-id="8584b-233">In hello [**Evaluate**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.retrypolicies.iextendedretrypolicy.evaluate.aspx) method in a custom retry policy, you can run custom code whenever a retry takes place.</span></span> <span data-ttu-id="8584b-234">I tillägg toorecording när ett nytt försök sker detta också ger du hello möjlighet toomodify retry-beteende.</span><span class="sxs-lookup"><span data-stu-id="8584b-234">In addition toorecording when a retry happens, this also gives you hello opportunity toomodify your retry behavior.</span></span>

    ```csharp 
    public RetryInfo Evaluate(RetryContext retryContext,
    OperationContext operationContext)
    {
        var statusCode = retryContext.LastRequestResult.HttpStatusCode;
        if (retryContext.CurrentRetryCount >= this.maximumAttempts
        || ((statusCode &gt;= 300 && statusCode &lt; 500 && statusCode != 408)
        || statusCode == 501 // Not Implemented
        || statusCode == 505 // Version Not Supported
            ))
        {
        // Do not retry
            return null;
        }

        // Monitor retries in hello primary location
        ...

        // Determine RetryInterval and TargetLocation
        RetryInfo info =
            CreateRetryInfo(retryContext.CurrentRetryCount);

        return info;
    }
    ```

*   <span data-ttu-id="8584b-235">hello tredje sätt är tooimplement en anpassad övervakning komponent i ditt program som pingar kontinuerligt primära lagringsplatsen slutpunkten med dummy läsa begäranden (till exempel läsa en liten blob) toodetermine dess hälsa.</span><span class="sxs-lookup"><span data-stu-id="8584b-235">hello third approach is tooimplement a custom monitoring component in your application that continually pings your primary storage endpoint with dummy read requests (such as reading a small blob) toodetermine its health.</span></span> <span data-ttu-id="8584b-236">Detta kan ta några resurser, men inte mycket.</span><span class="sxs-lookup"><span data-stu-id="8584b-236">This would take up some resources, but not a significant amount.</span></span> <span data-ttu-id="8584b-237">När ett problem har identifierats som når din tröskelvärde kan du sedan utför hello växeln för**SecondaryOnly** och skrivskyddat läge.</span><span class="sxs-lookup"><span data-stu-id="8584b-237">When a problem is discovered that reaches your threshold, you would then perform hello switch too**SecondaryOnly** and read-only mode.</span></span>

<span data-ttu-id="8584b-238">Vid något tillfälle vill tooswitch tillbaka toousing hello primära slutpunkt och tillåta uppdateringar.</span><span class="sxs-lookup"><span data-stu-id="8584b-238">At some point, you will want tooswitch back toousing hello primary endpoint and allowing updates.</span></span> <span data-ttu-id="8584b-239">Om du använder en av hello första två metoderna ovan kan du helt enkelt växla tillbaka toohello primära slutpunkt och aktivera uppdateringsläge när ett godtyckligt valda tid eller antal åtgärder har utförts.</span><span class="sxs-lookup"><span data-stu-id="8584b-239">If using one of hello first two methods listed above, you could simply switch back toohello primary endpoint and enable update mode after an arbitrarily selected amount of time or number of operations has been performed.</span></span> <span data-ttu-id="8584b-240">Sedan kan du låta den gå igenom hello logik igen.</span><span class="sxs-lookup"><span data-stu-id="8584b-240">You can then let it go through hello retry logic again.</span></span> <span data-ttu-id="8584b-241">Om hello problemet har åtgärdats, den fortsätta toouse hello primära slutpunkt och tillåta uppdateringar.</span><span class="sxs-lookup"><span data-stu-id="8584b-241">If hello problem has been fixed, it will continue toouse hello primary endpoint and allow updates.</span></span> <span data-ttu-id="8584b-242">Om det finns fortfarande ett problem, växlar en gång tillbaka toohello sekundär slutpunkt och skrivskyddat läge efter misslyckade hello kriterier som du har ställt in.</span><span class="sxs-lookup"><span data-stu-id="8584b-242">If there is still a problem, it will once more switch back toohello secondary endpoint and read-only mode after failing hello criteria you've set.</span></span>

<span data-ttu-id="8584b-243">Hello tredje scenariot när pinga hello primära lagringsplatsen endpoint blir lyckade igen, du kan utlösa hello växla tillbaka för**PrimaryOnly** och fortsätta att tillåta uppdateringar.</span><span class="sxs-lookup"><span data-stu-id="8584b-243">For hello third scenario, when pinging hello primary storage endpoint becomes successful again, you can trigger hello switch back too**PrimaryOnly** and continue allowing updates.</span></span>

## <a name="handling-eventually-consistent-data"></a><span data-ttu-id="8584b-244">Hantering av överensstämmelse data</span><span class="sxs-lookup"><span data-stu-id="8584b-244">Handling eventually consistent data</span></span>

<span data-ttu-id="8584b-245">RA-GRS fungerar genom att replikera transaktioner från hello primära toohello sekundär region.</span><span class="sxs-lookup"><span data-stu-id="8584b-245">RA-GRS works by replicating transactions from hello primary toohello secondary region.</span></span> <span data-ttu-id="8584b-246">Den här replikeringen garanterar att hello data i hello sekundära regionen är *överensstämmelse*.</span><span class="sxs-lookup"><span data-stu-id="8584b-246">This replication process guarantees that hello data in hello secondary region is *eventually consistent*.</span></span> <span data-ttu-id="8584b-247">Detta innebär att alla hello transaktioner i hello primär region så småningom kommer att visas i hello sekundär region, utan att det kan finnas en fördröjning innan de kan visas och att det är inte säkert hello transaktioner tas emot i hello sekundär region i samma ordning som hello som som de ursprungligen tillämpades i hello primära region.</span><span class="sxs-lookup"><span data-stu-id="8584b-247">This means that all hello transactions in hello primary region will eventually appear in hello secondary region, but that there may be a lag before they appear, and that there is no guarantee hello transactions arrive in hello secondary region in hello same order as that in which they were originally applied in hello primary region.</span></span> <span data-ttu-id="8584b-248">Om transaktionerna kommer till hello sekundär region utanför måste du *kan* Överväg att dina data i hello sekundär region toobe i ett inkonsekvent tillstånd tills hello service fångar.</span><span class="sxs-lookup"><span data-stu-id="8584b-248">If your transactions arrive in hello secondary region out of order, you *may* consider your data in hello secondary region toobe in an inconsistent state until hello service catches up.</span></span>

<span data-ttu-id="8584b-249">hello nedan visas ett exempel på vad som händer när du uppdaterar hello information om en medarbetare toomake hon medlem i hello *administratörer* roll.</span><span class="sxs-lookup"><span data-stu-id="8584b-249">hello following table shows an example of what might happen when you update hello details of an employee toomake her a member of hello *administrators* role.</span></span> <span data-ttu-id="8584b-250">För hello ut för det här exemplet detta kräver att du uppdaterar hello **medarbetare** entiteten och uppdatera en **administratörsroll** entitet med ett antal hello totala antalet administratörer.</span><span class="sxs-lookup"><span data-stu-id="8584b-250">For hello sake of this example, this requires you update hello **employee** entity and update an **administrator role** entity with a count of hello total number of administrators.</span></span> <span data-ttu-id="8584b-251">Observera hur hello uppdateringar tillämpas i ordning i hello sekundär region.</span><span class="sxs-lookup"><span data-stu-id="8584b-251">Notice how hello updates are applied out of order in hello secondary region.</span></span>

| <span data-ttu-id="8584b-252">**Tid**</span><span class="sxs-lookup"><span data-stu-id="8584b-252">**Time**</span></span> | <span data-ttu-id="8584b-253">**Transaktionen**</span><span class="sxs-lookup"><span data-stu-id="8584b-253">**Transaction**</span></span>                                            | <span data-ttu-id="8584b-254">**Replikering**</span><span class="sxs-lookup"><span data-stu-id="8584b-254">**Replication**</span></span>                       | <span data-ttu-id="8584b-255">**Tid för senaste synkronisering**</span><span class="sxs-lookup"><span data-stu-id="8584b-255">**Last Sync Time**</span></span> | <span data-ttu-id="8584b-256">**Resultat**</span><span class="sxs-lookup"><span data-stu-id="8584b-256">**Result**</span></span> |
|----------|------------------------------------------------------------|---------------------------------------|--------------------|------------| 
| <span data-ttu-id="8584b-257">T0</span><span class="sxs-lookup"><span data-stu-id="8584b-257">T0</span></span>       | <span data-ttu-id="8584b-258">Transaktionen A:</span><span class="sxs-lookup"><span data-stu-id="8584b-258">Transaction A:</span></span> <br> <span data-ttu-id="8584b-259">Infoga medarbetare</span><span class="sxs-lookup"><span data-stu-id="8584b-259">Insert employee</span></span> <br> <span data-ttu-id="8584b-260">entiteten i primär</span><span class="sxs-lookup"><span data-stu-id="8584b-260">entity in primary</span></span> |                                   |                    | <span data-ttu-id="8584b-261">Transaktionen A infogas tooprimary</span><span class="sxs-lookup"><span data-stu-id="8584b-261">Transaction A inserted tooprimary,</span></span><br> <span data-ttu-id="8584b-262">replikeras inte ännu.</span><span class="sxs-lookup"><span data-stu-id="8584b-262">not replicated yet.</span></span> |
| <span data-ttu-id="8584b-263">T1</span><span class="sxs-lookup"><span data-stu-id="8584b-263">T1</span></span>       |                                                            | <span data-ttu-id="8584b-264">Transaktionen A</span><span class="sxs-lookup"><span data-stu-id="8584b-264">Transaction A</span></span> <br> <span data-ttu-id="8584b-265">replikeras till</span><span class="sxs-lookup"><span data-stu-id="8584b-265">replicated to</span></span><br> <span data-ttu-id="8584b-266">sekundär</span><span class="sxs-lookup"><span data-stu-id="8584b-266">secondary</span></span> | <span data-ttu-id="8584b-267">T1</span><span class="sxs-lookup"><span data-stu-id="8584b-267">T1</span></span> | <span data-ttu-id="8584b-268">Transaktionen A replikerade toosecondary.</span><span class="sxs-lookup"><span data-stu-id="8584b-268">Transaction A replicated toosecondary.</span></span> <br><span data-ttu-id="8584b-269">Synkronisera senast uppdaterat.</span><span class="sxs-lookup"><span data-stu-id="8584b-269">Last Sync Time updated.</span></span>    |
| <span data-ttu-id="8584b-270">T2</span><span class="sxs-lookup"><span data-stu-id="8584b-270">T2</span></span>       | <span data-ttu-id="8584b-271">Transaktionen B:</span><span class="sxs-lookup"><span data-stu-id="8584b-271">Transaction B:</span></span><br><span data-ttu-id="8584b-272">Uppdatering</span><span class="sxs-lookup"><span data-stu-id="8584b-272">Update</span></span><br> <span data-ttu-id="8584b-273">medarbetare entitet</span><span class="sxs-lookup"><span data-stu-id="8584b-273">employee entity</span></span><br> <span data-ttu-id="8584b-274">i primära</span><span class="sxs-lookup"><span data-stu-id="8584b-274">in primary</span></span>  |                                | <span data-ttu-id="8584b-275">T1</span><span class="sxs-lookup"><span data-stu-id="8584b-275">T1</span></span>                 | <span data-ttu-id="8584b-276">Transaktionen skrivs tooprimary, B</span><span class="sxs-lookup"><span data-stu-id="8584b-276">Transaction B written tooprimary,</span></span><br> <span data-ttu-id="8584b-277">replikeras inte ännu.</span><span class="sxs-lookup"><span data-stu-id="8584b-277">not replicated yet.</span></span>  |
| <span data-ttu-id="8584b-278">T3</span><span class="sxs-lookup"><span data-stu-id="8584b-278">T3</span></span>       | <span data-ttu-id="8584b-279">Transaktionen C:</span><span class="sxs-lookup"><span data-stu-id="8584b-279">Transaction C:</span></span><br> <span data-ttu-id="8584b-280">Uppdatering</span><span class="sxs-lookup"><span data-stu-id="8584b-280">Update</span></span> <br><span data-ttu-id="8584b-281">Administratören</span><span class="sxs-lookup"><span data-stu-id="8584b-281">administrator</span></span><br><span data-ttu-id="8584b-282">rollentiteten i</span><span class="sxs-lookup"><span data-stu-id="8584b-282">role entity in</span></span><br><span data-ttu-id="8584b-283">primär</span><span class="sxs-lookup"><span data-stu-id="8584b-283">primary</span></span> |                    | <span data-ttu-id="8584b-284">T1</span><span class="sxs-lookup"><span data-stu-id="8584b-284">T1</span></span>                 | <span data-ttu-id="8584b-285">Transaktionen skrivs tooprimary, C</span><span class="sxs-lookup"><span data-stu-id="8584b-285">Transaction C written tooprimary,</span></span><br> <span data-ttu-id="8584b-286">replikeras inte ännu.</span><span class="sxs-lookup"><span data-stu-id="8584b-286">not replicated yet.</span></span>  |
| <span data-ttu-id="8584b-287">*T4*</span><span class="sxs-lookup"><span data-stu-id="8584b-287">*T4*</span></span>     |                                                       | <span data-ttu-id="8584b-288">Transaktionen C</span><span class="sxs-lookup"><span data-stu-id="8584b-288">Transaction C</span></span> <br><span data-ttu-id="8584b-289">replikeras till</span><span class="sxs-lookup"><span data-stu-id="8584b-289">replicated to</span></span><br> <span data-ttu-id="8584b-290">sekundär</span><span class="sxs-lookup"><span data-stu-id="8584b-290">secondary</span></span> | <span data-ttu-id="8584b-291">T1</span><span class="sxs-lookup"><span data-stu-id="8584b-291">T1</span></span>         | <span data-ttu-id="8584b-292">Transaktionen C replikerade toosecondary.</span><span class="sxs-lookup"><span data-stu-id="8584b-292">Transaction C replicated toosecondary.</span></span><br><span data-ttu-id="8584b-293">LastSyncTime inte uppdateras eftersom</span><span class="sxs-lookup"><span data-stu-id="8584b-293">LastSyncTime not updated because</span></span> <br><span data-ttu-id="8584b-294">transaktionen B har ännu inte replikerats.</span><span class="sxs-lookup"><span data-stu-id="8584b-294">transaction B has not been replicated yet.</span></span>|
| <span data-ttu-id="8584b-295">*T5*</span><span class="sxs-lookup"><span data-stu-id="8584b-295">*T5*</span></span>     | <span data-ttu-id="8584b-296">Läs entiteter</span><span class="sxs-lookup"><span data-stu-id="8584b-296">Read entities</span></span> <br><span data-ttu-id="8584b-297">från sekundär</span><span class="sxs-lookup"><span data-stu-id="8584b-297">from secondary</span></span>                           |                                  | <span data-ttu-id="8584b-298">T1</span><span class="sxs-lookup"><span data-stu-id="8584b-298">T1</span></span>                 | <span data-ttu-id="8584b-299">Du får hello inaktuella värdet för medarbetare</span><span class="sxs-lookup"><span data-stu-id="8584b-299">You get hello stale value for employee</span></span> <br> <span data-ttu-id="8584b-300">entiteten eftersom transaktionen B har inte</span><span class="sxs-lookup"><span data-stu-id="8584b-300">entity because transaction B hasn't</span></span> <br> <span data-ttu-id="8584b-301">replikerade ännu.</span><span class="sxs-lookup"><span data-stu-id="8584b-301">replicated yet.</span></span> <span data-ttu-id="8584b-302">Du får hello nytt värde för</span><span class="sxs-lookup"><span data-stu-id="8584b-302">You get hello new value for</span></span><br> <span data-ttu-id="8584b-303">administratören rollentiteten eftersom C har</span><span class="sxs-lookup"><span data-stu-id="8584b-303">administrator role entity because C has</span></span><br> <span data-ttu-id="8584b-304">replikeras.</span><span class="sxs-lookup"><span data-stu-id="8584b-304">replicated.</span></span> <span data-ttu-id="8584b-305">Tid för senaste synkronisering har fortfarande inte</span><span class="sxs-lookup"><span data-stu-id="8584b-305">Last Sync Time still hasn't</span></span><br> <span data-ttu-id="8584b-306">har uppdaterats eftersom transaktionen B</span><span class="sxs-lookup"><span data-stu-id="8584b-306">been updated because transaction B</span></span><br> <span data-ttu-id="8584b-307">har inte replikeras.</span><span class="sxs-lookup"><span data-stu-id="8584b-307">hasn't replicated.</span></span> <span data-ttu-id="8584b-308">Du kan se den</span><span class="sxs-lookup"><span data-stu-id="8584b-308">You can tell the</span></span><br><span data-ttu-id="8584b-309">administratören rollentiteten är inkonsekvent</span><span class="sxs-lookup"><span data-stu-id="8584b-309">administrator role entity is inconsistent</span></span> <br><span data-ttu-id="8584b-310">eftersom hello entitet datum/tid är efter</span><span class="sxs-lookup"><span data-stu-id="8584b-310">because hello entity date/time is after</span></span> <br><span data-ttu-id="8584b-311">hello tid för senaste synkronisering.</span><span class="sxs-lookup"><span data-stu-id="8584b-311">hello Last Sync Time.</span></span> |
| <span data-ttu-id="8584b-312">*T6*</span><span class="sxs-lookup"><span data-stu-id="8584b-312">*T6*</span></span>     |                                                      | <span data-ttu-id="8584b-313">Transaktionen B</span><span class="sxs-lookup"><span data-stu-id="8584b-313">Transaction B</span></span><br> <span data-ttu-id="8584b-314">replikeras till</span><span class="sxs-lookup"><span data-stu-id="8584b-314">replicated to</span></span><br> <span data-ttu-id="8584b-315">sekundär</span><span class="sxs-lookup"><span data-stu-id="8584b-315">secondary</span></span> | <span data-ttu-id="8584b-316">T6</span><span class="sxs-lookup"><span data-stu-id="8584b-316">T6</span></span>                 | <span data-ttu-id="8584b-317">*T6* – alla transaktioner via C har</span><span class="sxs-lookup"><span data-stu-id="8584b-317">*T6* – All transactions through C have</span></span> <br><span data-ttu-id="8584b-318">har replikerats tid för senaste synkronisering</span><span class="sxs-lookup"><span data-stu-id="8584b-318">been replicated, Last Sync Time</span></span><br> <span data-ttu-id="8584b-319">har uppdaterats.</span><span class="sxs-lookup"><span data-stu-id="8584b-319">is updated.</span></span> |

<span data-ttu-id="8584b-320">I det här exemplet förutsätter att hello klienten växlar tooreading från hello sekundär region på T5.</span><span class="sxs-lookup"><span data-stu-id="8584b-320">In this example, assume hello client switches tooreading from hello secondary region at T5.</span></span> <span data-ttu-id="8584b-321">Det kan läsa hello **administratörsroll** entitet just nu, men hello entiteten innehåller ett värde för hello antalet administratörer som inte är konsekvent med hello antalet **medarbetare** entiteter som är markerade som administratörer i hello sekundär region just nu.</span><span class="sxs-lookup"><span data-stu-id="8584b-321">It can successfully read hello **administrator role** entity at this time, but hello entity contains a value for hello count of administrators that is not consistent with hello number of **employee** entities that are marked as administrators in hello secondary region at this time.</span></span> <span data-ttu-id="8584b-322">Klienten kan bara visa det här värdet med hello risk att den är inkonsekvent information.</span><span class="sxs-lookup"><span data-stu-id="8584b-322">Your client could simply display this value, with hello risk that it is inconsistent information.</span></span> <span data-ttu-id="8584b-323">Alternativt hello kunde försöker klienten toodetermine som hello **administratörsroll** är i ett eventuellt inkonsekvent tillstånd eftersom hello uppdateringar har hänt fel ordning och informera hello användaren om detta.</span><span class="sxs-lookup"><span data-stu-id="8584b-323">Alternatively, hello client could attempt toodetermine that hello **administrator role** is in a potentially inconsistent state because hello updates have happened out of order, and then inform hello user of this fact.</span></span>

<span data-ttu-id="8584b-324">toorecognize att det finns potentiellt inkonsekventa data, hello klienten kan använda hello värdet för hello *tid för senaste synkronisering* att du kan få när som helst genom att fråga en storage-tjänst.</span><span class="sxs-lookup"><span data-stu-id="8584b-324">toorecognize that it has potentially inconsistent data, hello client can use hello value of hello *Last Sync Time* that you can get at any time by querying a storage service.</span></span> <span data-ttu-id="8584b-325">Detta visar hello tid då hello data i hello sekundär region senast konsekvent och när hello-tjänsten hade tillämpas alla hello transaktioner tidigare toothat punkt i tiden.</span><span class="sxs-lookup"><span data-stu-id="8584b-325">This tells you hello time when hello data in hello secondary region was last consistent and when hello service had applied all hello transactions prior toothat point in time.</span></span> <span data-ttu-id="8584b-326">I hello-exemplet ovan när hello tjänsten infogar hello **medarbetare** entiteten i hello sekundär region hello tid för senaste synkronisering har angetts för*T1*.</span><span class="sxs-lookup"><span data-stu-id="8584b-326">In hello example shown above, after hello service inserts hello **employee** entity in hello secondary region, hello last sync time is set too*T1*.</span></span> <span data-ttu-id="8584b-327">Det förblir *T1* tills hello uppdateras hello **medarbetare** entiteten i hello sekundär region när den är inställd för*T6*.</span><span class="sxs-lookup"><span data-stu-id="8584b-327">It remains at *T1* until hello service updates hello **employee** entity in hello secondary region when it is set too*T6*.</span></span> <span data-ttu-id="8584b-328">Om hello klienten hämtar hello tid för senaste synkronisering när det läser hello-entiteten vid *T5*, den kan jämföra den mot hello tidsstämpeln på hello entitet.</span><span class="sxs-lookup"><span data-stu-id="8584b-328">If hello client retrieves hello last sync time when it reads hello entity at *T5*, it can compare it with hello timestamp on hello entity.</span></span> <span data-ttu-id="8584b-329">Om hello tidstämpel för hello entiteten är senare än hello tid för senaste synkronisering och sedan hello målentiteten är i ett eventuellt inkonsekvent tillstånd och du kan ta allt är hello lämplig åtgärd för programmet.</span><span class="sxs-lookup"><span data-stu-id="8584b-329">If hello timestamp on hello entity is later than hello last sync time, then hello entity is in a potentially inconsistent state, and you can take whatever is hello appropriate action for your application.</span></span> <span data-ttu-id="8584b-330">Det här fältet kräver att du vet när hello senaste uppdatering toohello primära slutfördes.</span><span class="sxs-lookup"><span data-stu-id="8584b-330">Using this field requires that you know when hello last update toohello primary was completed.</span></span>

## <a name="testing"></a><span data-ttu-id="8584b-331">Testning</span><span class="sxs-lookup"><span data-stu-id="8584b-331">Testing</span></span>

<span data-ttu-id="8584b-332">Det är viktigt tootest som programmet fungerar som förväntat när återförsökbart fel påträffas.</span><span class="sxs-lookup"><span data-stu-id="8584b-332">It's important tootest that your application behaves as expected when it encounters retryable errors.</span></span> <span data-ttu-id="8584b-333">Till exempel behöver du tootest som hello programmet växlar toohello sekundära och i skrivskyddat läge när ett problem upptäcks och växlar tillbaka när hello primär region blir tillgänglig igen.</span><span class="sxs-lookup"><span data-stu-id="8584b-333">For example, you need tootest that hello application switches toohello secondary and into read-only mode when it detects a problem, and switches back when hello primary region becomes available again.</span></span> <span data-ttu-id="8584b-334">toodo, du behöver ett sätt toosimulate återförsökbart fel och styra hur ofta de inträffar.</span><span class="sxs-lookup"><span data-stu-id="8584b-334">toodo this, you need a way toosimulate retryable errors and control how often they occur.</span></span>

<span data-ttu-id="8584b-335">Du kan använda [Fiddler](http://www.telerik.com/fiddler) toointercept och ändra HTTP-svar i ett skript.</span><span class="sxs-lookup"><span data-stu-id="8584b-335">You can use [Fiddler](http://www.telerik.com/fiddler) toointercept and modify HTTP responses in a script.</span></span> <span data-ttu-id="8584b-336">Det här skriptet kan identifiera svar som kommer från din primära slutpunkt och ändra hello HTTP-status kod tooone som hello Storage-klientbibliotek känner igen som ett återförsökbart fel inträffade.</span><span class="sxs-lookup"><span data-stu-id="8584b-336">This script can identify responses that come from your primary endpoint and change hello HTTP status code tooone that hello Storage Client Library recognizes as a retryable error.</span></span> <span data-ttu-id="8584b-337">Det här kodstycket visar ett enkelt exempel på ett Fiddler skript som fångar upp svar tooread förfrågningar mot hello **employeedata** tabell tooreturn status 502:</span><span class="sxs-lookup"><span data-stu-id="8584b-337">This code snippet shows a simple example of a Fiddler script that intercepts responses tooread requests against hello **employeedata** table tooreturn a 502 status:</span></span>

```java
static function OnBeforeResponse(oSession: Session) {
    ...
    if ((oSession.hostname == "\[yourstorageaccount\].table.core.windows.net")
      && (oSession.PathAndQuery.StartsWith("/employeedata?$filter"))) {
        oSession.responseCode = 502;
    }
}
```

<span data-ttu-id="8584b-338">Du kan utöka ett brett spektrum av begäranden för det här exemplet toointercept och bara ändra hello **responseCode** på några av dem toobetter simulera ett verkligt scenario.</span><span class="sxs-lookup"><span data-stu-id="8584b-338">You could extend this example toointercept a wider range of requests and only change hello **responseCode** on some of them toobetter simulate a real-world scenario.</span></span> <span data-ttu-id="8584b-339">Mer information om hur du anpassar Fiddler skript finns [ändra en begäran eller ett svar](http://docs.telerik.com/fiddler/KnowledgeBase/FiddlerScript/ModifyRequestOrResponse) i hello Fiddler dokumentation.</span><span class="sxs-lookup"><span data-stu-id="8584b-339">For more information about customizing Fiddler scripts, see [Modifying a Request or Response](http://docs.telerik.com/fiddler/KnowledgeBase/FiddlerScript/ModifyRequestOrResponse) in hello Fiddler documentation.</span></span>

<span data-ttu-id="8584b-340">Om du har gjort hello tröskelvärden för växling av ditt program tooread läget endast konfigurerbara blir enklare tootest hello fungerar med icke-produktion transaktionsvolymer.</span><span class="sxs-lookup"><span data-stu-id="8584b-340">If you have made hello thresholds for switching your application tooread-only mode configurable, it will be easier tootest hello behavior with non-production transaction volumes.</span></span>

## <a name="next-steps"></a><span data-ttu-id="8584b-341">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="8584b-341">Next Steps</span></span>

* <span data-ttu-id="8584b-342">Mer information om läsbehörighet Geo-redundans, inklusive ett annat exempel på hur hello LastSyncTime ställs finns [Windows Azure-lagringsalternativ redundans och Geo-Redundant lagring med läsbehörighet](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/).</span><span class="sxs-lookup"><span data-stu-id="8584b-342">For more information about Read Access Geo-Redundancy, including another example of how hello LastSyncTime is set, please see [Windows Azure Storage Redundancy Options and Read Access Geo Redundant Storage](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/).</span></span>

* <span data-ttu-id="8584b-343">Ett fullständigt exempel som visar hur toomake hello växla fram och tillbaka mellan hello primära och sekundära slutpunkter, se [Azure exempel – som använder hello strömbrytare mönster med RA-GRS lagring](https://github.com/Azure-Samples/storage-dotnet-circuit-breaker-pattern-ha-apps-using-ra-grs).</span><span class="sxs-lookup"><span data-stu-id="8584b-343">For a complete sample showing how toomake hello switch back and forth between hello Primary and Secondary endpoints, please see [Azure Samples – Using hello Circuit Breaker Pattern with RA-GRS storage](https://github.com/Azure-Samples/storage-dotnet-circuit-breaker-pattern-ha-apps-using-ra-grs).</span></span>
