---
title: "Hur du använder Azure API Management med virtuella nätverk"
description: "Lär dig mer om att skapa en anslutning till ett virtuellt nätverk i Azure API Management och åtkomst till webbtjänster genom den."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 268cee739188d81feffc36ac07fcdfa18ff95a4d
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a><span data-ttu-id="c9278-103">Hur du använder Azure API Management med virtuella nätverk</span><span class="sxs-lookup"><span data-stu-id="c9278-103">How to use Azure API Management with virtual networks</span></span>
<span data-ttu-id="c9278-104">Virtuella Azure-nätverk (Vnet) kan du placera någon av dina Azure-resurser i ett routeable-internet-nätverk som du styr åtkomst till.</span><span class="sxs-lookup"><span data-stu-id="c9278-104">Azure Virtual Networks (VNETs) allow you to place any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="c9278-105">Dessa nätverk kan sedan vara ansluten till ditt lokala nätverk med olika VPN-teknologier.</span><span class="sxs-lookup"><span data-stu-id="c9278-105">These networks can then be connected to your on-premises networks using various VPN technologies.</span></span> <span data-ttu-id="c9278-106">Läs mer om Azure Virtual Networks startar med den här informationen: [Azure översikt över virtuella nätverk](../virtual-network/virtual-networks-overview.md).</span><span class="sxs-lookup"><span data-stu-id="c9278-106">To learn more about Azure Virtual Networks start with the information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="c9278-107">Azure API Management kan distribueras i det virtuella nätverket (VNET), så att den har åtkomst till backend-tjänster i nätverket.</span><span class="sxs-lookup"><span data-stu-id="c9278-107">Azure API Management can be deployed inside the virtual network (VNET), so it can access backend services within the network.</span></span> <span data-ttu-id="c9278-108">Developer-portalen och API-gateway kan konfigureras för att vara tillgänglig från Internet eller i det virtuella nätverket.</span><span class="sxs-lookup"><span data-stu-id="c9278-108">The developer portal and API gateway, can be configured to be accessible either from the Internet or only within the virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="c9278-109">Azure API Management stöder både klassiska och Azure Resource Manager Vnet.</span><span class="sxs-lookup"><span data-stu-id="c9278-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="c9278-110"><a name="enable-vpn"></a>Aktivera VNET-anslutning</span><span class="sxs-lookup"><span data-stu-id="c9278-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="c9278-111">Virtuella nätverk är tillgängliga i den **Premium** och **Developer** nivåer.</span><span class="sxs-lookup"><span data-stu-id="c9278-111">VNET connectivity is available in the **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="c9278-112">Om du vill växla mellan nivåer, öppna API Management-tjänsten i Azure-portalen och sedan öppna den **skala och prissättning** fliken. Under den **prisnivå** väljer Premium eller utvecklare nivån och klicka på Spara.</span><span class="sxs-lookup"><span data-stu-id="c9278-112">To switch between the tiers, open your API Management service in the Azure portal and then open the **Scale and pricing** tab. Under the **Pricing tier** section, select the Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="c9278-113">Om du vill aktivera VNET-anslutningen, öppna API Management-tjänsten i Azure portal och öppna den **för virtuella nätverk** sidan.</span><span class="sxs-lookup"><span data-stu-id="c9278-113">To enable VNET connectivity, open your API Management service in the Azure portal and open the **Virtual network** page.</span></span>

![Virtuellt nätverk-menyn i API Management][api-management-using-vnet-menu]

<span data-ttu-id="c9278-115">Välj typ av åtkomst:</span><span class="sxs-lookup"><span data-stu-id="c9278-115">Select the desired access type:</span></span>

* <span data-ttu-id="c9278-116">**Externa**: API Management gateway och developer portal är tillgänglig från internet via en extern belastningsutjämnare.</span><span class="sxs-lookup"><span data-stu-id="c9278-116">**External**: the API Management gateway and developer portal are accessible from the public internet via an external load balancer.</span></span> <span data-ttu-id="c9278-117">Gatewayen kan komma åt resurser i det virtuella nätverket.</span><span class="sxs-lookup"><span data-stu-id="c9278-117">The gateway can access resources within the virtual network.</span></span>

![Offentlig peering][api-management-vnet-public]

* <span data-ttu-id="c9278-119">**Internt**: API Management gateway och developer portal är enbart tillgänglig från det virtuella nätverket via en intern belastningsutjämnare.</span><span class="sxs-lookup"><span data-stu-id="c9278-119">**Internal**: the API Management gateway and developer portal are accessible only from within the virtual network via an internal load balancer.</span></span> <span data-ttu-id="c9278-120">Gatewayen kan komma åt resurser i det virtuella nätverket.</span><span class="sxs-lookup"><span data-stu-id="c9278-120">The gateway can access resources within the virtual network.</span></span>

![Privat peering][api-management-vnet-private]

<span data-ttu-id="c9278-122">Nu visas en lista över alla regioner där API Management-tjänsten har etablerats.</span><span class="sxs-lookup"><span data-stu-id="c9278-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="c9278-123">Välj en VNET och undernät för varje region.</span><span class="sxs-lookup"><span data-stu-id="c9278-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="c9278-124">I listan fylls med både klassiska och Resource Manager virtuella nätverk som är tillgängliga i din Azure-prenumerationer som har konfigurerats i den region som du konfigurerar.</span><span class="sxs-lookup"><span data-stu-id="c9278-124">The list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in the region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="c9278-125">**Tjänstslutpunkten** i ovanstående diagram innehåller Gateway-proxyn, Publisher Portal, Developer-portalen, GIT och direkt hantering av slutpunkten.</span><span class="sxs-lookup"><span data-stu-id="c9278-125">**Service Endpoint** in the above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and the Direct Management Endpoint.</span></span>
> <span data-ttu-id="c9278-126">**Hanteringsslutpunkten** i ovanstående diagram är den slutpunkt som värd för tjänsten för att hantera konfiguration via Azure portal och Powershell.</span><span class="sxs-lookup"><span data-stu-id="c9278-126">**Management Endpoint** in the above diagram is the endpoint hosted on the service to manage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="c9278-127">Tänk också på, att, även om diagrammet visar IP-adresser för olika, API Management-tjänsten **endast** svarar på dess konfigurerade värdnamn.</span><span class="sxs-lookup"><span data-stu-id="c9278-127">Also, note, that, even though, the diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c9278-128">När du distribuerar en Azure API Management-instans till en Resource Manager-VNET, måste tjänsten vara i ett dedikerat undernät som innehåller några resurser förutom Azure API Management-instanser.</span><span class="sxs-lookup"><span data-stu-id="c9278-128">When deploying an Azure API Management instance to a Resource Manager VNET, the service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="c9278-129">Om ett försök görs att distribuera en Azure API Management-instans till en Resource Manager VNET-undernät som innehåller andra resurser, distributionen misslyckas.</span><span class="sxs-lookup"><span data-stu-id="c9278-129">If an attempt is made to deploy an Azure API Management instance to a Resource Manager VNET subnet that contains other resources, the deployment will fail.</span></span>
>
>

![Välj VPN][api-management-setup-vpn-select]

<span data-ttu-id="c9278-131">Klicka på **spara** överst på skärmen.</span><span class="sxs-lookup"><span data-stu-id="c9278-131">Click **Save** at the top of the screen.</span></span>

> [!NOTE]
> <span data-ttu-id="c9278-132">VIP-adressen för API Management-instansen kommer att ändras varje gång virtuella nätverk är aktiverad eller inaktiverad.</span><span class="sxs-lookup"><span data-stu-id="c9278-132">The VIP address of the API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="c9278-133">VIP-adressen ändras samtidigt när API Management flyttas från **externa** till **internt** eller tvärtom</span><span class="sxs-lookup"><span data-stu-id="c9278-133">The VIP address will also change when API Management is moved from **External** to **Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="c9278-134">Om du ta bort API-hantering från ett VNET eller ändrar en distribuerad i kan tidigare VNET förbli låsta för upp till fyra timmar.</span><span class="sxs-lookup"><span data-stu-id="c9278-134">If you remove API Management from a VNET or change the one it is deployed in, the previously used VNET can remain locked for up to 4 hours.</span></span> <span data-ttu-id="c9278-135">Under denna tid går det inte att ta bort VNET eller distribuera en ny resurs till den.</span><span class="sxs-lookup"><span data-stu-id="c9278-135">During this period it will not be possible to delete the VNET or deploy a new resource to it.</span></span>

## <span data-ttu-id="c9278-136"><a name="enable-vnet-powershell"></a>Aktivera VNET-anslutningen med hjälp av PowerShell-cmdlets</span><span class="sxs-lookup"><span data-stu-id="c9278-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="c9278-137">Du kan också aktivera VNET-anslutning med hjälp av PowerShell-cmdlets</span><span class="sxs-lookup"><span data-stu-id="c9278-137">You can also enable VNET connectivity using the PowerShell cmdlets</span></span>

* <span data-ttu-id="c9278-138">**Skapa en API Management-tjänst i ett VNET**: Använd cmdlet [ny AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) att skapa en Azure API Management-tjänst i ett virtuellt nätverk.</span><span class="sxs-lookup"><span data-stu-id="c9278-138">**Create an API Management service inside a VNET**: Use the cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) to create an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="c9278-139">**Distribuera en befintlig API Management-tjänst i ett VNET**: Använd cmdlet [uppdatering AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) att flytta en befintlig Azure API Management-tjänst i ett virtuellt nätverk.</span><span class="sxs-lookup"><span data-stu-id="c9278-139">**Deploy an existing API Management service inside a VNET**: Use the cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) to move an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="c9278-140"><a name="connect-vnet"></a>Ansluta till en webbtjänst som finns inom ett virtuellt nätverk</span><span class="sxs-lookup"><span data-stu-id="c9278-140"><a name="connect-vnet"> </a>Connect to a web service hosted within a virtual Network</span></span>
<span data-ttu-id="c9278-141">När din API Management-tjänst är ansluten till VNET, är åtkomst till backend-tjänster i den inte annorlunda än att komma åt offentliga tjänster.</span><span class="sxs-lookup"><span data-stu-id="c9278-141">After your API Management service is connected to the VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="c9278-142">Skriv i den lokala IP-adressen eller värdnamnet (om en DNS-server är konfigurerad för VNET) för webbtjänsten i den **-webbtjänstens URL** fältet när du skapar ett nytt API eller redigerar en befintlig.</span><span class="sxs-lookup"><span data-stu-id="c9278-142">Just type in the local IP address or the host name (if a DNS server is configured for the VNET) of your web service into the **Web service URL** field when creating a new API or editing an existing one.</span></span>

![Lägg till API från VPN][api-management-setup-vpn-add-api]

## <span data-ttu-id="c9278-144"><a name="network-configuration-issues"></a>Vanliga nätverkskonfigurationen</span><span class="sxs-lookup"><span data-stu-id="c9278-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="c9278-145">Nedan följer en lista över vanliga problem som kan uppstå vid distribution av API Management-tjänsten till ett virtuellt nätverk.</span><span class="sxs-lookup"><span data-stu-id="c9278-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="c9278-146">**Anpassade DNS-serverinstallation**: I API Management-tjänsten är beroende av flera Azure-tjänster.</span><span class="sxs-lookup"><span data-stu-id="c9278-146">**Custom DNS server setup**: The API Management service depends on several Azure services.</span></span> <span data-ttu-id="c9278-147">När API-hantering finns i ett VNET med en anpassad DNS-server, måste den matcha värdnamn för de Azure-tjänsterna.</span><span class="sxs-lookup"><span data-stu-id="c9278-147">When API Management is hosted in a VNET with a custom DNS server, it needs to resolve the hostnames of those Azure services.</span></span> <span data-ttu-id="c9278-148">Följ [detta](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) vägledning om anpassade DNS-inställningarna.</span><span class="sxs-lookup"><span data-stu-id="c9278-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="c9278-149">Se tabellen portar och andra krav som referens.</span><span class="sxs-lookup"><span data-stu-id="c9278-149">See the ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c9278-150">Det rekommenderas att, om du använder en anpassad DNS-servrar för VNET kan du konfigurera som **innan** distribuera en API Management-tjänsten till den.</span><span class="sxs-lookup"><span data-stu-id="c9278-150">It is recommended that, if you are using a Custom DNS Server(s) for the VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="c9278-151">Annars måste du uppdatera API Management-tjänsten varje gång du ändrar DNS-servrar (s) genom att köra den [gäller åtgärden för konfiguration](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span><span class="sxs-lookup"><span data-stu-id="c9278-151">Otherwise you need to update the API Management service each time you change the DNS Servers(s) by running the [Apply Network Configuration Operation](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span></span>

* <span data-ttu-id="c9278-152">**Portar som behövs för API Management**: inkommande och utgående trafik i undernätet som API Management har distribuerats kan kontrolleras med [Nätverkssäkerhetsgruppen][Network Security Group].</span><span class="sxs-lookup"><span data-stu-id="c9278-152">**Ports required for API Management**: Inbound and Outbound traffic into the Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="c9278-153">Om någon av dessa portar är otillgängliga API Management kanske inte fungerar korrekt och kan inte komma åt.</span><span class="sxs-lookup"><span data-stu-id="c9278-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="c9278-154">Med en eller flera av de här portarna blockeras är ett annat vanligt felkonfiguration problem när du använder API-hantering med ett VNET.</span><span class="sxs-lookup"><span data-stu-id="c9278-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="c9278-155">När en instans för API Management-tjänsten är värd för ett virtuellt nätverk, används portarna i följande tabell.</span><span class="sxs-lookup"><span data-stu-id="c9278-155">When an API Management service instance is hosted in a VNET, the ports in the following table are used.</span></span>

| <span data-ttu-id="c9278-156">Källan / målet portar</span><span class="sxs-lookup"><span data-stu-id="c9278-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="c9278-157">Riktning</span><span class="sxs-lookup"><span data-stu-id="c9278-157">Direction</span></span> | <span data-ttu-id="c9278-158">Transportprotokoll</span><span class="sxs-lookup"><span data-stu-id="c9278-158">Transport protocol</span></span> | <span data-ttu-id="c9278-159">Syfte</span><span class="sxs-lookup"><span data-stu-id="c9278-159">Purpose</span></span> | <span data-ttu-id="c9278-160">Källan / målet</span><span class="sxs-lookup"><span data-stu-id="c9278-160">Source / Destination</span></span> | <span data-ttu-id="c9278-161">Åtkomsttyp</span><span class="sxs-lookup"><span data-stu-id="c9278-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="c9278-162">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="c9278-162">* / 80, 443</span></span> |<span data-ttu-id="c9278-163">Inkommande</span><span class="sxs-lookup"><span data-stu-id="c9278-163">Inbound</span></span> |<span data-ttu-id="c9278-164">TCP</span><span class="sxs-lookup"><span data-stu-id="c9278-164">TCP</span></span> |<span data-ttu-id="c9278-165">Klientkommunikation till API-hantering</span><span class="sxs-lookup"><span data-stu-id="c9278-165">Client communication to API Management</span></span> |<span data-ttu-id="c9278-166">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="c9278-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="c9278-167">Extern</span><span class="sxs-lookup"><span data-stu-id="c9278-167">External</span></span> |
| <span data-ttu-id="c9278-168">* / 3443</span><span class="sxs-lookup"><span data-stu-id="c9278-168">* / 3443</span></span> |<span data-ttu-id="c9278-169">Inkommande</span><span class="sxs-lookup"><span data-stu-id="c9278-169">Inbound</span></span> |<span data-ttu-id="c9278-170">TCP</span><span class="sxs-lookup"><span data-stu-id="c9278-170">TCP</span></span> |<span data-ttu-id="c9278-171">Hanteringsslutpunkten för Azure-portalen och Powershell</span><span class="sxs-lookup"><span data-stu-id="c9278-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="c9278-172">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="c9278-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="c9278-173">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-173">External & Internal</span></span> |
| <span data-ttu-id="c9278-174">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="c9278-174">* / 80, 443</span></span> |<span data-ttu-id="c9278-175">Utgående</span><span class="sxs-lookup"><span data-stu-id="c9278-175">Outbound</span></span> |<span data-ttu-id="c9278-176">TCP</span><span class="sxs-lookup"><span data-stu-id="c9278-176">TCP</span></span> |<span data-ttu-id="c9278-177">Beroendet av Azure Storage och Azure Service Bus</span><span class="sxs-lookup"><span data-stu-id="c9278-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="c9278-178">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="c9278-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="c9278-179">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-179">External & Internal</span></span> |
| <span data-ttu-id="c9278-180">* / 1433</span><span class="sxs-lookup"><span data-stu-id="c9278-180">* / 1433</span></span> |<span data-ttu-id="c9278-181">Utgående</span><span class="sxs-lookup"><span data-stu-id="c9278-181">Outbound</span></span> |<span data-ttu-id="c9278-182">TCP</span><span class="sxs-lookup"><span data-stu-id="c9278-182">TCP</span></span> |<span data-ttu-id="c9278-183">Beroende på Azure SQL</span><span class="sxs-lookup"><span data-stu-id="c9278-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="c9278-184">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="c9278-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="c9278-185">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-185">External & Internal</span></span> |
| <span data-ttu-id="c9278-186">* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="c9278-186">* / 11000 - 11999</span></span> |<span data-ttu-id="c9278-187">Utgående</span><span class="sxs-lookup"><span data-stu-id="c9278-187">Outbound</span></span> |<span data-ttu-id="c9278-188">TCP</span><span class="sxs-lookup"><span data-stu-id="c9278-188">TCP</span></span> |<span data-ttu-id="c9278-189">V12 Azure SQL-beroendet</span><span class="sxs-lookup"><span data-stu-id="c9278-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="c9278-190">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="c9278-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="c9278-191">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-191">External & Internal</span></span> |
| <span data-ttu-id="c9278-192">* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="c9278-192">* / 14000 - 14999</span></span> |<span data-ttu-id="c9278-193">Utgående</span><span class="sxs-lookup"><span data-stu-id="c9278-193">Outbound</span></span> |<span data-ttu-id="c9278-194">TCP</span><span class="sxs-lookup"><span data-stu-id="c9278-194">TCP</span></span> |<span data-ttu-id="c9278-195">V12 Azure SQL-beroendet</span><span class="sxs-lookup"><span data-stu-id="c9278-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="c9278-196">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="c9278-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="c9278-197">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-197">External & Internal</span></span> |
| <span data-ttu-id="c9278-198">* / 5671</span><span class="sxs-lookup"><span data-stu-id="c9278-198">* / 5671</span></span> |<span data-ttu-id="c9278-199">Utgående</span><span class="sxs-lookup"><span data-stu-id="c9278-199">Outbound</span></span> |<span data-ttu-id="c9278-200">AMQP</span><span class="sxs-lookup"><span data-stu-id="c9278-200">AMQP</span></span> |<span data-ttu-id="c9278-201">Beroende för inloggning till Event Hub-principen och övervakningsagent</span><span class="sxs-lookup"><span data-stu-id="c9278-201">Dependency for Log to Event Hub policy and monitoring agent</span></span> |<span data-ttu-id="c9278-202">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="c9278-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="c9278-203">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-203">External & Internal</span></span> |
| <span data-ttu-id="c9278-204">6381 - 6383 / 6381 - 6383</span><span class="sxs-lookup"><span data-stu-id="c9278-204">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="c9278-205">Inkommande och utgående</span><span class="sxs-lookup"><span data-stu-id="c9278-205">Inbound & Outbound</span></span> |<span data-ttu-id="c9278-206">UDP</span><span class="sxs-lookup"><span data-stu-id="c9278-206">UDP</span></span> |<span data-ttu-id="c9278-207">Beroende på Redis-Cache</span><span class="sxs-lookup"><span data-stu-id="c9278-207">Dependency on Redis Cache</span></span> |<span data-ttu-id="c9278-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="c9278-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="c9278-209">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-209">External & Internal</span></span> |-
| <span data-ttu-id="c9278-210">* / 445</span><span class="sxs-lookup"><span data-stu-id="c9278-210">* / 445</span></span> |<span data-ttu-id="c9278-211">Utgående</span><span class="sxs-lookup"><span data-stu-id="c9278-211">Outbound</span></span> |<span data-ttu-id="c9278-212">TCP</span><span class="sxs-lookup"><span data-stu-id="c9278-212">TCP</span></span> |<span data-ttu-id="c9278-213">Beroende på Azure-filresursen för GIT</span><span class="sxs-lookup"><span data-stu-id="c9278-213">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="c9278-214">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="c9278-214">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="c9278-215">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-215">External & Internal</span></span> |
| <span data-ttu-id="c9278-216">* / *</span><span class="sxs-lookup"><span data-stu-id="c9278-216">* / *</span></span> | <span data-ttu-id="c9278-217">Inkommande</span><span class="sxs-lookup"><span data-stu-id="c9278-217">Inbound</span></span> |<span data-ttu-id="c9278-218">TCP</span><span class="sxs-lookup"><span data-stu-id="c9278-218">TCP</span></span> |<span data-ttu-id="c9278-219">Azure-infrastrukturen belastningsutjämnare</span><span class="sxs-lookup"><span data-stu-id="c9278-219">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="c9278-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="c9278-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="c9278-221">Externa och interna</span><span class="sxs-lookup"><span data-stu-id="c9278-221">External & Internal</span></span> |

* <span data-ttu-id="c9278-222">**SSL-funktionen**: att bygga kedja för SSL-certifikat och validering API Management-tjänsten måste utgående nätverksanslutning till ocsp.msocsp.com, mscrl.microsoft.com och crl.microsoft.com. Detta beroende är inte krävs, om något av de certifikat som du överför till API Management innehåller hela kedjan rot-CA: N.</span><span class="sxs-lookup"><span data-stu-id="c9278-222">**SSL functionality**: To enable SSL certificate chain building and validation the API Management service needs Outbound network connectivity to ocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com. This dependency is not required, if any certificate you upload to API Management contain the full chain to the CA root.</span></span>

* <span data-ttu-id="c9278-223">**DNS-åtkomst**: utgående åtkomst på port 53 krävs för kommunikation med DNS-servrar.</span><span class="sxs-lookup"><span data-stu-id="c9278-223">**DNS Access**: Outbound access on port 53 is required for communication with DNS servers.</span></span> <span data-ttu-id="c9278-224">Om en anpassad DNS-server finns på den andra änden av en VPN-gateway, måste DNS-servern vara nåbar från det undernät som är värd för API-hantering.</span><span class="sxs-lookup"><span data-stu-id="c9278-224">If a custom DNS server exists on the other end of a VPN gateway, the DNS server must be reachable from the subnet hosting API Management.</span></span>

* <span data-ttu-id="c9278-225">**Mått och hälsoövervakning**: utgående nätverksanslutning till Azure-övervakning slutpunkter som löser under följande domäner: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span><span class="sxs-lookup"><span data-stu-id="c9278-225">**Metrics and Health Monitoring**: Outbound network connectivity to Azure Monitoring endpoints, which resolve under the following domains: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span></span>

* <span data-ttu-id="c9278-226">**Expressinstallationen väg**: en gemensam konfiguration av customer är att definiera egna standardvägen (0.0.0.0/0) som tvingar utgående Internet-trafiken flöda lokalt i stället.</span><span class="sxs-lookup"><span data-stu-id="c9278-226">**Express Route Setup**: A common customer configuration is to define their own default route (0.0.0.0/0) which forces outbound Internet traffic to instead flow on-premises.</span></span> <span data-ttu-id="c9278-227">Den här trafikflöde bryts utan undantag anslutningen till Azure API Management eftersom utgående trafik är antingen blockerade lokalt eller NAT skulle med ett okänt uppsättning adresser som inte längre att fungera med olika Azure-slutpunkter.</span><span class="sxs-lookup"><span data-stu-id="c9278-227">This traffic flow invariably breaks connectivity with Azure API Management because the outbound traffic is either blocked on-premises, or NAT'd to an unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="c9278-228">Lösningen är att definiera en (eller flera) användardefinierade vägar ([udr: er][UDRs]) i undernät som innehåller Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="c9278-228">The solution is to define one (or more) user-defined routes ([UDRs][UDRs]) on the subnet that contains the Azure API Management.</span></span> <span data-ttu-id="c9278-229">En UDR definierar undernät-specifika vägar som ska användas i stället för standardväg.</span><span class="sxs-lookup"><span data-stu-id="c9278-229">A UDR defines subnet-specific routes that will be honored instead of the default route.</span></span>
  <span data-ttu-id="c9278-230">Om möjligt bör du använder följande konfiguration:</span><span class="sxs-lookup"><span data-stu-id="c9278-230">If possible, it is recommended to use the following configuration:</span></span>
 * <span data-ttu-id="c9278-231">ExpressRoute-konfigurationen annonserar 0.0.0.0/0 och som standard kraft tunnlar all utgående trafik lokalt.</span><span class="sxs-lookup"><span data-stu-id="c9278-231">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="c9278-232">UDR tillämpad på undernätet som innehåller Azure API Management definierar 0.0.0.0/0 med ett nexthop-typ för Internet.</span><span class="sxs-lookup"><span data-stu-id="c9278-232">The UDR applied to the subnet containing the Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="c9278-233">Den kombinerade effekten av dessa steg är att undernätverksnivån UDR företräde framför den ExpressRoute Tvingad tunneltrafik tillse utgående Internetåtkomst från Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="c9278-233">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="c9278-234">Azure API Management stöds inte med ExpressRoute-konfigurationer som **felaktigt cross-annonsera vägar från offentlig peering sökvägen att privat peering sökväg**.</span><span class="sxs-lookup"><span data-stu-id="c9278-234">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span></span> <span data-ttu-id="c9278-235">ExpressRoute-konfigurationer som har konfigurerats, offentlig peering får vägannonser från Microsoft för ett stort antal Microsoft Azure IP-adressintervall.</span><span class="sxs-lookup"><span data-stu-id="c9278-235">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="c9278-236">Om dessa adressintervall felaktigt cross-annonseras i privat peering sökväg, är slutresultatet att alla utgående paket från Azure API Management-instans undernät felaktigt kraft tunnlar kundens lokala nätverkets infrastruktur.</span><span class="sxs-lookup"><span data-stu-id="c9278-236">If these address ranges are incorrectly cross-advertised on the private peering path, the end result is that all outbound network packets from the Azure API Management instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="c9278-237">Det här nätverket flödet bryts Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="c9278-237">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="c9278-238">Lösning på problemet är att stoppa mellan reklam vägar från offentlig peering sökvägen att privat peering sökväg.</span><span class="sxs-lookup"><span data-stu-id="c9278-238">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span></span>


## <span data-ttu-id="c9278-239"><a name="troubleshooting"></a>Felsökning</span><span class="sxs-lookup"><span data-stu-id="c9278-239"><a name="troubleshooting"> </a>Troubleshooting</span></span>
<span data-ttu-id="c9278-240">När du gör ändringar i nätverket referera till [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), för att verifiera om API Management-tjänsten inte har tillgång till någon av de viktiga resurser som den är beroende av.</span><span class="sxs-lookup"><span data-stu-id="c9278-240">When making changes to your network, refer to [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), to validate if the API Management service has not lost access to any of the critical resources which it depends upon.</span></span> <span data-ttu-id="c9278-241">Statusen ska uppdateras var 15: e minut.</span><span class="sxs-lookup"><span data-stu-id="c9278-241">The connectivity status should be updated every 15 minutes.</span></span>

## <span data-ttu-id="c9278-242"><a name="limitations"></a>Begränsningar</span><span class="sxs-lookup"><span data-stu-id="c9278-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="c9278-243">Ett undernät som innehåller API Management-instanser får inte innehålla andra Azure-resurs-typer.</span><span class="sxs-lookup"><span data-stu-id="c9278-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="c9278-244">Undernätet och API Management-tjänsten måste vara i samma prenumeration.</span><span class="sxs-lookup"><span data-stu-id="c9278-244">The subnet and the API Management service must be in the same subscription.</span></span>
* <span data-ttu-id="c9278-245">Ett undernät som innehåller API Management-instanser kan inte flyttas mellan prenumerationer.</span><span class="sxs-lookup"><span data-stu-id="c9278-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="c9278-246">När du använder ett internt virtuellt nätverk, endast en intern IP-adress ska vara tillgänglig från intervallet anges i [RFC 1918](https://tools.ietf.org/html/rfc1918), en offentlig IP-adress kan inte anges.</span><span class="sxs-lookup"><span data-stu-id="c9278-246">When using an internal virtual network, only an internal IP address will be available from the range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="c9278-247">För distribution av flera regioner API-hantering ansvarar med interna virtuella nätverk som har konfigurerats kan användare för att hantera sina egna belastningsutjämning som de äger DNS.</span><span class="sxs-lookup"><span data-stu-id="c9278-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own the DNS.</span></span>


## <span data-ttu-id="c9278-248"><a name="related-content"></a>Relaterat innehåll</span><span class="sxs-lookup"><span data-stu-id="c9278-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="c9278-249">Ansluta ett virtuellt nätverk till backend med hjälp av Vpn-Gateway</span><span class="sxs-lookup"><span data-stu-id="c9278-249">Connecting a Virtual Network to backend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [<span data-ttu-id="c9278-250">Ansluta ett virtuellt nätverk från olika distributionsmodeller</span><span class="sxs-lookup"><span data-stu-id="c9278-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="c9278-251">Hur du använder API-Inspector för att spåra anropar i Azure API Management</span><span class="sxs-lookup"><span data-stu-id="c9278-251">How to use the API Inspector to trace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md
