---
title: "aaaService Fabric säkerhetskopiering och återställning | Microsoft Docs"
description: "Konceptuell dokumentationen för Service Fabric-säkerhetskopiering och återställning"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: e502b59c84999c3fe825167383f00a5ebd70c9b5
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="3151f-103">Säkerhetskopiera och återställa Reliable Services och Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="3151f-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="3151f-104">Azure Service Fabric är en plattform för hög tillgänglighet som replikerar hello tillstånd över flera noder toomaintain hög tillgänglighet.</span><span class="sxs-lookup"><span data-stu-id="3151f-104">Azure Service Fabric is a high-availability platform that replicates hello state across multiple nodes toomaintain this high availability.</span></span>  <span data-ttu-id="3151f-105">Även om en nod i klustret hello misslyckas, fortsätter hello tjänster därför toobe som är tillgängliga.</span><span class="sxs-lookup"><span data-stu-id="3151f-105">Thus, even if one node in hello cluster fails, hello services continue toobe available.</span></span> <span data-ttu-id="3151f-106">Den här inbyggda redundans som tillhandahålls av hello plattformen kan vara tillräcklig för vissa, i vissa fall är det lämpligt att hello service tooback data (tooan externa store).</span><span class="sxs-lookup"><span data-stu-id="3151f-106">While this in-built redundancy provided by hello platform may be sufficient for some, in certain cases it is desirable for hello service tooback up data (tooan external store).</span></span>

> [!NOTE]
> <span data-ttu-id="3151f-107">Den kritiska toobackup och återställa dina data (och kontrollera att den fungerar som förväntat) så att du kan återställa från data går förlorade.</span><span class="sxs-lookup"><span data-stu-id="3151f-107">It is critical toobackup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="3151f-108">En tjänst kan exempelvis vilja tooback upp data i ordning tooprotect från hello följande scenarier:</span><span class="sxs-lookup"><span data-stu-id="3151f-108">For example, a service may want tooback up data in order tooprotect from hello following scenarios:</span></span>

- <span data-ttu-id="3151f-109">Hej för händelsen hello permanent förlorade en hela Service Fabric-klustret.</span><span class="sxs-lookup"><span data-stu-id="3151f-109">In hello event of hello permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="3151f-110">Permanent förlorade en majoritet av hello repliker för en partition för tjänsten</span><span class="sxs-lookup"><span data-stu-id="3151f-110">Permanent loss of a majority of hello replicas of a service partition</span></span>
- <span data-ttu-id="3151f-111">Administrativa fel där hello tillstånd hämtar eller förstörs.</span><span class="sxs-lookup"><span data-stu-id="3151f-111">Administrative errors whereby hello state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="3151f-112">T.ex, kan detta inträffa om en administratör med tillräcklig behörighet för felaktigt tar bort hello tjänst.</span><span class="sxs-lookup"><span data-stu-id="3151f-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes hello service.</span></span>
- <span data-ttu-id="3151f-113">Programfel i hello service som orsakar att data skadas.</span><span class="sxs-lookup"><span data-stu-id="3151f-113">Bugs in hello service that cause data corruption.</span></span> <span data-ttu-id="3151f-114">T.ex, kan det hända när en tjänst koduppgradering startas skrivning felaktiga data tooa tillförlitliga samling.</span><span class="sxs-lookup"><span data-stu-id="3151f-114">For example, this may happen when a service code upgrade starts writing faulty data tooa Reliable Collection.</span></span> <span data-ttu-id="3151f-115">I sådana fall hello både koden och hello data kan ha toobe återställs tooan tidigare tillstånd.</span><span class="sxs-lookup"><span data-stu-id="3151f-115">In such a case, both hello code and hello data may have toobe reverted tooan earlier state.</span></span>
- <span data-ttu-id="3151f-116">Offline databearbetning.</span><span class="sxs-lookup"><span data-stu-id="3151f-116">Offline data processing.</span></span> <span data-ttu-id="3151f-117">Det kan vara praktiskt toohave offline bearbetning av data för business intelligence som sker separat från hello-tjänsten som genererar hello data.</span><span class="sxs-lookup"><span data-stu-id="3151f-117">It might be convenient toohave offline processing of data for business intelligence that happens separately from hello service that generates hello data.</span></span>

<span data-ttu-id="3151f-118">hello säkerhetskopiering/återställning funktionen tillåter tjänster som bygger på hello Reliable Services API toocreate och återställning av säkerhetskopior.</span><span class="sxs-lookup"><span data-stu-id="3151f-118">hello Backup/Restore feature allows services built on hello Reliable Services API toocreate and restore backups.</span></span> <span data-ttu-id="3151f-119">hello att säkerhetskopiering API: er som tillhandahålls av hello plattform säkerhetskopiorna av en tjänst partition tillstånd, utan blockerar Läs- eller skrivåtgärder.</span><span class="sxs-lookup"><span data-stu-id="3151f-119">hello backup APIs provided by hello platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="3151f-120">hello återställning API: er kan en tjänst partition tillstånd toobe återställts från en säkerhetskopia av valda.</span><span class="sxs-lookup"><span data-stu-id="3151f-120">hello restore APIs allow a service partition's state toobe restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="3151f-121">Typer av säkerhetskopiering</span><span class="sxs-lookup"><span data-stu-id="3151f-121">Types of Backup</span></span>
<span data-ttu-id="3151f-122">Det finns två alternativ för säkerhetskopiering: fullständig och inkrementell.</span><span class="sxs-lookup"><span data-stu-id="3151f-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="3151f-123">En fullständig säkerhetskopia är en säkerhetskopia som innehåller alla hello data som krävs för toorecreate hello status hello replik: kontrollpunkter och alla loggposter.</span><span class="sxs-lookup"><span data-stu-id="3151f-123">A full backup is a backup that contains all hello data required toorecreate hello state of hello replica: checkpoints and all log records.</span></span>
<span data-ttu-id="3151f-124">Eftersom den har hello kontrollpunkter och hello loggen kan du återställa en fullständig säkerhetskopia ensamt.</span><span class="sxs-lookup"><span data-stu-id="3151f-124">Since it has hello checkpoints and hello log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="3151f-125">hello problem med fullständiga säkerhetskopieringar uppstår när hello kontrollpunkter är stora.</span><span class="sxs-lookup"><span data-stu-id="3151f-125">hello problem with full backups arises when hello checkpoints are large.</span></span>
<span data-ttu-id="3151f-126">En replik som har 16 GB tillstånd har till exempel kontrollpunkter som utgör cirka too16 GB.</span><span class="sxs-lookup"><span data-stu-id="3151f-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately too16 GB.</span></span>
<span data-ttu-id="3151f-127">Om vi har ett mål för återställningspunkt fem minuter behöver hello replica toobe säkerhetskopieras var femte minut.</span><span class="sxs-lookup"><span data-stu-id="3151f-127">If we have a Recovery Point Objective of five minutes, hello replica needs toobe backed up every five minutes.</span></span>
<span data-ttu-id="3151f-128">Varje gång den säkerhetskopierar måste toocopy 16 GB kontrollpunkter dessutom too50 MB (kan konfigureras med hjälp av `CheckpointThresholdInMB`) med loggar.</span><span class="sxs-lookup"><span data-stu-id="3151f-128">Each time it backs up it needs toocopy 16 GB of checkpoints in addition too50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Fullständig säkerhetskopiering exempel.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="3151f-130">hello lösning toothis problemet är inkrementella säkerhetskopieringar där säkerhetskopian bara innehåller loggposter hello ändrats sedan den senaste säkerhetskopieringen av hello.</span><span class="sxs-lookup"><span data-stu-id="3151f-130">hello solution toothis problem is incremental backups, where backup only contains hello changed log records since hello last backup.</span></span>

![Exempel för inkrementell säkerhetskopiering.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="3151f-132">Eftersom säkerhetskopior är endast ändringar sedan hello senaste säkerhetskopieringen (inte omfattar hello kontrollpunkter) är de tenderar toobe snabbare, men de kan inte återställas på egen hand.</span><span class="sxs-lookup"><span data-stu-id="3151f-132">Since incremental backups are only changes since hello last backup (does not include hello checkpoints), they tend toobe faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="3151f-133">toorestore en inkrementell säkerhetskopia hello hela loggsäkerhetskopieringssekvensen krävs.</span><span class="sxs-lookup"><span data-stu-id="3151f-133">toorestore an incremental backup, hello entire backup chain is required.</span></span>
<span data-ttu-id="3151f-134">En säkerhetskopiering kedja följt av ett antal sammanhängande inkrementella säkerhetskopieringar är en kedja av säkerhetskopior som börjar med en fullständig säkerhetskopia.</span><span class="sxs-lookup"><span data-stu-id="3151f-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="3151f-135">Säkerhetskopiering Reliable Services</span><span class="sxs-lookup"><span data-stu-id="3151f-135">Backup Reliable Services</span></span>
<span data-ttu-id="3151f-136">hello service författare har fullständig kontroll över när toomake säkerhetskopieringar och där säkerhetskopiorna lagras.</span><span class="sxs-lookup"><span data-stu-id="3151f-136">hello service author has full control of when toomake backups and where backups will be stored.</span></span>

<span data-ttu-id="3151f-137">toostart en säkerhetskopia hello-tjänsten måste tooinvoke hello ärvda medlemmen funktionen `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="3151f-137">toostart a backup, hello service needs tooinvoke hello inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="3151f-138">Säkerhetskopieringar kan göras från primära repliker och de behöver skriva status toobe beviljas.</span><span class="sxs-lookup"><span data-stu-id="3151f-138">Backups can be made only from primary replicas, and they require write status toobe granted.</span></span>

<span data-ttu-id="3151f-139">Enligt nedan, `BackupAsync` tar in en `BackupDescription` objekt, där en kan ange en fullständig eller inkrementell säkerhetskopiering, samt en Återanropsfunktionen, `Func<< BackupInfo, CancellationToken, Task<bool>>>` som anropas när hello säkerhetskopieringsmappen har skapats lokalt och flyttas redo toobe ut toosome extern lagring.</span><span class="sxs-lookup"><span data-stu-id="3151f-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when hello backup folder has been created locally and is ready toobe moved out toosome external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="3151f-140">Begäran tootake en inkrementell säkerhetskopia kan misslyckas med `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="3151f-140">Request tootake an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="3151f-141">Det här undantaget anger att en av följande saker hello sker:</span><span class="sxs-lookup"><span data-stu-id="3151f-141">This exception indicates that one of hello following things is happening:</span></span>

- <span data-ttu-id="3151f-142">hello replik har aldrig tagit en fullständig säkerhetskopiering eftersom det har blivit primära,</span><span class="sxs-lookup"><span data-stu-id="3151f-142">hello replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="3151f-143">Vissa av hello loggposter eftersom hello senaste säkerhetskopieringen har trunkerats eller</span><span class="sxs-lookup"><span data-stu-id="3151f-143">some of hello log records since hello last backup has been truncated or</span></span>
- <span data-ttu-id="3151f-144">replik skickades hello `MaxAccumulatedBackupLogSizeInMB` gränsen.</span><span class="sxs-lookup"><span data-stu-id="3151f-144">replica passed hello `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="3151f-145">Användare kan öka hello sannolikheten för att kunna toodo inkrementella säkerhetskopieringar genom att konfigurera `MinLogSizeInMB` eller `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="3151f-145">Users can increase hello likelihood of being able toodo incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="3151f-146">Observera att om du ökar värdena ökas hello per replik diskanvändning.</span><span class="sxs-lookup"><span data-stu-id="3151f-146">Note that increasing these values increases hello per replica disk usage.</span></span>
<span data-ttu-id="3151f-147">Mer information finns i [Reliable Services-konfiguration](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="3151f-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="3151f-148">`BackupInfo`innehåller information om hello säkerhetskopiering, inklusive hello platsen för hello mappen där hello runtime sparade hello säkerhetskopiering (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="3151f-148">`BackupInfo` provides information regarding hello backup, including hello location of hello folder where hello runtime saved hello backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="3151f-149">hello Återanropsfunktionen kan flytta hello `BackupInfo.Directory` tooan extern butik eller en annan plats.</span><span class="sxs-lookup"><span data-stu-id="3151f-149">hello callback function can move hello `BackupInfo.Directory` tooan external store or another location.</span></span>  <span data-ttu-id="3151f-150">Den här funktionen returnerar också bool som anger om det var kan toosuccessfully flytta hello tooits mål mapp för säkerhetskopiering.</span><span class="sxs-lookup"><span data-stu-id="3151f-150">This function also returns a bool that indicates whether it was able toosuccessfully move hello backup folder tooits target location.</span></span>

<span data-ttu-id="3151f-151">hello följande kod visar hur hello `BackupCallbackAsync` metoden kan vara används tooupload hello säkerhetskopiering tooAzure lagring:</span><span class="sxs-lookup"><span data-stu-id="3151f-151">hello following code demonstrates how hello `BackupCallbackAsync` method can be used tooupload hello backup tooAzure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="3151f-152">I exemplet som föregår hello `ExternalBackupStore` är hello exempel klass som används toointerface med Azure Blob storage och `UploadBackupFolderAsync` är hello-metod som komprimerar hello mapp och placerar den i hello Azure Blob store.</span><span class="sxs-lookup"><span data-stu-id="3151f-152">In hello preceeding example, `ExternalBackupStore` is hello sample class that is used toointerface with Azure Blob storage, and `UploadBackupFolderAsync` is hello method that compresses hello folder and places it in hello Azure Blob store.</span></span>

<span data-ttu-id="3151f-153">Tänk på följande:</span><span class="sxs-lookup"><span data-stu-id="3151f-153">Note that:</span></span>

  - <span data-ttu-id="3151f-154">Det kan finnas endast en säkerhetskopiering relä per replikering vid en given tidpunkt.</span><span class="sxs-lookup"><span data-stu-id="3151f-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="3151f-155">Mer än en `BackupAsync` samtal i taget genereras `FabricBackupInProgressException` toolimit inflight säkerhetskopieringar tooone.</span><span class="sxs-lookup"><span data-stu-id="3151f-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` toolimit inflight backups tooone.</span></span>
  - <span data-ttu-id="3151f-156">Om en replik misslyckas över när en säkerhetskopiering pågår kanske hello-säkerhetskopiering inte har slutförts.</span><span class="sxs-lookup"><span data-stu-id="3151f-156">If a replica fails over while a backup is in progress, hello backup may not have been completed.</span></span> <span data-ttu-id="3151f-157">Därför när hello växling vid fel är klar, är det hello service ansvar toorestart hello säkerhetskopiering genom att anropa `BackupAsync` efter behov.</span><span class="sxs-lookup"><span data-stu-id="3151f-157">Thus, once hello failover finishes, it is hello service's responsibility toorestart hello backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="3151f-158">Återställa Reliable Services</span><span class="sxs-lookup"><span data-stu-id="3151f-158">Restore Reliable Services</span></span>
<span data-ttu-id="3151f-159">I allmänhet indelas Hej då du kan behöva tooperform en återställningsåtgärd i dessa kategorier:</span><span class="sxs-lookup"><span data-stu-id="3151f-159">In general, hello cases when you might need tooperform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="3151f-160">hello service partitionera förlorade data.</span><span class="sxs-lookup"><span data-stu-id="3151f-160">hello service partition lost data.</span></span> <span data-ttu-id="3151f-161">Hello disk för två av tre repliker för en partition (inklusive hello primära repliken) hämtar skadad eller rensas.</span><span class="sxs-lookup"><span data-stu-id="3151f-161">For example, hello disk for two out of three replicas for a partition (including hello primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="3151f-162">hello nya primära behöva toorestore data från en säkerhetskopia.</span><span class="sxs-lookup"><span data-stu-id="3151f-162">hello new primary may need toorestore data from a backup.</span></span>
  - <span data-ttu-id="3151f-163">hello hela tjänsten går förlorad.</span><span class="sxs-lookup"><span data-stu-id="3151f-163">hello entire service is lost.</span></span> <span data-ttu-id="3151f-164">Till exempel en administratör tar bort hello hela tjänsten och hello-tjänsten och hello data måste därför toobe återställs.</span><span class="sxs-lookup"><span data-stu-id="3151f-164">For example, an administrator removes hello entire service and thus hello service and hello data need toobe restored.</span></span>
  - <span data-ttu-id="3151f-165">hello service replikerade skadad programdata (t.ex. på grund av ett fel i programmet).</span><span class="sxs-lookup"><span data-stu-id="3151f-165">hello service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="3151f-166">I det här fallet hello-tjänsten har toobe uppgraderas eller återställts tooremove hello orsaken till hello skador och icke-skadade data har återställts toobe.</span><span class="sxs-lookup"><span data-stu-id="3151f-166">In this case, hello service has toobe upgraded or reverted tooremove hello cause of hello corruption, and non-corrupt data has toobe restored.</span></span>

<span data-ttu-id="3151f-167">Medan flera metoder är möjligt, vi erbjuder några exempel på med `RestoreAsync` toorecover från hello ovan scenarier.</span><span class="sxs-lookup"><span data-stu-id="3151f-167">While many approaches are possible, we offer some examples on using `RestoreAsync` toorecover from hello above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="3151f-168">Partitionen dataförlust i Reliable Services</span><span class="sxs-lookup"><span data-stu-id="3151f-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="3151f-169">I det här fallet hello runtime skulle automatiskt identifiera hello dataförlust och anropa hello `OnDataLossAsync` API.</span><span class="sxs-lookup"><span data-stu-id="3151f-169">In this case, hello runtime would automatically detect hello data loss and invoke hello `OnDataLossAsync` API.</span></span>

<span data-ttu-id="3151f-170">hello service författare måste tooperform hello följande toorecover:</span><span class="sxs-lookup"><span data-stu-id="3151f-170">hello service author needs tooperform hello following toorecover:</span></span>

  - <span data-ttu-id="3151f-171">Åsidosätt hello virtuella basklassmetoden `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="3151f-171">Override hello virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="3151f-172">Hitta hello senaste säkerhetskopiering hello externa platsen som innehåller säkerhetskopior hello-tjänsten.</span><span class="sxs-lookup"><span data-stu-id="3151f-172">Find hello latest backup in hello external location that contains hello service's backups.</span></span>
  - <span data-ttu-id="3151f-173">Hämta senaste säkerhetskopian av hello (och packa hello säkerhetskopiering i hello säkerhetskopieringsmappen om den har komprimerats).</span><span class="sxs-lookup"><span data-stu-id="3151f-173">Download hello latest backup (and uncompress hello backup into hello backup folder if it was compressed).</span></span>
  - <span data-ttu-id="3151f-174">Hej `OnDataLossAsync` metoden ger ett `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="3151f-174">hello `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="3151f-175">Anropa hello `RestoreAsync` API på hello tillhandahålls `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="3151f-175">Call hello `RestoreAsync` API on hello provided `RestoreContext`.</span></span>
  - <span data-ttu-id="3151f-176">Returnera true om hello återställningen lyckades.</span><span class="sxs-lookup"><span data-stu-id="3151f-176">Return true if hello restoration was a success.</span></span>

<span data-ttu-id="3151f-177">Följande är exempel på implementering av hello `OnDataLossAsync` metoden:</span><span class="sxs-lookup"><span data-stu-id="3151f-177">Following is an example implementation of hello `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="3151f-178">`RestoreDescription`skickade toohello `RestoreContext.RestoreAsync` anrop innehåller en medlem som kallas `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="3151f-178">`RestoreDescription` passed in toohello `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="3151f-179">När du återställer en fullständig säkerhetskopia, detta `BackupFolderPath` ska anges toohello lokal sökväg till hello-mapp som innehåller en fullständig säkerhetskopiering.</span><span class="sxs-lookup"><span data-stu-id="3151f-179">When restoring a single full backup, this `BackupFolderPath` should be set toohello local path of hello folder that contains your full backup.</span></span>
<span data-ttu-id="3151f-180">När du återställer en fullständig säkerhetskopia och ett antal inkrementella säkerhetskopieringar `BackupFolderPath` ska anges toohello lokal sökväg på hello-mapp som innehåller inte bara hello fullständig säkerhetskopia, men även alla hello inkrementella säkerhetskopieringar.</span><span class="sxs-lookup"><span data-stu-id="3151f-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set toohello local path of hello folder that not only contains hello full backup, but also all hello incremental backups.</span></span>
<span data-ttu-id="3151f-181">`RestoreAsync`Anropet kan utlösa `FabricMissingFullBackupException` om hello `BackupFolderPath` som inte innehåller en fullständig säkerhetskopia.</span><span class="sxs-lookup"><span data-stu-id="3151f-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if hello `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="3151f-182">Den kan också ge `ArgumentException` om `BackupFolderPath` har brutits kedja för säkerhetskopior.</span><span class="sxs-lookup"><span data-stu-id="3151f-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="3151f-183">Om den innehåller hello fullständig säkerhetskopiering hello först inkrementell och hello tredje inkrementell säkerhetskopiering men ingen hälsningspaket andra inkrementell säkerhetskopiering.</span><span class="sxs-lookup"><span data-stu-id="3151f-183">For example, if it contains hello full backup, hello first incremental and hello third incremental backup but no hello second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="3151f-184">Hej RestorePolicy är tooSafe som standard.</span><span class="sxs-lookup"><span data-stu-id="3151f-184">hello RestorePolicy is set tooSafe by default.</span></span>  <span data-ttu-id="3151f-185">Det innebär att hello `RestoreAsync` API misslyckas med ArgumentException om den identifierar hello säkerhetskopiering mappen innehåller ett tillstånd som är äldre än eller lika med toohello tillstånd som finns i den här repliken.</span><span class="sxs-lookup"><span data-stu-id="3151f-185">This means that hello `RestoreAsync` API will fail with ArgumentException if it detects that hello backup folder contains a state that is older than or equal toohello state contained in this replica.</span></span>  <span data-ttu-id="3151f-186">`RestorePolicy.Force`kan vara används tooskip säkerhet kontrollen.</span><span class="sxs-lookup"><span data-stu-id="3151f-186">`RestorePolicy.Force` can be used tooskip this safety check.</span></span> <span data-ttu-id="3151f-187">Det har angetts som en del av `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="3151f-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="3151f-188">Borttagna eller förlorade service</span><span class="sxs-lookup"><span data-stu-id="3151f-188">Deleted or lost service</span></span>
<span data-ttu-id="3151f-189">Om en tjänst har tagits bort, måste du först återskapa hello-tjänsten innan hello data kan återställas.</span><span class="sxs-lookup"><span data-stu-id="3151f-189">If a service is removed, you must first re-create hello service before hello data can be restored.</span></span>  <span data-ttu-id="3151f-190">Det är viktigt toocreate hello tjänst med samma konfiguration, t.ex. partitioneringsschema så som hello data kan återställas sömlöst hello.</span><span class="sxs-lookup"><span data-stu-id="3151f-190">It is important toocreate hello service with hello same configuration, e.g., partitioning scheme, so that hello data can be restored seamlessly.</span></span>  <span data-ttu-id="3151f-191">När hello-tjänsten är igång, hello API toorestore data (`OnDataLossAsync` ovan) har toobe anropas för varje partition för den här tjänsten.</span><span class="sxs-lookup"><span data-stu-id="3151f-191">Once hello service is up, hello API toorestore data (`OnDataLossAsync` above) has toobe invoked on every partition of this service.</span></span> <span data-ttu-id="3151f-192">Ett sätt att uppnå detta är med hjälp av `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` för varje partition.</span><span class="sxs-lookup"><span data-stu-id="3151f-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="3151f-193">Från och med nu, är implementeringen hello samma som hello ovan scenario.</span><span class="sxs-lookup"><span data-stu-id="3151f-193">From this point, implementation is hello same as hello above scenario.</span></span> <span data-ttu-id="3151f-194">Varje partition måste toorestore hello senaste relevanta säkerhetskopiering från hello extern butik.</span><span class="sxs-lookup"><span data-stu-id="3151f-194">Each partition needs toorestore hello latest relevant backup from hello external store.</span></span> <span data-ttu-id="3151f-195">Ett villkor är hello partitionen ID kan ha nu ändrats, eftersom hello runtime skapar partitions-ID: N dynamiskt.</span><span class="sxs-lookup"><span data-stu-id="3151f-195">One caveat is that hello partition ID may have now changed, since hello runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="3151f-196">Hello-tjänsten måste därför toostore hello lämplig partitionsinformation och service name tooidentify hello rätt senaste säkerhetskopiering toorestore från för varje partition.</span><span class="sxs-lookup"><span data-stu-id="3151f-196">Thus, hello service needs toostore hello appropriate partition information and service name tooidentify hello correct latest backup toorestore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="3151f-197">Det rekommenderas inte toouse `FabricClient.ServiceManager.InvokeDataLossAsync` på varje partition toorestore hello hela tjänsten, eftersom som kan skada din klustertillstånd.</span><span class="sxs-lookup"><span data-stu-id="3151f-197">It is not recommended toouse `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition toorestore hello entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="3151f-198">Replikering av skadade programdata</span><span class="sxs-lookup"><span data-stu-id="3151f-198">Replication of corrupt application data</span></span>
<span data-ttu-id="3151f-199">Om uppgradering av hello nyligen distribuerade programmet har ett programfel, som kan orsaka skadade data.</span><span class="sxs-lookup"><span data-stu-id="3151f-199">If hello newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="3151f-200">Till exempel kan en uppgradering av programmet starta tooupdate alla telefonpost i en tillförlitlig ordlista med ett ogiltigt riktnummer.</span><span class="sxs-lookup"><span data-stu-id="3151f-200">For example, an application upgrade may start tooupdate every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="3151f-201">I det här fallet replikeras hello ogiltiga telefonnummer sedan Service Fabric inte är medveten om hello slags hello data som lagras.</span><span class="sxs-lookup"><span data-stu-id="3151f-201">In this case, hello invalid phone numbers will be replicated since Service Fabric is not aware of hello nature of hello data that is being stored.</span></span>

<span data-ttu-id="3151f-202">hello först öppna toodo när du identifiera sådana en flagranta programfel som gör att data skadas är toofreeze hello-tjänst på programnivå hello och, om möjligt uppgradera toohello version av hello programkod som saknar hello programfel.</span><span class="sxs-lookup"><span data-stu-id="3151f-202">hello first thing toodo after you detect such an egregious bug that causes data corruption is toofreeze hello service at hello application level and, if possible, upgrade toohello version of hello application code that does not have hello bug.</span></span>  <span data-ttu-id="3151f-203">Även efter hello service-koden är fast, hello data kan fortfarande vara skadade och därmed data måste toobe återställs.</span><span class="sxs-lookup"><span data-stu-id="3151f-203">However, even after hello service code is fixed, hello data may still be corrupt and thus data may need toobe restored.</span></span>  <span data-ttu-id="3151f-204">I sådana fall kan kanske det inte tillräckligt toorestore hello senaste säkerhetskopiering, eftersom hello senaste säkerhetskopieringar kan också vara skadad.</span><span class="sxs-lookup"><span data-stu-id="3151f-204">In such cases, it may not be sufficient toorestore hello latest backup, since hello latest backups may also be corrupt.</span></span>  <span data-ttu-id="3151f-205">Du har alltså toofind hello senaste säkerhetskopia som togs innan hello data har skadats.</span><span class="sxs-lookup"><span data-stu-id="3151f-205">Thus, you have toofind hello last backup that was made before hello data got corrupted.</span></span>

<span data-ttu-id="3151f-206">Om du inte är säker på vilken säkerhetskopior är skadade kan du distribuera ett nytt Service Fabric-kluster och återställa hello säkerhetskopior av berörda partitioner precis som hello ovan ”Borttaget eller förlorade service” scenario.</span><span class="sxs-lookup"><span data-stu-id="3151f-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore hello backups of affected partitions just like hello above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="3151f-207">Börja återställa hello säkerhetskopior från hello senaste toohello minst för varje partition.</span><span class="sxs-lookup"><span data-stu-id="3151f-207">For each partition, start restoring hello backups from hello most recent toohello least.</span></span> <span data-ttu-id="3151f-208">När du har hittat en säkerhetskopiering som inte har hello skadade flytta/ta bort alla säkerhetskopior för den här partitionen som var (än att säkerhetskopiering).</span><span class="sxs-lookup"><span data-stu-id="3151f-208">Once you find a backup that does not have hello corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="3151f-209">Upprepa proceduren för varje partition.</span><span class="sxs-lookup"><span data-stu-id="3151f-209">Repeat this process for each partition.</span></span> <span data-ttu-id="3151f-210">Nu när `OnDataLossAsync` anropas på hello partitionen i hello produktionskluster hello senaste säkerhetskopia finns hello externa arkivet ska vara hello en utvald av hello ovan processen.</span><span class="sxs-lookup"><span data-stu-id="3151f-210">Now, when `OnDataLossAsync` is called on hello partition in hello production cluster, hello last backup found in hello external store will be hello one picked by hello above process.</span></span>

<span data-ttu-id="3151f-211">Nu hello stegen i hello ”Deleted eller förlorade service” kan vara användas toorestore hello tillstånd hello Tjänststatus toohello innan hello buggy kod skadad hello tillstånd.</span><span class="sxs-lookup"><span data-stu-id="3151f-211">Now, hello steps in hello "Deleted or lost service" section can be used toorestore hello state of hello service toohello state before hello buggy code corrupted hello state.</span></span>

<span data-ttu-id="3151f-212">Tänk på följande:</span><span class="sxs-lookup"><span data-stu-id="3151f-212">Note that:</span></span>

  - <span data-ttu-id="3151f-213">När du återställer är det används en risk att hello säkerhetskopia återställs äldre än hello tillståndet för hello partitionen innan hello data gick förlorade.</span><span class="sxs-lookup"><span data-stu-id="3151f-213">When you restore, there is a chance that hello backup being restored is older than hello state of hello partition before hello data was lost.</span></span> <span data-ttu-id="3151f-214">Därför bör du återställa endast som en sista utväg toorecover så mycket data som möjligt.</span><span class="sxs-lookup"><span data-stu-id="3151f-214">Because of this, you should restore only as a last resort toorecover as much data as possible.</span></span>
  - <span data-ttu-id="3151f-215">hello sträng som representerar hello säkerhetskopiering mappsökvägen och hello sökvägar för filer i hello säkerhetskopieringsmappen kan vara större än 255 tecken, beroende på hello FabricDataRoot sökväg och programtyp namnlängd.</span><span class="sxs-lookup"><span data-stu-id="3151f-215">hello string that represents hello backup folder path and hello paths of files inside hello backup folder can be greater than 255 characters, depending on hello FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="3151f-216">Detta kan orsaka vissa .NET-metoder som `Directory.Move`, toothrow hello `PathTooLongException` undantag.</span><span class="sxs-lookup"><span data-stu-id="3151f-216">This can cause some .NET methods, like `Directory.Move`, toothrow hello `PathTooLongException` exception.</span></span> <span data-ttu-id="3151f-217">En lösning är toodirectly anropa kernel32 API: er, som `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="3151f-217">One workaround is toodirectly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="3151f-218">Säkerhetskopiering och återställning Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="3151f-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="3151f-219">Tillförlitliga aktörer Framework bygger på Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="3151f-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="3151f-220">Hej ActorService som är värd för hello actor(s) är en tillståndskänslig tillförlitlig tjänst.</span><span class="sxs-lookup"><span data-stu-id="3151f-220">hello ActorService which hosts hello actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="3151f-221">Därför måste alla hello säkerhetskopiering och återställning tillgängliga funktioner i Reliable Services är också tillgängliga tooReliable aktörer (utom beteenden som är specifika för tillståndsprovidern).</span><span class="sxs-lookup"><span data-stu-id="3151f-221">Hence, all hello backup and restore functionality available in Reliable Services is also available tooReliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="3151f-222">Eftersom säkerhetskopior kommer att vidtas på grundval av per partition, tillstånd för alla aktörer i att partition ska säkerhetskopieras (och återställningen liknar och sker på grundval av per partition).</span><span class="sxs-lookup"><span data-stu-id="3151f-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="3151f-223">tooperform säkerhetskopiering/återställning hello tjänstens ägare ska skapa en anpassad aktören service-klass som härleds från klassen ActorService och sedan säkerhetskopiering/återställning liknande tooReliable tjänster enligt beskrivningen ovan i föregående avsnitt.</span><span class="sxs-lookup"><span data-stu-id="3151f-223">tooperform backup/restore, hello service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar tooReliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="3151f-224">När du skapar en anpassad aktören tjänsteklass måste tooregister som också när du registrerar hello aktören.</span><span class="sxs-lookup"><span data-stu-id="3151f-224">When you create a custom actor service class, you need tooregister that as well when registering hello actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="3151f-225">hello tillstånd standardprovidern för Reliable Actors är `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="3151f-225">hello default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="3151f-226">Inkrementell säkerhetskopiering är inte aktiverad som standard för `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="3151f-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="3151f-227">Du kan aktivera inkrementell säkerhetskopiering genom att skapa `KvsActorStateProvider` med hello lämpliga inställningen i sin konstruktor och sedan överföra tooActorService konstruktorn enligt följande kodavsnitt:</span><span class="sxs-lookup"><span data-stu-id="3151f-227">You can enable incremental backup by creating `KvsActorStateProvider` with hello appropriate setting in its constructor and then passing it tooActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="3151f-228">När inkrementell säkerhetskopiering har aktiverats, tar en inkrementell säkerhetskopia kan misslyckas med FabricMissingFullBackupException av något av följande skäl och tootake en fullständig säkerhetskopiering behöver innan du tar inkrementella säkerhetskopiorna:</span><span class="sxs-lookup"><span data-stu-id="3151f-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need tootake a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="3151f-229">hello replik har aldrig tagit en fullständig säkerhetskopiering eftersom den blev primära.</span><span class="sxs-lookup"><span data-stu-id="3151f-229">hello replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="3151f-230">Vissa av hello loggposter trunkerades eftersom senaste säkerhetskopian skapades.</span><span class="sxs-lookup"><span data-stu-id="3151f-230">Some of hello log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="3151f-231">När inkrementell säkerhetskopiering är aktiverad `KvsActorStateProvider` använder inte cirkulär buffert toomanage loggen innehåller information och trunkerar den regelbundet.</span><span class="sxs-lookup"><span data-stu-id="3151f-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer toomanage its log records and periodically truncates it.</span></span> <span data-ttu-id="3151f-232">Om ingen säkerhetskopia är upptaget av användaren under 45 minuter, trunkerar hello system automatiskt hello loggposter.</span><span class="sxs-lookup"><span data-stu-id="3151f-232">If no backup is taken by user for a period of 45 minutes, hello system automatically truncates hello log records.</span></span> <span data-ttu-id="3151f-233">Intervallet kan konfigureras genom att ange `logTrunctationIntervalInMinutes` i `KvsActorStateProvider` konstruktor (liknande toowhen aktiverar inkrementell säkerhetskopiering).</span><span class="sxs-lookup"><span data-stu-id="3151f-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar toowhen enabling incremental backup).</span></span> <span data-ttu-id="3151f-234">också kan hämta trunkerade hello loggposter om primära repliken behöver toobuild en annan replik genom att skicka alla data.</span><span class="sxs-lookup"><span data-stu-id="3151f-234">hello log records may also get truncated if primary replica need toobuild another replica by sending all its data.</span></span>

<span data-ttu-id="3151f-235">När du gör återställningen från en säkerhetskopiering kedja liknande tooReliable tjänster ska hello BackupFolderPath innehålla underkataloger med en underkatalog med fullständig säkerhetskopiering och andra underkataloger som innehåller inkrementella säkerhetskopiorna.</span><span class="sxs-lookup"><span data-stu-id="3151f-235">When doing restore from a backup chain, similar tooReliable Services, hello BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="3151f-236">hello återställning API genereras FabricException med ett meddelande om hello loggsäkerhetskopieringssekvensen valideringen misslyckas.</span><span class="sxs-lookup"><span data-stu-id="3151f-236">hello restore API will throw FabricException with appropriate error message if hello backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="3151f-237">`KvsActorStateProvider`ignorerar för tillfället hello alternativet RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="3151f-237">`KvsActorStateProvider` currently ignores hello option RestorePolicy.Safe.</span></span> <span data-ttu-id="3151f-238">Stöd för den här funktionen är planerad i en kommande version.</span><span class="sxs-lookup"><span data-stu-id="3151f-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="3151f-239">Testa säkerhetskopiering och återställning</span><span class="sxs-lookup"><span data-stu-id="3151f-239">Testing Backup and Restore</span></span>
<span data-ttu-id="3151f-240">Det är viktigt tooensure som kritiska data säkerhetskopieras och återställas från.</span><span class="sxs-lookup"><span data-stu-id="3151f-240">It is important tooensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="3151f-241">Detta kan göras genom att anropa hello `Start-ServiceFabricPartitionDataLoss` cmdlet i PowerShell som kan orsaka dataförlust i en viss partition tootest om hello data säkerhetskopiera och återställa funktioner för tjänsten fungerar som förväntat.</span><span class="sxs-lookup"><span data-stu-id="3151f-241">This can be done by invoking hello `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition tootest whether hello data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="3151f-242">Det är också möjligt tooprogrammatically anropa förlust av data och återställa från händelsen samt.</span><span class="sxs-lookup"><span data-stu-id="3151f-242">It is also possible tooprogrammatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="3151f-243">Du kan hitta ett exempel på implementering av säkerhetskopiering och återställning av funktioner i hello referens webbprogrammet på GitHub.</span><span class="sxs-lookup"><span data-stu-id="3151f-243">You can find a sample implementation of backup and restore functionality in hello Web Reference App on GitHub.</span></span> <span data-ttu-id="3151f-244">Tittar du på hello `Inventory.Service` tjänsten för mer information.</span><span class="sxs-lookup"><span data-stu-id="3151f-244">Please look at hello `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-hello-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="3151f-245">Under huven hello: Mer information om säkerhetskopiering och återställning</span><span class="sxs-lookup"><span data-stu-id="3151f-245">Under hello hood: more details on backup and restore</span></span>
<span data-ttu-id="3151f-246">Här är några mer information om säkerhetskopiering och återställning.</span><span class="sxs-lookup"><span data-stu-id="3151f-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="3151f-247">Säkerhetskopiering</span><span class="sxs-lookup"><span data-stu-id="3151f-247">Backup</span></span>
<span data-ttu-id="3151f-248">hello tillförlitliga Tillståndshanterare ger hello möjlighet toocreate konsekvent säkerhetskopieringar utan att blockera alla läsa eller skrivåtgärder.</span><span class="sxs-lookup"><span data-stu-id="3151f-248">hello Reliable State Manager provides hello ability toocreate consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="3151f-249">toodo så, den använder en mekanism för datapersistence kontrollpunkts- och loggfiler.</span><span class="sxs-lookup"><span data-stu-id="3151f-249">toodo so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="3151f-250">hello tillförlitliga Tillståndshanterare tar fuzzy (lightweight) kontrollpunkter vid vissa punkter toorelieve tryck från hello transaktionella loggen och förbättra återställningstiden.</span><span class="sxs-lookup"><span data-stu-id="3151f-250">hello Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points toorelieve pressure from hello transactional log and improve recovery times.</span></span>  <span data-ttu-id="3151f-251">När `BackupAsync` anropas, hello tillförlitliga Tillståndshanterare instruerar alla tillförlitliga objekt toocopy deras senaste kontrollpunkten tooa lokala backup-mappen.</span><span class="sxs-lookup"><span data-stu-id="3151f-251">When `BackupAsync` is called, hello Reliable State Manager instructs all Reliable objects toocopy their latest checkpoint files tooa local backup folder.</span></span>  <span data-ttu-id="3151f-252">Hello tillförlitliga Tillståndshanterare kopierar sedan alla loggposter från hello ”start pekaren” toohello senaste loggpost till hello säkerhetskopieringsmappen.</span><span class="sxs-lookup"><span data-stu-id="3151f-252">Then, hello Reliable State Manager copies all log records, starting from hello "start pointer" toohello latest log record into hello backup folder.</span></span>  <span data-ttu-id="3151f-253">Eftersom alla hello loggposter in toohello senaste loggpost ingår i hello säkerhetskopiering och hello tillförlitliga Tillståndshanterare bevarar write-ahead loggning, hello tillförlitliga Tillståndshanterare garanterar att alla transaktioner som genomförs (`CommitAsync` returnerade har) ingår i hello säkerhetskopiering.</span><span class="sxs-lookup"><span data-stu-id="3151f-253">Since all hello log records up toohello latest log record are included in hello backup and hello Reliable State Manager preserves write-ahead logging, hello Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in hello backup.</span></span>

<span data-ttu-id="3151f-254">En transaktion som sparar efter `BackupAsync` har anropats kanske eller kanske inte hello säkerhetskopiering.</span><span class="sxs-lookup"><span data-stu-id="3151f-254">Any transaction that commits after `BackupAsync` has been called may or may not be in hello backup.</span></span>  <span data-ttu-id="3151f-255">När hello lokala säkerhetskopieringsmappen har fyllts av hello-plattformen (d.v.s. lokal säkerhetskopiering har slutförts av hello runtime) hello service säkerhetskopiering återanropet anropas.</span><span class="sxs-lookup"><span data-stu-id="3151f-255">Once hello local backup folder has been populated by hello platform (i.e., local backup is completed by hello runtime), hello service's backup callback is invoked.</span></span>  <span data-ttu-id="3151f-256">Den här återanrop ansvarar för att flytta hello säkerhetskopieringsmappen tooan extern plats, till exempel Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="3151f-256">This callback is responsible for moving hello backup folder tooan external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="3151f-257">Återställ</span><span class="sxs-lookup"><span data-stu-id="3151f-257">Restore</span></span>
<span data-ttu-id="3151f-258">hello tillförlitliga Tillståndshanterare innehåller hello möjlighet toorestore från en säkerhetskopia med hello `RestoreAsync` API.</span><span class="sxs-lookup"><span data-stu-id="3151f-258">hello Reliable State Manager provides hello ability toorestore from a backup by using hello `RestoreAsync` API.</span></span>  
<span data-ttu-id="3151f-259">Hej `RestoreAsync` metod på `RestoreContext` kan endast anropas inuti hello `OnDataLossAsync` metod.</span><span class="sxs-lookup"><span data-stu-id="3151f-259">hello `RestoreAsync` method on `RestoreContext` can be called only inside hello `OnDataLossAsync` method.</span></span>
<span data-ttu-id="3151f-260">Hej bool som returneras av `OnDataLossAsync` anger om hello tjänsten återställd dess tillstånd från en extern källa.</span><span class="sxs-lookup"><span data-stu-id="3151f-260">hello bool returned by `OnDataLossAsync` indicates whether hello service restored its state from an external source.</span></span>
<span data-ttu-id="3151f-261">Om hello `OnDataLossAsync` returnerar true, Service Fabric återskapar alla andra repliker från denna primära Server.</span><span class="sxs-lookup"><span data-stu-id="3151f-261">If hello `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="3151f-262">Service Fabric säkerställer att repliker som tar emot `OnDataLossAsync` anropa första övergången toohello primära rollen men inte beviljas läses status eller skriva status.</span><span class="sxs-lookup"><span data-stu-id="3151f-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition toohello primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="3151f-263">Detta innebär att för StatefulService implementerare `RunAsync` inte anropas förrän `OnDataLossAsync` har slutförts.</span><span class="sxs-lookup"><span data-stu-id="3151f-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="3151f-264">Sedan `OnDataLossAsync` kommer att anropas på hello nya primära.</span><span class="sxs-lookup"><span data-stu-id="3151f-264">Then, `OnDataLossAsync` will be invoked on hello new primary.</span></span>
<span data-ttu-id="3151f-265">Tills en tjänst är slutförd detta API har (genom att returnera true eller false) och är klar hello relevanta omkonfiguration, kommer hello API att anropas i taget.</span><span class="sxs-lookup"><span data-stu-id="3151f-265">Until a service completes this API successfully (by returning true or false) and finishes hello relevant reconfiguration, hello API will keep being called one at a time.</span></span>

<span data-ttu-id="3151f-266">`RestoreAsync`först utelämnar alla befintliga tillstånd i hello primära repliken som den anropades på.</span><span class="sxs-lookup"><span data-stu-id="3151f-266">`RestoreAsync` first drops all existing state in hello primary replica that it was called on.</span></span>  
<span data-ttu-id="3151f-267">Hello tillförlitliga Tillståndshanterare skapar sedan alla tillförlitliga hello-objekt som finns i hello säkerhetskopieringsmappen.</span><span class="sxs-lookup"><span data-stu-id="3151f-267">Then hello Reliable State Manager creates all hello Reliable objects that exist in hello backup folder.</span></span>  
<span data-ttu-id="3151f-268">Hello tillförlitliga objekt är sedan instrueras toorestore från deras kontrollpunkter i hello säkerhetskopieringsmappen.</span><span class="sxs-lookup"><span data-stu-id="3151f-268">Next, hello Reliable objects are instructed toorestore from their checkpoints in hello backup folder.</span></span>  
<span data-ttu-id="3151f-269">Slutligen hello tillförlitliga Tillståndshanterare återställer dess egna tillstånd från hello loggposter i hello säkerhetskopieringsmappen och utför återställningen.</span><span class="sxs-lookup"><span data-stu-id="3151f-269">Finally, hello Reliable State Manager recovers its own state from hello log records in hello backup folder and performs recovery.</span></span>  
<span data-ttu-id="3151f-270">Som en del av återställningsprocessen hello är åtgärder från hello ”startpunkt” som har commit loggposter i hello säkerhetskopieringsmappen upprepat toohello tillförlitliga objekt.</span><span class="sxs-lookup"><span data-stu-id="3151f-270">As part of hello recovery process, operations starting from hello "starting point" that have commit log records in hello backup folder are replayed toohello Reliable objects.</span></span>  
<span data-ttu-id="3151f-271">Det här steget säkerställer att hello återställda är konsekvent.</span><span class="sxs-lookup"><span data-stu-id="3151f-271">This step ensures that hello recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="3151f-272">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="3151f-272">Next steps</span></span>
  - [<span data-ttu-id="3151f-273">Tillförlitliga samlingar</span><span class="sxs-lookup"><span data-stu-id="3151f-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="3151f-274">Snabbstart för Reliable Services</span><span class="sxs-lookup"><span data-stu-id="3151f-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="3151f-275">Reliable Services-meddelanden</span><span class="sxs-lookup"><span data-stu-id="3151f-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="3151f-276">Tillförlitliga tjänstkonfiguration</span><span class="sxs-lookup"><span data-stu-id="3151f-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="3151f-277">För utvecklare för tillförlitlig samlingar</span><span class="sxs-lookup"><span data-stu-id="3151f-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

