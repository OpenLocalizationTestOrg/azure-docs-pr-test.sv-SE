---
title: "Service Fabric-säkerhetskopiering och återställning | Microsoft Docs"
description: "Konceptuell dokumentationen för Service Fabric-säkerhetskopiering och återställning"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: 4242962e7e03053ef25f198a0b2f6c8012e693eb
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 08/29/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="b74d7-103">Säkerhetskopiera och återställa Reliable Services och Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="b74d7-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="b74d7-104">Azure Service Fabric är en plattform för hög tillgänglighet som replikerar tillståndet över flera noder för att upprätthålla hög tillgänglighet.</span><span class="sxs-lookup"><span data-stu-id="b74d7-104">Azure Service Fabric is a high-availability platform that replicates the state across multiple nodes to maintain this high availability.</span></span>  <span data-ttu-id="b74d7-105">Även om en nod i klustret misslyckas därför fortsätter tjänster att vara tillgängliga.</span><span class="sxs-lookup"><span data-stu-id="b74d7-105">Thus, even if one node in the cluster fails, the services continue to be available.</span></span> <span data-ttu-id="b74d7-106">Den här inbyggda redundans som tillhandahålls av plattformen kan vara tillräcklig för vissa, i vissa fall är det lämpligt att tjänsten för att säkerhetskopiera data (till en extern butik).</span><span class="sxs-lookup"><span data-stu-id="b74d7-106">While this in-built redundancy provided by the platform may be sufficient for some, in certain cases it is desirable for the service to back up data (to an external store).</span></span>

> [!NOTE]
> <span data-ttu-id="b74d7-107">Det är viktigt att säkerhetskopiera och återställa dina data (och testa att det fungerar som förväntat) så att du kan återställa från data går förlorade.</span><span class="sxs-lookup"><span data-stu-id="b74d7-107">It is critical to backup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="b74d7-108">En tjänst kan till exempel vill säkerhetskopiera data för att skydda mot följande scenarier:</span><span class="sxs-lookup"><span data-stu-id="b74d7-108">For example, a service may want to back up data in order to protect from the following scenarios:</span></span>

- <span data-ttu-id="b74d7-109">Om en hel Service Fabric-klustret permanent förlorade.</span><span class="sxs-lookup"><span data-stu-id="b74d7-109">In the event of the permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="b74d7-110">Permanent förlorade en majoritet av replikerna för en partition för tjänsten</span><span class="sxs-lookup"><span data-stu-id="b74d7-110">Permanent loss of a majority of the replicas of a service partition</span></span>
- <span data-ttu-id="b74d7-111">Administrativa fel där tillståndet hämtar eller förstörs.</span><span class="sxs-lookup"><span data-stu-id="b74d7-111">Administrative errors whereby the state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="b74d7-112">T.ex, kan detta inträffa om en administratör med tillräcklig behörighet för felaktigt tar bort tjänsten.</span><span class="sxs-lookup"><span data-stu-id="b74d7-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes the service.</span></span>
- <span data-ttu-id="b74d7-113">Programfel i tjänsten som kan orsakar att data skadas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-113">Bugs in the service that cause data corruption.</span></span> <span data-ttu-id="b74d7-114">Det kan till exempel hända när en tjänst koduppgradering startas felaktiga data skrivs till en tillförlitlig samling.</span><span class="sxs-lookup"><span data-stu-id="b74d7-114">For example, this may happen when a service code upgrade starts writing faulty data to a Reliable Collection.</span></span> <span data-ttu-id="b74d7-115">I sådana fall kanske både koden och data återställas till ett tidigare tillstånd.</span><span class="sxs-lookup"><span data-stu-id="b74d7-115">In such a case, both the code and the data may have to be reverted to an earlier state.</span></span>
- <span data-ttu-id="b74d7-116">Offline databearbetning.</span><span class="sxs-lookup"><span data-stu-id="b74d7-116">Offline data processing.</span></span> <span data-ttu-id="b74d7-117">Det kan vara praktiskt att ha offline bearbetning av data för business intelligence som sker separat från den tjänst som genererar data.</span><span class="sxs-lookup"><span data-stu-id="b74d7-117">It might be convenient to have offline processing of data for business intelligence that happens separately from the service that generates the data.</span></span>

<span data-ttu-id="b74d7-118">Funktionen säkerhetskopiering/återställning kan tjänster som bygger på tillförlitliga Services-API för att skapa och återställa säkerhetskopior.</span><span class="sxs-lookup"><span data-stu-id="b74d7-118">The Backup/Restore feature allows services built on the Reliable Services API to create and restore backups.</span></span> <span data-ttu-id="b74d7-119">Säkerhetskopiering API: erna som tillhandahålls av plattformens Tillåt säkerhetskopiorna av en tjänst partition tillstånd, utan blockerar Läs- eller skrivåtgärder.</span><span class="sxs-lookup"><span data-stu-id="b74d7-119">The backup APIs provided by the platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="b74d7-120">Återställningen API: er kan en tjänst partition tillstånd och kan inte återställas från en säkerhetskopia av valda.</span><span class="sxs-lookup"><span data-stu-id="b74d7-120">The restore APIs allow a service partition's state to be restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="b74d7-121">Typer av säkerhetskopiering</span><span class="sxs-lookup"><span data-stu-id="b74d7-121">Types of Backup</span></span>
<span data-ttu-id="b74d7-122">Det finns två alternativ för säkerhetskopiering: fullständig och inkrementell.</span><span class="sxs-lookup"><span data-stu-id="b74d7-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="b74d7-123">En fullständig säkerhetskopia är en säkerhetskopia som innehåller de data som krävs för att återskapa tillståndet för repliken: kontrollpunkter och alla loggposter.</span><span class="sxs-lookup"><span data-stu-id="b74d7-123">A full backup is a backup that contains all the data required to recreate the state of the replica: checkpoints and all log records.</span></span>
<span data-ttu-id="b74d7-124">Eftersom den har kontrollpunkter och loggfilen, kan du återställa en fullständig säkerhetskopia ensamt.</span><span class="sxs-lookup"><span data-stu-id="b74d7-124">Since it has the checkpoints and the log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="b74d7-125">Problem med fullständiga säkerhetskopieringar uppstår när kontrollpunkter är stora.</span><span class="sxs-lookup"><span data-stu-id="b74d7-125">The problem with full backups arises when the checkpoints are large.</span></span>
<span data-ttu-id="b74d7-126">Till exempel en replik som har 16 GB tillstånd har kontrollpunkter som lägga upp cirka till 16 GB.</span><span class="sxs-lookup"><span data-stu-id="b74d7-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately to 16 GB.</span></span>
<span data-ttu-id="b74d7-127">Om vi har ett mål för återställningspunkt fem minuter måste repliken säkerhetskopieras var femte minut.</span><span class="sxs-lookup"><span data-stu-id="b74d7-127">If we have a Recovery Point Objective of five minutes, the replica needs to be backed up every five minutes.</span></span>
<span data-ttu-id="b74d7-128">Varje gång den säkerhetskopierar som behövs för att kopiera 16 GB kontrollpunkter förutom 50 MB (kan konfigureras med hjälp av `CheckpointThresholdInMB`) med loggar.</span><span class="sxs-lookup"><span data-stu-id="b74d7-128">Each time it backs up it needs to copy 16 GB of checkpoints in addition to 50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Fullständig säkerhetskopiering exempel.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="b74d7-130">Lösning på problemet är inkrementella säkerhetskopieringar där säkerhetskopian innehåller endast de ändrade posterna sedan den senaste säkerhetskopieringen.</span><span class="sxs-lookup"><span data-stu-id="b74d7-130">The solution to this problem is incremental backups, where backup only contains the changed log records since the last backup.</span></span>

![Exempel för inkrementell säkerhetskopiering.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="b74d7-132">Eftersom säkerhetskopior är endast ändringar sedan den senaste säkerhetskopieringen (inte omfattar kontrollpunkter) är de brukar gå snabbare, men kan inte återställas på egen hand.</span><span class="sxs-lookup"><span data-stu-id="b74d7-132">Since incremental backups are only changes since the last backup (does not include the checkpoints), they tend to be faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="b74d7-133">Om du vill återställa en inkrementell krävs säkerhetskopiering hela kedjan.</span><span class="sxs-lookup"><span data-stu-id="b74d7-133">To restore an incremental backup, the entire backup chain is required.</span></span>
<span data-ttu-id="b74d7-134">En säkerhetskopiering kedja följt av ett antal sammanhängande inkrementella säkerhetskopieringar är en kedja av säkerhetskopior som börjar med en fullständig säkerhetskopia.</span><span class="sxs-lookup"><span data-stu-id="b74d7-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="b74d7-135">Säkerhetskopiering Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b74d7-135">Backup Reliable Services</span></span>
<span data-ttu-id="b74d7-136">Tjänsten författaren har fullständig kontroll över när säkerhetskopior och där säkerhetskopiorna lagras.</span><span class="sxs-lookup"><span data-stu-id="b74d7-136">The service author has full control of when to make backups and where backups will be stored.</span></span>

<span data-ttu-id="b74d7-137">Om du vill starta en säkerhetskopiering tjänsten måste anropa funktionen ärvda medlemmen `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-137">To start a backup, the service needs to invoke the inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="b74d7-138">Säkerhetskopieringar kan göras från primära repliker och de behöver skrivstatus för att beviljas åtkomst.</span><span class="sxs-lookup"><span data-stu-id="b74d7-138">Backups can be made only from primary replicas, and they require write status to be granted.</span></span>

<span data-ttu-id="b74d7-139">Enligt nedan, `BackupAsync` tar in en `BackupDescription` objekt, där en kan ange en fullständig eller inkrementell säkerhetskopiering, samt en Återanropsfunktionen, `Func<< BackupInfo, CancellationToken, Task<bool>>>` som anropas när mappen har skapats lokalt och är redo att flytta till vissa extern lagring.</span><span class="sxs-lookup"><span data-stu-id="b74d7-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when the backup folder has been created locally and is ready to be moved out to some external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="b74d7-140">Begäran om att få en inkrementell säkerhetskopia kan misslyckas med `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-140">Request to take an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="b74d7-141">Det här undantaget anger att en av följande händer:</span><span class="sxs-lookup"><span data-stu-id="b74d7-141">This exception indicates that one of the following things is happening:</span></span>

- <span data-ttu-id="b74d7-142">repliken har aldrig tagit en fullständig säkerhetskopiering eftersom det har blivit primära,</span><span class="sxs-lookup"><span data-stu-id="b74d7-142">the replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="b74d7-143">Vissa av loggposter sedan den senaste säkerhetskopieringen har trunkerats eller</span><span class="sxs-lookup"><span data-stu-id="b74d7-143">some of the log records since the last backup has been truncated or</span></span>
- <span data-ttu-id="b74d7-144">repliken som skickades i `MaxAccumulatedBackupLogSizeInMB` gränsen.</span><span class="sxs-lookup"><span data-stu-id="b74d7-144">replica passed the `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="b74d7-145">Användare kan öka sannolikheten för att kunna göra inkrementella säkerhetskopieringar genom att konfigurera `MinLogSizeInMB` eller `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-145">Users can increase the likelihood of being able to do incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="b74d7-146">Observera att öka dessa värden ökar den per replik diskanvändning.</span><span class="sxs-lookup"><span data-stu-id="b74d7-146">Note that increasing these values increases the per replica disk usage.</span></span>
<span data-ttu-id="b74d7-147">Mer information finns i [Reliable Services-konfiguration](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="b74d7-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="b74d7-148">`BackupInfo`innehåller information om säkerhetskopiering, inklusive sökvägen till mappen där körningsmiljön sparade säkerhetskopieringen (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="b74d7-148">`BackupInfo` provides information regarding the backup, including the location of the folder where the runtime saved the backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="b74d7-149">Återanropsfunktionen kan flytta den `BackupInfo.Directory` till en annan plats eller en extern butik.</span><span class="sxs-lookup"><span data-stu-id="b74d7-149">The callback function can move the `BackupInfo.Directory` to an external store or another location.</span></span>  <span data-ttu-id="b74d7-150">Den här funktionen returnerar också bool som anger om kunde för att flytta säkerhetskopieringsmappen till dess målplats.</span><span class="sxs-lookup"><span data-stu-id="b74d7-150">This function also returns a bool that indicates whether it was able to successfully move the backup folder to its target location.</span></span>

<span data-ttu-id="b74d7-151">Följande kod visar hur `BackupCallbackAsync` metoden kan användas för att ladda upp säkerhetskopian till Azure Storage:</span><span class="sxs-lookup"><span data-stu-id="b74d7-151">The following code demonstrates how the `BackupCallbackAsync` method can be used to upload the backup to Azure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="b74d7-152">I det föregående exemplet `ExternalBackupStore` är exempel klass som används för gränssnittet med Azure Blob storage och `UploadBackupFolderAsync` är den metod som komprimerar mappen och placerar den i Azure Blob store.</span><span class="sxs-lookup"><span data-stu-id="b74d7-152">In the preceeding example, `ExternalBackupStore` is the sample class that is used to interface with Azure Blob storage, and `UploadBackupFolderAsync` is the method that compresses the folder and places it in the Azure Blob store.</span></span>

<span data-ttu-id="b74d7-153">Tänk på följande:</span><span class="sxs-lookup"><span data-stu-id="b74d7-153">Note that:</span></span>

  - <span data-ttu-id="b74d7-154">Det kan finnas endast en säkerhetskopiering relä per replikering vid en given tidpunkt.</span><span class="sxs-lookup"><span data-stu-id="b74d7-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="b74d7-155">Mer än en `BackupAsync` samtal i taget genereras `FabricBackupInProgressException` att begränsa inflight säkerhetskopieringar till en.</span><span class="sxs-lookup"><span data-stu-id="b74d7-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` to limit inflight backups to one.</span></span>
  - <span data-ttu-id="b74d7-156">Om en replik misslyckas över när en säkerhetskopiering pågår kan säkerhetskopieringen inte har slutförts.</span><span class="sxs-lookup"><span data-stu-id="b74d7-156">If a replica fails over while a backup is in progress, the backup may not have been completed.</span></span> <span data-ttu-id="b74d7-157">Därför när redundansväxlingen är klar, är det tjänstens ansvar för att starta om säkerhetskopieringen genom att anropa `BackupAsync` efter behov.</span><span class="sxs-lookup"><span data-stu-id="b74d7-157">Thus, once the failover finishes, it is the service's responsibility to restart the backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="b74d7-158">Återställa Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b74d7-158">Restore Reliable Services</span></span>
<span data-ttu-id="b74d7-159">I allmänhet indelas fall när du kan behöva utföra återställningsåtgärder i dessa kategorier:</span><span class="sxs-lookup"><span data-stu-id="b74d7-159">In general, the cases when you might need to perform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="b74d7-160">Tjänsten partitionera förlorade data.</span><span class="sxs-lookup"><span data-stu-id="b74d7-160">The service partition lost data.</span></span> <span data-ttu-id="b74d7-161">Disken för två av tre repliker för en partition (inklusive den primära repliken) hämtar skadad eller rensas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-161">For example, the disk for two out of three replicas for a partition (including the primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="b74d7-162">Den nya primärt kan behöva återställa data från en säkerhetskopia.</span><span class="sxs-lookup"><span data-stu-id="b74d7-162">The new primary may need to restore data from a backup.</span></span>
  - <span data-ttu-id="b74d7-163">Hela tjänsten går förlorad.</span><span class="sxs-lookup"><span data-stu-id="b74d7-163">The entire service is lost.</span></span> <span data-ttu-id="b74d7-164">Till exempel en administratör tar bort hela tjänsten och därmed tjänsten och data ska återställas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-164">For example, an administrator removes the entire service and thus the service and the data need to be restored.</span></span>
  - <span data-ttu-id="b74d7-165">Tjänsten replikerade skadad programdata (t.ex. på grund av ett fel i programmet).</span><span class="sxs-lookup"><span data-stu-id="b74d7-165">The service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="b74d7-166">I det här fallet har tjänsten ska uppgraderas eller för att ta bort orsaken till felet har återställts och icke skadade data måste återställas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-166">In this case, the service has to be upgraded or reverted to remove the cause of the corruption, and non-corrupt data has to be restored.</span></span>

<span data-ttu-id="b74d7-167">Medan flera metoder är möjligt, vi erbjuder några exempel på med `RestoreAsync` att återställa från ovannämnda scenarier.</span><span class="sxs-lookup"><span data-stu-id="b74d7-167">While many approaches are possible, we offer some examples on using `RestoreAsync` to recover from the above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="b74d7-168">Partitionen dataförlust i Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b74d7-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="b74d7-169">I det här fallet körningsmiljön skulle automatiskt identifiera data går förlorade och anropa den `OnDataLossAsync` API.</span><span class="sxs-lookup"><span data-stu-id="b74d7-169">In this case, the runtime would automatically detect the data loss and invoke the `OnDataLossAsync` API.</span></span>

<span data-ttu-id="b74d7-170">Tjänsten författare behöver för att utföra följande för att återställa:</span><span class="sxs-lookup"><span data-stu-id="b74d7-170">The service author needs to perform the following to recover:</span></span>

  - <span data-ttu-id="b74d7-171">Åsidosätta metoden virtuella basklass `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-171">Override the virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="b74d7-172">Hitta den senaste säkerhetskopian i den externa platsen som innehåller säkerhetskopior av tjänsten.</span><span class="sxs-lookup"><span data-stu-id="b74d7-172">Find the latest backup in the external location that contains the service's backups.</span></span>
  - <span data-ttu-id="b74d7-173">Hämta den senaste säkerhetskopian (och packa säkerhetskopieringen i mappen om den har komprimerats).</span><span class="sxs-lookup"><span data-stu-id="b74d7-173">Download the latest backup (and uncompress the backup into the backup folder if it was compressed).</span></span>
  - <span data-ttu-id="b74d7-174">Den `OnDataLossAsync` metoden ger ett `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-174">The `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="b74d7-175">Anropa den `RestoreAsync` API på angiven `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-175">Call the `RestoreAsync` API on the provided `RestoreContext`.</span></span>
  - <span data-ttu-id="b74d7-176">Returnera true om återställningen lyckades.</span><span class="sxs-lookup"><span data-stu-id="b74d7-176">Return true if the restoration was a success.</span></span>

<span data-ttu-id="b74d7-177">Följande är exempel på implementering av den `OnDataLossAsync` metoden:</span><span class="sxs-lookup"><span data-stu-id="b74d7-177">Following is an example implementation of the `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="b74d7-178">`RestoreDescription`skickade till den `RestoreContext.RestoreAsync` anrop innehåller en medlem som kallas `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-178">`RestoreDescription` passed in to the `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="b74d7-179">När du återställer en fullständig säkerhetskopia, detta `BackupFolderPath` ska anges till den lokala sökvägen till den mapp som innehåller en fullständig säkerhetskopiering.</span><span class="sxs-lookup"><span data-stu-id="b74d7-179">When restoring a single full backup, this `BackupFolderPath` should be set to the local path of the folder that contains your full backup.</span></span>
<span data-ttu-id="b74d7-180">När du återställer en fullständig säkerhetskopia och ett antal inkrementella säkerhetskopieringar `BackupFolderPath` ska anges till den lokala sökvägen till den mapp som inte bara innehåller en fullständig säkerhetskopiering, men även alla de inkrementella säkerhetskopiorna.</span><span class="sxs-lookup"><span data-stu-id="b74d7-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set to the local path of the folder that not only contains the full backup, but also all the incremental backups.</span></span>
<span data-ttu-id="b74d7-181">`RestoreAsync`Anropet kan utlösa `FabricMissingFullBackupException` om den `BackupFolderPath` som inte innehåller en fullständig säkerhetskopia.</span><span class="sxs-lookup"><span data-stu-id="b74d7-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if the `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="b74d7-182">Den kan också ge `ArgumentException` om `BackupFolderPath` har brutits kedja för säkerhetskopior.</span><span class="sxs-lookup"><span data-stu-id="b74d7-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="b74d7-183">Om den innehåller en fullständig säkerhetskopiering, till exempel först inkrementell och tredje inkrementell säkerhetskopiering men inga andra inkrementell säkerhetskopiering.</span><span class="sxs-lookup"><span data-stu-id="b74d7-183">For example, if it contains the full backup, the first incremental and the third incremental backup but no the second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="b74d7-184">RestorePolicy anges till säkra som standard.</span><span class="sxs-lookup"><span data-stu-id="b74d7-184">The RestorePolicy is set to Safe by default.</span></span>  <span data-ttu-id="b74d7-185">Detta innebär att den `RestoreAsync` API misslyckas med ArgumentException om den upptäcker att mappen innehåller ett tillstånd som är äldre än eller lika med det tillstånd som finns i den här repliken.</span><span class="sxs-lookup"><span data-stu-id="b74d7-185">This means that the `RestoreAsync` API will fail with ArgumentException if it detects that the backup folder contains a state that is older than or equal to the state contained in this replica.</span></span>  <span data-ttu-id="b74d7-186">`RestorePolicy.Force`kan användas för att hoppa över kontrollen säkerhet.</span><span class="sxs-lookup"><span data-stu-id="b74d7-186">`RestorePolicy.Force` can be used to skip this safety check.</span></span> <span data-ttu-id="b74d7-187">Det har angetts som en del av `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="b74d7-188">Borttagna eller förlorade service</span><span class="sxs-lookup"><span data-stu-id="b74d7-188">Deleted or lost service</span></span>
<span data-ttu-id="b74d7-189">Om en tjänst har tagits bort, måste du först återskapa tjänsten innan data kan återställas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-189">If a service is removed, you must first re-create the service before the data can be restored.</span></span>  <span data-ttu-id="b74d7-190">Det är viktigt att skapa tjänsten med samma konfiguration, t.ex. partitioneringsschema så att data kan återställas utan problem.</span><span class="sxs-lookup"><span data-stu-id="b74d7-190">It is important to create the service with the same configuration, e.g., partitioning scheme, so that the data can be restored seamlessly.</span></span>  <span data-ttu-id="b74d7-191">När tjänsten är igång API för att återställa data (`OnDataLossAsync` ovan) måste anropas för varje partition för den här tjänsten.</span><span class="sxs-lookup"><span data-stu-id="b74d7-191">Once the service is up, the API to restore data (`OnDataLossAsync` above) has to be invoked on every partition of this service.</span></span> <span data-ttu-id="b74d7-192">Ett sätt att uppnå detta är med hjälp av `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` för varje partition.</span><span class="sxs-lookup"><span data-stu-id="b74d7-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="b74d7-193">Från och med nu är implementering samma som scenariot ovan.</span><span class="sxs-lookup"><span data-stu-id="b74d7-193">From this point, implementation is the same as the above scenario.</span></span> <span data-ttu-id="b74d7-194">Varje partition måste återställa den senaste relevanta säkerhetskopieringen från extern butik.</span><span class="sxs-lookup"><span data-stu-id="b74d7-194">Each partition needs to restore the latest relevant backup from the external store.</span></span> <span data-ttu-id="b74d7-195">En begränsning är att partitions-ID kan ha nu ändrats, eftersom partition ID: N skapas dynamiskt i körningsmiljön.</span><span class="sxs-lookup"><span data-stu-id="b74d7-195">One caveat is that the partition ID may have now changed, since the runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="b74d7-196">Tjänsten måste därför att lagra lämplig information och tjänsten partitionsnamnet att identifiera den senaste korrekta säkerhetskopian att återställa från en för varje partition.</span><span class="sxs-lookup"><span data-stu-id="b74d7-196">Thus, the service needs to store the appropriate partition information and service name to identify the correct latest backup to restore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="b74d7-197">Det rekommenderas inte att använda `FabricClient.ServiceManager.InvokeDataLossAsync` på varje partition för att återställa hela tjänsten eftersom som kan skada din klustertillstånd.</span><span class="sxs-lookup"><span data-stu-id="b74d7-197">It is not recommended to use `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition to restore the entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="b74d7-198">Replikering av skadade programdata</span><span class="sxs-lookup"><span data-stu-id="b74d7-198">Replication of corrupt application data</span></span>
<span data-ttu-id="b74d7-199">Om uppgraderingen nyligen distribuerade program har ett fel som kan medföra att data skadas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-199">If the newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="b74d7-200">En uppgradering av programmet kan till exempel börja uppdatera alla phone antalet poster i en tillförlitlig ordlista med ett ogiltigt riktnummer.</span><span class="sxs-lookup"><span data-stu-id="b74d7-200">For example, an application upgrade may start to update every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="b74d7-201">I det här fallet replikeras ogiltiga telefonnummer sedan Service Fabric inte är medveten om vilka slags data som lagras.</span><span class="sxs-lookup"><span data-stu-id="b74d7-201">In this case, the invalid phone numbers will be replicated since Service Fabric is not aware of the nature of the data that is being stored.</span></span>

<span data-ttu-id="b74d7-202">Det första du ska göra när du identifiera sådana ett flagranta fel som orsakar skadade data är att låsa tjänsten på programnivå och, om möjligt, uppgradera till version av den programkod som inte har programfelet.</span><span class="sxs-lookup"><span data-stu-id="b74d7-202">The first thing to do after you detect such an egregious bug that causes data corruption is to freeze the service at the application level and, if possible, upgrade to the version of the application code that does not have the bug.</span></span>  <span data-ttu-id="b74d7-203">Även efter kod som har åtgärdats, data kan fortfarande vara skadad och därmed data kan behöva återställas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-203">However, even after the service code is fixed, the data may still be corrupt and thus data may need to be restored.</span></span>  <span data-ttu-id="b74d7-204">I sådana fall kan det inte räcker för att återställa den senaste säkerhetskopian eftersom de senaste säkerhetskopiorna kan också vara skadad.</span><span class="sxs-lookup"><span data-stu-id="b74d7-204">In such cases, it may not be sufficient to restore the latest backup, since the latest backups may also be corrupt.</span></span>  <span data-ttu-id="b74d7-205">Du har alltså att hitta den senaste säkerhetskopieringen gjordes innan data har skadats.</span><span class="sxs-lookup"><span data-stu-id="b74d7-205">Thus, you have to find the last backup that was made before the data got corrupted.</span></span>

<span data-ttu-id="b74d7-206">Om du inte är säker på vilken säkerhetskopior är skadade kan du distribuera ett nytt Service Fabric-kluster och återställa säkerhetskopior av berörda partitioner precis som anges ovan ”Deleted eller förlorade service” scenario.</span><span class="sxs-lookup"><span data-stu-id="b74d7-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore the backups of affected partitions just like the above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="b74d7-207">För varje partition startar återställa säkerhetskopior från den senaste till minst.</span><span class="sxs-lookup"><span data-stu-id="b74d7-207">For each partition, start restoring the backups from the most recent to the least.</span></span> <span data-ttu-id="b74d7-208">När du har hittat en säkerhetskopiering som inte har fel flyttning/ta bort alla säkerhetskopior för den här partitionen som var (än att säkerhetskopiering).</span><span class="sxs-lookup"><span data-stu-id="b74d7-208">Once you find a backup that does not have the corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="b74d7-209">Upprepa proceduren för varje partition.</span><span class="sxs-lookup"><span data-stu-id="b74d7-209">Repeat this process for each partition.</span></span> <span data-ttu-id="b74d7-210">Nu när `OnDataLossAsync` anropas på partitionen i produktion klustret den senaste säkerhetskopian finns i arkivet för externa blir en utvald av ovanstående procedur.</span><span class="sxs-lookup"><span data-stu-id="b74d7-210">Now, when `OnDataLossAsync` is called on the partition in the production cluster, the last backup found in the external store will be the one picked by the above process.</span></span>

<span data-ttu-id="b74d7-211">Nu steg ”Deleted eller förlorade service” avsnitt kan användas för att återställa status för tjänsten till läget innan buggy kod skadad tillståndet.</span><span class="sxs-lookup"><span data-stu-id="b74d7-211">Now, the steps in the "Deleted or lost service" section can be used to restore the state of the service to the state before the buggy code corrupted the state.</span></span>

<span data-ttu-id="b74d7-212">Tänk på följande:</span><span class="sxs-lookup"><span data-stu-id="b74d7-212">Note that:</span></span>

  - <span data-ttu-id="b74d7-213">När du återställer finns det en risk att säkerhetskopian som återställs är äldre än tillståndet för partitionen innan data gick förlorade.</span><span class="sxs-lookup"><span data-stu-id="b74d7-213">When you restore, there is a chance that the backup being restored is older than the state of the partition before the data was lost.</span></span> <span data-ttu-id="b74d7-214">Därför bör du återställa endast som en sista utväg återställa så mycket som möjligt av informationen.</span><span class="sxs-lookup"><span data-stu-id="b74d7-214">Because of this, you should restore only as a last resort to recover as much data as possible.</span></span>
  - <span data-ttu-id="b74d7-215">Den sträng som representerar sökvägen till säkerhetskopian och sökvägar för filer i mappen kan vara större än 255 tecken, beroende på FabricDataRoot sökvägen och programtyp namnlängd.</span><span class="sxs-lookup"><span data-stu-id="b74d7-215">The string that represents the backup folder path and the paths of files inside the backup folder can be greater than 255 characters, depending on the FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="b74d7-216">Detta kan orsaka vissa .NET-metoder som `Directory.Move`, för att utlösa den `PathTooLongException` undantag.</span><span class="sxs-lookup"><span data-stu-id="b74d7-216">This can cause some .NET methods, like `Directory.Move`, to throw the `PathTooLongException` exception.</span></span> <span data-ttu-id="b74d7-217">En lösning som direkt anropar kernel32 API: er, som `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-217">One workaround is to directly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="b74d7-218">Säkerhetskopiering och återställning Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="b74d7-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="b74d7-219">Tillförlitliga aktörer Framework bygger på Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="b74d7-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="b74d7-220">ActorService som är värd för actor(s) är en tillståndskänslig tillförlitlig tjänst.</span><span class="sxs-lookup"><span data-stu-id="b74d7-220">The ActorService which hosts the actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="b74d7-221">Därför måste är alla säkerhetskopiering och återställning av tillgängliga funktioner i Reliable Services också tillgänglig för Reliable Actors (utom beteenden som är specifika för tillståndsprovidern).</span><span class="sxs-lookup"><span data-stu-id="b74d7-221">Hence, all the backup and restore functionality available in Reliable Services is also available to Reliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="b74d7-222">Eftersom säkerhetskopior kommer att vidtas på grundval av per partition, tillstånd för alla aktörer i att partition ska säkerhetskopieras (och återställningen liknar och sker på grundval av per partition).</span><span class="sxs-lookup"><span data-stu-id="b74d7-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="b74d7-223">Om du vill utföra säkerhetskopiering/återställning med tjänstens ägare ska skapa en anpassad aktören service-klass som härleds från klassen ActorService och gör sedan säkerhetskopiering/återställning liknar Reliable Services enligt beskrivningen ovan i föregående avsnitt.</span><span class="sxs-lookup"><span data-stu-id="b74d7-223">To perform backup/restore, the service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar to Reliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="b74d7-224">När du skapar en anpassad aktören tjänstklass som du behöver registrera som samt när du registrerar aktören.</span><span class="sxs-lookup"><span data-stu-id="b74d7-224">When you create a custom actor service class, you need to register that as well when registering the actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="b74d7-225">Standardprovidern för tillstånd för Reliable Actors är `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-225">The default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="b74d7-226">Inkrementell säkerhetskopiering är inte aktiverad som standard för `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="b74d7-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="b74d7-227">Du kan aktivera inkrementell säkerhetskopiering genom att skapa `KvsActorStateProvider` med lämplig inställning i sin konstruktor och skicka den till ActorService konstruktorn enligt följande kodavsnitt:</span><span class="sxs-lookup"><span data-stu-id="b74d7-227">You can enable incremental backup by creating `KvsActorStateProvider` with the appropriate setting in its constructor and then passing it to ActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="b74d7-228">När inkrementell säkerhetskopiering har aktiverats, tar en inkrementell säkerhetskopia kan misslyckas med FabricMissingFullBackupException av något av följande skäl och du behöver utföra en fullständig säkerhetskopiering innan du tar inkrementella säkerhetskopiorna:</span><span class="sxs-lookup"><span data-stu-id="b74d7-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need to take a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="b74d7-229">Repliken har aldrig tagit en fullständig säkerhetskopiering eftersom den blev primära.</span><span class="sxs-lookup"><span data-stu-id="b74d7-229">The replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="b74d7-230">Vissa av posterna loggen har trunkerats eftersom senaste säkerhetskopian skapades.</span><span class="sxs-lookup"><span data-stu-id="b74d7-230">Some of the log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="b74d7-231">När inkrementell säkerhetskopiering är aktiverad `KvsActorStateProvider` använder inte cirkulär buffert för att hantera dess loggposter och trunkerar den regelbundet.</span><span class="sxs-lookup"><span data-stu-id="b74d7-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer to manage its log records and periodically truncates it.</span></span> <span data-ttu-id="b74d7-232">Om ingen säkerhetskopia är upptaget av användaren under 45 minuter, trunkerar loggposter automatiskt i systemet.</span><span class="sxs-lookup"><span data-stu-id="b74d7-232">If no backup is taken by user for a period of 45 minutes, the system automatically truncates the log records.</span></span> <span data-ttu-id="b74d7-233">Intervallet kan konfigureras genom att ange `logTrunctationIntervalInMinutes` i `KvsActorStateProvider` konstruktor (liknar när du aktiverar inkrementell säkerhetskopiering).</span><span class="sxs-lookup"><span data-stu-id="b74d7-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar to when enabling incremental backup).</span></span> <span data-ttu-id="b74d7-234">Loggposter kan också hämta trunkeras om primära repliken behöver för att skapa en annan replik genom att skicka alla data.</span><span class="sxs-lookup"><span data-stu-id="b74d7-234">The log records may also get truncated if primary replica need to build another replica by sending all its data.</span></span>

<span data-ttu-id="b74d7-235">När du gör återställningen från en säkerhetskopiering kedja liknar Reliable Services BackupFolderPath ska innehålla underkataloger med en underkatalog med fullständig säkerhetskopiering och andra underkataloger som innehåller inkrementella säkerhetskopiorna.</span><span class="sxs-lookup"><span data-stu-id="b74d7-235">When doing restore from a backup chain, similar to Reliable Services, the BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="b74d7-236">Återställ API genereras FabricException med ett meddelande om loggsäkerhetskopieringssekvensen verifieringen misslyckas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-236">The restore API will throw FabricException with appropriate error message if the backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="b74d7-237">`KvsActorStateProvider`ignorerar för tillfället alternativet RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="b74d7-237">`KvsActorStateProvider` currently ignores the option RestorePolicy.Safe.</span></span> <span data-ttu-id="b74d7-238">Stöd för den här funktionen är planerad i en kommande version.</span><span class="sxs-lookup"><span data-stu-id="b74d7-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="b74d7-239">Testa säkerhetskopiering och återställning</span><span class="sxs-lookup"><span data-stu-id="b74d7-239">Testing Backup and Restore</span></span>
<span data-ttu-id="b74d7-240">Det är viktigt att säkerställa att viktiga data säkerhetskopieras och återställas från.</span><span class="sxs-lookup"><span data-stu-id="b74d7-240">It is important to ensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="b74d7-241">Detta kan göras genom att anropa den `Start-ServiceFabricPartitionDataLoss` cmdlet i PowerShell som kan orsaka dataförlust i en viss partition för att kontrollera om data säkerhetskopiera och återställa funktioner för tjänsten fungerar som förväntat.</span><span class="sxs-lookup"><span data-stu-id="b74d7-241">This can be done by invoking the `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition to test whether the data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="b74d7-242">Det är också möjligt att anropa förlust av data och återställa från händelsen samt programmässigt.</span><span class="sxs-lookup"><span data-stu-id="b74d7-242">It is also possible to programmatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="b74d7-243">Du kan hitta ett exempel på implementering av säkerhetskopiering och återställning av funktioner i referens webbprogrammet på GitHub.</span><span class="sxs-lookup"><span data-stu-id="b74d7-243">You can find a sample implementation of backup and restore functionality in the Web Reference App on GitHub.</span></span> <span data-ttu-id="b74d7-244">Tittar du på den `Inventory.Service` tjänsten för mer information.</span><span class="sxs-lookup"><span data-stu-id="b74d7-244">Please look at the `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-the-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="b74d7-245">Under huven: Mer information om säkerhetskopiering och återställning</span><span class="sxs-lookup"><span data-stu-id="b74d7-245">Under the hood: more details on backup and restore</span></span>
<span data-ttu-id="b74d7-246">Här är några mer information om säkerhetskopiering och återställning.</span><span class="sxs-lookup"><span data-stu-id="b74d7-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="b74d7-247">Säkerhetskopiering</span><span class="sxs-lookup"><span data-stu-id="b74d7-247">Backup</span></span>
<span data-ttu-id="b74d7-248">Tillförlitliga Tillståndshanterarens ger möjlighet att skapa konsekvent säkerhetskopieringar utan att blockera alla läs- eller skrivåtgärder.</span><span class="sxs-lookup"><span data-stu-id="b74d7-248">The Reliable State Manager provides the ability to create consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="b74d7-249">Om du vill göra det, använder den en mekanism för datapersistence kontrollpunkts- och loggfiler.</span><span class="sxs-lookup"><span data-stu-id="b74d7-249">To do so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="b74d7-250">Tillförlitliga Tillståndshanterarens tar fuzzy (lightweight) kontrollpunkter vid vissa tidpunkter för att avlasta trycket från transaktionella loggen och förbättra återställningstiden.</span><span class="sxs-lookup"><span data-stu-id="b74d7-250">The Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points to relieve pressure from the transactional log and improve recovery times.</span></span>  <span data-ttu-id="b74d7-251">När `BackupAsync` anropas, tillförlitlig Tillståndshanterarens instruerar alla tillförlitliga objekt för att kopiera sina senaste kontrollpunktsfiler till en lokal mapp.</span><span class="sxs-lookup"><span data-stu-id="b74d7-251">When `BackupAsync` is called, the Reliable State Manager instructs all Reliable objects to copy their latest checkpoint files to a local backup folder.</span></span>  <span data-ttu-id="b74d7-252">Tillförlitliga Tillståndshanterarens kopierar sedan alla loggposter från ”start pekaren” till den senaste loggposten i säkerhetskopieringsmappen.</span><span class="sxs-lookup"><span data-stu-id="b74d7-252">Then, the Reliable State Manager copies all log records, starting from the "start pointer" to the latest log record into the backup folder.</span></span>  <span data-ttu-id="b74d7-253">Eftersom alla loggposter upp till den senaste loggposten ingår i säkerhetskopieringen och tillförlitlig Tillståndshanterarens bevarar write-ahead loggning, tillförlitlig Tillståndshanterarens garanterar att alla transaktioner som genomförs (`CommitAsync` har returnerat har) ingår i säkerhetskopian.</span><span class="sxs-lookup"><span data-stu-id="b74d7-253">Since all the log records up to the latest log record are included in the backup and the Reliable State Manager preserves write-ahead logging, the Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in the backup.</span></span>

<span data-ttu-id="b74d7-254">En transaktion som sparar efter `BackupAsync` har anropats kanske eller kanske inte i säkerhetskopian.</span><span class="sxs-lookup"><span data-stu-id="b74d7-254">Any transaction that commits after `BackupAsync` has been called may or may not be in the backup.</span></span>  <span data-ttu-id="b74d7-255">När den lokala mappen för säkerhetskopiering har fyllts av plattformen (d.v.s. lokal säkerhetskopia har avslutats av körningen), tjänstens säkerhetskopiering återanropet anropas.</span><span class="sxs-lookup"><span data-stu-id="b74d7-255">Once the local backup folder has been populated by the platform (i.e., local backup is completed by the runtime), the service's backup callback is invoked.</span></span>  <span data-ttu-id="b74d7-256">Den här återanrop ansvarar för att flytta säkerhetskopieringsmappen till en extern plats, till exempel Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="b74d7-256">This callback is responsible for moving the backup folder to an external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="b74d7-257">Återställ</span><span class="sxs-lookup"><span data-stu-id="b74d7-257">Restore</span></span>
<span data-ttu-id="b74d7-258">Tillförlitliga Tillståndshanterarens ger dig möjlighet att återställa från en säkerhetskopia med hjälp av den `RestoreAsync` API.</span><span class="sxs-lookup"><span data-stu-id="b74d7-258">The Reliable State Manager provides the ability to restore from a backup by using the `RestoreAsync` API.</span></span>  
<span data-ttu-id="b74d7-259">Den `RestoreAsync` metod på `RestoreContext` kan endast anropas inuti den `OnDataLossAsync` metoden.</span><span class="sxs-lookup"><span data-stu-id="b74d7-259">The `RestoreAsync` method on `RestoreContext` can be called only inside the `OnDataLossAsync` method.</span></span>
<span data-ttu-id="b74d7-260">Bool som returneras av `OnDataLossAsync` anger om tjänsten har återställts dess tillstånd från en extern källa.</span><span class="sxs-lookup"><span data-stu-id="b74d7-260">The bool returned by `OnDataLossAsync` indicates whether the service restored its state from an external source.</span></span>
<span data-ttu-id="b74d7-261">Om den `OnDataLossAsync` returnerar true, Service Fabric återskapar alla andra repliker från denna primära Server.</span><span class="sxs-lookup"><span data-stu-id="b74d7-261">If the `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="b74d7-262">Service Fabric säkerställer att repliker som tar emot `OnDataLossAsync` anropa första övergången till den primära rollen men inte beviljas läses status eller skriva status.</span><span class="sxs-lookup"><span data-stu-id="b74d7-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition to the primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="b74d7-263">Detta innebär att för StatefulService implementerare `RunAsync` inte anropas förrän `OnDataLossAsync` har slutförts.</span><span class="sxs-lookup"><span data-stu-id="b74d7-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="b74d7-264">Sedan `OnDataLossAsync` kommer att anropas på den nya primärt.</span><span class="sxs-lookup"><span data-stu-id="b74d7-264">Then, `OnDataLossAsync` will be invoked on the new primary.</span></span>
<span data-ttu-id="b74d7-265">Tills en tjänst är slutförd detta API har (genom att returnera true eller false) och är klar relevanta omkonfiguration, kommer API: et hålla som anropas i taget.</span><span class="sxs-lookup"><span data-stu-id="b74d7-265">Until a service completes this API successfully (by returning true or false) and finishes the relevant reconfiguration, the API will keep being called one at a time.</span></span>

<span data-ttu-id="b74d7-266">`RestoreAsync`först utelämnar alla befintliga tillstånd i den primära repliken som den anropades på.</span><span class="sxs-lookup"><span data-stu-id="b74d7-266">`RestoreAsync` first drops all existing state in the primary replica that it was called on.</span></span>  
<span data-ttu-id="b74d7-267">Sedan skapar tillförlitliga Tillståndshanterarens alla tillförlitliga objekt som finns i mappen.</span><span class="sxs-lookup"><span data-stu-id="b74d7-267">Then the Reliable State Manager creates all the Reliable objects that exist in the backup folder.</span></span>  
<span data-ttu-id="b74d7-268">Sedan instrueras tillförlitliga objekt att återställa från deras kontrollpunkter i mappen.</span><span class="sxs-lookup"><span data-stu-id="b74d7-268">Next, the Reliable objects are instructed to restore from their checkpoints in the backup folder.</span></span>  
<span data-ttu-id="b74d7-269">Slutligen tillförlitliga Tillståndshanterarens återställer dess egna tillstånd från loggposter i mappen och utför återställningen.</span><span class="sxs-lookup"><span data-stu-id="b74d7-269">Finally, the Reliable State Manager recovers its own state from the log records in the backup folder and performs recovery.</span></span>  
<span data-ttu-id="b74d7-270">Som en del av återställningsprocessen spelas åtgärder som startar från ”Start” som har commit loggposter i mappen tillförlitliga objekt.</span><span class="sxs-lookup"><span data-stu-id="b74d7-270">As part of the recovery process, operations starting from the "starting point" that have commit log records in the backup folder are replayed to the Reliable objects.</span></span>  
<span data-ttu-id="b74d7-271">Det här steget säkerställer att den återställda är konsekvent.</span><span class="sxs-lookup"><span data-stu-id="b74d7-271">This step ensures that the recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b74d7-272">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="b74d7-272">Next steps</span></span>
  - [<span data-ttu-id="b74d7-273">Tillförlitliga samlingar</span><span class="sxs-lookup"><span data-stu-id="b74d7-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="b74d7-274">Snabbstart för Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b74d7-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="b74d7-275">Reliable Services-meddelanden</span><span class="sxs-lookup"><span data-stu-id="b74d7-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="b74d7-276">Tillförlitliga tjänstkonfiguration</span><span class="sxs-lookup"><span data-stu-id="b74d7-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="b74d7-277">För utvecklare för tillförlitlig samlingar</span><span class="sxs-lookup"><span data-stu-id="b74d7-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

