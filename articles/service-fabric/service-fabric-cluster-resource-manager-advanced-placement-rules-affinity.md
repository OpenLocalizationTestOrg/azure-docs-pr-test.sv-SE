---
title: "Service Fabric klustret Resource Manager - tillhörighet | Microsoft Docs"
description: "Översikt över hur du konfigurerar tillhörighet för Service Fabric-tjänster"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 3efda4ee4016245668e5da431d7b8868a21c790e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 08/18/2017
---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a><span data-ttu-id="ae498-103">Konfigurera och använda tjänsten tillhörighet i Service Fabric</span><span class="sxs-lookup"><span data-stu-id="ae498-103">Configuring and using service affinity in Service Fabric</span></span>
<span data-ttu-id="ae498-104">Tillhörighet är en kontroll som tillhandahålls huvudsakligen för att underlätta övergången av större gigantiska program till molnet och mikrotjänster världen.</span><span class="sxs-lookup"><span data-stu-id="ae498-104">Affinity is a control that is provided mainly to help ease the transition of larger monolithic applications into the cloud and microservices world.</span></span> <span data-ttu-id="ae498-105">Det används också som en optimering för att förbättra prestanda för tjänster, även om du gör det kan ha sidoeffekter.</span><span class="sxs-lookup"><span data-stu-id="ae498-105">It is also used as an optimization for improving the performance of services, although doing so can have side effects.</span></span>

<span data-ttu-id="ae498-106">Anta att du tillämpar en större app eller en som bara inte utformad med mikrotjänster i åtanke till Service Fabric (eller distribuerad miljö).</span><span class="sxs-lookup"><span data-stu-id="ae498-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, to Service Fabric (or any distributed environment).</span></span> <span data-ttu-id="ae498-107">Den här typen av övergången är vanligt.</span><span class="sxs-lookup"><span data-stu-id="ae498-107">This type of transition is common.</span></span> <span data-ttu-id="ae498-108">Starta genom att lyfta hela appen i miljön, paketera den och se till att det körs.</span><span class="sxs-lookup"><span data-stu-id="ae498-108">You start by lifting the entire app into the environment, packaging it, and making sure it is running smoothly.</span></span> <span data-ttu-id="ae498-109">Du startar sedan dela upp frågan i olika mindre tjänster att alla kommunicera med varandra.</span><span class="sxs-lookup"><span data-stu-id="ae498-109">Then you start breaking it down into different smaller services that all talk to each other.</span></span>

<span data-ttu-id="ae498-110">Slutligen kan du att programmet har några problem.</span><span class="sxs-lookup"><span data-stu-id="ae498-110">Eventually you may find that the application is experiencing some issues.</span></span> <span data-ttu-id="ae498-111">Problemen indelas vanligtvis i dessa kategorier:</span><span class="sxs-lookup"><span data-stu-id="ae498-111">The issues usually fall into one of these categories:</span></span>

1. <span data-ttu-id="ae498-112">Vissa komponenten X i appen monolitisk hade ett odokumenterade beroende på komponenten Y och du har aktiverat precis dessa komponenter till separata tjänster.</span><span class="sxs-lookup"><span data-stu-id="ae498-112">Some component X in the monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span></span> <span data-ttu-id="ae498-113">Eftersom dessa tjänster körs nu på olika noder i klustret, är de bruten.</span><span class="sxs-lookup"><span data-stu-id="ae498-113">Since these services are now running on different nodes in the cluster, they're broken.</span></span>
2. <span data-ttu-id="ae498-114">Dessa komponenter kommunicerar (lokal namngivna pipes | delat minne | filer på disk) och de verkligen måste kunna skriva till en lokal resurs av prestandaskäl just nu.</span><span class="sxs-lookup"><span data-stu-id="ae498-114">These components communicate via (local named pipes | shared memory | files on disk) and they really need to be able to write to a shared local resource for performance reasons right now.</span></span> <span data-ttu-id="ae498-115">Hårda sambandet hämtar togs bort senare, kanske.</span><span class="sxs-lookup"><span data-stu-id="ae498-115">That hard dependency gets removed later, maybe.</span></span>
3. <span data-ttu-id="ae498-116">Allt är bra, men det visar sig att dessa två komponenter är faktiskt chatty och prestanda känslig.</span><span class="sxs-lookup"><span data-stu-id="ae498-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span></span> <span data-ttu-id="ae498-117">När de flyttas dem till olika tjänster övergripande programprestanda tanked eller latens ökade.</span><span class="sxs-lookup"><span data-stu-id="ae498-117">When they moved them into separate services overall application performance tanked or latency increased.</span></span> <span data-ttu-id="ae498-118">Övergripande program är därför inte uppfyller förväntningar.</span><span class="sxs-lookup"><span data-stu-id="ae498-118">As a result, the overall application is not meeting expectations.</span></span>

<span data-ttu-id="ae498-119">I dessa fall kan vi vill inte förlora våra refaktoriseringsaktiviteter arbete och vill inte gå tillbaka till monolitvolym.</span><span class="sxs-lookup"><span data-stu-id="ae498-119">In these cases, we don’t want to lose our refactoring work, and don’t want to go back to the monolith.</span></span> <span data-ttu-id="ae498-120">Senaste villkoret vara även önskvärt som en vanlig optimering.</span><span class="sxs-lookup"><span data-stu-id="ae498-120">The last condition may even be desirable as a plain optimization.</span></span> <span data-ttu-id="ae498-121">Tills vi kan göra om komponenter ska fungera naturligt som tjänster (eller kan vi lösa prestandaförväntningarna något annat sätt) är det dags måste vissa uppfattning om ort.</span><span class="sxs-lookup"><span data-stu-id="ae498-121">However, until we can redesign the components to work naturally as services (or until we can solve the performance expectations some other way) we're going to need some sense of locality.</span></span>

<span data-ttu-id="ae498-122">Hur ska du göra?</span><span class="sxs-lookup"><span data-stu-id="ae498-122">What to do?</span></span> <span data-ttu-id="ae498-123">Dessutom kan du aktivera tillhörighet.</span><span class="sxs-lookup"><span data-stu-id="ae498-123">Well, you could try turning on affinity.</span></span>

## <a name="how-to-configure-affinity"></a><span data-ttu-id="ae498-124">Att konfigurera mappning mellan</span><span class="sxs-lookup"><span data-stu-id="ae498-124">How to configure affinity</span></span>
<span data-ttu-id="ae498-125">Om du vill konfigurera tillhörighet kan du definiera en tillhörigheten mellan två olika tjänster.</span><span class="sxs-lookup"><span data-stu-id="ae498-125">To set up affinity, you define an affinity relationship between two different services.</span></span> <span data-ttu-id="ae498-126">Du kan tänka dig tillhörighet som ”pekar” en-tjänst på en annan och säger ”den här tjänsten kan endast köras var att tjänsten körs”.</span><span class="sxs-lookup"><span data-stu-id="ae498-126">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span></span> <span data-ttu-id="ae498-127">Ibland kallas för mappning mellan en överordnad-underordnad relation (där du peka underordnade på överordnat).</span><span class="sxs-lookup"><span data-stu-id="ae498-127">Sometimes we refer to affinity as a parent/child relationship (where you point the child at the parent).</span></span> <span data-ttu-id="ae498-128">Det innebär att repliker eller instanser av en tjänst är placerade på samma noder som en annan tjänst.</span><span class="sxs-lookup"><span data-stu-id="ae498-128">Affinity ensures that the replicas or instances of one service are placed on the same nodes as those of another service.</span></span>

```csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

> [!NOTE]
> <span data-ttu-id="ae498-129">En underordnad tjänst kan bara ingå i en enda tillhörigheten.</span><span class="sxs-lookup"><span data-stu-id="ae498-129">A child service can only participate in a single affinity relationship.</span></span> <span data-ttu-id="ae498-130">Om du vill lägga till underordnat tillhöra två överordnade tjänster samtidigt har flera olika alternativ:</span><span class="sxs-lookup"><span data-stu-id="ae498-130">If you wanted the child to be affinitized to two parent services at once you have a couple options:</span></span>
> - <span data-ttu-id="ae498-131">Omvänd relationerna (har parentService1 och parentService2 som pekar på den aktuella underordnade tjänsten), eller</span><span class="sxs-lookup"><span data-stu-id="ae498-131">Reverse the relationships (have parentService1 and parentService2 point at the current child service), or</span></span>
> - <span data-ttu-id="ae498-132">Utse en av överordnade som ett nav enligt konventionen och ha alla tjänster som pekar på den tjänsten.</span><span class="sxs-lookup"><span data-stu-id="ae498-132">Designate one of the parents as a hub by convention and have all services point at that service.</span></span> 
>
> <span data-ttu-id="ae498-133">Resultatet placering i klustret måste vara samma.</span><span class="sxs-lookup"><span data-stu-id="ae498-133">The resulting placement behavior in the cluster should be the same.</span></span>
>

## <a name="different-affinity-options"></a><span data-ttu-id="ae498-134">Alternativ för olika tillhörighet</span><span class="sxs-lookup"><span data-stu-id="ae498-134">Different affinity options</span></span>
<span data-ttu-id="ae498-135">Tillhörighet representeras via en av flera scheman för korrelation och har två olika lägen.</span><span class="sxs-lookup"><span data-stu-id="ae498-135">Affinity is represented via one of several correlation schemes, and has two different modes.</span></span> <span data-ttu-id="ae498-136">De vanligaste läget för mappning mellan engelskans NonAlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="ae498-136">The most common mode of affinity is what we call NonAlignedAffinity.</span></span> <span data-ttu-id="ae498-137">I NonAlignedAffinity placeras replikeringar eller instanser av olika tjänster på samma noder.</span><span class="sxs-lookup"><span data-stu-id="ae498-137">In NonAlignedAffinity, the replicas or instances of the different services are placed on the same nodes.</span></span> <span data-ttu-id="ae498-138">Det andra läget är AlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="ae498-138">The other mode is AlignedAffinity.</span></span> <span data-ttu-id="ae498-139">Justerade tillhörighet är användbar bara med tillståndskänsliga tjänster.</span><span class="sxs-lookup"><span data-stu-id="ae498-139">Aligned Affinity is useful only with stateful services.</span></span> <span data-ttu-id="ae498-140">Konfigurera två tillståndskänsliga tjänster om du vill ha justerad tillhörighet säkerställer att primärfärgerna av tjänsterna är placerade på samma noder efter varandra.</span><span class="sxs-lookup"><span data-stu-id="ae498-140">Configuring two stateful services to have aligned affinity ensures that the primaries of those services are placed on the same nodes as each other.</span></span> <span data-ttu-id="ae498-141">Det gör även varje par av sekundärservrar för dessa tjänster kan placeras på samma noder.</span><span class="sxs-lookup"><span data-stu-id="ae498-141">It also causes each pair of secondaries for those services to be placed on the same nodes.</span></span> <span data-ttu-id="ae498-142">Det är också möjligt (även om mindre fråga om vanliga) Konfigurera NonAlignedAffinity för tillståndskänsliga tjänster.</span><span class="sxs-lookup"><span data-stu-id="ae498-142">It is also possible (though less common) to configure NonAlignedAffinity for stateful services.</span></span> <span data-ttu-id="ae498-143">Olika repliker två tillståndskänsliga tjänster körs på samma noder för NonAlignedAffinity, men deras primärfärgerna kan hamna på olika noder.</span><span class="sxs-lookup"><span data-stu-id="ae498-143">For NonAlignedAffinity, the different replicas of the two stateful services would run on the same nodes, but their primaries could end up on different nodes.</span></span>

<span data-ttu-id="ae498-144"><center>
![Tillhörighet och deras effekter][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="ae498-144"><center>
![Affinity Modes and Their Effects][Image1]
</center></span></span>

### <a name="best-effort-desired-state"></a><span data-ttu-id="ae498-145">Bästa prestanda önskad tillstånd</span><span class="sxs-lookup"><span data-stu-id="ae498-145">Best effort desired state</span></span>
<span data-ttu-id="ae498-146">En mappningsrelation är bästa prestanda.</span><span class="sxs-lookup"><span data-stu-id="ae498-146">An affinity relationship is best effort.</span></span> <span data-ttu-id="ae498-147">Den ger inte samma garantier för samplacering eller tillförlitlighet som körs i samma körbara processen.</span><span class="sxs-lookup"><span data-stu-id="ae498-147">It does not provide the same guarantees of collocation or reliability that running in the same executable process does.</span></span> <span data-ttu-id="ae498-148">Tjänster i ett tillhörigheten är helt olika enheter som kan misslyckas och flyttas oberoende av varandra.</span><span class="sxs-lookup"><span data-stu-id="ae498-148">The services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span></span> <span data-ttu-id="ae498-149">En tillhörigheten kan också dela, även om dessa radbrytningar är tillfällig.</span><span class="sxs-lookup"><span data-stu-id="ae498-149">An affinity relationship could also break, though these breaks are temporary.</span></span> <span data-ttu-id="ae498-150">Till exempel innebär kapacitetsbegränsningar att endast en del av tjänsten objekten i tillhörigheten får plats på en viss nod.</span><span class="sxs-lookup"><span data-stu-id="ae498-150">For example, capacity limitations may mean that only some of the service objects in the affinity relationship can fit on a given node.</span></span> <span data-ttu-id="ae498-151">I dessa fall även om det finns en tillhörigheten på plats, kan inte den tillämpas på grund av andra villkor.</span><span class="sxs-lookup"><span data-stu-id="ae498-151">In these cases even though there's an affinity relationship in place, it can't be enforced due to the other constraints.</span></span> <span data-ttu-id="ae498-152">Om det är möjligt att göra det, korrigeras överträdelse senare.</span><span class="sxs-lookup"><span data-stu-id="ae498-152">If it is possible to do so, the violation is automatically corrected later.</span></span>

### <a name="chains-vs-stars"></a><span data-ttu-id="ae498-153">Kedjor kontra stjärnor</span><span class="sxs-lookup"><span data-stu-id="ae498-153">Chains vs. stars</span></span>
<span data-ttu-id="ae498-154">Klustret Resource Manager är idag inte kunna modellen kedjor tillhörighet relationer.</span><span class="sxs-lookup"><span data-stu-id="ae498-154">Today the Cluster Resource Manager isn't able to model chains of affinity relationships.</span></span> <span data-ttu-id="ae498-155">Det innebär som en tjänst som är underordnat i en tillhörigheten får inte vara en förälder i en annan tillhörigheten.</span><span class="sxs-lookup"><span data-stu-id="ae498-155">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span></span> <span data-ttu-id="ae498-156">Om du vill att den här typen av relation har du effektivt modellen som en stjärna i stället för en kedja.</span><span class="sxs-lookup"><span data-stu-id="ae498-156">If you want to model this type of relationship, you effectively have to model it as a star, rather than a chain.</span></span> <span data-ttu-id="ae498-157">Om du vill flytta från en kedja till en stjärna, den lägsta underordnat skulle ha en överordnad till den första underordnade överordnad i stället.</span><span class="sxs-lookup"><span data-stu-id="ae498-157">To move from a chain to a star, the bottommost child would be parented to the first child’s parent instead.</span></span> <span data-ttu-id="ae498-158">Beroende på hur dina tjänster kan du behöva göra detta flera gånger.</span><span class="sxs-lookup"><span data-stu-id="ae498-158">Depending on the arrangement of your services, you may have to do this multiple times.</span></span> <span data-ttu-id="ae498-159">Om det finns ingen fysisk överordnade tjänst, kan du behöva skapa en som fungerar som platshållare.</span><span class="sxs-lookup"><span data-stu-id="ae498-159">If there's no natural parent service, you may have to create one that serves as a placeholder.</span></span> <span data-ttu-id="ae498-160">Beroende på dina krav kan du även vill söka i [programgrupper](service-fabric-cluster-resource-manager-application-groups.md).</span><span class="sxs-lookup"><span data-stu-id="ae498-160">Depending on your requirements, you may also want to look into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span></span>

<span data-ttu-id="ae498-161"><center>
![Kedjor vs. Stjärnor i samband med tillhörighet relationer][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="ae498-161"><center>
![Chains vs. Stars in the Context of Affinity Relationships][Image2]
</center></span></span>

<span data-ttu-id="ae498-162">Märke om mappning mellan relationer idag till är att de är riktat.</span><span class="sxs-lookup"><span data-stu-id="ae498-162">Another thing to note about affinity relationships today is that they are directional.</span></span> <span data-ttu-id="ae498-163">Det innebär att regeln tillhörighet endast tillämpar att underordnat placeras med överordnat.</span><span class="sxs-lookup"><span data-stu-id="ae498-163">This means that the affinity rule only enforces that the child placed with the parent.</span></span> <span data-ttu-id="ae498-164">Det garanterar inte att överordnat finns med underordnat.</span><span class="sxs-lookup"><span data-stu-id="ae498-164">It does not ensure that the parent is located with the child.</span></span> <span data-ttu-id="ae498-165">Det är också viktigt att Observera att tillhörigheten inte perfekt eller direkt eftersom olika tjänster har med olika livscykler kan misslyckas och flytta oberoende av varandra.</span><span class="sxs-lookup"><span data-stu-id="ae498-165">It is also important to note that the affinity relationship can't be perfect or instantly enforced since different services have with different lifecycles and can fail and move independently.</span></span> <span data-ttu-id="ae498-166">Anta exempelvis att överordnat plötsligt flyttas över till en annan nod eftersom den har kraschat.</span><span class="sxs-lookup"><span data-stu-id="ae498-166">For example, let's say the parent suddenly fails over to another node because it crashed.</span></span> <span data-ttu-id="ae498-167">Hanteraren för filserverresurser och Failover Manager hanterar redundans först sedan hålla tjänsterna, konsekvent, och tillgänglig är prioriteten.</span><span class="sxs-lookup"><span data-stu-id="ae498-167">The Cluster Resource Manager and Failover Manager handle the failover first, since keeping the services up, consistent, and available is the priority.</span></span> <span data-ttu-id="ae498-168">När redundansväxlingen är klar på tillhörigheten har brutits, men klustret Resource Manager tror att allt är bra tills den meddelanden underordnad inte är finns med överordnat.</span><span class="sxs-lookup"><span data-stu-id="ae498-168">Once the failover completes, the affinity relationship is broken, but the Cluster Resource Manager thinks everything is fine until it notices that the child is not located with the parent.</span></span> <span data-ttu-id="ae498-169">Dessa typer av kontroller som utförs med jämna mellanrum.</span><span class="sxs-lookup"><span data-stu-id="ae498-169">These sorts of checks are performed periodically.</span></span> <span data-ttu-id="ae498-170">Mer information om hur klustret Resource Manager utvärderar villkor finns i [i den här artikeln](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), och [den här](service-fabric-cluster-resource-manager-balancing.md) berättar mer om hur du konfigurerar det intervall då dessa villkor utvärderas.</span><span class="sxs-lookup"><span data-stu-id="ae498-170">More information on how the Cluster Resource Manager evaluates constraints is available in [this article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), and [this one](service-fabric-cluster-resource-manager-balancing.md) talks more about how to configure the cadence on which these constraints are evaluated.</span></span>   


### <a name="partitioning-support"></a><span data-ttu-id="ae498-171">Partitionering</span><span class="sxs-lookup"><span data-stu-id="ae498-171">Partitioning support</span></span>
<span data-ttu-id="ae498-172">Observera om mappning mellan den sista åtgärd är den tillhörighet relationer inte stöds om överordnat är partitionerad.</span><span class="sxs-lookup"><span data-stu-id="ae498-172">The final thing to notice about affinity is that affinity relationships aren’t supported where the parent is partitioned.</span></span> <span data-ttu-id="ae498-173">Partitionerade överordnade tjänster kan stödjas förr eller senare, men idag är det inte tillåtet.</span><span class="sxs-lookup"><span data-stu-id="ae498-173">Partitioned parent services may be supported eventually, but today it is not allowed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ae498-174">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="ae498-174">Next steps</span></span>
- <span data-ttu-id="ae498-175">Mer information om hur du konfigurerar tjänster, [Lär dig mer om hur du konfigurerar tjänster](service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="ae498-175">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="ae498-176">Att begränsa tjänster till en liten uppsättning datorer eller aggregering belastningen på tjänster, använda [programgrupper](service-fabric-cluster-resource-manager-application-groups.md)</span><span class="sxs-lookup"><span data-stu-id="ae498-176">To limit services to a small set of machines or aggregating the load of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png