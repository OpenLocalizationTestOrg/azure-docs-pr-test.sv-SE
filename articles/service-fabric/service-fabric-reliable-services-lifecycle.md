---
title: "Översikt över livscykeln för Azure Service Fabric Reliable Services | Microsoft Docs"
description: "Lär dig mer om livscykeln för olika händelser i Service Fabric reliable services"
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: 
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 16021ca72a2f10070b6409417ff0d88009591331
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 08/18/2017
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="a59b8-103">Översikt över livscykeln Reliable services</span><span class="sxs-lookup"><span data-stu-id="a59b8-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="a59b8-104">C# i Windows</span><span class="sxs-lookup"><span data-stu-id="a59b8-104">C# on Windows</span></span>](service-fabric-reliable-services-lifecycle.md)
> * [<span data-ttu-id="a59b8-105">Java i Linux</span><span class="sxs-lookup"><span data-stu-id="a59b8-105">Java on Linux</span></span>](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="a59b8-106">Grunderna i livscykeln är viktigast när du tänker livscykler för Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="a59b8-106">When thinking about the lifecycles of Reliable Services, the basics of the lifecycle are the most important.</span></span> <span data-ttu-id="a59b8-107">I allmänhet:</span><span class="sxs-lookup"><span data-stu-id="a59b8-107">In general:</span></span>

- <span data-ttu-id="a59b8-108">Under Start</span><span class="sxs-lookup"><span data-stu-id="a59b8-108">During Startup</span></span>
  - <span data-ttu-id="a59b8-109">Tjänster är uppbyggda</span><span class="sxs-lookup"><span data-stu-id="a59b8-109">Services are constructed</span></span>
  - <span data-ttu-id="a59b8-110">De har möjlighet att skapa och returnera noll eller flera lyssnare</span><span class="sxs-lookup"><span data-stu-id="a59b8-110">They have an opportunity to construct and return zero or more listeners</span></span>
  - <span data-ttu-id="a59b8-111">Alla returnerade lyssnare öppnas kommunikation med tjänsten</span><span class="sxs-lookup"><span data-stu-id="a59b8-111">Any returned listeners are opened, allowing communication with the service</span></span>
  - <span data-ttu-id="a59b8-112">Tjänstens RunAsync-metoden anropas, vilket gör att tjänsten för att göra länge körs eller bakgrund arbete</span><span class="sxs-lookup"><span data-stu-id="a59b8-112">The Service's RunAsync method is called, allowing the service to do long running or background work</span></span>
- <span data-ttu-id="a59b8-113">Vid avstängning</span><span class="sxs-lookup"><span data-stu-id="a59b8-113">During shutdown</span></span>
  - <span data-ttu-id="a59b8-114">Annullering-token som skickades till RunAsync avbryts och lyssnarna stängs</span><span class="sxs-lookup"><span data-stu-id="a59b8-114">The cancellation token passed to RunAsync is canceled, and the listeners are closed</span></span>
  - <span data-ttu-id="a59b8-115">När detta är klar, själva tjänstobjektet är destructed</span><span class="sxs-lookup"><span data-stu-id="a59b8-115">Once that is complete, the service object itself is destructed</span></span>

<span data-ttu-id="a59b8-116">Det finns information runt den exakta sorteringen av dessa händelser.</span><span class="sxs-lookup"><span data-stu-id="a59b8-116">There are details around the exact ordering of these events.</span></span> <span data-ttu-id="a59b8-117">I synnerhet kan ordningen för händelser ändras lite beroende på om tjänsten tillförlitliga är Stateless eller Stateful.</span><span class="sxs-lookup"><span data-stu-id="a59b8-117">In particular, the order of events may change slightly depending on whether the Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="a59b8-118">Dessutom för tillståndskänsliga tjänster måste vi hantera primära växlingen scenario.</span><span class="sxs-lookup"><span data-stu-id="a59b8-118">In addition, for stateful services, we have to deal with the Primary swap scenario.</span></span> <span data-ttu-id="a59b8-119">Under den här sekvensen rollen som primär överförs till en annan replik (eller kommer tillbaka) utan att tjänsten avslutas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-119">During this sequence, the role of Primary is transferred to another replica (or comes back) without the service shutting down.</span></span> <span data-ttu-id="a59b8-120">Slutligen behöver vi tänka på felet villkor.</span><span class="sxs-lookup"><span data-stu-id="a59b8-120">Finally, we have to think about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="a59b8-121">Tillståndslösa tjänsten startades</span><span class="sxs-lookup"><span data-stu-id="a59b8-121">Stateless service startup</span></span>
<span data-ttu-id="a59b8-122">Livscykeln för tillståndslösa tjänsten är ganska enkelt.</span><span class="sxs-lookup"><span data-stu-id="a59b8-122">The lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="a59b8-123">Här är ordningen för händelser:</span><span class="sxs-lookup"><span data-stu-id="a59b8-123">Here's the order of events:</span></span>

1. <span data-ttu-id="a59b8-124">Tjänsten har skapats</span><span class="sxs-lookup"><span data-stu-id="a59b8-124">The Service is constructed</span></span>
2. <span data-ttu-id="a59b8-125">Görs sedan i parallella två saker:</span><span class="sxs-lookup"><span data-stu-id="a59b8-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="a59b8-126">`StatelessService.CreateServiceInstanceListeners()`har anropats och eventuella returnerade lyssnare öppnas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="a59b8-127">`ICommunicationListener.OpenAsync()`anropas på varje lyssnare</span><span class="sxs-lookup"><span data-stu-id="a59b8-127">`ICommunicationListener.OpenAsync()` is called on each listener</span></span>
    - <span data-ttu-id="a59b8-128">Tjänstens `StatelessService.RunAsync()` metoden anropas</span><span class="sxs-lookup"><span data-stu-id="a59b8-128">The service's `StatelessService.RunAsync()` method is called</span></span>
3. <span data-ttu-id="a59b8-129">Om den finns i tjänstens `StatelessService.OnOpenAsync()` metoden anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-129">If present, the service's `StatelessService.OnOpenAsync()` method is called.</span></span> <span data-ttu-id="a59b8-130">Det här är en ovanligt åsidosättning, men den är tillgänglig.</span><span class="sxs-lookup"><span data-stu-id="a59b8-130">This is an uncommon override, but it is available.</span></span>

<span data-ttu-id="a59b8-131">Det är viktigt att notera att det finns ingen ordning mellan anrop för att skapa och öppna lyssnare och RunAsync.</span><span class="sxs-lookup"><span data-stu-id="a59b8-131">It is important to note that there is no ordering between the calls to create and open the listeners and RunAsync.</span></span> <span data-ttu-id="a59b8-132">Lyssnarna kan öppna innan RunAsync har startats.</span><span class="sxs-lookup"><span data-stu-id="a59b8-132">The listeners may open before RunAsync is started.</span></span> <span data-ttu-id="a59b8-133">På liknande sätt kan RunAsync hamna anropas innan kommunikationslyssnarna är öppna eller även har skapats.</span><span class="sxs-lookup"><span data-stu-id="a59b8-133">Similarly, RunAsync may end up invoked before the communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="a59b8-134">Om ingen synkronisering krävs, måste lämnas den som Övning till Implementeraren.</span><span class="sxs-lookup"><span data-stu-id="a59b8-134">If any synchronization is required, it is left as an exercise to the implementer.</span></span> <span data-ttu-id="a59b8-135">Vanliga lösningar:</span><span class="sxs-lookup"><span data-stu-id="a59b8-135">Common solutions:</span></span>

  - <span data-ttu-id="a59b8-136">Lyssnare fungerar ibland inte förrän annan information som har skapats eller arbete som gjorts.</span><span class="sxs-lookup"><span data-stu-id="a59b8-136">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="a59b8-137">För tillståndslösa tjänster som arbete kan vanligtvis utföras på andra platser som:</span><span class="sxs-lookup"><span data-stu-id="a59b8-137">For stateless services that work can usually be done in other locations, such as:</span></span> 
    - <span data-ttu-id="a59b8-138">i tjänstens konstruktor</span><span class="sxs-lookup"><span data-stu-id="a59b8-138">in the service's constructor</span></span>
    - <span data-ttu-id="a59b8-139">under den `CreateServiceInstanceListeners()` anropa</span><span class="sxs-lookup"><span data-stu-id="a59b8-139">during the `CreateServiceInstanceListeners()` call</span></span>
    - <span data-ttu-id="a59b8-140">som en del av konstruktionen för lyssnare sig själv</span><span class="sxs-lookup"><span data-stu-id="a59b8-140">as a part of the construction of the listener itself</span></span>
  - <span data-ttu-id="a59b8-141">Ibland vill koden i RunAsync inte startas förrän lyssnarna är öppna.</span><span class="sxs-lookup"><span data-stu-id="a59b8-141">Sometimes the code in RunAsync does not want to start until the listeners are open.</span></span> <span data-ttu-id="a59b8-142">I så fall krävs ytterligare samordning.</span><span class="sxs-lookup"><span data-stu-id="a59b8-142">In this case additional coordination is necessary.</span></span> <span data-ttu-id="a59b8-143">En vanlig lösning är vissa flagga i lyssnare som anger när de har slutförts.</span><span class="sxs-lookup"><span data-stu-id="a59b8-143">One common solution is some flag within the listeners indicating when they have completed.</span></span> <span data-ttu-id="a59b8-144">Den här flaggan kontrolleras sedan i RunAsync innan du fortsätter verkligt arbete.</span><span class="sxs-lookup"><span data-stu-id="a59b8-144">This flag is then checked in RunAsync before continuing to actual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="a59b8-145">Tillståndslösa tjänsten avstängning</span><span class="sxs-lookup"><span data-stu-id="a59b8-145">Stateless service shutdown</span></span>
<span data-ttu-id="a59b8-146">När du stänger en tillståndslös tjänst följt samma mönster bara i omvänd:</span><span class="sxs-lookup"><span data-stu-id="a59b8-146">When shutting down a stateless service, the same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="a59b8-147">Parallellt</span><span class="sxs-lookup"><span data-stu-id="a59b8-147">In parallel</span></span>
    - <span data-ttu-id="a59b8-148">Alla öppna lyssnare stängs.</span><span class="sxs-lookup"><span data-stu-id="a59b8-148">Any open listeners are Closed.</span></span> <span data-ttu-id="a59b8-149">`ICommunicationListener.CloseAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="a59b8-149">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="a59b8-150">Annullering-token som skickades till `RunAsync()` har avbrutits.</span><span class="sxs-lookup"><span data-stu-id="a59b8-150">The cancellation token passed to `RunAsync()` is canceled.</span></span> <span data-ttu-id="a59b8-151">Kontrollera token annullering `IsCancellationRequested` -egenskap returnerar true, och om den anropas token `ThrowIfCancellationRequested` metoden returnerar en `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="a59b8-151">Checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="a59b8-152">En gång `CloseAsync()` har slutförts på varje lyssnare och `RunAsync()` också har slutförts tjänstens `StatelessService.OnCloseAsync()` metoden anropas, om sådan finns.</span><span class="sxs-lookup"><span data-stu-id="a59b8-152">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatelessService.OnCloseAsync()` method is called, if present.</span></span> <span data-ttu-id="a59b8-153">Det är ovanligt att åsidosätta `StatelessService.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="a59b8-153">It is uncommon to override `StatelessService.OnCloseAsync()`.</span></span>
3. <span data-ttu-id="a59b8-154">När `StatelessService.OnCloseAsync()` är klar serviceobjektet destructed</span><span class="sxs-lookup"><span data-stu-id="a59b8-154">After `StatelessService.OnCloseAsync()` completes, the service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="a59b8-155">Tillståndskänslig service Start</span><span class="sxs-lookup"><span data-stu-id="a59b8-155">Stateful service Startup</span></span>
<span data-ttu-id="a59b8-156">Tillståndskänsliga tjänster har ett liknande mönster tillståndslösa tjänster med några ändringar.</span><span class="sxs-lookup"><span data-stu-id="a59b8-156">Stateful services have a similar pattern to stateless services, with a few changes.</span></span> <span data-ttu-id="a59b8-157">När du startar en tillståndskänslig service är ordningen för händelser:</span><span class="sxs-lookup"><span data-stu-id="a59b8-157">When starting up a stateful service, the order of events is as follows:</span></span>

1. <span data-ttu-id="a59b8-158">Tjänsten har skapats</span><span class="sxs-lookup"><span data-stu-id="a59b8-158">The Service is constructed</span></span>
2. <span data-ttu-id="a59b8-159">`StatefulServiceBase.OnOpenAsync()`anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-159">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="a59b8-160">Detta åsidosätts uncommonly i tjänsten.</span><span class="sxs-lookup"><span data-stu-id="a59b8-160">This is uncommonly overridden in the service.</span></span>
3. <span data-ttu-id="a59b8-161">Följande händer parallellt</span><span class="sxs-lookup"><span data-stu-id="a59b8-161">The following things happen in parallel</span></span>
    - <span data-ttu-id="a59b8-162">`StatefulServiceBase.CreateServiceReplicaListeners()`anropas</span><span class="sxs-lookup"><span data-stu-id="a59b8-162">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked</span></span> 
      - <span data-ttu-id="a59b8-163">Om tjänsten är en primär öppnas alla returnerade lyssnare.</span><span class="sxs-lookup"><span data-stu-id="a59b8-163">If the service is a Primary all returned listeners are Opened.</span></span> <span data-ttu-id="a59b8-164">`ICommunicationListener.OpenAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="a59b8-164">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
      - <span data-ttu-id="a59b8-165">Om tjänsten är en sekundär kan endast dessa lyssnare markerad som `ListenOnSecondary = true` öppnas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-165">If the service is a Secondary, only those listeners marked as `ListenOnSecondary = true` are opened.</span></span> <span data-ttu-id="a59b8-166">Med lyssnare som är öppna på sekundärservrar är mindre vanliga.</span><span class="sxs-lookup"><span data-stu-id="a59b8-166">Having listeners that are open on Secondaries is less common.</span></span>
    - <span data-ttu-id="a59b8-167">Den om tjänsten är en primär, tjänstens `StatefulServiceBase.RunAsync()` metoden anropas</span><span class="sxs-lookup"><span data-stu-id="a59b8-167">The if the Service is currently a Primary, the service's `StatefulServiceBase.RunAsync()` method is called</span></span>
4. <span data-ttu-id="a59b8-168">När alla replik lyssnarens `OpenAsync()` anrop slutföra och `RunAsync()` anropas, `StatefulServiceBase.OnChangeRoleAsync()` anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-168">Once all the replica listener's `OpenAsync()` calls complete and `RunAsync()` is called, `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="a59b8-169">Detta åsidosätts uncommonly i tjänsten.</span><span class="sxs-lookup"><span data-stu-id="a59b8-169">This is uncommonly overridden in the service.</span></span>

<span data-ttu-id="a59b8-170">På liknande sätt till tillståndslösa tjänster finns inga samordning mellan ordningen som lyssnarna har skapats och öppnats och när RunAsync anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-170">Similarly to stateless services, there's no coordination between the order in which the listeners are created and opened and when RunAsync is called.</span></span> <span data-ttu-id="a59b8-171">Om du behöver samordning är ungefär lösningarna.</span><span class="sxs-lookup"><span data-stu-id="a59b8-171">If you need coordination, the solutions are much the same.</span></span> <span data-ttu-id="a59b8-172">Det finns en ytterligare fall: säger att anrop anländer till kommunikationslyssnarna kräver information som sparas i vissa [tillförlitliga samlingar](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="a59b8-172">THere is one additional case: say that the calls arriving at the communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="a59b8-173">Vissa ytterligare samordning är nödvändigt eftersom kommunikationslyssnarna gick att öppna innan de tillförlitliga samlingarna är läsbart eller skrivbart och innan RunAsync kunde starta.</span><span class="sxs-lookup"><span data-stu-id="a59b8-173">Because the communication listeners could open before the reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="a59b8-174">Den enklaste och de vanligaste lösningen är för kommunikationslyssnarna att returnera vissa felkod som klienten använder för att försöka.</span><span class="sxs-lookup"><span data-stu-id="a59b8-174">The simplest and most common solution is for the communication listeners to return some error code that the client uses to know to retry the request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="a59b8-175">Tillståndskänslig service avstängning</span><span class="sxs-lookup"><span data-stu-id="a59b8-175">Stateful service Shutdown</span></span>
<span data-ttu-id="a59b8-176">På samma sätt som tillståndslösa tjänster Livscykelhändelser vid avstängningen är samma som under starten men omvänd.</span><span class="sxs-lookup"><span data-stu-id="a59b8-176">Similarly to Stateless services, the lifecycle events during shutdown are the same as during startup, but reversed.</span></span> <span data-ttu-id="a59b8-177">När en tillståndskänslig service stängs av, händer följande:</span><span class="sxs-lookup"><span data-stu-id="a59b8-177">When a stateful service is being shut down, the following events occur:</span></span>

1. <span data-ttu-id="a59b8-178">Parallellt</span><span class="sxs-lookup"><span data-stu-id="a59b8-178">In parallel</span></span>
    - <span data-ttu-id="a59b8-179">Alla öppna lyssnare stängs.</span><span class="sxs-lookup"><span data-stu-id="a59b8-179">Any open listeners are Closed.</span></span> <span data-ttu-id="a59b8-180">`ICommunicationListener.CloseAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="a59b8-180">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="a59b8-181">Annullering-token som skickades till `RunAsync()` har avbrutits.</span><span class="sxs-lookup"><span data-stu-id="a59b8-181">The cancellation token passed to `RunAsync()` is canceled.</span></span> <span data-ttu-id="a59b8-182">Kontrollera token annullering `IsCancellationRequested` -egenskap returnerar true, och om den anropas token `ThrowIfCancellationRequested` metoden returnerar en `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="a59b8-182">Checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="a59b8-183">En gång `CloseAsync()` har slutförts på varje lyssnare och `RunAsync()` också har slutförts tjänstens `StatefulServiceBase.OnChangeRoleAsync()` anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-183">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="a59b8-184">(Detta uncommonly åsidosätts i tjänsten.)</span><span class="sxs-lookup"><span data-stu-id="a59b8-184">(This is uncommonly overridden in the service.)</span></span>
    - <span data-ttu-id="a59b8-185">Väntar på RunAsync att slutföra är bara nödvändigt om den här tjänsten repliken var en primär.</span><span class="sxs-lookup"><span data-stu-id="a59b8-185">Waiting for RunAsync to complete is only necessary if this service replica was a Primary.</span></span>
3. <span data-ttu-id="a59b8-186">En gång i `StatefulServiceBase.OnChangeRoleAsync()` metoden har slutförts i `StatefulServiceBase.OnCloseAsync()` -metoden anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-186">Once the `StatefulServiceBase.OnChangeRoleAsync()` method completes, the `StatefulServiceBase.OnCloseAsync()` method is called.</span></span> <span data-ttu-id="a59b8-187">Det här är en ovanligt åsidosättning, men den är tillgänglig.</span><span class="sxs-lookup"><span data-stu-id="a59b8-187">This is an uncommon override, but it is available.</span></span>
3. <span data-ttu-id="a59b8-188">När `StatefulServiceBase.OnCloseAsync()` är klar serviceobjektet destructed.</span><span class="sxs-lookup"><span data-stu-id="a59b8-188">After `StatefulServiceBase.OnCloseAsync()` completes, the service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="a59b8-189">Tillståndskänslig service primära växlingar</span><span class="sxs-lookup"><span data-stu-id="a59b8-189">Stateful service primary swaps</span></span>
<span data-ttu-id="a59b8-190">När en tillståndskänslig service körs, har de primära replikerna av de tillståndskänsliga tjänsterna sina kommunikationslyssnarna öppnas och deras RunAsync-metoden anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-190">While a stateful service is running, only the Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="a59b8-191">Sekundär är uppbyggda men det finns inga ytterligare anrop.</span><span class="sxs-lookup"><span data-stu-id="a59b8-191">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="a59b8-192">När en tillståndskänslig tjänst körs men, kan vilka repliken för närvarande är primärt ändra.</span><span class="sxs-lookup"><span data-stu-id="a59b8-192">While a stateful service is running however, which replica is currently the Primary can change.</span></span> <span data-ttu-id="a59b8-193">Vad innebär det i villkoren för händelserna livscykel som en replik kan se?</span><span class="sxs-lookup"><span data-stu-id="a59b8-193">What does this mean in terms of the lifecycle events that a replica can see?</span></span> <span data-ttu-id="a59b8-194">Beteendet tillståndskänslig repliken ser beror på om det är repliken som nedgraderas eller uppgraderas under växlingen.</span><span class="sxs-lookup"><span data-stu-id="a59b8-194">The behavior the stateful replica sees depends on whether it is the replica being demoted or promoted during the swap.</span></span>

### <a name="for-the-primary-being-demoted"></a><span data-ttu-id="a59b8-195">För den primära som nedgraderas</span><span class="sxs-lookup"><span data-stu-id="a59b8-195">For the primary being demoted</span></span>
<span data-ttu-id="a59b8-196">Service Fabric måste den här repliken för att avbryta behandlar meddelanden och avsluta alla bakgrundsjobbet avbrytas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-196">Service Fabric needs this replica to stop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="a59b8-197">Därför kan liknar det här steget när tjänsten stängs av.</span><span class="sxs-lookup"><span data-stu-id="a59b8-197">As a result, this step looks similar to when the service is being shut down.</span></span> <span data-ttu-id="a59b8-198">En skillnaden är att tjänsten inte är destructed eller stängts eftersom det fortfarande som en sekundär.</span><span class="sxs-lookup"><span data-stu-id="a59b8-198">One difference is that the Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="a59b8-199">Följande API: er anropas:</span><span class="sxs-lookup"><span data-stu-id="a59b8-199">The following APIs are called:</span></span>

1. <span data-ttu-id="a59b8-200">Parallellt</span><span class="sxs-lookup"><span data-stu-id="a59b8-200">In parallel</span></span>
    - <span data-ttu-id="a59b8-201">Alla öppna lyssnare stängs.</span><span class="sxs-lookup"><span data-stu-id="a59b8-201">Any open listeners are Closed.</span></span> <span data-ttu-id="a59b8-202">`ICommunicationListener.CloseAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="a59b8-202">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="a59b8-203">Annullering-token som skickades till `RunAsync()` har avbrutits.</span><span class="sxs-lookup"><span data-stu-id="a59b8-203">The cancellation token passed to `RunAsync()` is canceled.</span></span> <span data-ttu-id="a59b8-204">Kontrollera token annullering `IsCancellationRequested` -egenskap returnerar true, och om den anropas token `ThrowIfCancellationRequested` metoden returnerar en `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="a59b8-204">Checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="a59b8-205">En gång `CloseAsync()` har slutförts på varje lyssnare och `RunAsync()` också har slutförts tjänstens `StatefulServiceBase.OnChangeRoleAsync()` anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-205">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="a59b8-206">Detta åsidosätts uncommonly i tjänsten.</span><span class="sxs-lookup"><span data-stu-id="a59b8-206">This is uncommonly overridden in the service.</span></span>

### <a name="for-the-secondary-being-promoted"></a><span data-ttu-id="a59b8-207">För den sekundära som uppgraderas</span><span class="sxs-lookup"><span data-stu-id="a59b8-207">For the secondary being promoted</span></span>
<span data-ttu-id="a59b8-208">På liknande sätt, Service Fabric måste replikeringen att starta lyssnar efter meddelanden på kabeln och starta alla bakgrundsaktiviteter den mån om.</span><span class="sxs-lookup"><span data-stu-id="a59b8-208">Similarly, Service Fabric needs this replica to start listening for messages on the wire and start any background tasks it cares about.</span></span> <span data-ttu-id="a59b8-209">Därför kan liknar den här processen när tjänsten har skapats, förutom att repliken själva finns redan.</span><span class="sxs-lookup"><span data-stu-id="a59b8-209">As a result, this process looks similar to when the service is created, except that the replica itself already exists.</span></span> <span data-ttu-id="a59b8-210">Följande API: er anropas:</span><span class="sxs-lookup"><span data-stu-id="a59b8-210">The following APIs are called:</span></span>

1. <span data-ttu-id="a59b8-211">Parallellt</span><span class="sxs-lookup"><span data-stu-id="a59b8-211">In parallel</span></span>
    - <span data-ttu-id="a59b8-212">`StatefulServiceBase.CreateServiceReplicaListeners()`har anropats och eventuella returnerade lyssnare öppnas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-212">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="a59b8-213">`ICommunicationListener.OpenAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="a59b8-213">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="a59b8-214">Tjänstens `StatefulServiceBase.RunAsync()` metoden anropas</span><span class="sxs-lookup"><span data-stu-id="a59b8-214">The service's `StatefulServiceBase.RunAsync()` method is called</span></span>
2. <span data-ttu-id="a59b8-215">När alla replik lyssnarens `OpenAsync()` anrop slutföra och `RunAsync()` har anropats `StatefulServiceBase.OnChangeRoleAsync()` anropas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-215">Once all the replica listener's `OpenAsync()` calls complete and `RunAsync()` has been called,  `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="a59b8-216">Detta åsidosätts uncommonly i tjänsten.</span><span class="sxs-lookup"><span data-stu-id="a59b8-216">This is uncommonly overridden in the service.</span></span>

### <a name="common-issues-during-stateful-service-shutdown-and-primary-demotion"></a><span data-ttu-id="a59b8-217">Vanliga problem vid avstängning av tjänst tillståndskänsliga och primära degradering</span><span class="sxs-lookup"><span data-stu-id="a59b8-217">Common issues during stateful service shutdown and primary demotion</span></span>
<span data-ttu-id="a59b8-218">Service Fabric ändringar av en tillståndskänslig tjänst för en mängd olika skäl.</span><span class="sxs-lookup"><span data-stu-id="a59b8-218">Service Fabric changes the Primary of a stateful service for a variety of reasons.</span></span> <span data-ttu-id="a59b8-219">De vanligaste är [kluster ombalansering](service-fabric-cluster-resource-manager-balancing.md) och [Programuppgradering](service-fabric-application-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="a59b8-219">The most common are [cluster rebalancing](service-fabric-cluster-resource-manager-balancing.md) and [application upgrade](service-fabric-application-upgrade.md).</span></span> <span data-ttu-id="a59b8-220">Under dessa åtgärder (samt under normal drift avslutning, som du vill se om tjänsten har tagits bort), är det viktigt att tjänsten följer den `CancellationToken`.</span><span class="sxs-lookup"><span data-stu-id="a59b8-220">During these operations (as well as during normal service shutdown, like you'd see if the service was deleted), it is important that the service respect the `CancellationToken`.</span></span> <span data-ttu-id="a59b8-221">Tjänster som inte hanterar avbryta en klar får flera problem.</span><span class="sxs-lookup"><span data-stu-id="a59b8-221">Services that do not handle cancellation cleanly will experience several issues.</span></span> <span data-ttu-id="a59b8-222">I synnerhet dessa åtgärder kommer att vara långsam eftersom Service Fabric väntar tjänster ska avslutas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-222">In particular, these operations will be slow since Service Fabric waits for the services to stop gracefully.</span></span> <span data-ttu-id="a59b8-223">Slutligen kan detta leda till misslyckade uppgraderingar tiden och återställa.</span><span class="sxs-lookup"><span data-stu-id="a59b8-223">This can ultimately lead to failed upgrades that time out and roll back.</span></span> <span data-ttu-id="a59b8-224">Respektera cancellation-token kan också medföra imbalanced kluster eftersom noder hämta hot men kan inte vara genomförs tjänsterna eftersom det tar för lång tid att flytta dem någon annanstans.</span><span class="sxs-lookup"><span data-stu-id="a59b8-224">Failure to honor the cancellation token can also cause imbalanced clusters because nodes get hot but the services can't be rebalanced since it takes too long to move them elsewhere.</span></span> 

<span data-ttu-id="a59b8-225">Eftersom tjänsterna är tillståndskänslig, det är också troligt att de använder den [tillförlitliga samlingar](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="a59b8-225">Since the services are stateful, it is also likely that they are using the [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="a59b8-226">När en primär degraderas i Service Fabric är en av de första sakerna som händer skrivåtkomst till tillståndet för underliggande återkallas.</span><span class="sxs-lookup"><span data-stu-id="a59b8-226">In Service Fabric, when a Primary is demoted, one of the first things that happens is that write access to the underlying state is revoked.</span></span> <span data-ttu-id="a59b8-227">Detta leder till en annan uppsättning problem som kan påverka service lifecycle.</span><span class="sxs-lookup"><span data-stu-id="a59b8-227">This leads to a second set of issues that can impact the service lifecycle.</span></span> <span data-ttu-id="a59b8-228">Samlingar returnerade undantag baserat på tiden och om repliken flyttas eller stängs av.</span><span class="sxs-lookup"><span data-stu-id="a59b8-228">The collections return Exceptions based on the timing and whether the replica is being moved or shut down.</span></span> <span data-ttu-id="a59b8-229">Sådana undantag ska hanteras på rätt sätt.</span><span class="sxs-lookup"><span data-stu-id="a59b8-229">These exceptions should be handled correctly.</span></span> <span data-ttu-id="a59b8-230">Undantag från Service Fabric är indelade i permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) och tillfälligt [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) kategorier.</span><span class="sxs-lookup"><span data-stu-id="a59b8-230">Exceptions thrown by Service Fabric fall into permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) and transient [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categories.</span></span> <span data-ttu-id="a59b8-231">Permanent undantag ska loggas och uppstod medan tillfälligt undantag kan göras baserat på vissa logik.</span><span class="sxs-lookup"><span data-stu-id="a59b8-231">Permanent exceptions should be logged and thrown, while the transient exceptions may be retried based on some retry logic.</span></span>

<span data-ttu-id="a59b8-232">Hantering av undantag som härrör från användning av den `ReliableCollections` tillsammans med tjänsten Livscykelhändelser är en viktig del av testa och validera en tillförlitlig tjänst.</span><span class="sxs-lookup"><span data-stu-id="a59b8-232">Handling the exceptions that come from use of the `ReliableCollections` in conjunction with service lifecycle events is an important part of testing and validating a Reliable Service.</span></span> <span data-ttu-id="a59b8-233">Rekommendationen är alltid att köra tjänsten under belastning under uppgraderingar och [chaos testning](service-fabric-controlled-chaos.md) innan du distribuerar någonsin till produktionen.</span><span class="sxs-lookup"><span data-stu-id="a59b8-233">The recommendation is always to run your service under load while performing upgrades and [chaos testing](service-fabric-controlled-chaos.md) before ever deploying to production.</span></span> <span data-ttu-id="a59b8-234">De grundläggande stegen för att säkerställa att din tjänst har implementerats korrekt och hanterar Livscykelhändelser på rätt sätt.</span><span class="sxs-lookup"><span data-stu-id="a59b8-234">These basic steps help ensure that your service is correctly implemented and handles lifecycle events correctly.</span></span>


## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="a59b8-235">Information om tjänsten livscykel</span><span class="sxs-lookup"><span data-stu-id="a59b8-235">Notes on service lifecycle</span></span>
  - <span data-ttu-id="a59b8-236">Både den `RunAsync()` metod och `CreateServiceReplicaListeners/CreateServiceInstanceListeners` anrop är valfria.</span><span class="sxs-lookup"><span data-stu-id="a59b8-236">Both the `RunAsync()` method and the `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="a59b8-237">En tjänst kan ha ett av dem, båda eller inget.</span><span class="sxs-lookup"><span data-stu-id="a59b8-237">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="a59b8-238">Till exempel om tjänsten gör allt arbete som svar på användaren anropar det behövs ingen att implementera `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="a59b8-238">For example, if the service does all its work in response to user calls, there is no need for it to implement `RunAsync()`.</span></span> <span data-ttu-id="a59b8-239">Endast kommunikationslyssnarna och deras associerade kod krävs.</span><span class="sxs-lookup"><span data-stu-id="a59b8-239">Only the communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="a59b8-240">På liknande sätt är att skapa och returnera kommunikationslyssnarna valfritt, eftersom tjänsten kan ha endast bakgrundsjobbet att göra och så att endast måste implementera`RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="a59b8-240">Similarly, creating and returning communication listeners is optional, as the service may have only background work to do, and so only needs to implement `RunAsync()`</span></span>
  - <span data-ttu-id="a59b8-241">Det är giltigt för en tjänst att slutföra `RunAsync()` har och RETUR från den.</span><span class="sxs-lookup"><span data-stu-id="a59b8-241">It is valid for a service to complete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="a59b8-242">Slutför är inte ett fel inträffar.</span><span class="sxs-lookup"><span data-stu-id="a59b8-242">Completing is not a failure condition.</span></span> <span data-ttu-id="a59b8-243">Slutför `RunAsync()` visar att bakgrundsjobbet för tjänsten har slutförts.</span><span class="sxs-lookup"><span data-stu-id="a59b8-243">Completing `RunAsync()` indicates that the background work of the service has completed.</span></span> <span data-ttu-id="a59b8-244">För tillståndskänsliga reliable services `RunAsync()` anropas igen om repliken har nedgraderats från primär till sekundär och sedan befordras till primära.</span><span class="sxs-lookup"><span data-stu-id="a59b8-244">For stateful reliable services, `RunAsync()` is called again if the replica were demoted from Primary to Secondary and then promoted back to Primary.</span></span>
  - <span data-ttu-id="a59b8-245">Om en tjänst avslutas från `RunAsync()` genom att vissa oväntat undantag utgör detta ett fel.</span><span class="sxs-lookup"><span data-stu-id="a59b8-245">If a service exits from `RunAsync()` by throwing some unexpected exception, this constitutes a failure.</span></span> <span data-ttu-id="a59b8-246">Serviceobjektet stängs av och rapporterade felet hälsa.</span><span class="sxs-lookup"><span data-stu-id="a59b8-246">The service object is shut down and a health error reported.</span></span>
  - <span data-ttu-id="a59b8-247">När det finns ingen tidsgräns på returneras från dessa metoder kan du att förlora omedelbart möjligheten att skriva till tillförlitliga samlingar och därför slutföra inte något verkligt arbete.</span><span class="sxs-lookup"><span data-stu-id="a59b8-247">While there is no time limit on returning from these methods, you immediately lose the ability to write to Reliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="a59b8-248">Vi rekommenderar att du returnera så snabbt som möjligt vid mottagning av begäran om att avbryta.</span><span class="sxs-lookup"><span data-stu-id="a59b8-248">It is recommended that you return as quickly as possible upon receiving the cancellation request.</span></span> <span data-ttu-id="a59b8-249">Om tjänsten inte svarar på dessa API-anrop i rimlig tid Service Fabric tvång att avbryta tjänsten.</span><span class="sxs-lookup"><span data-stu-id="a59b8-249">If your service does not respond to these API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="a59b8-250">Vanligtvis sker detta endast under programuppgraderingar eller när en tjänst tas bort.</span><span class="sxs-lookup"><span data-stu-id="a59b8-250">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="a59b8-251">Det här är 15 minuter som standard.</span><span class="sxs-lookup"><span data-stu-id="a59b8-251">This timeout is 15 minutes by default.</span></span>
  - <span data-ttu-id="a59b8-252">Fel i den `OnCloseAsync()` sökväg resultatet i `OnAbort()` anropas som är ett sista chansen bästa möjligheten för tjänsten för att rensa upp och frigör alla resurser som de har begärts.</span><span class="sxs-lookup"><span data-stu-id="a59b8-252">Failures in the `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for the service to clean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="a59b8-253">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="a59b8-253">Next steps</span></span>
- [<span data-ttu-id="a59b8-254">Introduktion till Reliable Services</span><span class="sxs-lookup"><span data-stu-id="a59b8-254">Introduction to Reliable Services</span></span>](service-fabric-reliable-services-introduction.md)
- [<span data-ttu-id="a59b8-255">Snabbstart för Reliable Services</span><span class="sxs-lookup"><span data-stu-id="a59b8-255">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
- [<span data-ttu-id="a59b8-256">Reliable Services avancerade användning</span><span class="sxs-lookup"><span data-stu-id="a59b8-256">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
