---
title: "aaaOverview av hello livscykeln för Azure Service Fabric Reliable Services | Microsoft Docs"
description: "Lär dig mer om hello livscykeln för olika händelser i Service Fabric reliable services"
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: 
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 0d75ed5ee7cda85ac9af6a02e160727277804a2b
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="b48db-103">Översikt över livscykeln Reliable services</span><span class="sxs-lookup"><span data-stu-id="b48db-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="b48db-104">C# i Windows</span><span class="sxs-lookup"><span data-stu-id="b48db-104">C# on Windows</span></span>](service-fabric-reliable-services-lifecycle.md)
> * [<span data-ttu-id="b48db-105">Java i Linux</span><span class="sxs-lookup"><span data-stu-id="b48db-105">Java on Linux</span></span>](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="b48db-106">När du tänker hello livscykler för Reliable Services är hello grunderna i hello livscykel hello viktigaste.</span><span class="sxs-lookup"><span data-stu-id="b48db-106">When thinking about hello lifecycles of Reliable Services, hello basics of hello lifecycle are hello most important.</span></span> <span data-ttu-id="b48db-107">I allmänhet:</span><span class="sxs-lookup"><span data-stu-id="b48db-107">In general:</span></span>

- <span data-ttu-id="b48db-108">Under Start</span><span class="sxs-lookup"><span data-stu-id="b48db-108">During Startup</span></span>
  - <span data-ttu-id="b48db-109">Tjänster är uppbyggda</span><span class="sxs-lookup"><span data-stu-id="b48db-109">Services are constructed</span></span>
  - <span data-ttu-id="b48db-110">De har en möjlighet tooconstruct och returnera noll eller flera lyssnare</span><span class="sxs-lookup"><span data-stu-id="b48db-110">They have an opportunity tooconstruct and return zero or more listeners</span></span>
  - <span data-ttu-id="b48db-111">Alla returnerade lyssnare öppnas kommunikation med hello-tjänsten</span><span class="sxs-lookup"><span data-stu-id="b48db-111">Any returned listeners are opened, allowing communication with hello service</span></span>
  - <span data-ttu-id="b48db-112">hello Service RunAsync metoden anropas, så att hello tjänsten toodo tidskrävande eller bakgrund arbete</span><span class="sxs-lookup"><span data-stu-id="b48db-112">hello Service's RunAsync method is called, allowing hello service toodo long running or background work</span></span>
- <span data-ttu-id="b48db-113">Vid avstängning</span><span class="sxs-lookup"><span data-stu-id="b48db-113">During shutdown</span></span>
  - <span data-ttu-id="b48db-114">hello annullering token skickade tooRunAsync avbryts och hello-lyssnare har stängts</span><span class="sxs-lookup"><span data-stu-id="b48db-114">hello cancellation token passed tooRunAsync is canceled, and hello listeners are closed</span></span>
  - <span data-ttu-id="b48db-115">När detta är klar, hello service själva objektet är destructed</span><span class="sxs-lookup"><span data-stu-id="b48db-115">Once that is complete, hello service object itself is destructed</span></span>

<span data-ttu-id="b48db-116">Det finns information kring hello exakt sorteringen av dessa händelser.</span><span class="sxs-lookup"><span data-stu-id="b48db-116">There are details around hello exact ordering of these events.</span></span> <span data-ttu-id="b48db-117">I synnerhet kan hello ordningen för händelser ändras lite beroende på om hello tillförlitlig tjänst är Stateless eller Stateful.</span><span class="sxs-lookup"><span data-stu-id="b48db-117">In particular, hello order of events may change slightly depending on whether hello Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="b48db-118">Dessutom för tillståndskänsliga tjänster har vi toodeal med hello primära växlingen scenario.</span><span class="sxs-lookup"><span data-stu-id="b48db-118">In addition, for stateful services, we have toodeal with hello Primary swap scenario.</span></span> <span data-ttu-id="b48db-119">Under den här sekvensen hello rollen som primär är överförda tooanother replik (eller kommer tillbaka) utan hello-tjänsten avslutas.</span><span class="sxs-lookup"><span data-stu-id="b48db-119">During this sequence, hello role of Primary is transferred tooanother replica (or comes back) without hello service shutting down.</span></span> <span data-ttu-id="b48db-120">Slutligen har vi toothink om felet villkor.</span><span class="sxs-lookup"><span data-stu-id="b48db-120">Finally, we have toothink about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="b48db-121">Tillståndslösa tjänsten startades</span><span class="sxs-lookup"><span data-stu-id="b48db-121">Stateless service startup</span></span>
<span data-ttu-id="b48db-122">hello livscykeln för tillståndslösa tjänsten är ganska enkelt.</span><span class="sxs-lookup"><span data-stu-id="b48db-122">hello lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="b48db-123">Här är hello efter händelser:</span><span class="sxs-lookup"><span data-stu-id="b48db-123">Here's hello order of events:</span></span>

1. <span data-ttu-id="b48db-124">hello har tjänsten skapats</span><span class="sxs-lookup"><span data-stu-id="b48db-124">hello Service is constructed</span></span>
2. <span data-ttu-id="b48db-125">Görs sedan i parallella två saker:</span><span class="sxs-lookup"><span data-stu-id="b48db-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="b48db-126">`StatelessService.CreateServiceInstanceListeners()`har anropats och eventuella returnerade lyssnare öppnas.</span><span class="sxs-lookup"><span data-stu-id="b48db-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="b48db-127">`ICommunicationListener.OpenAsync()`anropas på varje lyssnare</span><span class="sxs-lookup"><span data-stu-id="b48db-127">`ICommunicationListener.OpenAsync()` is called on each listener</span></span>
    - <span data-ttu-id="b48db-128">Hej tjänstens `StatelessService.RunAsync()` metoden anropas</span><span class="sxs-lookup"><span data-stu-id="b48db-128">hello service's `StatelessService.RunAsync()` method is called</span></span>
3. <span data-ttu-id="b48db-129">Om den finns hello tjänstens `StatelessService.OnOpenAsync()` metoden anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-129">If present, hello service's `StatelessService.OnOpenAsync()` method is called.</span></span> <span data-ttu-id="b48db-130">Det här är en ovanligt åsidosättning, men den är tillgänglig.</span><span class="sxs-lookup"><span data-stu-id="b48db-130">This is an uncommon override, but it is available.</span></span>

<span data-ttu-id="b48db-131">Det är viktigt toonote att det finns ingen ordning mellan hello anrop toocreate och öppna hello-lyssnare och RunAsync.</span><span class="sxs-lookup"><span data-stu-id="b48db-131">It is important toonote that there is no ordering between hello calls toocreate and open hello listeners and RunAsync.</span></span> <span data-ttu-id="b48db-132">hello lyssnare kan öppna innan RunAsync har startats.</span><span class="sxs-lookup"><span data-stu-id="b48db-132">hello listeners may open before RunAsync is started.</span></span> <span data-ttu-id="b48db-133">På liknande sätt kan RunAsync hamna anropas innan hello kommunikationslyssnarna är öppna eller även har skapats.</span><span class="sxs-lookup"><span data-stu-id="b48db-133">Similarly, RunAsync may end up invoked before hello communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="b48db-134">Om ingen synkronisering krävs lämnas den som en övning toohello implementerare.</span><span class="sxs-lookup"><span data-stu-id="b48db-134">If any synchronization is required, it is left as an exercise toohello implementer.</span></span> <span data-ttu-id="b48db-135">Vanliga lösningar:</span><span class="sxs-lookup"><span data-stu-id="b48db-135">Common solutions:</span></span>

  - <span data-ttu-id="b48db-136">Lyssnare fungerar ibland inte förrän annan information som har skapats eller arbete som gjorts.</span><span class="sxs-lookup"><span data-stu-id="b48db-136">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="b48db-137">För tillståndslösa tjänster som arbete kan vanligtvis utföras på andra platser som:</span><span class="sxs-lookup"><span data-stu-id="b48db-137">For stateless services that work can usually be done in other locations, such as:</span></span> 
    - <span data-ttu-id="b48db-138">i hello service-konstruktorn</span><span class="sxs-lookup"><span data-stu-id="b48db-138">in hello service's constructor</span></span>
    - <span data-ttu-id="b48db-139">under hello `CreateServiceInstanceListeners()` anropa</span><span class="sxs-lookup"><span data-stu-id="b48db-139">during hello `CreateServiceInstanceListeners()` call</span></span>
    - <span data-ttu-id="b48db-140">som en del av hello konstruktionen av hello listener sig själv</span><span class="sxs-lookup"><span data-stu-id="b48db-140">as a part of hello construction of hello listener itself</span></span>
  - <span data-ttu-id="b48db-141">Ibland vill hello koden i RunAsync inte toostart tills hello lyssnare är öppna.</span><span class="sxs-lookup"><span data-stu-id="b48db-141">Sometimes hello code in RunAsync does not want toostart until hello listeners are open.</span></span> <span data-ttu-id="b48db-142">I så fall krävs ytterligare samordning.</span><span class="sxs-lookup"><span data-stu-id="b48db-142">In this case additional coordination is necessary.</span></span> <span data-ttu-id="b48db-143">En vanlig lösning är vissa flagga i hello lyssnare som anger när de har slutförts.</span><span class="sxs-lookup"><span data-stu-id="b48db-143">One common solution is some flag within hello listeners indicating when they have completed.</span></span> <span data-ttu-id="b48db-144">Den här flaggan kontrolleras sedan i RunAsync innan du fortsätter tooactual arbete.</span><span class="sxs-lookup"><span data-stu-id="b48db-144">This flag is then checked in RunAsync before continuing tooactual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="b48db-145">Tillståndslösa tjänsten avstängning</span><span class="sxs-lookup"><span data-stu-id="b48db-145">Stateless service shutdown</span></span>
<span data-ttu-id="b48db-146">När du stänger en tillståndslös tjänst hello samma mönster följs bara i omvänd:</span><span class="sxs-lookup"><span data-stu-id="b48db-146">When shutting down a stateless service, hello same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="b48db-147">Parallellt</span><span class="sxs-lookup"><span data-stu-id="b48db-147">In parallel</span></span>
    - <span data-ttu-id="b48db-148">Alla öppna lyssnare stängs.</span><span class="sxs-lookup"><span data-stu-id="b48db-148">Any open listeners are Closed.</span></span> <span data-ttu-id="b48db-149">`ICommunicationListener.CloseAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="b48db-149">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="b48db-150">hello annullering token som skickades för`RunAsync()` har avbrutits.</span><span class="sxs-lookup"><span data-stu-id="b48db-150">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="b48db-151">Kontrollerar hello annullering token `IsCancellationRequested` -egenskap returnerar true, och om den anropas hello token `ThrowIfCancellationRequested` metoden returnerar en `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="b48db-151">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="b48db-152">En gång `CloseAsync()` har slutförts på varje lyssnare och `RunAsync()` också har slutförts hello service `StatelessService.OnCloseAsync()` metoden anropas, om sådan finns.</span><span class="sxs-lookup"><span data-stu-id="b48db-152">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatelessService.OnCloseAsync()` method is called, if present.</span></span> <span data-ttu-id="b48db-153">Det är ovanligt toooverride `StatelessService.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="b48db-153">It is uncommon toooverride `StatelessService.OnCloseAsync()`.</span></span>
3. <span data-ttu-id="b48db-154">När `StatelessService.OnCloseAsync()` är klar hello webbtjänstobjektet destructed</span><span class="sxs-lookup"><span data-stu-id="b48db-154">After `StatelessService.OnCloseAsync()` completes, hello service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="b48db-155">Tillståndskänslig service Start</span><span class="sxs-lookup"><span data-stu-id="b48db-155">Stateful service Startup</span></span>
<span data-ttu-id="b48db-156">Tillståndskänsliga tjänster har en liknande mönster toostateless tjänster, med några ändringar.</span><span class="sxs-lookup"><span data-stu-id="b48db-156">Stateful services have a similar pattern toostateless services, with a few changes.</span></span> <span data-ttu-id="b48db-157">När du startar en tillståndskänslig service är hello händelser följande:</span><span class="sxs-lookup"><span data-stu-id="b48db-157">When starting up a stateful service, hello order of events is as follows:</span></span>

1. <span data-ttu-id="b48db-158">hello har tjänsten skapats</span><span class="sxs-lookup"><span data-stu-id="b48db-158">hello Service is constructed</span></span>
2. <span data-ttu-id="b48db-159">`StatefulServiceBase.OnOpenAsync()`anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-159">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="b48db-160">Detta åsidosätts uncommonly i hello-tjänsten.</span><span class="sxs-lookup"><span data-stu-id="b48db-160">This is uncommonly overridden in hello service.</span></span>
3. <span data-ttu-id="b48db-161">hello händer följande parallellt</span><span class="sxs-lookup"><span data-stu-id="b48db-161">hello following things happen in parallel</span></span>
    - <span data-ttu-id="b48db-162">`StatefulServiceBase.CreateServiceReplicaListeners()`anropas</span><span class="sxs-lookup"><span data-stu-id="b48db-162">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked</span></span> 
      - <span data-ttu-id="b48db-163">Om hello-tjänsten är en primär öppnas alla returnerade lyssnare.</span><span class="sxs-lookup"><span data-stu-id="b48db-163">If hello service is a Primary all returned listeners are Opened.</span></span> <span data-ttu-id="b48db-164">`ICommunicationListener.OpenAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="b48db-164">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
      - <span data-ttu-id="b48db-165">Om hello-tjänsten är en sekundär kan endast dessa lyssnare markerad som `ListenOnSecondary = true` öppnas.</span><span class="sxs-lookup"><span data-stu-id="b48db-165">If hello service is a Secondary, only those listeners marked as `ListenOnSecondary = true` are opened.</span></span> <span data-ttu-id="b48db-166">Med lyssnare som är öppna på sekundärservrar är mindre vanliga.</span><span class="sxs-lookup"><span data-stu-id="b48db-166">Having listeners that are open on Secondaries is less common.</span></span>
    - <span data-ttu-id="b48db-167">Hej om hello Service är en primär, hello tjänst `StatefulServiceBase.RunAsync()` metoden anropas</span><span class="sxs-lookup"><span data-stu-id="b48db-167">hello if hello Service is currently a Primary, hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
4. <span data-ttu-id="b48db-168">När alla hello replik lyssnare `OpenAsync()` anrop slutföra och `RunAsync()` anropas, `StatefulServiceBase.OnChangeRoleAsync()` anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-168">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` is called, `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="b48db-169">Detta åsidosätts uncommonly i hello-tjänsten.</span><span class="sxs-lookup"><span data-stu-id="b48db-169">This is uncommonly overridden in hello service.</span></span>

<span data-ttu-id="b48db-170">På liknande sätt toostateless tjänster, det finns inga samordning mellan hello ordning i vilken hello lyssnare skapas och öppnas och när RunAsync anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-170">Similarly toostateless services, there's no coordination between hello order in which hello listeners are created and opened and when RunAsync is called.</span></span> <span data-ttu-id="b48db-171">Om du behöver samordning, är det mycket hello samma hello lösningar.</span><span class="sxs-lookup"><span data-stu-id="b48db-171">If you need coordination, hello solutions are much hello same.</span></span> <span data-ttu-id="b48db-172">Det finns en ytterligare fall: säger att hello anrop anländer till hello kommunikationslyssnarna kräver information som sparas i vissa [tillförlitliga samlingar](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="b48db-172">THere is one additional case: say that hello calls arriving at hello communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="b48db-173">Vissa ytterligare samordning är nödvändigt eftersom hello kommunikationslyssnarna gick att öppna innan hello tillförlitliga samlingar är läsbart eller skrivbart och innan RunAsync kunde starta.</span><span class="sxs-lookup"><span data-stu-id="b48db-173">Because hello communication listeners could open before hello reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="b48db-174">hello enklaste och de vanligaste lösningen är för hello kommunikation lyssnare tooreturn vissa felkod som hello använder tooknow tooretry hello klientbegäran.</span><span class="sxs-lookup"><span data-stu-id="b48db-174">hello simplest and most common solution is for hello communication listeners tooreturn some error code that hello client uses tooknow tooretry hello request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="b48db-175">Tillståndskänslig service avstängning</span><span class="sxs-lookup"><span data-stu-id="b48db-175">Stateful service Shutdown</span></span>
<span data-ttu-id="b48db-176">På samma sätt tooStateless tjänster hello Livscykelhändelser vid avstängningen är hello samma som under starten, men omvänd.</span><span class="sxs-lookup"><span data-stu-id="b48db-176">Similarly tooStateless services, hello lifecycle events during shutdown are hello same as during startup, but reversed.</span></span> <span data-ttu-id="b48db-177">När en tillståndskänslig service stängs av, händer hello följande:</span><span class="sxs-lookup"><span data-stu-id="b48db-177">When a stateful service is being shut down, hello following events occur:</span></span>

1. <span data-ttu-id="b48db-178">Parallellt</span><span class="sxs-lookup"><span data-stu-id="b48db-178">In parallel</span></span>
    - <span data-ttu-id="b48db-179">Alla öppna lyssnare stängs.</span><span class="sxs-lookup"><span data-stu-id="b48db-179">Any open listeners are Closed.</span></span> <span data-ttu-id="b48db-180">`ICommunicationListener.CloseAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="b48db-180">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="b48db-181">hello annullering token som skickades för`RunAsync()` har avbrutits.</span><span class="sxs-lookup"><span data-stu-id="b48db-181">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="b48db-182">Kontrollerar hello annullering token `IsCancellationRequested` -egenskap returnerar true, och om den anropas hello token `ThrowIfCancellationRequested` metoden returnerar en `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="b48db-182">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="b48db-183">En gång `CloseAsync()` har slutförts på varje lyssnare och `RunAsync()` också har slutförts hello service `StatefulServiceBase.OnChangeRoleAsync()` anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-183">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="b48db-184">(Detta uncommonly åsidosätts i hello service.)</span><span class="sxs-lookup"><span data-stu-id="b48db-184">(This is uncommonly overridden in hello service.)</span></span>
    - <span data-ttu-id="b48db-185">Väntar på att RunAsync är toocomplete bara nödvändigt om den här tjänsten repliken var en primär.</span><span class="sxs-lookup"><span data-stu-id="b48db-185">Waiting for RunAsync toocomplete is only necessary if this service replica was a Primary.</span></span>
3. <span data-ttu-id="b48db-186">En gång hello `StatefulServiceBase.OnChangeRoleAsync()` metoden har slutförts hello `StatefulServiceBase.OnCloseAsync()` metoden anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-186">Once hello `StatefulServiceBase.OnChangeRoleAsync()` method completes, hello `StatefulServiceBase.OnCloseAsync()` method is called.</span></span> <span data-ttu-id="b48db-187">Det här är en ovanligt åsidosättning, men den är tillgänglig.</span><span class="sxs-lookup"><span data-stu-id="b48db-187">This is an uncommon override, but it is available.</span></span>
3. <span data-ttu-id="b48db-188">När `StatefulServiceBase.OnCloseAsync()` är klar hello webbtjänstobjektet destructed.</span><span class="sxs-lookup"><span data-stu-id="b48db-188">After `StatefulServiceBase.OnCloseAsync()` completes, hello service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="b48db-189">Tillståndskänslig service primära växlingar</span><span class="sxs-lookup"><span data-stu-id="b48db-189">Stateful service primary swaps</span></span>
<span data-ttu-id="b48db-190">När en tillståndskänslig tjänst körs bara ha hello primära repliker av de tillståndskänsliga tjänsterna sina kommunikationslyssnarna öppnas och deras RunAsync-metoden anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-190">While a stateful service is running, only hello Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="b48db-191">Sekundär är uppbyggda men det finns inga ytterligare anrop.</span><span class="sxs-lookup"><span data-stu-id="b48db-191">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="b48db-192">När en tillståndskänslig tjänst körs men, kan vilka repliken är för närvarande hello primära ändra.</span><span class="sxs-lookup"><span data-stu-id="b48db-192">While a stateful service is running however, which replica is currently hello Primary can change.</span></span> <span data-ttu-id="b48db-193">Vad innebär det i termer av hello Livscykelhändelser som en replik kan se? hello beteende hello tillståndskänslig replik ser beror på om det är hello replik som nedgraderas eller uppgraderas under hello växlingen.</span><span class="sxs-lookup"><span data-stu-id="b48db-193">What does this mean in terms of hello lifecycle events that a replica can see? hello behavior hello stateful replica sees depends on whether it is hello replica being demoted or promoted during hello swap.</span></span>

### <a name="for-hello-primary-being-demoted"></a><span data-ttu-id="b48db-194">För hello primära som nedgraderas</span><span class="sxs-lookup"><span data-stu-id="b48db-194">For hello primary being demoted</span></span>
<span data-ttu-id="b48db-195">Service Fabric måste den här repliken toostop meddelandebehandling och avsluta alla bakgrundsjobbet avbrytas.</span><span class="sxs-lookup"><span data-stu-id="b48db-195">Service Fabric needs this replica toostop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="b48db-196">Det här steget ser ut liknande toowhen hello-tjänsten stängs av.</span><span class="sxs-lookup"><span data-stu-id="b48db-196">As a result, this step looks similar toowhen hello service is being shut down.</span></span> <span data-ttu-id="b48db-197">En skillnaden är att hello Service inte är destructed eller stängts eftersom det fortfarande som en sekundär.</span><span class="sxs-lookup"><span data-stu-id="b48db-197">One difference is that hello Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="b48db-198">hello följande API: er anropas:</span><span class="sxs-lookup"><span data-stu-id="b48db-198">hello following APIs are called:</span></span>

1. <span data-ttu-id="b48db-199">Parallellt</span><span class="sxs-lookup"><span data-stu-id="b48db-199">In parallel</span></span>
    - <span data-ttu-id="b48db-200">Alla öppna lyssnare stängs.</span><span class="sxs-lookup"><span data-stu-id="b48db-200">Any open listeners are Closed.</span></span> <span data-ttu-id="b48db-201">`ICommunicationListener.CloseAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="b48db-201">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="b48db-202">hello annullering token som skickades för`RunAsync()` har avbrutits.</span><span class="sxs-lookup"><span data-stu-id="b48db-202">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="b48db-203">Kontrollerar hello annullering token `IsCancellationRequested` -egenskap returnerar true, och om den anropas hello token `ThrowIfCancellationRequested` metoden returnerar en `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="b48db-203">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="b48db-204">En gång `CloseAsync()` har slutförts på varje lyssnare och `RunAsync()` också har slutförts hello service `StatefulServiceBase.OnChangeRoleAsync()` anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-204">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="b48db-205">Detta åsidosätts uncommonly i hello-tjänsten.</span><span class="sxs-lookup"><span data-stu-id="b48db-205">This is uncommonly overridden in hello service.</span></span>

### <a name="for-hello-secondary-being-promoted"></a><span data-ttu-id="b48db-206">För sekundära hello som uppgraderas</span><span class="sxs-lookup"><span data-stu-id="b48db-206">For hello secondary being promoted</span></span>
<span data-ttu-id="b48db-207">På liknande sätt, Service Fabric måste den här repliken toostart lyssnar efter meddelanden på hello överföring och starta alla bakgrundsaktiviteter den mån om.</span><span class="sxs-lookup"><span data-stu-id="b48db-207">Similarly, Service Fabric needs this replica toostart listening for messages on hello wire and start any background tasks it cares about.</span></span> <span data-ttu-id="b48db-208">Därför kan den här processen ser ut som liknande toowhen hello tjänst skapas, utom hello repliken finns själva redan.</span><span class="sxs-lookup"><span data-stu-id="b48db-208">As a result, this process looks similar toowhen hello service is created, except that hello replica itself already exists.</span></span> <span data-ttu-id="b48db-209">hello följande API: er anropas:</span><span class="sxs-lookup"><span data-stu-id="b48db-209">hello following APIs are called:</span></span>

1. <span data-ttu-id="b48db-210">Parallellt</span><span class="sxs-lookup"><span data-stu-id="b48db-210">In parallel</span></span>
    - <span data-ttu-id="b48db-211">`StatefulServiceBase.CreateServiceReplicaListeners()`har anropats och eventuella returnerade lyssnare öppnas.</span><span class="sxs-lookup"><span data-stu-id="b48db-211">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="b48db-212">`ICommunicationListener.OpenAsync()`anropas på varje lyssnare.</span><span class="sxs-lookup"><span data-stu-id="b48db-212">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="b48db-213">Hej tjänstens `StatefulServiceBase.RunAsync()` metoden anropas</span><span class="sxs-lookup"><span data-stu-id="b48db-213">hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
2. <span data-ttu-id="b48db-214">När alla hello replik lyssnare `OpenAsync()` anrop slutföra och `RunAsync()` har anropats `StatefulServiceBase.OnChangeRoleAsync()` anropas.</span><span class="sxs-lookup"><span data-stu-id="b48db-214">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` has been called,  `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="b48db-215">Detta åsidosätts uncommonly i hello-tjänsten.</span><span class="sxs-lookup"><span data-stu-id="b48db-215">This is uncommonly overridden in hello service.</span></span>

### <a name="common-issues-during-stateful-service-shutdown-and-primary-demotion"></a><span data-ttu-id="b48db-216">Vanliga problem vid avstängning av tjänst tillståndskänsliga och primära degradering</span><span class="sxs-lookup"><span data-stu-id="b48db-216">Common issues during stateful service shutdown and primary demotion</span></span>
<span data-ttu-id="b48db-217">Service Fabric ändringar hello primära av en tillståndskänslig tjänst för en mängd olika skäl.</span><span class="sxs-lookup"><span data-stu-id="b48db-217">Service Fabric changes hello Primary of a stateful service for a variety of reasons.</span></span> <span data-ttu-id="b48db-218">hello vanligaste är [kluster ombalansering](service-fabric-cluster-resource-manager-balancing.md) och [Programuppgradering](service-fabric-application-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="b48db-218">hello most common are [cluster rebalancing](service-fabric-cluster-resource-manager-balancing.md) and [application upgrade](service-fabric-application-upgrade.md).</span></span> <span data-ttu-id="b48db-219">Under dessa åtgärder (samt under normal drift avslutning, som du vill se om hello-tjänsten har tagits bort), är det viktigt att hello service avseende hello `CancellationToken`.</span><span class="sxs-lookup"><span data-stu-id="b48db-219">During these operations (as well as during normal service shutdown, like you'd see if hello service was deleted), it is important that hello service respect hello `CancellationToken`.</span></span> <span data-ttu-id="b48db-220">Tjänster som inte hanterar avbryta en klar får flera problem.</span><span class="sxs-lookup"><span data-stu-id="b48db-220">Services that do not handle cancellation cleanly will experience several issues.</span></span> <span data-ttu-id="b48db-221">I synnerhet dessa åtgärder kommer att vara långsam eftersom Service Fabric väntar hello services toostop avslutas.</span><span class="sxs-lookup"><span data-stu-id="b48db-221">In particular, these operations will be slow since Service Fabric waits for hello services toostop gracefully.</span></span> <span data-ttu-id="b48db-222">Slutligen kan detta leda toofailed uppgraderingar tiden och återställa.</span><span class="sxs-lookup"><span data-stu-id="b48db-222">This can ultimately lead toofailed upgrades that time out and roll back.</span></span> <span data-ttu-id="b48db-223">Fel toohonor hello annullering token kan också medföra imbalanced kluster eftersom noder hämta hot men kan inte vara genomförs hello services eftersom det tar för lång toomove dem någon annanstans.</span><span class="sxs-lookup"><span data-stu-id="b48db-223">Failure toohonor hello cancellation token can also cause imbalanced clusters because nodes get hot but hello services can't be rebalanced since it takes too long toomove them elsewhere.</span></span> 

<span data-ttu-id="b48db-224">Eftersom hello tjänster är tillståndskänslig, det är också troligt att de använder hello [tillförlitliga samlingar](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="b48db-224">Since hello services are stateful, it is also likely that they are using hello [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="b48db-225">När en primär degraderas i Service Fabric är hello första saker händer att tillståndet för skrivåtkomst toohello underliggande har återkallats.</span><span class="sxs-lookup"><span data-stu-id="b48db-225">In Service Fabric, when a Primary is demoted, one of hello first things that happens is that write access toohello underlying state is revoked.</span></span> <span data-ttu-id="b48db-226">Detta leder tooa andra uppsättning problem som kan påverka hello service lifecycle.</span><span class="sxs-lookup"><span data-stu-id="b48db-226">This leads tooa second set of issues that can impact hello service lifecycle.</span></span> <span data-ttu-id="b48db-227">hello samlingar returnerade undantag baserat på hello tidsinställning och om hello replik flyttas eller stängs av.</span><span class="sxs-lookup"><span data-stu-id="b48db-227">hello collections return Exceptions based on hello timing and whether hello replica is being moved or shut down.</span></span> <span data-ttu-id="b48db-228">Sådana undantag ska hanteras på rätt sätt.</span><span class="sxs-lookup"><span data-stu-id="b48db-228">These exceptions should be handled correctly.</span></span> <span data-ttu-id="b48db-229">Undantag från Service Fabric är indelade i permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) och tillfälligt [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) kategorier.</span><span class="sxs-lookup"><span data-stu-id="b48db-229">Exceptions thrown by Service Fabric fall into permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) and transient [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categories.</span></span> <span data-ttu-id="b48db-230">Permanent undantag ska loggas och uppstod medan hello tillfälligt undantag kan göras baserat på vissa logik.</span><span class="sxs-lookup"><span data-stu-id="b48db-230">Permanent exceptions should be logged and thrown, while hello transient exceptions may be retried based on some retry logic.</span></span>

<span data-ttu-id="b48db-231">Hantera hello undantag som härrör från användning av hello `ReliableCollections` tillsammans med tjänsten Livscykelhändelser är en viktig del av testa och validera en tillförlitlig tjänst.</span><span class="sxs-lookup"><span data-stu-id="b48db-231">Handling hello exceptions that come from use of hello `ReliableCollections` in conjunction with service lifecycle events is an important part of testing and validating a Reliable Service.</span></span> <span data-ttu-id="b48db-232">Hej rekommendation är alltid toorun din tjänst under belastning under uppgraderingar och [chaos testning](service-fabric-controlled-chaos.md) innan du distribuerar någonsin tooproduction.</span><span class="sxs-lookup"><span data-stu-id="b48db-232">hello recommendation is always toorun your service under load while performing upgrades and [chaos testing](service-fabric-controlled-chaos.md) before ever deploying tooproduction.</span></span> <span data-ttu-id="b48db-233">De grundläggande stegen för att säkerställa att din tjänst har implementerats korrekt och hanterar Livscykelhändelser på rätt sätt.</span><span class="sxs-lookup"><span data-stu-id="b48db-233">These basic steps help ensure that your service is correctly implemented and handles lifecycle events correctly.</span></span>


## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="b48db-234">Information om tjänsten livscykel</span><span class="sxs-lookup"><span data-stu-id="b48db-234">Notes on service lifecycle</span></span>
  - <span data-ttu-id="b48db-235">Båda hello `RunAsync()` metod och hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` anrop är valfria.</span><span class="sxs-lookup"><span data-stu-id="b48db-235">Both hello `RunAsync()` method and hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="b48db-236">En tjänst kan ha ett av dem, båda eller inget.</span><span class="sxs-lookup"><span data-stu-id="b48db-236">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="b48db-237">Till exempel om hello tjänsten gör allt arbete i svaret toouser anrop, det behövs ingen för den tooimplement `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="b48db-237">For example, if hello service does all its work in response toouser calls, there is no need for it tooimplement `RunAsync()`.</span></span> <span data-ttu-id="b48db-238">Endast hello kommunikationslyssnarna och deras associerade kod krävs.</span><span class="sxs-lookup"><span data-stu-id="b48db-238">Only hello communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="b48db-239">På liknande sätt att skapa och returnera kommunikationslyssnarna är valfritt, eftersom hello service kanske bara bakgrunden fungerar toodo och så att endast måste tooimplement`RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="b48db-239">Similarly, creating and returning communication listeners is optional, as hello service may have only background work toodo, and so only needs tooimplement `RunAsync()`</span></span>
  - <span data-ttu-id="b48db-240">Det är giltigt för en tjänst toocomplete `RunAsync()` har och RETUR från den.</span><span class="sxs-lookup"><span data-stu-id="b48db-240">It is valid for a service toocomplete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="b48db-241">Slutför är inte ett fel inträffar.</span><span class="sxs-lookup"><span data-stu-id="b48db-241">Completing is not a failure condition.</span></span> <span data-ttu-id="b48db-242">Slutför `RunAsync()` visar att hello bakgrundsjobbet av hello-tjänsten har slutförts.</span><span class="sxs-lookup"><span data-stu-id="b48db-242">Completing `RunAsync()` indicates that hello background work of hello service has completed.</span></span> <span data-ttu-id="b48db-243">För tillståndskänsliga reliable services `RunAsync()` anropas igen om hello replik degraderades från primära tooSecondary och upphöja tillbaka tooPrimary.</span><span class="sxs-lookup"><span data-stu-id="b48db-243">For stateful reliable services, `RunAsync()` is called again if hello replica were demoted from Primary tooSecondary and then promoted back tooPrimary.</span></span>
  - <span data-ttu-id="b48db-244">Om en tjänst avslutas från `RunAsync()` genom att vissa oväntat undantag utgör detta ett fel.</span><span class="sxs-lookup"><span data-stu-id="b48db-244">If a service exits from `RunAsync()` by throwing some unexpected exception, this constitutes a failure.</span></span> <span data-ttu-id="b48db-245">webbtjänstobjektet hello stängs av och rapporterade felet hälsa.</span><span class="sxs-lookup"><span data-stu-id="b48db-245">hello service object is shut down and a health error reported.</span></span>
  - <span data-ttu-id="b48db-246">När det finns ingen tidsgräns på returneras från dessa metoder kan du att förlora omedelbart hello möjlighet toowrite tooReliable samlingar och därför slutföra inte något verkligt arbete.</span><span class="sxs-lookup"><span data-stu-id="b48db-246">While there is no time limit on returning from these methods, you immediately lose hello ability toowrite tooReliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="b48db-247">Vi rekommenderar att du returnera så snabbt som möjligt när hello annullering begäran tas emot.</span><span class="sxs-lookup"><span data-stu-id="b48db-247">It is recommended that you return as quickly as possible upon receiving hello cancellation request.</span></span> <span data-ttu-id="b48db-248">Om tjänsten inte svarar toothese API-anrop inom en rimlig tid Service Fabric kan framtvinga stänga av tjänsten.</span><span class="sxs-lookup"><span data-stu-id="b48db-248">If your service does not respond toothese API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="b48db-249">Vanligtvis sker detta endast under programuppgraderingar eller när en tjänst tas bort.</span><span class="sxs-lookup"><span data-stu-id="b48db-249">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="b48db-250">Det här är 15 minuter som standard.</span><span class="sxs-lookup"><span data-stu-id="b48db-250">This timeout is 15 minutes by default.</span></span>
  - <span data-ttu-id="b48db-251">Fel i hello `OnCloseAsync()` sökväg resultatet i `OnAbort()` anropas som är ett sista chansen bästa möjlighet för hello tjänsten tooclean upp och frigör alla resurser som de har begärts.</span><span class="sxs-lookup"><span data-stu-id="b48db-251">Failures in hello `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for hello service tooclean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b48db-252">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="b48db-252">Next steps</span></span>
- [<span data-ttu-id="b48db-253">Introduktion tooReliable tjänster</span><span class="sxs-lookup"><span data-stu-id="b48db-253">Introduction tooReliable Services</span></span>](service-fabric-reliable-services-introduction.md)
- [<span data-ttu-id="b48db-254">Snabbstart för Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b48db-254">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
- [<span data-ttu-id="b48db-255">Reliable Services avancerade användning</span><span class="sxs-lookup"><span data-stu-id="b48db-255">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
