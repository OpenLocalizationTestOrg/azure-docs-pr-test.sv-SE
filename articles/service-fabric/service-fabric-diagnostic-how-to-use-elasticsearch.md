---
title: "Med Elasticsearch som trace för Service Fabric programarkivet | Microsoft Docs"
description: "Beskriver hur Service Fabric-program kan använda Elasticsearch och Kibana att lagra indexet och söka igenom programspårningar (loggarna)"
services: service-fabric
documentationcenter: .net
author: karolz-ms
manager: adegeo
editor: 
ms.assetid: e59b0c39-e468-4d9e-b453-d5f2a8ad20d8
ms.service: service-fabric
ms.devlang: dotNet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 04/07/2017
ms.author: karolz@microsoft.com
redirect_url: /azure/service-fabric/service-fabric-diagnostics-event-aggregation-eventflow
ms.openlocfilehash: 2d2ceceea131b41ad1a1735aaa2a859d035ab098
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 07/11/2017
---
# <a name="use-elasticsearch-as-a-service-fabric-application-trace-store"></a><span data-ttu-id="e28a7-103">Använd Elasticsearch som en spårning i Service Fabric-programmet lagrar</span><span class="sxs-lookup"><span data-stu-id="e28a7-103">Use Elasticsearch as a Service Fabric application trace store</span></span>
## <a name="introduction"></a><span data-ttu-id="e28a7-104">Introduktion</span><span class="sxs-lookup"><span data-stu-id="e28a7-104">Introduction</span></span>
<span data-ttu-id="e28a7-105">Den här artikeln beskriver hur [Azure Service Fabric](https://azure.microsoft.com/documentation/services/service-fabric/) program kan använda **Elasticsearch** och **Kibana** för programmet trace lagring, indexering och sökning.</span><span class="sxs-lookup"><span data-stu-id="e28a7-105">This article describes how [Azure Service Fabric](https://azure.microsoft.com/documentation/services/service-fabric/) applications can use **Elasticsearch** and **Kibana** for application trace storage, indexing, and search.</span></span> <span data-ttu-id="e28a7-106">[Elasticsearch](https://www.elastic.co/guide/index.html) är en öppen källkod, distribuerade och skalbar realtid Sök och analytics-motor som lämpar sig väl för den här uppgiften.</span><span class="sxs-lookup"><span data-stu-id="e28a7-106">[Elasticsearch](https://www.elastic.co/guide/index.html) is an open-source, distributed, and scalable real-time search and analytics engine that is well-suited for this task.</span></span> <span data-ttu-id="e28a7-107">Den kan installeras på Windows- och Linux virtuella datorer som körs i Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="e28a7-107">It can be installed on Windows and Linux virtual machines running in Microsoft Azure.</span></span> <span data-ttu-id="e28a7-108">Elasticsearch effektivt kan bearbeta *strukturerade* spår som genereras med hjälp av teknik som **ETW Event Tracing for Windows ()**.</span><span class="sxs-lookup"><span data-stu-id="e28a7-108">Elasticsearch can efficiently process *structured* traces produced using technologies such as **Event Tracing for Windows (ETW)**.</span></span>

<span data-ttu-id="e28a7-109">ETW används av Service Fabric runtime till källan diagnostisk information (spår).</span><span class="sxs-lookup"><span data-stu-id="e28a7-109">ETW is used by Service Fabric runtime to source diagnostic information (traces).</span></span> <span data-ttu-id="e28a7-110">Det är den rekommenderade metoden för Service Fabric-program som källa för sina diagnostisk information.</span><span class="sxs-lookup"><span data-stu-id="e28a7-110">It is the recommended method for Service Fabric applications to source their diagnostic information, too.</span></span> <span data-ttu-id="e28a7-111">Använder samma metod kan korrelation mellan angivna runtime och tillämpningsprogrammet spår och gör felsökningen lättare.</span><span class="sxs-lookup"><span data-stu-id="e28a7-111">Using the same mechanism allows for correlation between runtime-supplied and application-supplied traces and makes troubleshooting easier.</span></span> <span data-ttu-id="e28a7-112">Mallar för Service Fabric-projekt i Visual Studio omfattar en loggning API: T (baserad på .NET **EventSource** klassen) som skickar ETW-spårning som standard.</span><span class="sxs-lookup"><span data-stu-id="e28a7-112">Service Fabric project templates in Visual Studio include a logging API (based on the .NET **EventSource** class) that emits ETW traces by default.</span></span> <span data-ttu-id="e28a7-113">En allmän översikt över Service Fabric application spårning med ETW, se [övervakning och diagnos av tjänster i en inställning för lokal dator development](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md).</span><span class="sxs-lookup"><span data-stu-id="e28a7-113">For a general overview of Service Fabric application tracing using ETW, see [Monitoring and diagnosing services in a local machine development setup](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md).</span></span>

<span data-ttu-id="e28a7-114">För spårning visas i Elasticsearch, behöver de hämtats vid Service Fabric klusternoderna i realtid (medan programmet körs) och skickas till en Elasticsearch slutpunkt.</span><span class="sxs-lookup"><span data-stu-id="e28a7-114">For the traces to show up in Elasticsearch, they need to be captured at the Service Fabric cluster nodes in real time (while the application is running) and sent to an Elasticsearch endpoint.</span></span> <span data-ttu-id="e28a7-115">Det finns två huvudsakliga alternativ för spårning fånga in:</span><span class="sxs-lookup"><span data-stu-id="e28a7-115">There are two major options for trace capturing:</span></span>

* <span data-ttu-id="e28a7-116">**Processen spårning fånga in**</span><span class="sxs-lookup"><span data-stu-id="e28a7-116">**In-process trace capturing**</span></span>  
  <span data-ttu-id="e28a7-117">Programmet eller mer exakt tjänstprocessen ansvarar för att skicka ut diagnostikdata till arkivet trace (Elasticsearch).</span><span class="sxs-lookup"><span data-stu-id="e28a7-117">The application, or more precisely, service process, is responsible for sending out the diagnostic data to the trace store (Elasticsearch).</span></span>
* <span data-ttu-id="e28a7-118">**Out-of-process spårning fånga in**</span><span class="sxs-lookup"><span data-stu-id="e28a7-118">**Out-of-process trace capturing**</span></span>  
  <span data-ttu-id="e28a7-119">En separat agent fånga in spårningar från tjänstprocessen eller processer och skickar dem till arkivet spårningen.</span><span class="sxs-lookup"><span data-stu-id="e28a7-119">A separate agent is capturing traces from the service process or processes and sending them to the trace store.</span></span>

<span data-ttu-id="e28a7-120">Nedan, vi beskriver hur du ställer in Elasticsearch på Azure, diskutera tekniker och nackdelar för både avbilda alternativ och förklarar hur du konfigurerar ett Service Fabric-tjänsten för att skicka data till Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e28a7-120">Below, we describe how to set up Elasticsearch on Azure, discuss the pros and cons for both capture options, and explain how to configure a Service Fabric service to send data to Elasticsearch.</span></span>

## <a name="set-up-elasticsearch-on-azure"></a><span data-ttu-id="e28a7-121">Ställ in Elasticsearch på Azure</span><span class="sxs-lookup"><span data-stu-id="e28a7-121">Set up Elasticsearch on Azure</span></span>
<span data-ttu-id="e28a7-122">Det enklaste sättet att konfigurera tjänsten Elasticsearch på Azure är via [ **Azure Resource Manager-mallar**](../azure-resource-manager/resource-group-overview.md).</span><span class="sxs-lookup"><span data-stu-id="e28a7-122">The most straightforward way to set up the Elasticsearch service on Azure is through [**Azure Resource Manager templates**](../azure-resource-manager/resource-group-overview.md).</span></span> <span data-ttu-id="e28a7-123">En omfattande [Quickstart Azure Resource Manager-mall för Elasticsearch](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch) är tillgänglig från lagringsplatsen för Azure Quickstart-mallar.</span><span class="sxs-lookup"><span data-stu-id="e28a7-123">A comprehensive [Quickstart Azure Resource Manager template for Elasticsearch](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch) is available from Azure Quickstart templates repository.</span></span> <span data-ttu-id="e28a7-124">Den här mallen använder separata storage-konton för skalenheter (grupper av noder).</span><span class="sxs-lookup"><span data-stu-id="e28a7-124">This template uses separate storage accounts for scale units (groups of nodes).</span></span> <span data-ttu-id="e28a7-125">Det kan också etablera separata klient och server-noder med olika konfigurationer och olika mängder datadiskar som är anslutna.</span><span class="sxs-lookup"><span data-stu-id="e28a7-125">It can also provision separate client and server nodes with different configurations and various numbers of data disks attached.</span></span>

<span data-ttu-id="e28a7-126">Här kan vi använder en annan mall, kallas **ES MultiNode** från den [Azure diagnostikverktyg](https://github.com/Azure/azure-diagnostics-tools).</span><span class="sxs-lookup"><span data-stu-id="e28a7-126">Here, we use another template, called **ES-MultiNode** from the [Azure diagnostic tools repository](https://github.com/Azure/azure-diagnostics-tools).</span></span> <span data-ttu-id="e28a7-127">Den här mallen är enklare att använda och skapar ett Elasticsearch kluster som skyddas av grundläggande HTTP-autentisering.</span><span class="sxs-lookup"><span data-stu-id="e28a7-127">This template is easier to use, and it creates an Elasticsearch cluster protected by HTTP basic authentication.</span></span> <span data-ttu-id="e28a7-128">Innan du fortsätter, ska du hämta databasen från GitHub till din dator (genom att klona databasen eller hämtar en zip-fil).</span><span class="sxs-lookup"><span data-stu-id="e28a7-128">Before you proceed, download the repository from GitHub to your machine (by either cloning the repository or downloading a zip file).</span></span> <span data-ttu-id="e28a7-129">ES MultiNode mall finns i mappen med samma namn.</span><span class="sxs-lookup"><span data-stu-id="e28a7-129">The ES-MultiNode template is located in the folder with the same name.</span></span>

### <a name="prepare-a-machine-to-run-elasticsearch-installation-scripts"></a><span data-ttu-id="e28a7-130">Förbered en dator som ska köra Elasticsearch installationsskript</span><span class="sxs-lookup"><span data-stu-id="e28a7-130">Prepare a machine to run Elasticsearch installation scripts</span></span>
<span data-ttu-id="e28a7-131">Det enklaste sättet att använda mallen ES MultiNode är via ett tillhandahållna Azure PowerShell-skript som heter `CreateElasticSearchCluster`.</span><span class="sxs-lookup"><span data-stu-id="e28a7-131">The easiest way to use the ES-MultiNode template is through a provided Azure PowerShell script called `CreateElasticSearchCluster`.</span></span> <span data-ttu-id="e28a7-132">Om du vill använda det här skriptet, måste du installera PowerShell-moduler och ett verktyg som kallas **openssl**.</span><span class="sxs-lookup"><span data-stu-id="e28a7-132">To use this script, you need to install PowerShell modules and a tool called **openssl**.</span></span> <span data-ttu-id="e28a7-133">Dessa krävs för att skapa en SSH-nyckel som kan användas för att fjärradministrera Elasticsearch klustret.</span><span class="sxs-lookup"><span data-stu-id="e28a7-133">The latter is needed for creating an SSH key that can be used to administer your Elasticsearch cluster remotely.</span></span>

<span data-ttu-id="e28a7-134">`CreateElasticSearchCluster`skript är utformad för enkel användning med ES MultiNode mall från en Windows-dator.</span><span class="sxs-lookup"><span data-stu-id="e28a7-134">`CreateElasticSearchCluster` script is designed for ease of use with the ES-MultiNode template from a Windows machine.</span></span> <span data-ttu-id="e28a7-135">Det är möjligt att använda mallen på en icke-Windows-dator, men det scenariot är utanför omfattningen för den här artikeln.</span><span class="sxs-lookup"><span data-stu-id="e28a7-135">It is possible to use the template on a non-Windows machine, but that scenario is beyond the scope of this article.</span></span>

1. <span data-ttu-id="e28a7-136">Om du inte har installerat dem redan [ **Azure PowerShell-moduler**](http://aka.ms/webpi-azps).</span><span class="sxs-lookup"><span data-stu-id="e28a7-136">If you haven't installed them already, install [**Azure PowerShell modules**](http://aka.ms/webpi-azps).</span></span> <span data-ttu-id="e28a7-137">När du uppmanas, klickar du på **kör**, sedan **installera**.</span><span class="sxs-lookup"><span data-stu-id="e28a7-137">When prompted, click **Run**, then **Install**.</span></span> <span data-ttu-id="e28a7-138">Azure PowerShell 1.3 eller senare krävs.</span><span class="sxs-lookup"><span data-stu-id="e28a7-138">Azure PowerShell 1.3 or newer is required.</span></span>
2. <span data-ttu-id="e28a7-139">Den **openssl** tool ingår i distributionen av [ **Git för Windows**](http://www.git-scm.com/downloads).</span><span class="sxs-lookup"><span data-stu-id="e28a7-139">The **openssl** tool is included in the distribution of [**Git for Windows**](http://www.git-scm.com/downloads).</span></span> <span data-ttu-id="e28a7-140">Om du redan inte har gjort det, installera [Git för Windows](http://www.git-scm.com/downloads) nu.</span><span class="sxs-lookup"><span data-stu-id="e28a7-140">If you have not done so already, install [Git for Windows](http://www.git-scm.com/downloads) now.</span></span> <span data-ttu-id="e28a7-141">(Standard installationsalternativ är OK.)</span><span class="sxs-lookup"><span data-stu-id="e28a7-141">(The default installation options are OK.)</span></span>
3. <span data-ttu-id="e28a7-142">Förutsatt att Git har installerats men ingår inte i systemsökvägen, öppna ett Microsoft Azure PowerShell-fönster och kör följande kommandon:</span><span class="sxs-lookup"><span data-stu-id="e28a7-142">Assuming that Git has been installed but not included in the system path, open a Microsoft Azure PowerShell window and run the following commands:</span></span>
   
    ```powershell
    $ENV:PATH += ";<Git installation folder>\usr\bin"
    $ENV:OPENSSL_CONF = "<Git installation folder>\usr\ssl\openssl.cnf"
    ```
   
    <span data-ttu-id="e28a7-143">Ersätt den `<Git installation folder>` med Git-plats på din dator; standardvärdet är **”C:\Program Files\Git”**.</span><span class="sxs-lookup"><span data-stu-id="e28a7-143">Replace the `<Git installation folder>` with the Git location on your machine; the default is **"C:\Program Files\Git"**.</span></span> <span data-ttu-id="e28a7-144">Observera semikolon i början av den första sökvägen.</span><span class="sxs-lookup"><span data-stu-id="e28a7-144">Note the semicolon character at the beginning of the first path.</span></span>
4. <span data-ttu-id="e28a7-145">Se till att du har loggat in till Azure (via [ `Add-AzureRmAccount` ](https://msdn.microsoft.com/library/mt619267.aspx) cmdlet) och att du har valt prenumerationen som ska användas för att skapa elastiska Sök-kluster.</span><span class="sxs-lookup"><span data-stu-id="e28a7-145">Ensure that you are logged on to Azure (via [`Add-AzureRmAccount`](https://msdn.microsoft.com/library/mt619267.aspx) cmdlet) and that you have selected the subscription that should be used to create your Elastic Search cluster.</span></span> <span data-ttu-id="e28a7-146">Du kan kontrollera att korrekt prenumeration har valts med hjälp av `Get-AzureRmContext` och `Get-AzureRmSubscription` cmdlets.</span><span class="sxs-lookup"><span data-stu-id="e28a7-146">You can verify that correct subscription is selected using `Get-AzureRmContext` and `Get-AzureRmSubscription` cmdlets.</span></span>
5. <span data-ttu-id="e28a7-147">Om du inte redan gjort det, kan du ändra den aktuella katalogen till mappen ES MultiNode.</span><span class="sxs-lookup"><span data-stu-id="e28a7-147">If you haven't done so already, change the current directory to the ES-MultiNode folder.</span></span>

### <a name="run-the-createelasticsearchcluster-script"></a><span data-ttu-id="e28a7-148">Kör skriptet CreateElasticSearchCluster</span><span class="sxs-lookup"><span data-stu-id="e28a7-148">Run the CreateElasticSearchCluster script</span></span>
<span data-ttu-id="e28a7-149">Innan du kör skriptet, öppna den `azuredeploy-parameters.json` filen och verifiera eller ange värden för skriptparametrarna.</span><span class="sxs-lookup"><span data-stu-id="e28a7-149">Before you run the script, open the `azuredeploy-parameters.json` file and verify or provide values for the script parameters.</span></span> <span data-ttu-id="e28a7-150">Följande parametrar finns:</span><span class="sxs-lookup"><span data-stu-id="e28a7-150">The following parameters are provided:</span></span>

| <span data-ttu-id="e28a7-151">Parameternamn</span><span class="sxs-lookup"><span data-stu-id="e28a7-151">Parameter Name</span></span> | <span data-ttu-id="e28a7-152">Beskrivning</span><span class="sxs-lookup"><span data-stu-id="e28a7-152">Description</span></span> |
| --- | --- |
| <span data-ttu-id="e28a7-153">dnsNameForLoadBalancerIP</span><span class="sxs-lookup"><span data-stu-id="e28a7-153">dnsNameForLoadBalancerIP</span></span> |<span data-ttu-id="e28a7-154">Det namn som används för att skapa synligt offentligt DNS-namn för den elastiska sökningen kluster (genom att lägga till Azure-region domänen till det angivna namnet).</span><span class="sxs-lookup"><span data-stu-id="e28a7-154">The name that is used to create the publicly visible DNS name for the Elastic Search cluster (by appending the Azure region domain to the provided name).</span></span> <span data-ttu-id="e28a7-155">Om det här parametervärdet är ”myBigCluster” och den valda Azure-regionen är USA, västra, är det resulterande DNS-namnet för klustret myBigCluster.westus.cloudapp.azure.com.</span><span class="sxs-lookup"><span data-stu-id="e28a7-155">For example, if this parameter value is "myBigCluster" and the chosen Azure region is West US, the resulting DNS name for the cluster is myBigCluster.westus.cloudapp.azure.com.</span></span> <br /><br /><span data-ttu-id="e28a7-156">Det här namnet fungerar också som ett namn för skogsrotsdomänen för många artefakter som är associerade med elastisk Sök-klustret, till exempel data nodnamn.</span><span class="sxs-lookup"><span data-stu-id="e28a7-156">This name also serves as a root name for many artifacts associated with the Elastic Search cluster, such as data node names.</span></span> |
| <span data-ttu-id="e28a7-157">adminUsername</span><span class="sxs-lookup"><span data-stu-id="e28a7-157">adminUsername</span></span> |<span data-ttu-id="e28a7-158">Namnet på administratörskontot för att hantera elastisk Sök-kluster (motsvarande SSH-nycklar genereras automatiskt).</span><span class="sxs-lookup"><span data-stu-id="e28a7-158">The name of the administrator account for managing the Elastic Search cluster (corresponding SSH keys are generated automatically).</span></span> |
| <span data-ttu-id="e28a7-159">dataNodeCount</span><span class="sxs-lookup"><span data-stu-id="e28a7-159">dataNodeCount</span></span> |<span data-ttu-id="e28a7-160">Antalet noder i klustret elastisk sökning.</span><span class="sxs-lookup"><span data-stu-id="e28a7-160">The number of nodes in the Elastic Search cluster.</span></span> <span data-ttu-id="e28a7-161">Den aktuella versionen av skriptet skiljer inte mellan data och fråga noder. alla noder spela upp båda rollerna.</span><span class="sxs-lookup"><span data-stu-id="e28a7-161">The current version of the script does not distinguish between data and query nodes; all nodes play both roles.</span></span> <span data-ttu-id="e28a7-162">Standardvärdet är 3 noder.</span><span class="sxs-lookup"><span data-stu-id="e28a7-162">Defaults to 3 nodes.</span></span> |
| <span data-ttu-id="e28a7-163">dataDiskSize</span><span class="sxs-lookup"><span data-stu-id="e28a7-163">dataDiskSize</span></span> |<span data-ttu-id="e28a7-164">Storleken på diskar (i GB) som har allokerats för varje datanod.</span><span class="sxs-lookup"><span data-stu-id="e28a7-164">The size of data disks (in GB) that is allocated for each data node.</span></span> <span data-ttu-id="e28a7-165">Varje nod som tar emot 4 datadiskar dedikerad enbart till elastisk Search-tjänsten.</span><span class="sxs-lookup"><span data-stu-id="e28a7-165">Each node receives 4 data disks, exclusively dedicated to Elastic Search service.</span></span> |
| <span data-ttu-id="e28a7-166">Region</span><span class="sxs-lookup"><span data-stu-id="e28a7-166">region</span></span> |<span data-ttu-id="e28a7-167">Namnet på Azure-region där elastisk Sök klustret ska finnas.</span><span class="sxs-lookup"><span data-stu-id="e28a7-167">The name of Azure region where the Elastic Search cluster should be located.</span></span> |
| <span data-ttu-id="e28a7-168">esUserName</span><span class="sxs-lookup"><span data-stu-id="e28a7-168">esUserName</span></span> |<span data-ttu-id="e28a7-169">Användarnamnet på användaren som har konfigurerats för åtkomst till ES-klustret (omfattas grundläggande HTTP-autentisering).</span><span class="sxs-lookup"><span data-stu-id="e28a7-169">The user name of the user that is configured to have access to ES cluster (subject to HTTP basic authentication).</span></span> <span data-ttu-id="e28a7-170">Lösenordet ingår inte i parameterfilen och måste anges när `CreateElasticSearchCluster` anropas skriptet.</span><span class="sxs-lookup"><span data-stu-id="e28a7-170">The password is not part of parameters file and must be provided when `CreateElasticSearchCluster` script is invoked.</span></span> |
| <span data-ttu-id="e28a7-171">vmSizeDataNodes</span><span class="sxs-lookup"><span data-stu-id="e28a7-171">vmSizeDataNodes</span></span> |<span data-ttu-id="e28a7-172">Virtuella Azure-datorstorleken för elastiska Sök klusternoder.</span><span class="sxs-lookup"><span data-stu-id="e28a7-172">The Azure virtual machine size for Elastic Search cluster nodes.</span></span> <span data-ttu-id="e28a7-173">Standard_D2 standard.</span><span class="sxs-lookup"><span data-stu-id="e28a7-173">Defaults to Standard_D2.</span></span> |

<span data-ttu-id="e28a7-174">Du är nu redo att köra skriptet.</span><span class="sxs-lookup"><span data-stu-id="e28a7-174">Now you are ready to run the script.</span></span> <span data-ttu-id="e28a7-175">Kör följande kommando:</span><span class="sxs-lookup"><span data-stu-id="e28a7-175">Issue the following command:</span></span>

```powershell
CreateElasticSearchCluster -ResourceGroupName <es-group-name> -Region <azure-region> -EsPassword <es-password>
```

<span data-ttu-id="e28a7-176">där</span><span class="sxs-lookup"><span data-stu-id="e28a7-176">where</span></span> 

| <span data-ttu-id="e28a7-177">Parameternamn för skript</span><span class="sxs-lookup"><span data-stu-id="e28a7-177">Script Parameter Name</span></span> | <span data-ttu-id="e28a7-178">Beskrivning</span><span class="sxs-lookup"><span data-stu-id="e28a7-178">Description</span></span> |
| --- | --- |
| `<es-group-name>` |<span data-ttu-id="e28a7-179">Namnet på Azure-resursgrupp som innehåller alla elastisk Sök klusterresurser.</span><span class="sxs-lookup"><span data-stu-id="e28a7-179">The name of the Azure resource group that will contain all Elastic Search cluster resources.</span></span> |
| `<azure-region>` |<span data-ttu-id="e28a7-180">Namnet på Azure-regionen där elastisk Sök klustret ska skapas.</span><span class="sxs-lookup"><span data-stu-id="e28a7-180">The name of the Azure region where the Elastic Search cluster should be created.</span></span> |
| `<es-password>` |<span data-ttu-id="e28a7-181">Lösenordet för elastiska Sök användare.</span><span class="sxs-lookup"><span data-stu-id="e28a7-181">The password for the Elastic Search user.</span></span> |

> [!NOTE]
> <span data-ttu-id="e28a7-182">Om du får en NullReferenceException från cmdleten Test-AzureResourceGroup du har glömt att logga in på Azure (`Add-AzureRmAccount`).</span><span class="sxs-lookup"><span data-stu-id="e28a7-182">If you get a NullReferenceException from the Test-AzureResourceGroup cmdlet, you have forgotten to log on to Azure (`Add-AzureRmAccount`).</span></span>
> 
> 

<span data-ttu-id="e28a7-183">Om du får ett felmeddelande från att köra skriptet och du bestämma att felet orsakades av ett fel mall parametervärde, åtgärda parameterfilen och köra skriptet igen med ett annat resursnamn för gruppen.</span><span class="sxs-lookup"><span data-stu-id="e28a7-183">If you get an error from running the script and you determine that the error was caused by a wrong template parameter value, correct the parameter file and run the script again with a different resource group name.</span></span> <span data-ttu-id="e28a7-184">Du kan också återanvända samma resursgruppens namn och har skriptet rensa den gamla servern genom att lägga till den `-RemoveExistingResourceGroup` parametern att anropa skript.</span><span class="sxs-lookup"><span data-stu-id="e28a7-184">You can also reuse the same resource group name and have the script clean up the old one by adding the `-RemoveExistingResourceGroup` parameter to the script invocation.</span></span>

### <a name="result-of-running-the-createelasticsearchcluster-script"></a><span data-ttu-id="e28a7-185">Resultatet av CreateElasticSearchCluster-skript</span><span class="sxs-lookup"><span data-stu-id="e28a7-185">Result of running the CreateElasticSearchCluster script</span></span>
<span data-ttu-id="e28a7-186">När du har kört den `CreateElasticSearchCluster` skript följande huvudsakliga artefakter kommer att skapas.</span><span class="sxs-lookup"><span data-stu-id="e28a7-186">After you run the `CreateElasticSearchCluster` script, the following main artifacts will be created.</span></span> <span data-ttu-id="e28a7-187">Det här exemplet förutsätter vi att du har använt ”myBigCluster” som värde för den `dnsNameForLoadBalancerIP` parametern och att den region där du skapade klustret är västra USA.</span><span class="sxs-lookup"><span data-stu-id="e28a7-187">For this example we assume that you have used "myBigCluster" as the value of the `dnsNameForLoadBalancerIP` parameter and that the region where you created the cluster is West US.</span></span>

| <span data-ttu-id="e28a7-188">Artefakt</span><span class="sxs-lookup"><span data-stu-id="e28a7-188">Artifact</span></span> | <span data-ttu-id="e28a7-189">Namn, plats och kommentarer</span><span class="sxs-lookup"><span data-stu-id="e28a7-189">Name, location, and remarks</span></span> |
| --- | --- |
| <span data-ttu-id="e28a7-190">SSH-nyckeln för fjärradministration</span><span class="sxs-lookup"><span data-stu-id="e28a7-190">SSH key for remote administration</span></span> |<span data-ttu-id="e28a7-191">myBigCluster.key filen (i katalogen där CreateElasticSearchCluster kördes).</span><span class="sxs-lookup"><span data-stu-id="e28a7-191">myBigCluster.key file (in the directory from which the CreateElasticSearchCluster was run).</span></span> <br /><br /><span data-ttu-id="e28a7-192">Den här nyckelfilen kan användas för att ansluta till noden admin och (via noden admin) till datanoder i klustret.</span><span class="sxs-lookup"><span data-stu-id="e28a7-192">This key file can be used to connect to the admin node and (through the admin node) to data nodes in the cluster.</span></span> |
| <span data-ttu-id="e28a7-193">Admin-nod</span><span class="sxs-lookup"><span data-stu-id="e28a7-193">Admin node</span></span> |<span data-ttu-id="e28a7-194">myBigCluster admin.westus.cloudapp.azure.com</span><span class="sxs-lookup"><span data-stu-id="e28a7-194">myBigCluster-admin.westus.cloudapp.azure.com</span></span> <br /><br /><span data-ttu-id="e28a7-195">En särskild virtuell dator för Elasticsearch klustret fjärradministration--den enda som gör att externa SSH-anslutningar.</span><span class="sxs-lookup"><span data-stu-id="e28a7-195">A dedicated VM for remote Elasticsearch cluster administration--the only one that allows external SSH connections.</span></span> <span data-ttu-id="e28a7-196">Den körs på samma virtuella nätverk som alla klusternoder för Elasticsearch, men inga Elasticsearch tjänster körs inte.</span><span class="sxs-lookup"><span data-stu-id="e28a7-196">It runs on the same virtual network as all the Elasticsearch cluster nodes, but it does not run any Elasticsearch services.</span></span> |
| <span data-ttu-id="e28a7-197">Datanoder</span><span class="sxs-lookup"><span data-stu-id="e28a7-197">Data nodes</span></span> |<span data-ttu-id="e28a7-198">myBigCluster1...</span><span class="sxs-lookup"><span data-stu-id="e28a7-198">myBigCluster1 …</span></span> <span data-ttu-id="e28a7-199">myBigCluster*N*</span><span class="sxs-lookup"><span data-stu-id="e28a7-199">myBigCluster*N*</span></span> <br /><br /><span data-ttu-id="e28a7-200">Datanoder som kör Elasticsearch och Kibana tjänster.</span><span class="sxs-lookup"><span data-stu-id="e28a7-200">Data nodes that are running Elasticsearch and Kibana services.</span></span> <span data-ttu-id="e28a7-201">Du kan ansluta via SSH till varje nod, men endast via noden Administration.</span><span class="sxs-lookup"><span data-stu-id="e28a7-201">You can connect via SSH to each node, but only via the admin node.</span></span> |
| <span data-ttu-id="e28a7-202">Elasticsearch kluster</span><span class="sxs-lookup"><span data-stu-id="e28a7-202">Elasticsearch cluster</span></span> |<span data-ttu-id="e28a7-203">http://myBigCluster.westus.cloudapp.Azure.com/ES/</span><span class="sxs-lookup"><span data-stu-id="e28a7-203">http://myBigCluster.westus.cloudapp.azure.com/es/</span></span> <br /><br /><span data-ttu-id="e28a7-204">Primär slutpunkt för Elasticsearch klustret (Observera suffixet /es).</span><span class="sxs-lookup"><span data-stu-id="e28a7-204">The primary endpoint for the Elasticsearch cluster (note the /es suffix).</span></span> <span data-ttu-id="e28a7-205">Den är skyddad av grundläggande HTTP-autentisering (autentiseringsuppgifterna har de angivna parametrarna esUserName/esPassword av mallen ES MultiNode).</span><span class="sxs-lookup"><span data-stu-id="e28a7-205">It is protected by basic HTTP authentication (the credentials were the specified esUserName/esPassword parameters of the ES-MultiNode template).</span></span> <span data-ttu-id="e28a7-206">Klustret har också huvudet plugin-program installerat (http://myBigCluster.westus.cloudapp.azure.com/es/_plugin/head) för grundläggande klusteradministration.</span><span class="sxs-lookup"><span data-stu-id="e28a7-206">The cluster has also the head plug-in installed (http://myBigCluster.westus.cloudapp.azure.com/es/_plugin/head) for basic cluster administration.</span></span> |
| <span data-ttu-id="e28a7-207">Kibana service</span><span class="sxs-lookup"><span data-stu-id="e28a7-207">Kibana service</span></span> |<span data-ttu-id="e28a7-208">http://myBigCluster.westus.cloudapp.Azure.com</span><span class="sxs-lookup"><span data-stu-id="e28a7-208">http://myBigCluster.westus.cloudapp.azure.com</span></span> <br /><br /><span data-ttu-id="e28a7-209">Tjänsten Kibana ställs in för att visa data från skapade Elasticsearch klustret.</span><span class="sxs-lookup"><span data-stu-id="e28a7-209">The Kibana service is set up to show data from the created Elasticsearch cluster.</span></span> <span data-ttu-id="e28a7-210">Den är skyddad av samma autentiseringsuppgifter som själva klustret.</span><span class="sxs-lookup"><span data-stu-id="e28a7-210">It is protected by the same authentication credentials as the cluster itself.</span></span> |

## <a name="in-process-versus-out-of-process-trace-capturing"></a><span data-ttu-id="e28a7-211">I processen jämfört med out-of-process spårning fånga in</span><span class="sxs-lookup"><span data-stu-id="e28a7-211">In-process versus out-of-process trace capturing</span></span>
<span data-ttu-id="e28a7-212">I inledningen nämndes två huvudsakliga sätt för att samla in diagnostikdata: i processen och out-of-process.</span><span class="sxs-lookup"><span data-stu-id="e28a7-212">In the introduction, we mentioned two fundamental ways of collecting diagnostic data: in-process and out-of-process.</span></span> <span data-ttu-id="e28a7-213">Varje har styrkor och svagheter.</span><span class="sxs-lookup"><span data-stu-id="e28a7-213">Each has strengths and weaknesses.</span></span>

<span data-ttu-id="e28a7-214">Fördelarna med den **pågående spårning fånga** omfattar:</span><span class="sxs-lookup"><span data-stu-id="e28a7-214">Advantages of the **in-process trace capturing** include:</span></span>

1. <span data-ttu-id="e28a7-215">*Enkel konfiguration och distribution*</span><span class="sxs-lookup"><span data-stu-id="e28a7-215">*Easy configuration and deployment*</span></span>
   
   * <span data-ttu-id="e28a7-216">Konfigurationen av diagnostikdata samlingen har bara en del av programkonfigurationen.</span><span class="sxs-lookup"><span data-stu-id="e28a7-216">The configuration of diagnostic data collection is just part of the application configuration.</span></span> <span data-ttu-id="e28a7-217">Det är lätt att alltid synkronisera den ”” med resten av programmet.</span><span class="sxs-lookup"><span data-stu-id="e28a7-217">It is easy to always keep it "in sync" with the rest of the application.</span></span>
   * <span data-ttu-id="e28a7-218">Programspecifika eller per service configuration kan enkelt uppnås.</span><span class="sxs-lookup"><span data-stu-id="e28a7-218">Per-application or per-service configuration is easily achievable.</span></span>
   * <span data-ttu-id="e28a7-219">Out-of-process spårning fånga kräver vanligtvis en separat distributionen och konfigurationen av diagnostiska agenten som är en extra administrativa uppgifter och en tänkbar orsak till fel.</span><span class="sxs-lookup"><span data-stu-id="e28a7-219">Out-of-process trace capturing usually requires a separate deployment and configuration of the diagnostic agent, which is an extra administrative task and a potential source of errors.</span></span> <span data-ttu-id="e28a7-220">Viss agent-teknik kan ofta endast en instans av agenten per virtuell dator (nod).</span><span class="sxs-lookup"><span data-stu-id="e28a7-220">The particular agent technology often allows only one instance of the agent per virtual machine (node).</span></span> <span data-ttu-id="e28a7-221">Det innebär att konfigurationen för insamling av diagnostik-konfiguration delas med alla program och tjänster som körs på noden.</span><span class="sxs-lookup"><span data-stu-id="e28a7-221">This means that configuration for the collection of the diagnostic configuration is shared among all applications and services running on that node.</span></span>
2. <span data-ttu-id="e28a7-222">*Flexibilitet*</span><span class="sxs-lookup"><span data-stu-id="e28a7-222">*Flexibility*</span></span>
   
   * <span data-ttu-id="e28a7-223">Programmet kan skicka data oavsett var den ska, så länge det finns ett klientbiblioteket som stöder måldata lagringssystemet.</span><span class="sxs-lookup"><span data-stu-id="e28a7-223">The application can send the data wherever it needs to go, as long as there is a client library that supports the targeted data storage system.</span></span> <span data-ttu-id="e28a7-224">Nya sänkor kan läggas till på önskat sätt.</span><span class="sxs-lookup"><span data-stu-id="e28a7-224">New sinks can be added as desired.</span></span>
   * <span data-ttu-id="e28a7-225">Komplexa capture, filtrering och Datasammanställning regler kan implementeras.</span><span class="sxs-lookup"><span data-stu-id="e28a7-225">Complex capture, filtering, and data-aggregation rules can be implemented.</span></span>
   * <span data-ttu-id="e28a7-226">En out-of-process spårning fånga in begränsas ofta av data sänkor som har stöd för agenten.</span><span class="sxs-lookup"><span data-stu-id="e28a7-226">An out-of-process trace capturing is often limited by the data sinks that the agent supports.</span></span> <span data-ttu-id="e28a7-227">Vissa agenter är extensible.</span><span class="sxs-lookup"><span data-stu-id="e28a7-227">Some agents are extensible.</span></span>
3. <span data-ttu-id="e28a7-228">*Åtkomst till interna programdata och kontext*</span><span class="sxs-lookup"><span data-stu-id="e28a7-228">*Access to internal application data and context*</span></span>
   
   * <span data-ttu-id="e28a7-229">Undersystemet diagnostik körs i processen för program/tjänst kan enkelt utöka spårningar med relevant information.</span><span class="sxs-lookup"><span data-stu-id="e28a7-229">The diagnostic subsystem running inside the application/service process can easily augment the traces with contextual information.</span></span>
   * <span data-ttu-id="e28a7-230">I out-of-process-metod måste data skickas till en agent via någon mekanism för kommunikation mellan processer, till exempel händelsespårning för Windows.</span><span class="sxs-lookup"><span data-stu-id="e28a7-230">In the out-of-process approach, the data must be sent to an agent via some inter-process communication mechanism, such as Event Tracing for Windows.</span></span> <span data-ttu-id="e28a7-231">Den här mekanismen kan införa ytterligare begränsningar.</span><span class="sxs-lookup"><span data-stu-id="e28a7-231">This mechanism could impose additional limitations.</span></span>

<span data-ttu-id="e28a7-232">Fördelarna med den **out-of-process spårning fånga** omfattar:</span><span class="sxs-lookup"><span data-stu-id="e28a7-232">Advantages of the **out-of-process trace capturing** include:</span></span>

1. <span data-ttu-id="e28a7-233">*Möjlighet att övervaka programmet och samla in krascher Dumpar*</span><span class="sxs-lookup"><span data-stu-id="e28a7-233">*The ability to monitor the application and collect crash dumps*</span></span>
   
   * <span data-ttu-id="e28a7-234">I processen spårning fånga kanske misslyckas om programmet inte startar eller kraschar.</span><span class="sxs-lookup"><span data-stu-id="e28a7-234">In-process trace capturing may be unsuccessful if the application fails to start or crashes.</span></span> <span data-ttu-id="e28a7-235">En oberoende agent har mycket större möjlighet att samla in viktig information för felsökning.</span><span class="sxs-lookup"><span data-stu-id="e28a7-235">An independent agent has a much better chance of capturing crucial troubleshooting information.</span></span><br /><br />
2. <span data-ttu-id="e28a7-236">*Förfall, stabilitet och beprövade prestanda*</span><span class="sxs-lookup"><span data-stu-id="e28a7-236">*Maturity, robustness, and proven performance*</span></span>
   
   * <span data-ttu-id="e28a7-237">En agent som utvecklats av en plattform leverantör (till exempel en agent för Microsoft Azure-diagnostik) har undersökts rigorösa testning och slaget härdning.</span><span class="sxs-lookup"><span data-stu-id="e28a7-237">An agent developed by a platform vendor (such as a Microsoft Azure Diagnostics agent) has been subject to rigorous testing and battle-hardening.</span></span>
   * <span data-ttu-id="e28a7-238">Med pågående spårning fånga, måste vara försiktig så att aktiviteten för att skicka diagnostikdata från en process för programmet inte påverka programmets huvudsakliga aktiviteter eller införa tidsinställning eller prestanda.</span><span class="sxs-lookup"><span data-stu-id="e28a7-238">With in-process trace capturing, care must be taken to ensure that the activity of sending diagnostic data from an application process does not interfere with the application's main tasks or introduce timing or performance problems.</span></span> <span data-ttu-id="e28a7-239">En separat körs agent är mindre risk för dessa problem och är specifikt utformade för att begränsa dess påverkan på systemet.</span><span class="sxs-lookup"><span data-stu-id="e28a7-239">An independently running agent is less prone to these issues and is specifically designed to limit its impact on the system.</span></span>

<span data-ttu-id="e28a7-240">Det är möjligt att kombinera och dra nytta av båda metoderna.</span><span class="sxs-lookup"><span data-stu-id="e28a7-240">It is possible to combine and benefit from both approaches.</span></span> <span data-ttu-id="e28a7-241">Faktiskt kan det vara den bästa lösningen för många program.</span><span class="sxs-lookup"><span data-stu-id="e28a7-241">Indeed, it might be the best solution for many applications.</span></span>

<span data-ttu-id="e28a7-242">Här kan vi använda den **Microsoft.Diagnostic.Listeners biblioteket** och pågående spårningen avbildning för att skicka data från ett Service Fabric-program till ett Elasticsearch-kluster.</span><span class="sxs-lookup"><span data-stu-id="e28a7-242">Here, we use the **Microsoft.Diagnostic.Listeners library** and the in-process trace capturing to send data from a Service Fabric application to an Elasticsearch cluster.</span></span>

## <a name="use-the-listeners-library-to-send-diagnostic-data-to-elasticsearch"></a><span data-ttu-id="e28a7-243">Använd lyssnare-biblioteket för att skicka diagnostikdata till Elasticsearch</span><span class="sxs-lookup"><span data-stu-id="e28a7-243">Use the Listeners library to send diagnostic data to Elasticsearch</span></span>
<span data-ttu-id="e28a7-244">Microsoft.Diagnostic.Listeners biblioteket är en del av PartyCluster exempelprogrammet Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="e28a7-244">The Microsoft.Diagnostic.Listeners library is part of PartyCluster sample Service Fabric application.</span></span> <span data-ttu-id="e28a7-245">Du använder den:</span><span class="sxs-lookup"><span data-stu-id="e28a7-245">To use it:</span></span>

1. <span data-ttu-id="e28a7-246">Hämta [PartyCluster exempel](https://github.com/Azure-Samples/service-fabric-dotnet-management-party-cluster) från GitHub.</span><span class="sxs-lookup"><span data-stu-id="e28a7-246">Download [the PartyCluster sample](https://github.com/Azure-Samples/service-fabric-dotnet-management-party-cluster) from GitHub.</span></span>
2. <span data-ttu-id="e28a7-247">Kopiera Microsoft.Diagnostics.Listeners och Microsoft.Diagnostics.Listeners.Fabric projekt (hela mappar) från katalogen PartyCluster exempel till mappen lösning på det program som ska skicka data till Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="e28a7-247">Copy the Microsoft.Diagnostics.Listeners and Microsoft.Diagnostics.Listeners.Fabric projects (whole folders) from the PartyCluster sample directory to the solution folder of the application that is supposed to send the data to Elasticsearch.</span></span>
3. <span data-ttu-id="e28a7-248">Öppna mål-lösningen, högerklicka på noden lösningen i Solution Explorer och välj **lägga till befintliga projekt**.</span><span class="sxs-lookup"><span data-stu-id="e28a7-248">Open the target solution, right-click the solution node in the Solution Explorer, and choose **Add Existing Project**.</span></span> <span data-ttu-id="e28a7-249">Lägger till Microsoft.Diagnostics.Listeners-projekt i lösningen.</span><span class="sxs-lookup"><span data-stu-id="e28a7-249">Add the Microsoft.Diagnostics.Listeners project to the solution.</span></span> <span data-ttu-id="e28a7-250">Upprepa samma för Microsoft.Diagnostics.Listeners.Fabric-projektet.</span><span class="sxs-lookup"><span data-stu-id="e28a7-250">Repeat the same for the Microsoft.Diagnostics.Listeners.Fabric project.</span></span>
4. <span data-ttu-id="e28a7-251">Lägg till en projektreferens från service-projektet till två projekt som lagts till.</span><span class="sxs-lookup"><span data-stu-id="e28a7-251">Add a project reference from your service project(s) to the two added projects.</span></span> <span data-ttu-id="e28a7-252">(Varje tjänst som ska skicka data till Elasticsearch ska referera till Microsoft.Diagnostics.EventListeners och Microsoft.Diagnostics.EventListeners.Fabric).</span><span class="sxs-lookup"><span data-stu-id="e28a7-252">(Each service that is supposed to send data to Elasticsearch should reference Microsoft.Diagnostics.EventListeners and Microsoft.Diagnostics.EventListeners.Fabric).</span></span>
   
    ![Projektreferenser till Microsoft.Diagnostics.EventListeners och Microsoft.Diagnostics.EventListeners.Fabric bibliotek][1]

### <a name="service-fabric-general-availability-release-and-microsoftdiagnosticstracing-nuget-package"></a><span data-ttu-id="e28a7-254">Versionen av Service Fabric allmän tillgänglighet och Microsoft.Diagnostics.Tracing Nuget-paketet</span><span class="sxs-lookup"><span data-stu-id="e28a7-254">Service Fabric General Availability release and Microsoft.Diagnostics.Tracing Nuget package</span></span>
<span data-ttu-id="e28a7-255">Program som skapats med versionen av Service Fabric allmän tillgänglighet (2.0.135, publicerat den 31 mars 2016) mål **.NET Framework 4.5.2**.</span><span class="sxs-lookup"><span data-stu-id="e28a7-255">Applications built with Service Fabric General Availability release (2.0.135, released March 31, 2016) target **.NET Framework 4.5.2**.</span></span> <span data-ttu-id="e28a7-256">Den här versionen är den högsta versionen av .NET Framework som stöds av Azure vid tidpunkten för GA-version.</span><span class="sxs-lookup"><span data-stu-id="e28a7-256">This version is the highest version of the .NET Framework supported by Azure at the time of the GA release.</span></span> <span data-ttu-id="e28a7-257">Den här versionen av framework saknar tyvärr vissa EventListener-APIs som behöver Microsoft.Diagnostics.Listeners-biblioteket.</span><span class="sxs-lookup"><span data-stu-id="e28a7-257">Unfortunately, this version of the framework lacks certain EventListener APIs that the Microsoft.Diagnostics.Listeners library needs.</span></span> <span data-ttu-id="e28a7-258">Eftersom EventSource (komponent som utgör grunden för loggning av API: er i Fabric-program) och EventListener nära tillsammans, måste varje projekt som använder Microsoft.Diagnostics.Listeners biblioteket använda en alternativ implementering av EventSource.</span><span class="sxs-lookup"><span data-stu-id="e28a7-258">Because EventSource (the component that forms the basis of logging APIs in Fabric applications) and EventListener are tightly coupled, every project that uses the Microsoft.Diagnostics.Listeners library must use an alternative implementation of EventSource.</span></span> <span data-ttu-id="e28a7-259">Den här implementeringen tillhandahålls av den **Microsoft.Diagnostics.Tracing Nuget-paketet**, skapade av Microsoft.</span><span class="sxs-lookup"><span data-stu-id="e28a7-259">This implementation is provided by the **Microsoft.Diagnostics.Tracing Nuget package**, authored by Microsoft.</span></span> <span data-ttu-id="e28a7-260">Paketet är fullt bakåtkompatibel med EventSource som ingår i framework, så inga kodändringar ska vara nödvändiga än refererade namnområde ändringar.</span><span class="sxs-lookup"><span data-stu-id="e28a7-260">The package is fully backward-compatible with EventSource included in the framework, so no code changes should be necessary other than referenced namespace changes.</span></span>

<span data-ttu-id="e28a7-261">Om du vill börja använda Microsoft.Diagnostics.Tracing implementeringen av klassen EventSource, gör följande för varje service-projekt som ska skicka data till Elasticsearch:</span><span class="sxs-lookup"><span data-stu-id="e28a7-261">To start using the Microsoft.Diagnostics.Tracing implementation of the EventSource class, follow these steps for each service project that needs to send data to Elasticsearch:</span></span>

1. <span data-ttu-id="e28a7-262">Högerklicka på tjänsten projektet och välj **hantera Nuget-paket**.</span><span class="sxs-lookup"><span data-stu-id="e28a7-262">Right-click on the service project and choose **Manage Nuget Packages**.</span></span>
2. <span data-ttu-id="e28a7-263">Växla till nuget.org paketkällan (om den inte redan är markerad) och Sök efter ”**Microsoft.Diagnostics.Tracing**”.</span><span class="sxs-lookup"><span data-stu-id="e28a7-263">Switch to the nuget.org package source (if it is not already selected) and search for "**Microsoft.Diagnostics.Tracing**".</span></span>
3. <span data-ttu-id="e28a7-264">Installera den `Microsoft.Diagnostics.Tracing.EventSource` paketet (och dess beroenden).</span><span class="sxs-lookup"><span data-stu-id="e28a7-264">Install the `Microsoft.Diagnostics.Tracing.EventSource` package (and its dependencies).</span></span>
4. <span data-ttu-id="e28a7-265">Öppna den **ServiceEventSource.cs** eller **ActorEventSource.cs** filen i projektet service och ersätter den `using System.Diagnostics.Tracing` direktivet ovanpå filen med den `using Microsoft.Diagnostics.Tracing` direktiv.</span><span class="sxs-lookup"><span data-stu-id="e28a7-265">Open the **ServiceEventSource.cs** or **ActorEventSource.cs** file in your service project and replace the `using System.Diagnostics.Tracing` directive on top of the file with the `using Microsoft.Diagnostics.Tracing` directive.</span></span>

<span data-ttu-id="e28a7-266">Dessa steg behövs inte när den **.NET Framework 4.6** stöds av Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="e28a7-266">These steps will not be necessary once the **.NET Framework 4.6** is supported by Microsoft Azure.</span></span>

### <a name="elasticsearch-listener-instantiation-and-configuration"></a><span data-ttu-id="e28a7-267">Elasticsearch lyssnare instansiering och konfiguration</span><span class="sxs-lookup"><span data-stu-id="e28a7-267">Elasticsearch listener instantiation and configuration</span></span>
<span data-ttu-id="e28a7-268">Det sista steget för att skicka diagnostikdata till Elasticsearch är att skapa en instans av `ElasticSearchListener` och konfigurera den med Elasticsearch anslutningsdata.</span><span class="sxs-lookup"><span data-stu-id="e28a7-268">The final step for sending diagnostic data to Elasticsearch is to create an instance of `ElasticSearchListener` and configure it with Elasticsearch connection data.</span></span> <span data-ttu-id="e28a7-269">Lyssnaren samlar automatiskt in alla händelser som samlats in via EventSource klasser som definieras i service-projekt.</span><span class="sxs-lookup"><span data-stu-id="e28a7-269">The listener automatically captures all events raised via EventSource classes defined in the service project.</span></span> <span data-ttu-id="e28a7-270">Den måste vara aktiv under livslängden för tjänsten, så den bästa platsen för att skapa den är i kod som initiering.</span><span class="sxs-lookup"><span data-stu-id="e28a7-270">It needs to be alive during the lifetime of the service, so the best place to create it is in the service initialization code.</span></span> <span data-ttu-id="e28a7-271">Här är hur initieringskoden för den tillståndslösa tjänsten kan se ut efter ändringar (tillägg pekas i kommentarer som börjar med `****`):</span><span class="sxs-lookup"><span data-stu-id="e28a7-271">Here is how the initialization code for a stateless service could look after the necessary changes (additions pointed out in comments starting with `****`):</span></span>

```csharp
using System;
using System.Diagnostics;
using System.Fabric;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.ServiceFabric.Services.Runtime;

// **** Add the following directives
using Microsoft.Diagnostics.EventListeners;
using Microsoft.Diagnostics.EventListeners.Fabric;

namespace Stateless1
{
    internal static class Program
    {
        /// <summary>
        /// This is the entry point of the service host process.
        /// </summary>        
        private static void Main()
        {
            try
            {
                // **** Instantiate ElasticSearchListener
                var configProvider = new FabricConfigurationProvider("ElasticSearchEventListener");
                ElasticSearchListener esListener = null;
                if (configProvider.HasConfiguration)
                {
                    esListener = new ElasticSearchListener(configProvider, new FabricHealthReporter("ElasticSearchEventListener"));
                }

                // The ServiceManifest.XML file defines one or more service type names.
                // Registering a service maps a service type name to a .NET type.
                // When Service Fabric creates an instance of this service type,
                // an instance of the class is created in this host process.

                ServiceRuntime.RegisterServiceAsync("Stateless1Type", 
                    context => new Stateless1(context)).GetAwaiter().GetResult();

                ServiceEventSource.Current.ServiceTypeRegistered(Process.GetCurrentProcess().Id, typeof(Stateless1).Name);

                // Prevents this host process from terminating so services keep running.
                Thread.Sleep(Timeout.Infinite);

                // **** Ensure that the ElasticSearchListner instance is not garbage-collected prematurely
                GC.KeepAlive(esListener);
            }
            catch (Exception e)
            {
                ServiceEventSource.Current.ServiceHostInitializationFailed(e);
                throw;
            }
        }
    }
}
```

<span data-ttu-id="e28a7-272">Elasticsearch anslutningsdata ska placeras i ett separat avsnitt i tjänstekonfigurationsfilen (**PackageRoot\Config\Settings.xml**).</span><span class="sxs-lookup"><span data-stu-id="e28a7-272">Elasticsearch connection data should be put in a separate section in the service configuration file (**PackageRoot\Config\Settings.xml**).</span></span> <span data-ttu-id="e28a7-273">Namnet på avsnittet måste motsvara värdet som skickas till den `FabricConfigurationProvider` konstruktor, till exempel:</span><span class="sxs-lookup"><span data-stu-id="e28a7-273">The name of the section must correspond to the value passed to the `FabricConfigurationProvider` constructor, for example:</span></span>

```xml
<Section Name="ElasticSearchEventListener">
  <Parameter Name="serviceUri" Value="http://myBigCluster.westus.cloudapp.azure.com/es/" />
  <Parameter Name="userName" Value="(ES user name)" />
  <Parameter Name="password" Value="(ES user password)" />
  <Parameter Name="indexNamePrefix" Value="myapp" />
</Section>
```
<span data-ttu-id="e28a7-274">Värdena för `serviceUri`, `userName` och `password` parametrar motsvarar Elasticsearch klusteradress slutpunkt, Elasticsearch användarnamn och lösenord, respektive.</span><span class="sxs-lookup"><span data-stu-id="e28a7-274">The values of `serviceUri`, `userName` and `password` parameters correspond to the Elasticsearch cluster endpoint address, Elasticsearch user name, and password, respectively.</span></span> <span data-ttu-id="e28a7-275">`indexNamePrefix`är prefixet för Elasticsearch index. Microsoft.Diagnostics.Listeners biblioteket skapar ett nytt index för sina data varje dag.</span><span class="sxs-lookup"><span data-stu-id="e28a7-275">`indexNamePrefix` is the prefix for Elasticsearch indexes; the Microsoft.Diagnostics.Listeners library creates a new index for its data daily.</span></span>

### <a name="verification"></a><span data-ttu-id="e28a7-276">Verifieringen</span><span class="sxs-lookup"><span data-stu-id="e28a7-276">Verification</span></span>
<span data-ttu-id="e28a7-277">Klart!</span><span class="sxs-lookup"><span data-stu-id="e28a7-277">That's it!</span></span> <span data-ttu-id="e28a7-278">Nu när tjänsten körs startar skicka spårningar till tjänsten Elasticsearch som angetts i konfigurationen.</span><span class="sxs-lookup"><span data-stu-id="e28a7-278">Now, whenever the service is run, it starts sending traces to the Elasticsearch service specified in the configuration.</span></span> <span data-ttu-id="e28a7-279">Du kan kontrollera detta genom att öppna Kibana UI som är associerade med Elasticsearch målinstansen.</span><span class="sxs-lookup"><span data-stu-id="e28a7-279">You can verify this by opening the Kibana UI associated with the target Elasticsearch instance.</span></span> <span data-ttu-id="e28a7-280">I vårt exempel är adressen http://myBigCluster.westus.cloudapp.azure.com/.</span><span class="sxs-lookup"><span data-stu-id="e28a7-280">In our example, the page address is http://myBigCluster.westus.cloudapp.azure.com/.</span></span> <span data-ttu-id="e28a7-281">Kontrollera att index med namnprefix valt för den `ElasticSearchListener` instans faktiskt har skapats och fylls med data.</span><span class="sxs-lookup"><span data-stu-id="e28a7-281">Check that indexes with the name prefix chosen for the `ElasticSearchListener` instance have indeed been created and populated with data.</span></span>

![Kibana visar PartyCluster programhändelser][2]

## <a name="next-steps"></a><span data-ttu-id="e28a7-283">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="e28a7-283">Next steps</span></span>
* [<span data-ttu-id="e28a7-284">Lär dig mer om hur du diagnostiserar och övervakningstjänsten Service Fabric</span><span class="sxs-lookup"><span data-stu-id="e28a7-284">Learn more about diagnosing and monitoring a Service Fabric service</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

<!--Image references-->
[1]: ./media/service-fabric-diagnostics-how-to-use-elasticsearch/listener-lib-references.png
[2]: ./media/service-fabric-diagnostics-how-to-use-elasticsearch/kibana.png
