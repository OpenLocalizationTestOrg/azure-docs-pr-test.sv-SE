---
title: "Köra adhoc-analysfrågor över flera Azure SQL-databaser | Microsoft Docs"
description: "Köra ad hoc-frågor för analytics över flera SQL-databaser i appen Wingtip SaaS flera innehavare."
keywords: sql database tutorial
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: c287fe5d6b333c749b0580b5253e7e46ac27232b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 07/11/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a><span data-ttu-id="b6512-104">Köra ad hoc-frågor för analytics över alla Wingtip SaaS-klienter</span><span class="sxs-lookup"><span data-stu-id="b6512-104">Run ad-hoc analytics queries across all Wingtip SaaS tenants</span></span>

<span data-ttu-id="b6512-105">I kursen får köra du distribuerade frågor över hela uppsättningen av innehavaren databaser för att aktivera ad hoc-analyser.</span><span class="sxs-lookup"><span data-stu-id="b6512-105">In this tutorial, you run distributed queries across the entire set of tenant databases to enable ad-hoc analytics.</span></span> <span data-ttu-id="b6512-106">Elastisk frågan används för att aktivera distribuerade frågor som kräver en databas för ytterligare analys distribueras (till katalogserver).</span><span class="sxs-lookup"><span data-stu-id="b6512-106">Elastic Query is used to enable distributed queries, which requires an additional analytics database is deployed (to the catalog server).</span></span> <span data-ttu-id="b6512-107">Dessa frågor kan extrahera insikter begravd i den dagliga användningsdata Wingtip SaaS-appen.</span><span class="sxs-lookup"><span data-stu-id="b6512-107">These queries can extract insights buried in the day-to-day operational data of the Wingtip SaaS app.</span></span>


<span data-ttu-id="b6512-108">I den här guiden lär du dig:</span><span class="sxs-lookup"><span data-stu-id="b6512-108">In this tutorial you learn:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="b6512-109">Om de globala vyerna i varje databas, som gör att effektiva frågor över klienter</span><span class="sxs-lookup"><span data-stu-id="b6512-109">About the global views in each database, that enable efficient querying across tenants</span></span>
> * <span data-ttu-id="b6512-110">Så här distribuerar du en ad hoc-analytics-databas</span><span class="sxs-lookup"><span data-stu-id="b6512-110">How to deploy an ad-hoc analytics database</span></span>
> * <span data-ttu-id="b6512-111">Så här kör du distribuerade frågor över alla klient-databaser</span><span class="sxs-lookup"><span data-stu-id="b6512-111">How to run distributed queries across all tenant databases</span></span>



<span data-ttu-id="b6512-112">Följande krav måste uppfyllas för att kunna köra den här självstudiekursen:</span><span class="sxs-lookup"><span data-stu-id="b6512-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="b6512-113">Wingtip SaaS-appen har distribuerats.</span><span class="sxs-lookup"><span data-stu-id="b6512-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="b6512-114">För att distribuera på mindre än fem minuter finns [distribuera och utforska Wingtip SaaS-program](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="b6512-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="b6512-115">Azure PowerShell ska ha installerats.</span><span class="sxs-lookup"><span data-stu-id="b6512-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="b6512-116">Mer information finns i [Komma igång med Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span><span class="sxs-lookup"><span data-stu-id="b6512-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>
* <span data-ttu-id="b6512-117">SQL Server Management Studio (SSMS) har installerats.</span><span class="sxs-lookup"><span data-stu-id="b6512-117">SQL Server Management Studio (SSMS) is installed.</span></span> <span data-ttu-id="b6512-118">Om du vill hämta och installera SSMS finns [Hämta SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span><span class="sxs-lookup"><span data-stu-id="b6512-118">To download and install SSMS, see [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span></span>


## <a name="ad-hoc-analytics-pattern"></a><span data-ttu-id="b6512-119">Ad hoc-analytics mönster</span><span class="sxs-lookup"><span data-stu-id="b6512-119">Ad-hoc analytics pattern</span></span>

<span data-ttu-id="b6512-120">En av stora möjligheter med SaaS-program är att använda den stora mängden klientdata lagras centralt i molnet.</span><span class="sxs-lookup"><span data-stu-id="b6512-120">One of the great opportunities with SaaS applications is to use the vast amount of tenant data stored centrally in the cloud.</span></span> <span data-ttu-id="b6512-121">Använda dessa data och få insikter om drift och användning av programmet, klienterna, sina användare, inställningar, beteenden och så vidare. Dessa insights hjälper funktionen utveckling, användbarhet förbättringar och andra investeringar i dina appar och tjänster.</span><span class="sxs-lookup"><span data-stu-id="b6512-121">Use this data to gain insights into the operation and usage of your application, your tenants, their users, preferences, behaviors, etc. These insights can guide feature development, usability improvements, and other investments in your apps and services.</span></span>

<span data-ttu-id="b6512-122">Det är lätt att komma åt en enkel databas med flera klienter, men inte så enkelt när du har distribuerat tusentals databaser.</span><span class="sxs-lookup"><span data-stu-id="b6512-122">Accessing this data in a single multi-tenant database is easy, but not so easy when distributed at scale across potentially thousands of databases.</span></span> <span data-ttu-id="b6512-123">En metod är att använda [elastisk frågan](sql-database-elastic-query-overview.md), vilket innebär att skicka en fråga i en distribuerad uppsättning databaser med gemensamma schemat.</span><span class="sxs-lookup"><span data-stu-id="b6512-123">One approach is to use [Elastic Query](sql-database-elastic-query-overview.md), which enables querying across a distributed set of databases with common schema.</span></span> <span data-ttu-id="b6512-124">Elastisk frågan använder en enda *head* databas i vilken externa tabeller har definierats som spegling tabeller eller vyer i distribuerade (klient)-databaser.</span><span class="sxs-lookup"><span data-stu-id="b6512-124">Elastic Query uses a single *head* database in which external tables are defined that mirror tables or views in the distributed (tenant) databases.</span></span> <span data-ttu-id="b6512-125">Frågorna som skickas till huvuddatabasen kompileras för att skapa en distribuerad frågeplan, och delar av frågan skickas ned till klientdatabaserna efter behov.</span><span class="sxs-lookup"><span data-stu-id="b6512-125">Queries submitted to this head database are compiled to produce a distributed query plan, with portions of the query pushed down to the tenant databases as needed.</span></span> <span data-ttu-id="b6512-126">Elastic Query använder shardkartan i katalogdatabasen för att ange platsen för klientdatabaserna.</span><span class="sxs-lookup"><span data-stu-id="b6512-126">Elastic Query uses the shard map in the catalog database to provide the location of the tenant databases.</span></span> <span data-ttu-id="b6512-127">Installation och fråga är enkla standarden [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), och stöd för ad hoc-frågor från verktyg som Power BI och Excel.</span><span class="sxs-lookup"><span data-stu-id="b6512-127">Setup and query are straightforward using standard [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), and support ad-hoc querying from tools like Power BI and Excel.</span></span>

<span data-ttu-id="b6512-128">Genom att distribuera frågor över klient-databaser innehåller elastisk frågan direkta insikter om live produktionsdata.</span><span class="sxs-lookup"><span data-stu-id="b6512-128">By distributing queries across the tenant databases, Elastic Query provides immediate insight into live production data.</span></span> <span data-ttu-id="b6512-129">Men eftersom elastisk fråga hämtar data från potentiellt många databaser, kan svarstid ibland vara högre än för motsvarande frågor skickas till en enskild databas för flera innehavare.</span><span class="sxs-lookup"><span data-stu-id="b6512-129">However, as Elastic Query pulls data from potentially many databases, query latency can sometimes be higher than for equivalent queries submitted to a single multi-tenant database.</span></span> <span data-ttu-id="b6512-130">Vara bör försiktig när designa frågar för att minimera den information som returneras.</span><span class="sxs-lookup"><span data-stu-id="b6512-130">Care should be taken when designing queries to minimize the data that is returned.</span></span> <span data-ttu-id="b6512-131">Elastisk frågan är ofta bäst för frågor små mängder data i realtid, till skillnad från byggnad som används ofta eller komplexa analytics-frågor eller rapporter.</span><span class="sxs-lookup"><span data-stu-id="b6512-131">Elastic Query is often best suited for querying small amounts of real-time data, as opposed to building frequently used or complex analytics queries or reports.</span></span> <span data-ttu-id="b6512-132">Om frågorna inte utför väl kan titta på den [åtgärdsplan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) att se vilken del av frågan har aviserats till fjärrdatabasen och hur mycket data som returneras.</span><span class="sxs-lookup"><span data-stu-id="b6512-132">If queries don't perform well, look at the [execution plan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) to see what part of the query has been pushed down to the remote database and how much data is being returned.</span></span> <span data-ttu-id="b6512-133">Frågor som kräver komplexa analytisk bearbetning kan vara bättre hanteras i vissa fall genom att extrahera klientdata till en särskild databas eller datalager som är optimerade för analytics-frågor.</span><span class="sxs-lookup"><span data-stu-id="b6512-133">Queries that require complex analytical processing may be better served in some cases by extracting tenant data into a dedicated database or data warehouse optimized for analytics queries.</span></span> <span data-ttu-id="b6512-134">Det här mönstret förklaras i den [klient analytics kursen](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="b6512-134">This pattern is explained in the [tenant analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md).</span></span> 

## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="b6512-135">Hämta Wingtip-programskript</span><span class="sxs-lookup"><span data-stu-id="b6512-135">Get the Wingtip application scripts</span></span>

<span data-ttu-id="b6512-136">Wingtip SaaS-skript och programmets källkod är tillgängliga i den [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github-lagringsplatsen.</span><span class="sxs-lookup"><span data-stu-id="b6512-136">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="b6512-137">[Steg för att hämta Wingtip SaaS-skripten](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="b6512-137">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>

## <a name="create-ticket-sales-data"></a><span data-ttu-id="b6512-138">Skapa biljett försäljningsdata</span><span class="sxs-lookup"><span data-stu-id="b6512-138">Create ticket sales data</span></span>

<span data-ttu-id="b6512-139">Skapa biljett försäljningsdata genom att köra biljett-generatorn för att köra frågor mot en mer intressant datauppsättning.</span><span class="sxs-lookup"><span data-stu-id="b6512-139">To run queries against a more interesting data set, create ticket sales data by running the ticket-generator.</span></span>

1. <span data-ttu-id="b6512-140">I den *PowerShell ISE*öppnar den... \\Learning moduler\\operativa Analytics\\ad hoc Analytics\\*Demo-AdhocAnalytics.ps1* skript och ange följande värden:</span><span class="sxs-lookup"><span data-stu-id="b6512-140">In the *PowerShell ISE*, open the ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* script and set the following values:</span></span>
   * <span data-ttu-id="b6512-141">**$DemoScenario** = 1, **köpa biljetter för händelser på alla handelsplatser**.</span><span class="sxs-lookup"><span data-stu-id="b6512-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues**.</span></span>
2. <span data-ttu-id="b6512-142">Tryck på **F5** att köra skriptet och generera Biljettförsäljning.</span><span class="sxs-lookup"><span data-stu-id="b6512-142">Press **F5** to run the script and generate ticket sales.</span></span> <span data-ttu-id="b6512-143">När skriptet körs, fortsätter du stegen i den här självstudiekursen.</span><span class="sxs-lookup"><span data-stu-id="b6512-143">While the script is running, continue the steps in this tutorial.</span></span> <span data-ttu-id="b6512-144">Biljett-data som efterfrågas i den *köra ad hoc-distribuerade frågor* avsnittet, så vänta biljett generator att slutföras om det fortfarande körs när du kommer till den här övningen.</span><span class="sxs-lookup"><span data-stu-id="b6512-144">The ticket data is queried in the *Run ad-hoc distributed queries* section, so wait for the ticket generator to complete if it's still running when you get to that exercise.</span></span>

## <a name="explore-the-global-views"></a><span data-ttu-id="b6512-145">Utforska globala vyer</span><span class="sxs-lookup"><span data-stu-id="b6512-145">Explore the global views</span></span>

<span data-ttu-id="b6512-146">Wingtip SaaS-programmet skapas med en modell för klient per databas, så att klienten databasschemat definieras ur en enskild klient.</span><span class="sxs-lookup"><span data-stu-id="b6512-146">The Wingtip SaaS application is built using a tenant-per-database model, so the tenant database schema is defined from a single-tenant perspective.</span></span> <span data-ttu-id="b6512-147">Klient-specifik information finns i en tabell *plats*, som alltid har en enda rad och implementeras som en heap utan en primärnyckel.</span><span class="sxs-lookup"><span data-stu-id="b6512-147">Tenant-specific information exists in one table, *Venue*, which always has a single row, and is implemented as a heap, without a primary key.</span></span> <span data-ttu-id="b6512-148">Andra tabeller i schemat behöver inte vara relaterad till den *plats* tabellen, eftersom vid normal användning är aldrig osäker vilken data som hör till.</span><span class="sxs-lookup"><span data-stu-id="b6512-148">Other tables in the schema don't need to be related to the *Venue* table, because in normal use, there is never any doubt which tenant the data belongs to.</span></span>

<span data-ttu-id="b6512-149">Men när du frågar över alla databaser är det viktigt att elastisk fråga kan hantera informationen som om det är en del av en enskild logisk databas delat av klient.</span><span class="sxs-lookup"><span data-stu-id="b6512-149">However, when querying across all databases, it's important that Elastic Query can treat the data as if it is part of a single logical database sharded by tenant.</span></span> <span data-ttu-id="b6512-150">För att uppnå en uppsättning 'globala' vyer läggs till databasen klient projektet klient-id till var och en av de tabeller som frågas globalt.</span><span class="sxs-lookup"><span data-stu-id="b6512-150">To achieve this, a set of 'global' views are added to the tenant database that project a tenant id into each of the tables that are queried globally.</span></span> <span data-ttu-id="b6512-151">Till exempel den *VenueEvents* visa lägger till en beräknad *VenueId* kolumnerna planerat från den *händelser* tabell.</span><span class="sxs-lookup"><span data-stu-id="b6512-151">For example, the *VenueEvents* view adds a computed *VenueId* to the columns projected from the *Events* table.</span></span> <span data-ttu-id="b6512-152">Genom att definiera den externa tabellen i head-databasen via *VenueEvents* (i stället för den underliggande *händelser* tabell), elastisk fråga kan push-teknik kopplingar baserat på *VenueId*så att de kan köras parallellt på varje fjärrdatabasen (istället för på head databasen).</span><span class="sxs-lookup"><span data-stu-id="b6512-152">By defining the external table in the head database over *VenueEvents* (rather than the underlying *Events* table), Elastic Query is able to push down joins based on *VenueId* so they can be executed in parallel on each remote database (rather than on the head database).</span></span> <span data-ttu-id="b6512-153">Detta minskar avsevärt mängden data som returneras, vilket resulterar i en stor ökning av prestanda för många frågor.</span><span class="sxs-lookup"><span data-stu-id="b6512-153">This dramatically reduces the amount of data that is returned, which results in a substantial increase in performance for many queries.</span></span> <span data-ttu-id="b6512-154">De här globala vyer har skapats i förväg i alla klient-databaser (och i *basetenantdb*).</span><span class="sxs-lookup"><span data-stu-id="b6512-154">These global views have been pre-created in all tenant databases (and in *basetenantdb*).</span></span>

1. <span data-ttu-id="b6512-155">Öppna SSMS och [ansluta till tenants1 -&lt;användare&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span><span class="sxs-lookup"><span data-stu-id="b6512-155">Open SSMS and [connect to the tenants1-&lt;USER&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span></span>
2. <span data-ttu-id="b6512-156">Expandera **databaser**, högerklicka på **contosoconcerthall**, och välj **ny fråga**.</span><span class="sxs-lookup"><span data-stu-id="b6512-156">Expand **Databases**, right-click **contosoconcerthall**, and select **New Query**.</span></span>
3. <span data-ttu-id="b6512-157">Kör följande frågor för att utforska skillnaden mellan en klient-tabeller och globala vyer:</span><span class="sxs-lookup"><span data-stu-id="b6512-157">Run the following queries to explore the difference between the single-tenant tables and the global views:</span></span>

   ```T-SQL
   -- The base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice the plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- The base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects the VenueId retrieved from the Venues table.
   SELECT * FROM VenueEvents
   ```

<span data-ttu-id="b6512-158">I dessa vyer i *VenueId* beräknas som en hash av vilken plats, men alla metoden kan användas för att införa ett unikt värde.</span><span class="sxs-lookup"><span data-stu-id="b6512-158">In these views, the *VenueId* is computed as a hash of the Venue name, but any approach could be used to introduce a unique value.</span></span> <span data-ttu-id="b6512-159">Den här metoden är ungefär samma sätt som klientnyckeln beräknas för användning i katalogen.</span><span class="sxs-lookup"><span data-stu-id="b6512-159">This approach is similar to the way the tenant key is computed for use in the catalog.</span></span>

<span data-ttu-id="b6512-160">För att granska definitionen av den *handelsplatser* vy:</span><span class="sxs-lookup"><span data-stu-id="b6512-160">To examine the definition of the *Venues* view:</span></span>

1. <span data-ttu-id="b6512-161">I **Object Explorer**, expandera **contosoconcethall** > **vyer**:</span><span class="sxs-lookup"><span data-stu-id="b6512-161">In **Object Explorer**, expand **contosoconcethall** > **Views**:</span></span>

   ![vyer](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. <span data-ttu-id="b6512-163">Högerklicka på **dbo. Handelsplatser**.</span><span class="sxs-lookup"><span data-stu-id="b6512-163">Right-click **dbo.Venues**.</span></span>
3. <span data-ttu-id="b6512-164">Välj **skript som** > **skapa till** > **nya Query Editor-fönstret**</span><span class="sxs-lookup"><span data-stu-id="b6512-164">Select **Script View as** > **CREATE To** > **New Query Editor Window**</span></span>

<span data-ttu-id="b6512-165">Skript för någon av de andra *plats* vyer för att se hur de lägger till den *VenueId*.</span><span class="sxs-lookup"><span data-stu-id="b6512-165">Script any of the other *Venue* views to see how they add the *VenueId*.</span></span>

## <a name="deploy-the-database-used-for-ad-hoc-distributed-queries"></a><span data-ttu-id="b6512-166">Distribuera den databas som används för ad hoc-distribuerade frågor</span><span class="sxs-lookup"><span data-stu-id="b6512-166">Deploy the database used for ad-hoc distributed queries</span></span>

<span data-ttu-id="b6512-167">Den här övningen distribuerar den *adhocanalytics* databas.</span><span class="sxs-lookup"><span data-stu-id="b6512-167">This exercise deploys the *adhocanalytics* database.</span></span> <span data-ttu-id="b6512-168">Detta är head databasen som innehåller schema som används för att fråga över alla klient-databaser.</span><span class="sxs-lookup"><span data-stu-id="b6512-168">This is the head database that will contain the schema used for querying across all tenant databases.</span></span> <span data-ttu-id="b6512-169">Databasen har distribuerats till befintliga katalogserver, vilket är den server som används för alla datorhanteringsrelaterade databaser i sample-appen.</span><span class="sxs-lookup"><span data-stu-id="b6512-169">The database is deployed to the existing catalog server, which is the server used for all management-related databases in the sample app.</span></span>

1. <span data-ttu-id="b6512-170">Öppna ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* i *PowerShell ISE* och ange följande värden:</span><span class="sxs-lookup"><span data-stu-id="b6512-170">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in the *PowerShell ISE* and set the following values:</span></span>
   * <span data-ttu-id="b6512-171">**$DemoScenario** = 2, **Distribuera adhoc-analysdatabas**.</span><span class="sxs-lookup"><span data-stu-id="b6512-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span></span>

2. <span data-ttu-id="b6512-172">Tryck på **F5** att köra skriptet och skapa den *adhocanalytics* databas.</span><span class="sxs-lookup"><span data-stu-id="b6512-172">Press **F5** to run the script and create the *adhocanalytics* database.</span></span>

<span data-ttu-id="b6512-173">I nästa avsnitt, du lägger till schemat i databasen så att den kan användas för att köra distribuerade frågor.</span><span class="sxs-lookup"><span data-stu-id="b6512-173">In the next section, you add schema to the database so it can be used to run distributed queries.</span></span>

## <a name="configure-the-database-for-running-distributed-queries"></a><span data-ttu-id="b6512-174">Konfigurera databasen för att köra distribuerade frågor</span><span class="sxs-lookup"><span data-stu-id="b6512-174">Configure the database for running distributed queries</span></span>

<span data-ttu-id="b6512-175">Den här övningen lägger till schemat (extern datakälla och extern tabelldefinitioner) i ad hoc-analytics-databasen som gör att fråga över alla klient-databaser.</span><span class="sxs-lookup"><span data-stu-id="b6512-175">This exercise adds schema (the external data source and external table definitions) to the ad-hoc analytics database that enables querying across all tenant databases.</span></span>

1. <span data-ttu-id="b6512-176">Öppna SQL Server Management Studio och Anslut till ad hoc Analytics-databasen som du skapade i föregående steg.</span><span class="sxs-lookup"><span data-stu-id="b6512-176">Open SQL Server Management Studio, and connect to the Adhoc Analytics database you created in the previous step.</span></span> <span data-ttu-id="b6512-177">Namnet på databasen kommer att adhocanalytics.</span><span class="sxs-lookup"><span data-stu-id="b6512-177">The name of the database will be adhocanalytics.</span></span>
2. <span data-ttu-id="b6512-178">Öppna ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *initiera AdhocAnalyticsDB.sql* i SSMS.</span><span class="sxs-lookup"><span data-stu-id="b6512-178">Open ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span></span>
3. <span data-ttu-id="b6512-179">Granska SQL-skript och Tänk på följande:</span><span class="sxs-lookup"><span data-stu-id="b6512-179">Review the SQL script and note the following:</span></span>

   <span data-ttu-id="b6512-180">Elastisk frågan använder en databas-omfattande autentisering för åtkomst till alla klient-databaser.</span><span class="sxs-lookup"><span data-stu-id="b6512-180">Elastic Query uses a database-scoped credential to access each of the tenant databases.</span></span> <span data-ttu-id="b6512-181">Dessa autentiseringsuppgifter måste vara tillgänglig i alla databaser och bör normalt beviljas den minimala behörigheten som krävs för att aktivera dessa ad hoc-frågor.</span><span class="sxs-lookup"><span data-stu-id="b6512-181">This credential needs to be available in all the databases and should normally be granted the minimum rights required to enable these ad-hoc queries.</span></span>

    ![Skapa autentiseringsuppgifter](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   <span data-ttu-id="b6512-183">Den externa datakällan som definieras för att använda klient Fragmentera kartan i katalogdatabasen.</span><span class="sxs-lookup"><span data-stu-id="b6512-183">The external data source, that is defined to use the tenant shard map in the catalog database.</span></span> <span data-ttu-id="b6512-184">Med det som den externa datakällan kan distribueras frågor för alla databaser som är registrerade i katalogen när frågan körs.</span><span class="sxs-lookup"><span data-stu-id="b6512-184">By using this as the external data source, queries are distributed to all databases registered in the catalog when the query is run.</span></span> <span data-ttu-id="b6512-185">Eftersom servernamn är olika för varje distribution, hämtar Initieringsskript för den här platsen för katalogdatabasen genom att hämta den aktuella servern (@@servername) där skriptet körs.</span><span class="sxs-lookup"><span data-stu-id="b6512-185">Because server names are different for each deployment, this initialization script gets the location of the catalog database by retrieving the current server (@@servername) where the script is executed.</span></span>

    ![Skapa extern datakälla](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   <span data-ttu-id="b6512-187">Externa tabeller som refererar till de globala vyerna som beskrivs i föregående avsnitt och definieras med **DISTRIBUTION = SHARDED(VenueId)**.</span><span class="sxs-lookup"><span data-stu-id="b6512-187">The external tables that reference the global views described in the previous section, and defined with **DISTRIBUTION = SHARDED(VenueId)**.</span></span> <span data-ttu-id="b6512-188">Eftersom varje *VenueId* mappar till en enskild databas detta förbättrar prestanda för många scenarier som visas i nästa avsnitt.</span><span class="sxs-lookup"><span data-stu-id="b6512-188">Because each *VenueId* maps to a single database, this improves performance for many scenarios as shown in the next section.</span></span>

    ![Skapa externa tabeller](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   <span data-ttu-id="b6512-190">Den lokala tabellen *VenueTypes* som skapas och fylls.</span><span class="sxs-lookup"><span data-stu-id="b6512-190">The local table *VenueTypes* that is created and populated.</span></span> <span data-ttu-id="b6512-191">Denna referenstabell data är vanligt i alla klient-databaser, så kan representeras som en lokal tabell och ifyllda med gemensamma data.</span><span class="sxs-lookup"><span data-stu-id="b6512-191">This reference data table is common in all tenant databases, so it can be represented here as a local table and populated with the common data.</span></span> <span data-ttu-id="b6512-192">För vissa frågor detta kan minska mängden data som flyttas mellan klient-databaser och *adhocanalytics* databas.</span><span class="sxs-lookup"><span data-stu-id="b6512-192">For some queries this may reduce the amount of data moved between the tenant databases and the *adhocanalytics* database.</span></span>

    ![Skapa tabell](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   <span data-ttu-id="b6512-194">Om du inkluderar referenstabellerna i det här sättet måste du uppdatera tabellschemat och data när du uppdaterar klient-databaser.</span><span class="sxs-lookup"><span data-stu-id="b6512-194">If you include reference tables in this manner, be sure to update the table schema and data whenever you update the tenant databases.</span></span>

4. <span data-ttu-id="b6512-195">Tryck på **F5** att köra skriptet och initiera den *adhocanalytics* databas.</span><span class="sxs-lookup"><span data-stu-id="b6512-195">Press **F5** to run the script and initialize the *adhocanalytics* database.</span></span> 

<span data-ttu-id="b6512-196">Du kan nu köra distribuerade frågor och samla in insikter över alla klienter!</span><span class="sxs-lookup"><span data-stu-id="b6512-196">Now you can run distributed queries, and gather insights across all tenants!</span></span>

## <a name="run-ad-hoc-distributed-queries"></a><span data-ttu-id="b6512-197">Köra ad hoc-distribuerade frågor</span><span class="sxs-lookup"><span data-stu-id="b6512-197">Run ad-hoc distributed queries</span></span>

<span data-ttu-id="b6512-198">Nu när den *adhocanalytics* databasen är ställa in, gå vidare och köra några distribuerade frågor.</span><span class="sxs-lookup"><span data-stu-id="b6512-198">Now that the *adhocanalytics* database is set up, go ahead and run some distributed queries.</span></span> <span data-ttu-id="b6512-199">Är körningsplanen för en bättre förståelse för där frågebearbetningen sker.</span><span class="sxs-lookup"><span data-stu-id="b6512-199">Include the execution plan for a better understanding of where the query processing is happening.</span></span> 

<span data-ttu-id="b6512-200">När undersöks körningsplanen, hovra över plan ikoner för information.</span><span class="sxs-lookup"><span data-stu-id="b6512-200">When inspecting the execution plan, hover over the plan icons for details.</span></span> 

<span data-ttu-id="b6512-201">Viktigt att notera, är den här inställningen **DISTRIBUTION = SHARDED(VenueId)** när vi har definierat den externa datakällan förbättras prestanda för många scenarier.</span><span class="sxs-lookup"><span data-stu-id="b6512-201">Important to note, is that setting **DISTRIBUTION = SHARDED(VenueId)** when we defined the external data source, improves performance for many scenarios.</span></span> <span data-ttu-id="b6512-202">Eftersom varje *VenueId* mappar till en enskild databas filtrering enkelt görs via fjärranslutning, returnerar bara de data vi behöver.</span><span class="sxs-lookup"><span data-stu-id="b6512-202">Because each *VenueId* maps to a single database, filtering is easily done remotely, returning only the data we need.</span></span>

1. <span data-ttu-id="b6512-203">Öppna ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* i SSMS.</span><span class="sxs-lookup"><span data-stu-id="b6512-203">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span></span>
2. <span data-ttu-id="b6512-204">Se till att du är ansluten till den **adhocanalytics** databas.</span><span class="sxs-lookup"><span data-stu-id="b6512-204">Ensure you are connected to the **adhocanalytics** database.</span></span>
3. <span data-ttu-id="b6512-205">Välj den **frågan** -menyn och klicka på **innehåller faktiska körning som planera**</span><span class="sxs-lookup"><span data-stu-id="b6512-205">Select the **Query** menu and click **Include Actual Execution Plan**</span></span>
4. <span data-ttu-id="b6512-206">Markera den *vilka handelsplatser är registrerade?* fråga och tryck på **F5**.</span><span class="sxs-lookup"><span data-stu-id="b6512-206">Highlight the *Which venues are currently registered?* query, and press **F5**.</span></span>

   <span data-ttu-id="b6512-207">Frågan returnerar listan över hela platsen, som illustrerar hur snabbt och enkelt det är att fråga på alla klienter och returnera data från varje klient.</span><span class="sxs-lookup"><span data-stu-id="b6512-207">The query returns the entire venue list, illustrating how quick and easy it is to query across all tenants and return data from each tenant.</span></span>

   <span data-ttu-id="b6512-208">Inspektera planen och se att för hela kostnaden är fjärransluten frågan eftersom vi bara gå till varje klient-databas och välja information för platsen.</span><span class="sxs-lookup"><span data-stu-id="b6512-208">Inspect the plan and see that the entire cost is the remote query because we're simply going to each tenant database and selecting the venue information.</span></span>

   ![Välj * från dbo. Handelsplatser](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. <span data-ttu-id="b6512-210">Välj nästa fråga och tryck på **F5**.</span><span class="sxs-lookup"><span data-stu-id="b6512-210">Select the next query, and press **F5**.</span></span>

   <span data-ttu-id="b6512-211">Den här frågan kopplar ihop data från klient-databaser och lokalt *VenueTypes* tabellen (lokal, eftersom den är en tabell den *adhocanalytics* databas).</span><span class="sxs-lookup"><span data-stu-id="b6512-211">This query joins data from the tenant databases and the local *VenueTypes* table (local, as its a table in the *adhocanalytics* database).</span></span>

   <span data-ttu-id="b6512-212">Inspektera planen och se att flesta kostnaden är fjärransluten frågan eftersom vi söka varje klients plats info (dbo. Handelsplatser) och gör sedan en snabb lokalt join med lokalt *VenueTypes* tabell för att visa det egna namnet.</span><span class="sxs-lookup"><span data-stu-id="b6512-212">Inspect the plan and see that the majority of cost is the remote query because we query each tenant's venue info (dbo.Venues), and then do a quick local join with the local *VenueTypes* table to display the friendly name.</span></span>

   ![Anslut på fjärrdatorn och den lokala data](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. <span data-ttu-id="b6512-214">Nu välja de *vilken dag mest biljetter såldes?* fråga och tryck på **F5**.</span><span class="sxs-lookup"><span data-stu-id="b6512-214">Now select the *On which day were the most tickets sold?* query, and press **F5**.</span></span>

   <span data-ttu-id="b6512-215">Den här frågan har lite mer komplexa att ansluta och aggregering.</span><span class="sxs-lookup"><span data-stu-id="b6512-215">This query does a bit more complex joining and aggregation.</span></span> <span data-ttu-id="b6512-216">Vad är viktigt att notera är att de flesta av bearbetningen sker externt och återigen vi hämta bara de rader som vi måste returnera en enda rad för varje plats sammanställd biljett Försäljning antal per dag.</span><span class="sxs-lookup"><span data-stu-id="b6512-216">What's important to note is that most of the processing is done remotely, and once again, we bring back only the rows we need, returning just a single row for each venue's aggregate ticket sale count per day.</span></span>

   ![DocumentDB](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a><span data-ttu-id="b6512-218">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="b6512-218">Next steps</span></span>

<span data-ttu-id="b6512-219">I den här självstudiekursen lärde du dig att:</span><span class="sxs-lookup"><span data-stu-id="b6512-219">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="b6512-220">Köra distribuerade frågor över alla klientdatabaser</span><span class="sxs-lookup"><span data-stu-id="b6512-220">Run distributed queries across all tenant databases</span></span>
> * <span data-ttu-id="b6512-221">Distribuera en ad hoc-analytics databas och lägga till schemat för att kunna köra distribuerade frågor.</span><span class="sxs-lookup"><span data-stu-id="b6512-221">Deploy an ad-hoc analytics database and add schema to it to run distributed queries.</span></span>


<span data-ttu-id="b6512-222">Prova den [klient Analytics-självstudier](sql-database-saas-tutorial-tenant-analytics.md) att utforska extrahera data till en separat analytics-databas för mer komplexa analyser bearbetning...</span><span class="sxs-lookup"><span data-stu-id="b6512-222">Now try the [Tenant Analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md) to explore extracting data to a separate analytics database for more complex analytics processing...</span></span>

## <a name="additional-resources"></a><span data-ttu-id="b6512-223">Ytterligare resurser</span><span class="sxs-lookup"><span data-stu-id="b6512-223">Additional resources</span></span>

* <span data-ttu-id="b6512-224">Ytterligare [självstudier som bygger på Wingtip SaaS-program](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="b6512-224">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="b6512-225">Elastic Query</span><span class="sxs-lookup"><span data-stu-id="b6512-225">Elastic Query</span></span>](sql-database-elastic-query-overview.md)
