---
title: "aaaRun ad hoc-analytics frågor över flera Azure SQL-databaser | Microsoft Docs"
description: "Köra ad hoc-frågor för analytics över flera SQL-databaser i hello Wingtip SaaS flera innehavare app."
keywords: sql database tutorial
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: 140cd51fdd03b5a548147282b51ceb0ad80c944d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a><span data-ttu-id="33f07-104">Köra ad hoc-frågor för analytics över alla Wingtip SaaS-klienter</span><span class="sxs-lookup"><span data-stu-id="33f07-104">Run ad-hoc analytics queries across all Wingtip SaaS tenants</span></span>

<span data-ttu-id="33f07-105">I kursen får köra du distribuerade frågor över hello hela uppsättningen av klient databaser tooenable ad hoc-analytics.</span><span class="sxs-lookup"><span data-stu-id="33f07-105">In this tutorial, you run distributed queries across hello entire set of tenant databases tooenable ad-hoc analytics.</span></span> <span data-ttu-id="33f07-106">Elastisk frågan är används tooenable distribuerade frågor som kräver en databas för ytterligare analys distribueras (toohello katalogserver).</span><span class="sxs-lookup"><span data-stu-id="33f07-106">Elastic Query is used tooenable distributed queries, which requires an additional analytics database is deployed (toohello catalog server).</span></span> <span data-ttu-id="33f07-107">Dessa frågor kan extrahera insikter begravd i hello dagliga användningsdata hello Wingtip SaaS-appen.</span><span class="sxs-lookup"><span data-stu-id="33f07-107">These queries can extract insights buried in hello day-to-day operational data of hello Wingtip SaaS app.</span></span>


<span data-ttu-id="33f07-108">I den här guiden lär du dig:</span><span class="sxs-lookup"><span data-stu-id="33f07-108">In this tutorial you learn:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="33f07-109">Om hello globala vyer i varje databas, som gör att effektiva frågor över klienter</span><span class="sxs-lookup"><span data-stu-id="33f07-109">About hello global views in each database, that enable efficient querying across tenants</span></span>
> * <span data-ttu-id="33f07-110">Hur toodeploy en ad hoc-analytics-databas</span><span class="sxs-lookup"><span data-stu-id="33f07-110">How toodeploy an ad-hoc analytics database</span></span>
> * <span data-ttu-id="33f07-111">Hur toorun distribuerade frågor över alla klient-databaser</span><span class="sxs-lookup"><span data-stu-id="33f07-111">How toorun distributed queries across all tenant databases</span></span>



<span data-ttu-id="33f07-112">den här självstudiekursen, se till att hello följande krav är slutförda toocomplete:</span><span class="sxs-lookup"><span data-stu-id="33f07-112">toocomplete this tutorial, make sure hello following prerequisites are completed:</span></span>

* <span data-ttu-id="33f07-113">hello Wingtip SaaS appen har distribuerats.</span><span class="sxs-lookup"><span data-stu-id="33f07-113">hello Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="33f07-114">toodeploy på mindre än fem minuter finns [distribuera och utforska hello Wingtip SaaS-program](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="33f07-114">toodeploy in less than five minutes, see [Deploy and explore hello Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="33f07-115">Azure PowerShell ska ha installerats.</span><span class="sxs-lookup"><span data-stu-id="33f07-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="33f07-116">Mer information finns i [Komma igång med Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span><span class="sxs-lookup"><span data-stu-id="33f07-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>
* <span data-ttu-id="33f07-117">SQL Server Management Studio (SSMS) har installerats.</span><span class="sxs-lookup"><span data-stu-id="33f07-117">SQL Server Management Studio (SSMS) is installed.</span></span> <span data-ttu-id="33f07-118">toodownload och installera SSMS, se [Hämta SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span><span class="sxs-lookup"><span data-stu-id="33f07-118">toodownload and install SSMS, see [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span></span>


## <a name="ad-hoc-analytics-pattern"></a><span data-ttu-id="33f07-119">Ad hoc-analytics mönster</span><span class="sxs-lookup"><span data-stu-id="33f07-119">Ad-hoc analytics pattern</span></span>

<span data-ttu-id="33f07-120">En av hello stora möjligheter med SaaS-program är toouse hello mängder med klientdata som lagras centralt i hello molnet.</span><span class="sxs-lookup"><span data-stu-id="33f07-120">One of hello great opportunities with SaaS applications is toouse hello vast amount of tenant data stored centrally in hello cloud.</span></span> <span data-ttu-id="33f07-121">Använd den här data toogain insikter om hello igen och användning av programmet, klienterna, sina användare, inställningar, beteenden och så vidare. Dessa insights hjälper funktionen utveckling, användbarhet förbättringar och andra investeringar i dina appar och tjänster.</span><span class="sxs-lookup"><span data-stu-id="33f07-121">Use this data toogain insights into hello operation and usage of your application, your tenants, their users, preferences, behaviors, etc. These insights can guide feature development, usability improvements, and other investments in your apps and services.</span></span>

<span data-ttu-id="33f07-122">Det är lätt att komma åt en enkel databas med flera klienter, men inte så enkelt när du har distribuerat tusentals databaser.</span><span class="sxs-lookup"><span data-stu-id="33f07-122">Accessing this data in a single multi-tenant database is easy, but not so easy when distributed at scale across potentially thousands of databases.</span></span> <span data-ttu-id="33f07-123">En metod som är toouse [elastisk frågan](sql-database-elastic-query-overview.md), vilket innebär att skicka en fråga i en distribuerad uppsättning databaser med gemensamma schemat.</span><span class="sxs-lookup"><span data-stu-id="33f07-123">One approach is toouse [Elastic Query](sql-database-elastic-query-overview.md), which enables querying across a distributed set of databases with common schema.</span></span> <span data-ttu-id="33f07-124">Elastisk frågan använder en enda *head* databas i vilken externa tabeller har definierats spegling tabeller eller vyer i hello distribuerade databaser (klient).</span><span class="sxs-lookup"><span data-stu-id="33f07-124">Elastic Query uses a single *head* database in which external tables are defined that mirror tables or views in hello distributed (tenant) databases.</span></span> <span data-ttu-id="33f07-125">Frågor som skickats toothis head databasen är kompilerade tooproduce en distribuerad frågeplanen med delar av hello frågan flyttas fram toohello klient databaser efter behov.</span><span class="sxs-lookup"><span data-stu-id="33f07-125">Queries submitted toothis head database are compiled tooproduce a distributed query plan, with portions of hello query pushed down toohello tenant databases as needed.</span></span> <span data-ttu-id="33f07-126">Elastisk frågan använder hello Fragmentera kartan i hello databasen tooprovide hello katalogplats hello klient databaser.</span><span class="sxs-lookup"><span data-stu-id="33f07-126">Elastic Query uses hello shard map in hello catalog database tooprovide hello location of hello tenant databases.</span></span> <span data-ttu-id="33f07-127">Installation och fråga är enkla standarden [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), och stöd för ad hoc-frågor från verktyg som Power BI och Excel.</span><span class="sxs-lookup"><span data-stu-id="33f07-127">Setup and query are straightforward using standard [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), and support ad-hoc querying from tools like Power BI and Excel.</span></span>

<span data-ttu-id="33f07-128">Genom att distribuera frågor över hello klient databaser innehåller elastisk frågan direkta insikter om live produktionsdata.</span><span class="sxs-lookup"><span data-stu-id="33f07-128">By distributing queries across hello tenant databases, Elastic Query provides immediate insight into live production data.</span></span> <span data-ttu-id="33f07-129">Som elastisk fråga hämtar data från potentiellt många databaser, skickas frågan svarstid kan ibland vara högre än för motsvarande frågor tooa enskilda databaser för flera innehavare.</span><span class="sxs-lookup"><span data-stu-id="33f07-129">However, as Elastic Query pulls data from potentially many databases, query latency can sometimes be higher than for equivalent queries submitted tooa single multi-tenant database.</span></span> <span data-ttu-id="33f07-130">Vara bör försiktig när designa frågar toominimize hello data som returneras.</span><span class="sxs-lookup"><span data-stu-id="33f07-130">Care should be taken when designing queries toominimize hello data that is returned.</span></span> <span data-ttu-id="33f07-131">Elastisk frågan är ofta bäst för små mängder data i realtid, frågor som skillnad från toobuilding används ofta komplexa analytics-frågor eller rapporter.</span><span class="sxs-lookup"><span data-stu-id="33f07-131">Elastic Query is often best suited for querying small amounts of real-time data, as opposed toobuilding frequently used or complex analytics queries or reports.</span></span> <span data-ttu-id="33f07-132">Om frågorna inte utför väl kan titta på hello [åtgärdsplan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) toosee vilken del av hello frågan har aviserats toohello fjärrdatabasen och hur mycket data som returneras.</span><span class="sxs-lookup"><span data-stu-id="33f07-132">If queries don't perform well, look at hello [execution plan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) toosee what part of hello query has been pushed down toohello remote database and how much data is being returned.</span></span> <span data-ttu-id="33f07-133">Frågor som kräver komplexa analytisk bearbetning kan vara bättre hanteras i vissa fall genom att extrahera klientdata till en särskild databas eller datalager som är optimerade för analytics-frågor.</span><span class="sxs-lookup"><span data-stu-id="33f07-133">Queries that require complex analytical processing may be better served in some cases by extracting tenant data into a dedicated database or data warehouse optimized for analytics queries.</span></span> <span data-ttu-id="33f07-134">Det här mönstret förklaras i hello [klient analytics kursen](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="33f07-134">This pattern is explained in hello [tenant analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md).</span></span> 

## <a name="get-hello-wingtip-application-scripts"></a><span data-ttu-id="33f07-135">Hämta hello Wingtip programskript</span><span class="sxs-lookup"><span data-stu-id="33f07-135">Get hello Wingtip application scripts</span></span>

<span data-ttu-id="33f07-136">hello Wingtip SaaS-skript och programmets källkod är tillgängliga i hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github-lagringsplatsen.</span><span class="sxs-lookup"><span data-stu-id="33f07-136">hello Wingtip SaaS scripts and application source code are available in hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="33f07-137">[Steg toodownload hello Wingtip SaaS skript](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="33f07-137">[Steps toodownload hello Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>

## <a name="create-ticket-sales-data"></a><span data-ttu-id="33f07-138">Skapa biljett försäljningsdata</span><span class="sxs-lookup"><span data-stu-id="33f07-138">Create ticket sales data</span></span>

<span data-ttu-id="33f07-139">toorun frågor mot en mer intressant datamängd, skapa biljett försäljningsdata genom att köra hello biljett-generatorn.</span><span class="sxs-lookup"><span data-stu-id="33f07-139">toorun queries against a more interesting data set, create ticket sales data by running hello ticket-generator.</span></span>

1. <span data-ttu-id="33f07-140">I hello *PowerShell ISE*öppnar hello... \\Learning moduler\\operativa Analytics\\ad hoc Analytics\\*Demo-AdhocAnalytics.ps1* skript och ange hello följande värden:</span><span class="sxs-lookup"><span data-stu-id="33f07-140">In hello *PowerShell ISE*, open hello ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* script and set hello following values:</span></span>
   * <span data-ttu-id="33f07-141">**$DemoScenario** = 1, **köpa biljetter för händelser på alla handelsplatser**.</span><span class="sxs-lookup"><span data-stu-id="33f07-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues**.</span></span>
2. <span data-ttu-id="33f07-142">Tryck på **F5** att köra hello skript och generera Biljettförsäljning.</span><span class="sxs-lookup"><span data-stu-id="33f07-142">Press **F5** to run hello script and generate ticket sales.</span></span> <span data-ttu-id="33f07-143">När hello skriptet körs, Fortsätt med hello steg i den här självstudiekursen.</span><span class="sxs-lookup"><span data-stu-id="33f07-143">While hello script is running, continue hello steps in this tutorial.</span></span> <span data-ttu-id="33f07-144">hello biljett data som efterfrågas i hello *köra ad hoc-distribuerade frågor* avsnittet, så vänta hello biljett generator toocomplete om det fortfarande körs när du får toothat övningen.</span><span class="sxs-lookup"><span data-stu-id="33f07-144">hello ticket data is queried in hello *Run ad-hoc distributed queries* section, so wait for hello ticket generator toocomplete if it's still running when you get toothat exercise.</span></span>

## <a name="explore-hello-global-views"></a><span data-ttu-id="33f07-145">Utforska hello globala vyer</span><span class="sxs-lookup"><span data-stu-id="33f07-145">Explore hello global views</span></span>

<span data-ttu-id="33f07-146">hello Wingtip SaaS-programmet skapas med en modell för klient per databas, så hello klient databasschemat definieras ur en enskild klient.</span><span class="sxs-lookup"><span data-stu-id="33f07-146">hello Wingtip SaaS application is built using a tenant-per-database model, so hello tenant database schema is defined from a single-tenant perspective.</span></span> <span data-ttu-id="33f07-147">Klient-specifik information finns i en tabell *plats*, som alltid har en enda rad och implementeras som en heap utan en primärnyckel.</span><span class="sxs-lookup"><span data-stu-id="33f07-147">Tenant-specific information exists in one table, *Venue*, which always has a single row, and is implemented as a heap, without a primary key.</span></span> <span data-ttu-id="33f07-148">Andra tabeller i hello-schemat inte behöver toobe relaterade toohello *plats* tabellen, eftersom vid normal användning är aldrig osäker vilken klient hello information som hör till.</span><span class="sxs-lookup"><span data-stu-id="33f07-148">Other tables in hello schema don't need toobe related toohello *Venue* table, because in normal use, there is never any doubt which tenant hello data belongs to.</span></span>

<span data-ttu-id="33f07-149">Men när du frågar över alla databaser är det viktigt att elastisk fråga kan behandla hello data som om det är en del av en enskild logisk databas delat av klient.</span><span class="sxs-lookup"><span data-stu-id="33f07-149">However, when querying across all databases, it's important that Elastic Query can treat hello data as if it is part of a single logical database sharded by tenant.</span></span> <span data-ttu-id="33f07-150">tooachieve är detta en uppsättning 'globala' vyer tillagda toohello klient databasen som en klient-id till varje hello-tabeller som frågas globalt.</span><span class="sxs-lookup"><span data-stu-id="33f07-150">tooachieve this, a set of 'global' views are added toohello tenant database that project a tenant id into each of hello tables that are queried globally.</span></span> <span data-ttu-id="33f07-151">Till exempel hello *VenueEvents* visa lägger till en beräknad *VenueId* toohello kolumner planerat från hello *händelser* tabell.</span><span class="sxs-lookup"><span data-stu-id="33f07-151">For example, hello *VenueEvents* view adds a computed *VenueId* toohello columns projected from hello *Events* table.</span></span> <span data-ttu-id="33f07-152">Genom att definiera hello extern tabell i hello head databas över *VenueEvents* (i stället för hello underliggande *händelser* tabell), elastisk frågan är kan toopush ned kopplingar baserat på *VenueId* så att de kan köras parallellt på varje fjärrdatabasen (istället för på hello head databas).</span><span class="sxs-lookup"><span data-stu-id="33f07-152">By defining hello external table in hello head database over *VenueEvents* (rather than hello underlying *Events* table), Elastic Query is able toopush down joins based on *VenueId* so they can be executed in parallel on each remote database (rather than on hello head database).</span></span> <span data-ttu-id="33f07-153">Detta minskar kraftigt hello mängden data som returneras, vilket resulterar i en stor ökning av prestanda för många frågor.</span><span class="sxs-lookup"><span data-stu-id="33f07-153">This dramatically reduces hello amount of data that is returned, which results in a substantial increase in performance for many queries.</span></span> <span data-ttu-id="33f07-154">De här globala vyer har skapats i förväg i alla klient-databaser (och i *basetenantdb*).</span><span class="sxs-lookup"><span data-stu-id="33f07-154">These global views have been pre-created in all tenant databases (and in *basetenantdb*).</span></span>

1. <span data-ttu-id="33f07-155">Öppna SSMS och [ansluta toohello tenants1 -&lt;användare&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span><span class="sxs-lookup"><span data-stu-id="33f07-155">Open SSMS and [connect toohello tenants1-&lt;USER&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span></span>
2. <span data-ttu-id="33f07-156">Expandera **databaser**, högerklicka på **contosoconcerthall**, och välj **ny fråga**.</span><span class="sxs-lookup"><span data-stu-id="33f07-156">Expand **Databases**, right-click **contosoconcerthall**, and select **New Query**.</span></span>
3. <span data-ttu-id="33f07-157">Kör följande frågor tooexplore hello skillnaden mellan hello stöd för en innehavare tabeller och vyer som hello globala hello:</span><span class="sxs-lookup"><span data-stu-id="33f07-157">Run hello following queries tooexplore hello difference between hello single-tenant tables and hello global views:</span></span>

   ```T-SQL
   -- hello base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice hello plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- hello base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects hello VenueId retrieved from hello Venues table.
   SELECT * FROM VenueEvents
   ```

<span data-ttu-id="33f07-158">I dessa vyer hello *VenueId* beräknas eftersom en hash av hello plats namn, men alla metoden skulle kunna använda toointroduce ett unikt värde.</span><span class="sxs-lookup"><span data-stu-id="33f07-158">In these views, hello *VenueId* is computed as a hash of hello Venue name, but any approach could be used toointroduce a unique value.</span></span> <span data-ttu-id="33f07-159">Den här metoden är liknande toohello sätt hello klientnyckel beräknas för användning i hello-katalogen.</span><span class="sxs-lookup"><span data-stu-id="33f07-159">This approach is similar toohello way hello tenant key is computed for use in hello catalog.</span></span>

<span data-ttu-id="33f07-160">tooexamine hello definition av hello *handelsplatser* vy:</span><span class="sxs-lookup"><span data-stu-id="33f07-160">tooexamine hello definition of hello *Venues* view:</span></span>

1. <span data-ttu-id="33f07-161">I **Object Explorer**, expandera **contosoconcethall** > **vyer**:</span><span class="sxs-lookup"><span data-stu-id="33f07-161">In **Object Explorer**, expand **contosoconcethall** > **Views**:</span></span>

   ![vyer](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. <span data-ttu-id="33f07-163">Högerklicka på **dbo. Handelsplatser**.</span><span class="sxs-lookup"><span data-stu-id="33f07-163">Right-click **dbo.Venues**.</span></span>
3. <span data-ttu-id="33f07-164">Välj **skript som** > **skapa till** > **nya Query Editor-fönstret**</span><span class="sxs-lookup"><span data-stu-id="33f07-164">Select **Script View as** > **CREATE To** > **New Query Editor Window**</span></span>

<span data-ttu-id="33f07-165">Skript för någon av hello andra *plats* vyer toosee hur de lägger till hello *VenueId*.</span><span class="sxs-lookup"><span data-stu-id="33f07-165">Script any of hello other *Venue* views toosee how they add hello *VenueId*.</span></span>

## <a name="deploy-hello-database-used-for-ad-hoc-distributed-queries"></a><span data-ttu-id="33f07-166">Distribuera hello-databasen som används för ad hoc-distribuerade frågor</span><span class="sxs-lookup"><span data-stu-id="33f07-166">Deploy hello database used for ad-hoc distributed queries</span></span>

<span data-ttu-id="33f07-167">Den här övningen distribuerar hello *adhocanalytics* databas.</span><span class="sxs-lookup"><span data-stu-id="33f07-167">This exercise deploys hello *adhocanalytics* database.</span></span> <span data-ttu-id="33f07-168">Detta är head hello-databas som innehåller hello-schema som används för att fråga över alla klient-databaser.</span><span class="sxs-lookup"><span data-stu-id="33f07-168">This is hello head database that will contain hello schema used for querying across all tenant databases.</span></span> <span data-ttu-id="33f07-169">hello-databasen är distribuerade toohello befintliga katalogserver, vilket är hello-server som används för alla datorhanteringsrelaterade databaser i hello sample-appen.</span><span class="sxs-lookup"><span data-stu-id="33f07-169">hello database is deployed toohello existing catalog server, which is hello server used for all management-related databases in hello sample app.</span></span>

1. <span data-ttu-id="33f07-170">Öppna... \\Learning moduler\\operativa Analytics\\ad hoc Analytics\\*Demo-AdhocAnalytics.ps1* i hello *PowerShell ISE* och ange hello följande värden:</span><span class="sxs-lookup"><span data-stu-id="33f07-170">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in hello *PowerShell ISE* and set hello following values:</span></span>
   * <span data-ttu-id="33f07-171">**$DemoScenario** = 2, **Distribuera adhoc-analysdatabas**.</span><span class="sxs-lookup"><span data-stu-id="33f07-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span></span>

2. <span data-ttu-id="33f07-172">Tryck på **F5** toorun hello skript och skapa hello *adhocanalytics* databas.</span><span class="sxs-lookup"><span data-stu-id="33f07-172">Press **F5** toorun hello script and create hello *adhocanalytics* database.</span></span>

<span data-ttu-id="33f07-173">I nästa avsnitt om hello, du lägger till schemat toohello databasen så att den kan vara används toorun distribuerade frågor.</span><span class="sxs-lookup"><span data-stu-id="33f07-173">In hello next section, you add schema toohello database so it can be used toorun distributed queries.</span></span>

## <a name="configure-hello-database-for-running-distributed-queries"></a><span data-ttu-id="33f07-174">Konfigurera hello databasen för att köra distribuerade frågor</span><span class="sxs-lookup"><span data-stu-id="33f07-174">Configure hello database for running distributed queries</span></span>

<span data-ttu-id="33f07-175">Den här övningen lägger till schemat (hello extern datakälla och extern tabelldefinitioner) toohello ad hoc-analytics-databas som gör att fråga över alla klient-databaser.</span><span class="sxs-lookup"><span data-stu-id="33f07-175">This exercise adds schema (hello external data source and external table definitions) toohello ad-hoc analytics database that enables querying across all tenant databases.</span></span>

1. <span data-ttu-id="33f07-176">Öppna SQL Server Management Studio och Anslut toohello ad hoc Analytics-databas som du skapade i föregående steg i hello.</span><span class="sxs-lookup"><span data-stu-id="33f07-176">Open SQL Server Management Studio, and connect toohello Adhoc Analytics database you created in hello previous step.</span></span> <span data-ttu-id="33f07-177">hello namnet på hello databasen kommer att adhocanalytics.</span><span class="sxs-lookup"><span data-stu-id="33f07-177">hello name of hello database will be adhocanalytics.</span></span>
2. <span data-ttu-id="33f07-178">Öppna ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *initiera AdhocAnalyticsDB.sql* i SSMS.</span><span class="sxs-lookup"><span data-stu-id="33f07-178">Open ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span></span>
3. <span data-ttu-id="33f07-179">Granska hello SQL-skript och notera hello följande:</span><span class="sxs-lookup"><span data-stu-id="33f07-179">Review hello SQL script and note hello following:</span></span>

   <span data-ttu-id="33f07-180">Elastisk frågan använder en databas-omfattande autentisering tooaccess varje hello klient databaser.</span><span class="sxs-lookup"><span data-stu-id="33f07-180">Elastic Query uses a database-scoped credential tooaccess each of hello tenant databases.</span></span> <span data-ttu-id="33f07-181">Dessa autentiseringsuppgifter måste toobe som är tillgängliga i alla hello-databaser och bör normalt beviljas hello minsta nödvändiga rättigheterna för tooenable dessa ad hoc-frågor.</span><span class="sxs-lookup"><span data-stu-id="33f07-181">This credential needs toobe available in all hello databases and should normally be granted hello minimum rights required tooenable these ad-hoc queries.</span></span>

    ![Skapa autentiseringsuppgifter](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   <span data-ttu-id="33f07-183">hello definierat extern datakälla som är toouse hello klient Fragmentera kartan i hello katalogdatabasen.</span><span class="sxs-lookup"><span data-stu-id="33f07-183">hello external data source, that is defined toouse hello tenant shard map in hello catalog database.</span></span> <span data-ttu-id="33f07-184">Med detta som hello extern datakälla kan är frågor distribuerade tooall databaser som är registrerade i hello katalog när hello frågan körs.</span><span class="sxs-lookup"><span data-stu-id="33f07-184">By using this as hello external data source, queries are distributed tooall databases registered in hello catalog when hello query is run.</span></span> <span data-ttu-id="33f07-185">Eftersom servernamn är olika för varje distribution initieringen skriptet hämtar hello platsen för hello katalogdatabasen genom att hämta aktuella hello-servern (@@servername) där hello skriptet körs.</span><span class="sxs-lookup"><span data-stu-id="33f07-185">Because server names are different for each deployment, this initialization script gets hello location of hello catalog database by retrieving hello current server (@@servername) where hello script is executed.</span></span>

    ![Skapa extern datakälla](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   <span data-ttu-id="33f07-187">Hej externa tabeller som refererar till hello globala vyer beskrivs i föregående avsnitt i hello och definieras med **DISTRIBUTION = SHARDED(VenueId)**.</span><span class="sxs-lookup"><span data-stu-id="33f07-187">hello external tables that reference hello global views described in hello previous section, and defined with **DISTRIBUTION = SHARDED(VenueId)**.</span></span> <span data-ttu-id="33f07-188">Eftersom varje *VenueId* mappar tooa enskild databas, detta förbättrar prestanda i många fall enligt hello nästa avsnitt.</span><span class="sxs-lookup"><span data-stu-id="33f07-188">Because each *VenueId* maps tooa single database, this improves performance for many scenarios as shown in hello next section.</span></span>

    ![Skapa externa tabeller](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   <span data-ttu-id="33f07-190">hello lokal tabell *VenueTypes* som skapas och fylls.</span><span class="sxs-lookup"><span data-stu-id="33f07-190">hello local table *VenueTypes* that is created and populated.</span></span> <span data-ttu-id="33f07-191">Denna referenstabell data är vanligt i alla klient-databaser, så kan representeras som en lokal tabell och ifyllda med hello gemensamma data.</span><span class="sxs-lookup"><span data-stu-id="33f07-191">This reference data table is common in all tenant databases, so it can be represented here as a local table and populated with hello common data.</span></span> <span data-ttu-id="33f07-192">För vissa frågor detta kan minska hello mängden data flyttas mellan hello klient databaser och hello *adhocanalytics* databas.</span><span class="sxs-lookup"><span data-stu-id="33f07-192">For some queries this may reduce hello amount of data moved between hello tenant databases and hello *adhocanalytics* database.</span></span>

    ![Skapa tabell](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   <span data-ttu-id="33f07-194">Om du inkluderar referenstabellerna på detta sätt vara säker på att tooupdate hello-tabellschemat och data när du uppdaterar hello klient databaser.</span><span class="sxs-lookup"><span data-stu-id="33f07-194">If you include reference tables in this manner, be sure tooupdate hello table schema and data whenever you update hello tenant databases.</span></span>

4. <span data-ttu-id="33f07-195">Tryck på **F5** toorun hello skript och initiera hello *adhocanalytics* databas.</span><span class="sxs-lookup"><span data-stu-id="33f07-195">Press **F5** toorun hello script and initialize hello *adhocanalytics* database.</span></span> 

<span data-ttu-id="33f07-196">Du kan nu köra distribuerade frågor och samla in insikter över alla klienter!</span><span class="sxs-lookup"><span data-stu-id="33f07-196">Now you can run distributed queries, and gather insights across all tenants!</span></span>

## <a name="run-ad-hoc-distributed-queries"></a><span data-ttu-id="33f07-197">Köra ad hoc-distribuerade frågor</span><span class="sxs-lookup"><span data-stu-id="33f07-197">Run ad-hoc distributed queries</span></span>

<span data-ttu-id="33f07-198">Nu att hello *adhocanalytics* databasen är ställa in, gå vidare och köra några distribuerade frågor.</span><span class="sxs-lookup"><span data-stu-id="33f07-198">Now that hello *adhocanalytics* database is set up, go ahead and run some distributed queries.</span></span> <span data-ttu-id="33f07-199">Inkludera hello åtgärdsplan för bättre förståelse av där hello frågebearbetning sker.</span><span class="sxs-lookup"><span data-stu-id="33f07-199">Include hello execution plan for a better understanding of where hello query processing is happening.</span></span> 

<span data-ttu-id="33f07-200">När undersöks hello åtgärdsplan, hovra över hello plan ikoner för information.</span><span class="sxs-lookup"><span data-stu-id="33f07-200">When inspecting hello execution plan, hover over hello plan icons for details.</span></span> 

<span data-ttu-id="33f07-201">Viktiga toonote är inställningen **DISTRIBUTION = SHARDED(VenueId)** när vi har definierat hello extern datakälla förbättras prestanda för många scenarier.</span><span class="sxs-lookup"><span data-stu-id="33f07-201">Important toonote, is that setting **DISTRIBUTION = SHARDED(VenueId)** when we defined hello external data source, improves performance for many scenarios.</span></span> <span data-ttu-id="33f07-202">Eftersom varje *VenueId* mappar tooa enskild databas filtrering är enkelt klart via fjärranslutning, returnerar endast hello data som behövs.</span><span class="sxs-lookup"><span data-stu-id="33f07-202">Because each *VenueId* maps tooa single database, filtering is easily done remotely, returning only hello data we need.</span></span>

1. <span data-ttu-id="33f07-203">Öppna ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* i SSMS.</span><span class="sxs-lookup"><span data-stu-id="33f07-203">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span></span>
2. <span data-ttu-id="33f07-204">Se till att du är ansluten toohello **adhocanalytics** databas.</span><span class="sxs-lookup"><span data-stu-id="33f07-204">Ensure you are connected toohello **adhocanalytics** database.</span></span>
3. <span data-ttu-id="33f07-205">Välj hello **frågan** -menyn och klicka på **innehåller faktiska körning som planera**</span><span class="sxs-lookup"><span data-stu-id="33f07-205">Select hello **Query** menu and click **Include Actual Execution Plan**</span></span>
4. <span data-ttu-id="33f07-206">Markera hello *vilka handelsplatser är registrerade?* fråga och tryck på **F5**.</span><span class="sxs-lookup"><span data-stu-id="33f07-206">Highlight hello *Which venues are currently registered?* query, and press **F5**.</span></span>

   <span data-ttu-id="33f07-207">hello frågan returnerar hello hela platsen listan illustrerar hur snabbt och enkelt det är tooquery på alla klienter och returnera data från varje klient.</span><span class="sxs-lookup"><span data-stu-id="33f07-207">hello query returns hello entire venue list, illustrating how quick and easy it is tooquery across all tenants and return data from each tenant.</span></span>

   <span data-ttu-id="33f07-208">Inspektera hello planen och se att hello hela kostnaden hello frågan eftersom vi helt enkelt pågående tooeach klient databasen och välja hello platsen information.</span><span class="sxs-lookup"><span data-stu-id="33f07-208">Inspect hello plan and see that hello entire cost is hello remote query because we're simply going tooeach tenant database and selecting hello venue information.</span></span>

   ![Välj * från dbo. Handelsplatser](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. <span data-ttu-id="33f07-210">Välj hello nästa fråga och tryck på **F5**.</span><span class="sxs-lookup"><span data-stu-id="33f07-210">Select hello next query, and press **F5**.</span></span>

   <span data-ttu-id="33f07-211">Den här frågan kopplar ihop data från hello klient databaser och hello lokala *VenueTypes* tabellen (lokal, eftersom den är en tabell i hello *adhocanalytics* databas).</span><span class="sxs-lookup"><span data-stu-id="33f07-211">This query joins data from hello tenant databases and hello local *VenueTypes* table (local, as its a table in hello *adhocanalytics* database).</span></span>

   <span data-ttu-id="33f07-212">Inspektera hello planen och se den hello merparten av kostnaden är hello frågan eftersom vi söka varje klients plats info (dbo. Handelsplatser) och gör sedan en snabb lokalt join med hello lokala *VenueTypes* toodisplay hello eget namn.</span><span class="sxs-lookup"><span data-stu-id="33f07-212">Inspect hello plan and see that hello majority of cost is hello remote query because we query each tenant's venue info (dbo.Venues), and then do a quick local join with hello local *VenueTypes* table toodisplay hello friendly name.</span></span>

   ![Anslut på fjärrdatorn och den lokala data](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. <span data-ttu-id="33f07-214">Nu välja hello *vilken dag har hello de flesta biljetter säljs?* fråga och tryck på **F5**.</span><span class="sxs-lookup"><span data-stu-id="33f07-214">Now select hello *On which day were hello most tickets sold?* query, and press **F5**.</span></span>

   <span data-ttu-id="33f07-215">Den här frågan har lite mer komplexa att ansluta och aggregering.</span><span class="sxs-lookup"><span data-stu-id="33f07-215">This query does a bit more complex joining and aggregation.</span></span> <span data-ttu-id="33f07-216">Vad är viktigt toonote är att de flesta av hello bearbetningen sker externt och återigen vi hämta tillbaka endast hello rader vi måste returnera en enda rad för varje plats sammanställd biljett Försäljning antal per dag.</span><span class="sxs-lookup"><span data-stu-id="33f07-216">What's important toonote is that most of hello processing is done remotely, and once again, we bring back only hello rows we need, returning just a single row for each venue's aggregate ticket sale count per day.</span></span>

   ![DocumentDB](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a><span data-ttu-id="33f07-218">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="33f07-218">Next steps</span></span>

<span data-ttu-id="33f07-219">I den här självstudiekursen lärde du dig att:</span><span class="sxs-lookup"><span data-stu-id="33f07-219">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="33f07-220">Köra distribuerade frågor över alla klientdatabaser</span><span class="sxs-lookup"><span data-stu-id="33f07-220">Run distributed queries across all tenant databases</span></span>
> * <span data-ttu-id="33f07-221">Distribuera en ad hoc-analytics databas och Lägg till schema tooit toorun distribuerade frågor.</span><span class="sxs-lookup"><span data-stu-id="33f07-221">Deploy an ad-hoc analytics database and add schema tooit toorun distributed queries.</span></span>


<span data-ttu-id="33f07-222">Prova nu hello [klient Analytics-självstudier](sql-database-saas-tutorial-tenant-analytics.md) tooexplore extrahera data tooa separat analytics databasen för mer komplexa analyser bearbetning...</span><span class="sxs-lookup"><span data-stu-id="33f07-222">Now try hello [Tenant Analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md) tooexplore extracting data tooa separate analytics database for more complex analytics processing...</span></span>

## <a name="additional-resources"></a><span data-ttu-id="33f07-223">Ytterligare resurser</span><span class="sxs-lookup"><span data-stu-id="33f07-223">Additional resources</span></span>

* <span data-ttu-id="33f07-224">Ytterligare [självstudier som bygger på hello Wingtip SaaS-program](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="33f07-224">Additional [tutorials that build upon hello Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="33f07-225">Elastic Query</span><span class="sxs-lookup"><span data-stu-id="33f07-225">Elastic Query</span></span>](sql-database-elastic-query-overview.md)
