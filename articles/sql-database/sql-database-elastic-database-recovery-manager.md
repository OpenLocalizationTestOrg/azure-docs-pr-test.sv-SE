---
title: aaaUsing Recovery Manager toofix Fragmentera mappa problem | Microsoft Docs
description: "Använd hello RecoveryManager klassen toosolve problem med Fragmentera maps"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="6c9e4-103">Med hjälp av hello RecoveryManager klassen toofix Fragmentera kartan problem</span><span class="sxs-lookup"><span data-stu-id="6c9e4-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="6c9e4-104">Hej [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) klassen innehåller hello möjlighet tooeasily identifiera och åtgärda eventuella inkonsekvenser mellan hello globala Fragmentera karta (GSM) och hello lokala Fragmentera kartan (LSM) i en databasmiljö med delat ADO.Net-program.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="6c9e4-105">hello GSM och LSM spåra hello mappningen för varje databas i ett delat.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="6c9e4-106">Ibland kan sker en paus mellan hello GSM och hello LSM.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="6c9e4-107">I så fall använder hello RecoveryManager klassen toodetect och reparera hello break.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="6c9e4-108">Hej RecoveryManager klassen är en del av hello [klientbibliotek för elastisk databas](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Fragmentera karta][1]

<span data-ttu-id="6c9e4-110">Termdefinitioner finns [elastisk databas verktyg ordlista](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="6c9e4-111">hur hello toounderstand **ShardMapManager** används toomanage data i ett delat lösning finns [Fragmentera kartan management](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="6c9e4-112">Varför använda hello recovery manager?</span><span class="sxs-lookup"><span data-stu-id="6c9e4-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="6c9e4-113">I en databasmiljö med delat finns en klient per databas och många databaser per server.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="6c9e4-114">Det kan också finnas flera servrar i hello-miljö.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="6c9e4-115">Varje databas mappas i hello Fragmentera mappning så anrop kan vara routade toohello rätt server och databas.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="6c9e4-116">Databaser spåras enligt tooa **horisontell partitionering nyckeln**, och varje Fragmentera har tilldelats en **viktiga värdeintervallet**.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="6c9e4-117">Till exempel kan en nyckel för horisontell partitionering representera hello kundnamn från ”D” för ”F.”</span><span class="sxs-lookup"><span data-stu-id="6c9e4-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="6c9e4-118">Hej mappningen av alla delar (aka databaser) och intervallen mappningen finns i hello **globala Fragmentera karta (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="6c9e4-119">Varje databas innehåller också en karta över hello-intervall som finns på hello Fragmentera som kallas hello **lokala Fragmentera karta (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="6c9e4-120">När en app ansluter tooa Fragmentera, cachelagras hello mappning med hello app för snabb hämtning.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="6c9e4-121">Hej LSM är används toovalidate cachelagrade data.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="6c9e4-122">hello kan GSM och LSM bli synkroniserad för hello följande orsaker:</span><span class="sxs-lookup"><span data-stu-id="6c9e4-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="6c9e4-123">hello borttagning av en Fragmentera vars intervallet antas toono längre vara används eller ändra namn på en Fragmentera.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="6c9e4-124">Om du tar bort en Fragmentera resulterar i en **frånkopplade Fragmentera mappning**.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="6c9e4-125">På liknande sätt kan har bytt namn till databasen orsaka en överbliven Fragmentera mappning.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="6c9e4-126">Beroende på hello syftet med hello ändring, hello Fragmentera behöva toobe tas bort eller hello Fragmentera placering måste toobe uppdateras.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="6c9e4-127">toorecover en borttagen databas finns [återställa en borttagen databas](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="6c9e4-128">Geo-redundans inträffar.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-128">A geo-failover event occurs.</span></span> <span data-ttu-id="6c9e4-129">toocontinue, måste en uppdatera hello servernamnet och databasnamnet av Fragmentera kartan manager i hello programmet och sedan hello Fragmentera mappning information för alla delar i en Fragmentera karta.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="6c9e4-130">Om det finns en geo-redundans, bör sådana recovery logik automatiseras hello redundans arbetsflödet.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="6c9e4-131">Automatisera återställningsåtgärder aktiverar ett friktionsfritt hanterbarhet för geo-aktiverade databaser och undviker mänsklig manuella åtgärder.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="6c9e4-132">toolearn om alternativ toorecover en databas om ett avbrott för data center, se [företagskontinuitet](sql-database-business-continuity.md) och [Disaster Recovery](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="6c9e4-133">En Fragmentera eller hello ShardMapManager databasen är återställda tooan tidigare punkt i tiden.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="6c9e4-134">toolearn om punkten i tidsåterställningen med hjälp av säkerhetskopior, se [återställning med hjälp av säkerhetskopior](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="6c9e4-135">Mer information om Azure SQL Database elastisk Databasverktyg, geo-replikering och återställning finns i hello följande:</span><span class="sxs-lookup"><span data-stu-id="6c9e4-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="6c9e4-136">Översikt: Molnet business continuity och databasen katastrofåterställning med SQL-databas</span><span class="sxs-lookup"><span data-stu-id="6c9e4-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="6c9e4-137">Kom igång med elastiska Databasverktyg</span><span class="sxs-lookup"><span data-stu-id="6c9e4-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="6c9e4-138">Hantering av ShardMap</span><span class="sxs-lookup"><span data-stu-id="6c9e4-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="6c9e4-139">Hämtar RecoveryManager från en ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="6c9e4-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="6c9e4-140">hello första steget är toocreate en RecoveryManager-instans.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="6c9e4-141">Hej [GetRecoveryManager metoden](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returnerar hello recovery manager för hello aktuella [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instans.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="6c9e4-142">tooaddress eventuella inkonsekvenser i hello Fragmentera mappa, måste du först hämta hello RecoveryManager för hello viss Fragmentera kartan.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="6c9e4-143">I det här exemplet hello RecoveryManager har initierats från hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="6c9e4-144">Hej ShardMapManager som innehåller en ShardMap har också redan initierats.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="6c9e4-145">Eftersom den här programkod manipulerar hello Fragmentera kartan själva, hello autentiseringsuppgifter i hello fabriksmetoden (i föregående exempel hello smmConnectionString) ska vara autentiseringsuppgifter som har skrivskyddad behörighet på hello GSM databasen som refereras av hello anslutningssträng.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="6c9e4-146">Autentiseringsuppgifterna är vanligtvis skiljer sig från autentiseringsuppgifterna tooopen anslutningar för data-beroende routning.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="6c9e4-147">Mer information finns i [med autentiseringsuppgifter i hello elastisk databas klienten](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="6c9e4-148">Ta bort en Fragmentera från hello ShardMap efter en Fragmentera har tagits bort</span><span class="sxs-lookup"><span data-stu-id="6c9e4-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="6c9e4-149">Hej [DetachShard metoden](https://msdn.microsoft.com/library/azure/dn842083.aspx) tar bort hello får Fragmentera från hello Fragmentera kartan och tar bort mappningar som är associerade med hello Fragmentera.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="6c9e4-150">Hej platsparametern är hello Fragmentera plats, särskilt servernamnet och databasnamnet på hello Fragmentera som oberoende.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="6c9e4-151">Hej shardMapName parametern är hello Fragmentera mappningsnamn.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="6c9e4-152">Detta är endast krävs när flera Fragmentera maps hanteras av hello samma Fragmentera kartan manager.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="6c9e4-153">Valfri.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="6c9e4-154">Använd den här tekniken endast om du är säker på att hello-intervall för hello uppdateras mappningen är tom.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="6c9e4-155">Kontrollera hello metoderna ovan inte data för hello-intervall som ska flyttas, så det är bäst tooinclude kontrollerar i kod.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="6c9e4-156">Det här exemplet tar bort shards från hello Fragmentera kartan.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="6c9e4-157">hello Fragmentera karta visar hello Fragmentera plats i hello GSM före hello borttagningen av hello Fragmentera.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="6c9e4-158">Eftersom hello Fragmentera har tagits bort, förutsätts det var avsiktlig och hello horisontell partitionering viktiga intervallet är inte längre används.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="6c9e4-159">Om inte, kan du köra punkt i tidpunkt för återställning.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="6c9e4-160">toorecover hello Fragmentera från en tidigare punkt i tiden.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="6c9e4-161">(I så fall granska hello följande avsnitt toodetect Fragmentera inkonsekvenser.) toorecover, se [punkten i tidsåterställningen](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="6c9e4-162">Eftersom det förutsätts hello databasadministratörer att ta bort var avsiktlig hello slutliga administrativa Rensa åtgärden är toodelete hello post toohello Fragmentera i hello Fragmentera kartan manager.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="6c9e4-163">Detta förhindrar att hello program oavsiktligt skriver information tooa område som inte förväntas.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="6c9e4-164">toodetect mappning skillnader</span><span class="sxs-lookup"><span data-stu-id="6c9e4-164">toodetect mapping differences</span></span>
<span data-ttu-id="6c9e4-165">Hej [DetectMappingDifferences metoden](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) markerar och returnerar ett av hello Fragmentera maps (lokal eller global) som sanningen hello datakälla och synkroniserar mappningar på båda Fragmentera maps (GSM och LSM).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="6c9e4-166">Hej *plats* anger hello servernamnet och databasnamnet.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="6c9e4-167">Hej *shardMapName* parametern är hello Fragmentera mappningsnamn.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="6c9e4-168">Detta är endast krävs om flera Fragmentera maps hanteras av hello samma Fragmentera kartan manager.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="6c9e4-169">Valfri.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="6c9e4-170">tooresolve mappning skillnader</span><span class="sxs-lookup"><span data-stu-id="6c9e4-170">tooresolve mapping differences</span></span>
<span data-ttu-id="6c9e4-171">Hej [ResolveMappingDifferences metoden](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) väljer ett av hello Fragmentera maps (lokal eller global) som sanningen hello datakälla och synkroniserar mappningar på båda Fragmentera maps (GSM och LSM).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="6c9e4-172">Hej *RecoveryToken* parametern räknar hello skillnader i hello mappningar mellan hello GSM och hello LSM för hello specifika Fragmentera.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="6c9e4-173">Hej [MappingDifferenceResolution uppräkningen](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) är används tooindicate hello metod för att lösa hello skillnaden mellan hello Fragmentera mappningar.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="6c9e4-174">**MappingDifferenceResolution.KeepShardMapping** när hello LSM innehåller hello korrekt mappning och därför hello mappning i hello Fragmentera ska användas.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="6c9e4-175">Detta gäller vanligtvis hello om det finns en växling vid fel: hello Fragmentera finns nu på en ny server.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="6c9e4-176">Eftersom hello Fragmentera måste först tas bort från hello GSM (metoden hello RecoveryManager.DetachShard), finns inte längre en mappning på hello GSM.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="6c9e4-177">Hej LSM måste därför vara används toore-upprätta hello Fragmentera mappning.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="6c9e4-178">Koppla en Fragmentera toohello ShardMap när en Fragmentera har återställts</span><span class="sxs-lookup"><span data-stu-id="6c9e4-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="6c9e4-179">Hej [AttachShard metoden](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) bifogar hello angivna Fragmentera toohello Fragmentera kartan.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="6c9e4-180">Sedan identifierar inkonsekvenser Fragmentera kartan och uppdaterar hello mappningar toomatch hello Fragmentera hello punkt i hello Fragmentera återställningen.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="6c9e4-181">Det förutsätts att hello-databasen är också har bytt namn till tooreflect hello ursprungliga databasnamnet (innan hello Fragmentera återställdes), eftersom hello punkt i tiden återställningen som standard tooa ny databas läggas till med hello tidsstämpel.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="6c9e4-182">Hej *plats* parametern är hello servernamnet och databasnamnet på hello Fragmentera som kopplas.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="6c9e4-183">Hej *shardMapName* parametern är hello Fragmentera mappningsnamn.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="6c9e4-184">Detta är endast krävs när flera Fragmentera maps hanteras av hello samma Fragmentera kartan manager.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="6c9e4-185">Valfri.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-185">Optional.</span></span> 

<span data-ttu-id="6c9e4-186">Det här exemplet lägger till en Fragmentera toohello Fragmentera karta som nyligen har återställts från en tidigare punkt i tiden.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="6c9e4-187">Eftersom hello Fragmentera (dvs hello mappning för hello Fragmentera i hello LSM) har återställts, är det eventuellt inkonsekvent med hello Fragmentera post i hello GSM.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="6c9e4-188">Utanför den här exempelkoden hello Fragmentera har återställts och byta namn på toohello ursprungliga namnet på hello-databasen.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="6c9e4-189">Eftersom den har återställts, förutsätts hello mappning i hello LSM finns hello betrodda mappning.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="6c9e4-190">Uppdatera Fragmentera platser efter en geo-redundans (återställa) för hello shards</span><span class="sxs-lookup"><span data-stu-id="6c9e4-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="6c9e4-191">Om det finns en geo-redundans, hello sekundära databasen är åtkomlig skriva och blir hello nya primära databasen.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="6c9e4-192">Hej namnet hello server och potentiellt hello-databasen (beroende på din konfiguration), kan skilja sig från hello ursprungliga primära servern.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="6c9e4-193">Därför hello avbildningar för hello Fragmentera i hello GSM och LSM måste åtgärdas.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="6c9e4-194">På liknande sätt, om hello databasen är återställda tooa annat namn eller plats eller tooan tidigare tidpunkt, detta kan orsaka inkonsekvenser i hello Fragmentera maps.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="6c9e4-195">hello Fragmentera kartan Manager hanterar hello distribution av öppna anslutningar toohello rätt databas.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="6c9e4-196">Distribution baseras på hello data i hello Fragmentera kartan och hello värdet för hello horisontell partitionering nyckel som är hello mål för hello program begäran.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="6c9e4-197">Efter en geo-redundans, måste den här informationen uppdateras med hello korrekt servernamnet, databasnamnet och Fragmentera mappningen av hello återställda databasen.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="6c9e4-198">Bästa praxis</span><span class="sxs-lookup"><span data-stu-id="6c9e4-198">Best practices</span></span>
<span data-ttu-id="6c9e4-199">GEO-redundans och återställning är åtgärder som vanligtvis hanteras av en administratör molnet för hello-program som använder en Azure SQL-databaser funktionerna för verksamhetskontinuitet avsiktligt.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="6c9e4-200">Kontinuitet planering kräver processer och procedurer åtgärder tooensure verksamheten kan fortsätta utan avbrott.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="6c9e4-201">Hej metoder tillgängliga som en del av hello RecoveryManager klass som ska användas i den här arbete flödet tooensure hello GSM och LSM hålls uppdaterade baserat på hello recovery åtgärd.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="6c9e4-202">Det finns fem grundläggande steg tooproperly säkerställt hello GSM och LSM återspeglar hello korrekt information efter en redundansväxling.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="6c9e4-203">Hej programmet kod tooexecute de här stegen kan integreras i befintliga verktyg och arbetsflöde.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="6c9e4-204">Hämta hello RecoveryManager från hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="6c9e4-205">Koppla bort hello gamla Fragmentera från hello Fragmentera mappningen.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="6c9e4-206">Koppla hello nya Fragmentera toohello Fragmentera karta, inklusive hello ny Fragmentera plats.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="6c9e4-207">Identifiera inkonsekvenser i hello mappning mellan hello GSM och LSM.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="6c9e4-208">Lösa skillnader mellan hello GSM och hello LSM, betrodda hello LSM.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="6c9e4-209">Det här exemplet utför hello följande steg:</span><span class="sxs-lookup"><span data-stu-id="6c9e4-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="6c9e4-210">Tar bort shards från hello Fragmentera karta som avspeglar Fragmentera platser innan hello redundansväxlingen.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="6c9e4-211">Bifogar shards toohello Fragmentera kartan reflekterande hello nya Fragmentera platser (hello parametern ”Configuration.SecondaryServer” är hello-serverns nya namn men hello samma databasnamn).</span><span class="sxs-lookup"><span data-stu-id="6c9e4-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="6c9e4-212">Hämtar hello recovery token med hjälp av mappning skillnader mellan hello GSM och hello LSM för varje Fragmentera.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="6c9e4-213">Löser hello inkonsekvenser av betrodda hello-mappning från hello LSM för varje Fragmentera.</span><span class="sxs-lookup"><span data-stu-id="6c9e4-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

