---
title: "aaaUsing klientbibliotek för elastisk databas med Entity Framework | Microsoft Docs"
description: "Använd klientbibliotek för elastisk databas och Entity Framework för att koda databaser"
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: b9c3065b-cb92-41be-aa7f-deba23e7e159
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/06/2017
ms.author: torsteng
ms.openlocfilehash: 917f6d28d9855c0b42afe2c008613a9bbb3ec6b6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="elastic-database-client-library-with-entity-framework"></a><span data-ttu-id="9e1eb-103">Klientbibliotek för elastisk databas med Entity Framework</span><span class="sxs-lookup"><span data-stu-id="9e1eb-103">Elastic Database client library with Entity Framework</span></span>
<span data-ttu-id="9e1eb-104">Det här dokumentet visar hello ändringar i ett Entity Framework-program som är nödvändiga toointegrate med hello [elastisk Databasverktyg](sql-database-elastic-scale-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-104">This document shows hello changes in an Entity Framework application that are needed toointegrate with hello [Elastic Database tools](sql-database-elastic-scale-introduction.md).</span></span> <span data-ttu-id="9e1eb-105">hello fokus ligger på fastställdes [Fragmentera kartan management](sql-database-elastic-scale-shard-map-management.md) och [data beroende routning](sql-database-elastic-scale-data-dependent-routing.md) med hello Entity Framework **Code First** metod.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-105">hello focus is on composing [shard map management](sql-database-elastic-scale-shard-map-management.md) and [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md) with hello Entity Framework **Code First** approach.</span></span> <span data-ttu-id="9e1eb-106">Hej [Code först - ny databas](http://msdn.microsoft.com/data/jj193542.aspx) självstudier för EF fungerar som exemplet körs i hela dokumentet.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-106">hello [Code First - New Database](http://msdn.microsoft.com/data/jj193542.aspx) tutorial for EF serves as our running example throughout this document.</span></span> <span data-ttu-id="9e1eb-107">hello exempelkod som åtföljer det här dokumentet är en del av verktygen för elastisk databas uppsättning exempel i hello Visual Studio-kodexempel.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-107">hello sample code accompanying this document is part of elastic database tools' set of samples in hello Visual Studio Code Samples.</span></span>

## <a name="downloading-and-running-hello-sample-code"></a><span data-ttu-id="9e1eb-108">Hämta och kör hello exempelkod</span><span class="sxs-lookup"><span data-stu-id="9e1eb-108">Downloading and Running hello Sample Code</span></span>
<span data-ttu-id="9e1eb-109">toodownload hello koden för den här artikeln:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-109">toodownload hello code for this article:</span></span>

* <span data-ttu-id="9e1eb-110">Visual Studio 2012 eller senare krävs.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-110">Visual Studio 2012 or later is required.</span></span> 
* <span data-ttu-id="9e1eb-111">Hämta hello [elastisk DB-verktyg för Azure SQL - Entity Framework-integrering exempel](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) på MSDN.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-111">Download hello [Elastic DB Tools for Azure SQL - Entity Framework Integration sample](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) from MSDN.</span></span> <span data-ttu-id="9e1eb-112">Packa upp hello exempel tooa plats.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-112">Unzip hello sample tooa location of your choosing.</span></span>
* <span data-ttu-id="9e1eb-113">Starta Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-113">Start Visual Studio.</span></span> 
* <span data-ttu-id="9e1eb-114">Välj Arkiv -> Öppna projekt/lösning i Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-114">In Visual Studio, select File -> Open Project/Solution.</span></span> 
* <span data-ttu-id="9e1eb-115">I hello **öppna projekt** dialogrutan navigera toohello exempel som du hämtade och markera **EntityFrameworkCodeFirst.sln** tooopen hello exempel.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-115">In hello **Open Project** dialog, navigate toohello sample you downloaded and select **EntityFrameworkCodeFirst.sln** tooopen hello sample.</span></span> 

<span data-ttu-id="9e1eb-116">toorun hello exemplet behöver du toocreate tre tomma databaser i Azure SQL Database:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-116">toorun hello sample, you need toocreate three empty databases in Azure SQL Database:</span></span>

* <span data-ttu-id="9e1eb-117">Fragmentera kartan Manager-databasen</span><span class="sxs-lookup"><span data-stu-id="9e1eb-117">Shard Map Manager database</span></span>
* <span data-ttu-id="9e1eb-118">Fragmentera 1-databasen</span><span class="sxs-lookup"><span data-stu-id="9e1eb-118">Shard 1 database</span></span>
* <span data-ttu-id="9e1eb-119">Fragmentera 2-databas</span><span class="sxs-lookup"><span data-stu-id="9e1eb-119">Shard 2 database</span></span>

<span data-ttu-id="9e1eb-120">När du har skapat dessa databaser, Fyll i hello platshållare i **Program.cs** med din Azure SQL DB-servernamn, databasnamn hello och dina autentiseringsuppgifter tooconnect toohello databaser.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-120">Once you have created these databases, fill in hello place holders in **Program.cs** with your Azure SQL DB server name, hello database names and your credentials tooconnect toohello databases.</span></span> <span data-ttu-id="9e1eb-121">Skapa hello lösning i Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-121">Build hello solution in Visual Studio.</span></span> <span data-ttu-id="9e1eb-122">Visual Studio hämtar hello krävs NuGet-paket för hello klientbibliotek för elastisk databas, Entity Framework och hantering som en del av hello build-tillfälligt fel.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-122">Visual Studio will download hello required NuGet packages for hello elastic database client library, Entity Framework, and Transient Fault handling as part of hello build process.</span></span> <span data-ttu-id="9e1eb-123">Se till att återställa NuGet-paket har aktiverats för din lösning.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-123">Make sure that restoring NuGet packages is enabled for your solution.</span></span> <span data-ttu-id="9e1eb-124">Du kan aktivera den här inställningen genom att högerklicka på hello lösningsfilen i hello Visual Studio Solution Explorer.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-124">You can enable this setting by right-clicking on hello solution file in hello Visual Studio Solution Explorer.</span></span> 

## <a name="entity-framework-workflows"></a><span data-ttu-id="9e1eb-125">Entity Framework-arbetsflöden</span><span class="sxs-lookup"><span data-stu-id="9e1eb-125">Entity Framework workflows</span></span>
<span data-ttu-id="9e1eb-126">Entity Framework utvecklare förlitar sig på något av följande fyra arbetsflöden toobuild program och tooensure persistence för programobjekt hello:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-126">Entity Framework developers rely on one of hello following four workflows toobuild applications and tooensure persistence for application objects:</span></span> 

* <span data-ttu-id="9e1eb-127">**Code första (ny databas)**: hello EF utvecklare skapar hello modellen i hello programkod och sedan EF genererar hello databasen från den.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-127">**Code First (New Database)**: hello EF developer creates hello model in hello application code and then EF generates hello database from it.</span></span> 
* <span data-ttu-id="9e1eb-128">**Code första (befintlig databas)**: hello utvecklare kan EF generera hello programkod för hello modellen från en befintlig databas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-128">**Code First (Existing Database)**: hello developer lets EF generate hello application code for hello model from an existing database.</span></span>
* <span data-ttu-id="9e1eb-129">**Modellen första**: hello utvecklare skapar hello modellen i hello EF designer och EF skapar sedan hello databasen från hello modell.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-129">**Model First**: hello developer creates hello model in hello EF designer and then EF creates hello database from hello model.</span></span>
* <span data-ttu-id="9e1eb-130">**Databasen första**: hello utvecklare använder EF tooling tooinfer hello modellen från en befintlig databas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-130">**Database First**: hello developer uses EF tooling tooinfer hello model from an existing database.</span></span> 

<span data-ttu-id="9e1eb-131">Alla dessa metoder är beroende av hello DbContext-klassen tootransparently hantera anslutningar och databasschemat för ett program.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-131">All these approaches rely on hello DbContext class tootransparently manage database connections and database schema for an application.</span></span> <span data-ttu-id="9e1eb-132">Som diskuteras i detalj senare i hello dokumentet olika konstruktorer i hello DbContext-basklassen Tillåt för olika nivåer av kontroll över anslutningen Skapa databas startprogram och schemat skapas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-132">As we will discuss in more detail later in hello document, different constructors on hello DbContext base class allow for different levels of control over connection creation, database bootstrapping and schema creation.</span></span> <span data-ttu-id="9e1eb-133">Utmaningar uppkommer främst hello fakta som tillhandahålls av EF hello-anslutning databashantering hello anslutning hanteringsfunktioner hello beroende routning av gränssnitt för data som anges av hello klientbibliotek för elastisk databas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-133">Challenges arise primarily from hello fact that hello database connection management provided by EF intersects with hello connection management capabilities of hello data dependent routing interfaces provided by hello elastic database client library.</span></span> 

## <a name="elastic-database-tools-assumptions"></a><span data-ttu-id="9e1eb-134">Förutsättningar för verktyg för elastisk databas</span><span class="sxs-lookup"><span data-stu-id="9e1eb-134">Elastic database tools assumptions</span></span>
<span data-ttu-id="9e1eb-135">Termdefinitioner finns [elastisk databas verktyg ordlista](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-135">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span>

<span data-ttu-id="9e1eb-136">Med klientbibliotek för elastisk databas, kan du definiera partitioner för dina programdata som kallas shardlets.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-136">With elastic database client library, you define partitions of your application data called shardlets.</span></span> <span data-ttu-id="9e1eb-137">Shardlets identifieras med en nyckel för horisontell partitionering och mappade toospecific databaser.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-137">Shardlets are identified by a sharding key and are mapped toospecific databases.</span></span> <span data-ttu-id="9e1eb-138">Ett program kan ha valfritt antal databaser efter behov och distribuera hello shardlets tooprovide tillräckligt med kapacitet eller prestanda angivna aktuella affärsbehov.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-138">An application may have as many databases as needed and distribute hello shardlets tooprovide enough capacity or performance given current business requirements.</span></span> <span data-ttu-id="9e1eb-139">hello-mappningen för horisontell partitionering nyckelvärden toohello databaser lagras av en Fragmentera karta som tillhandahålls av hello elastisk databas-klientens API: er.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-139">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello elastic database client APIs.</span></span> <span data-ttu-id="9e1eb-140">Den här funktionen kallas **Fragmentera kartan Management**, eller SMM för kort.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-140">We call this capability **Shard Map Management**, or SMM for short.</span></span> <span data-ttu-id="9e1eb-141">hello Fragmentera kartan fungerar också som hello broker till databaser för begäranden som innehåller en nyckel för horisontell partitionering.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-141">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="9e1eb-142">Vi refererar toothis kapaciteten som **data beroende routning**.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-142">We refer toothis capability as **data-dependent routing**.</span></span> 

<span data-ttu-id="9e1eb-143">hello Fragmentera kartan manager skyddar användare från inkonsekvent vyer i shardlet data som kan uppstå när samtidiga shardlet hanteringsåtgärder (till exempel omlokalisering data från en Fragmentera tooanother) sker.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-143">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations (such as relocating data from one shard tooanother) are happening.</span></span> <span data-ttu-id="9e1eb-144">toodo hello så Fragmentera maps hanteras av hello biblioteket broker hello databasen klientanslutningar för ett program.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-144">toodo so, hello shard maps managed by hello client library broker hello database connections for an application.</span></span> <span data-ttu-id="9e1eb-145">Detta tillåter hello Fragmentera kartan funktioner tooautomatically kill en databasanslutning när Fragmentera hanteringsåtgärder kan påverka hello shardlet som hello anslutningen har skapats för.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-145">This allows hello shard map functionality tooautomatically kill a database connection when shard management operations could impact hello shardlet that hello connection has been created for.</span></span> <span data-ttu-id="9e1eb-146">Den här metoden måste toointegrate med några av EFS funktioner, till exempel skapa nya anslutningar från en befintlig en toocheck för databasen.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-146">This approach needs toointegrate with some of EF’s functionality, such as creating new connections from an existing one toocheck for database existence.</span></span> <span data-ttu-id="9e1eb-147">I allmänhet våra observationer har att hello standard DbContext-konstruktorer bara fungerar på ett tillförlitligt sätt för stängd databasanslutningar som kan klonas på ett säkert sätt för EF arbete.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-147">In general, our observation has been that hello standard DbContext constructors only work reliably for closed database connections that can safely be cloned for EF work.</span></span> <span data-ttu-id="9e1eb-148">hello design principen för elastisk databas är i stället tooonly broker öppna anslutningar.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-148">hello design principle of elastic database instead is tooonly broker opened connections.</span></span> <span data-ttu-id="9e1eb-149">En tror att stänga en anslutning som asynkrona av hello klientbiblioteket innan överlämnande toohello EF DbContext kan lösa problemet.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-149">One might think that closing a connection brokered by hello client library before handing it over toohello EF DbContext may solve this issue.</span></span> <span data-ttu-id="9e1eb-150">Genom att stänga hello anslutning och förlita dig på EF toore öppna det, kan en dock foregoes hello validering och konsekvens kontroller som utförs av hello-biblioteket.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-150">However, by closing hello connection and relying on EF toore-open it, one foregoes hello validation and consistency checks performed by hello library.</span></span> <span data-ttu-id="9e1eb-151">hello migreringar funktioner i EF, men använder dessa anslutningar toomanage hello underliggande databasschemat på ett sätt som är transparent toohello program.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-151">hello migrations functionality in EF, however, uses these connections toomanage hello underlying database schema in a way that is transparent toohello application.</span></span> <span data-ttu-id="9e1eb-152">Vi rekommenderar vi skulle som tooretain och kombinera alla dessa funktioner från både hello klientbibliotek för elastisk databas och EF i hello samma program.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-152">Ideally, we would like tooretain and combine all these capabilities from both hello elastic database client library and EF in hello same application.</span></span> <span data-ttu-id="9e1eb-153">hello beskrivs följande avsnitt de här egenskaperna och kraven i detalj.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-153">hello following section discusses these properties and requirements in more detail.</span></span> 

## <a name="requirements"></a><span data-ttu-id="9e1eb-154">Krav</span><span class="sxs-lookup"><span data-stu-id="9e1eb-154">Requirements</span></span>
<span data-ttu-id="9e1eb-155">När du arbetar med både hello klientbibliotek för elastisk databas och Entity Framework-API: er kan vill vi tooretain hello följande egenskaper:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-155">When working with both hello elastic database client library and Entity Framework APIs, we want tooretain hello following properties:</span></span> 

* <span data-ttu-id="9e1eb-156">**Skalbar**: tooadd eller ta bort databaser från hello datanivå hello delat tillämpas efter behov för hello kapacitetskraven hello program.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-156">**Scale-out**: tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> <span data-ttu-id="9e1eb-157">Det innebär att kontroll över hello hello skapas eller tas bort av databaser och använder hello elastisk databas Fragmentera kartan manager API: er toomanage databaser och mappningar av shardlets.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-157">This means control over hello hello creation and deletion of databases and using hello elastic database shard map manager APIs toomanage databases, and mappings of shardlets.</span></span> 
* <span data-ttu-id="9e1eb-158">**Konsekvenskontroll**: hello program använder horisontell partitionering och använder hello data beroende funktioner för hello klientbiblioteket.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-158">**Consistency**: hello application employs sharding, and uses hello data dependent routing capabilities of hello client library.</span></span> <span data-ttu-id="9e1eb-159">tooavoid skadas eller fel frågeresultat anslutningar är asynkrona via hello Fragmentera kartan manager.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-159">tooavoid corruption or wrong query results, connections are brokered through hello shard map manager.</span></span> <span data-ttu-id="9e1eb-160">Detta bevarar validering och konsekvens.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-160">This also retains validation and consistency.</span></span>
* <span data-ttu-id="9e1eb-161">**Code första**: tooretain hello lättare EFS kod första paradigmet.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-161">**Code First**: tooretain hello convenience of EF’s code first paradigm.</span></span> <span data-ttu-id="9e1eb-162">I den första koden mappas klasser i programmet hello transparent toohello underliggande databasstrukturer.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-162">In Code First, classes in hello application are mapped transparently toohello underlying database structures.</span></span> <span data-ttu-id="9e1eb-163">hello programkod samverkar med DbSets som maskerar de flesta aspekter hello underliggande databasen bearbetas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-163">hello application code interacts with DbSets that mask most aspects involved in hello underlying database processing.</span></span>
* <span data-ttu-id="9e1eb-164">**Schemat**: Entity Framework hanterar inledande databasen schemat skapas och efterföljande schemat utvecklingen via migreringar.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-164">**Schema**: Entity Framework handles initial database schema creation and subsequent schema evolution through migrations.</span></span> <span data-ttu-id="9e1eb-165">Behålla dessa funktioner är det enkelt som hello data utvecklas att anpassa din app.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-165">By retaining these capabilities, adapting your app is easy as hello data evolves.</span></span> 

<span data-ttu-id="9e1eb-166">hello följande riktlinjer anger hur toosatisfy kraven för Code First program med elastiska Databasverktyg.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-166">hello following guidance instructs how toosatisfy these requirements for Code First applications using elastic database tools.</span></span> 

## <a name="data-dependent-routing-using-ef-dbcontext"></a><span data-ttu-id="9e1eb-167">Data beroende routning med EF DbContext</span><span class="sxs-lookup"><span data-stu-id="9e1eb-167">Data dependent routing using EF DbContext</span></span>
<span data-ttu-id="9e1eb-168">Databasanslutningar med Entity Framework vanligtvis hanteras via underklasser för **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-168">Database connections with Entity Framework are typically managed through subclasses of **DbContext**.</span></span> <span data-ttu-id="9e1eb-169">Skapa dessa underklasser som härleds från **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-169">Create these subclasses by deriving from **DbContext**.</span></span> <span data-ttu-id="9e1eb-170">Är där du definierar din **DbSets** som implementerar hello databasen har säkerhetskopierats samlingar av CLR-objekt för tillämpningsprogrammet.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-170">This is where you define your **DbSets** that implement hello database-backed collections of CLR objects for your application.</span></span> <span data-ttu-id="9e1eb-171">Vi kan identifiera flera användbara egenskaper som inte nödvändigtvis har för andra EF code första Programscenarier hello gäller data beroende routning är:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-171">In hello context of data dependent routing, we can identify several helpful properties that do not necessarily hold for other EF code first application scenarios:</span></span> 

* <span data-ttu-id="9e1eb-172">hello databas redan finns och har registrerats i hello elastisk databas Fragmentera kartan.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-172">hello database already exists and has been registered in hello elastic database shard map.</span></span> 
* <span data-ttu-id="9e1eb-173">hello schemat för programmet hello redan distribuerade toohello databasen (beskrivs nedan).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-173">hello schema of hello application has already been deployed toohello database (explained below).</span></span> 
* <span data-ttu-id="9e1eb-174">Data dependent routning anslutningar toohello databasen asynkrona hello Fragmentera Map.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-174">Data-dependent routing connections toohello database are brokered by hello shard map.</span></span> 

<span data-ttu-id="9e1eb-175">toointegrate **DbContexts** med data beroende routning för skalbar:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-175">toointegrate **DbContexts** with data-dependent routing for scale-out:</span></span>

1. <span data-ttu-id="9e1eb-176">Skapa fysiska databasanslutningar via hello elastisk Databasgränssnitt hello Fragmentera kartan manager</span><span class="sxs-lookup"><span data-stu-id="9e1eb-176">Create physical database connections through hello elastic database client interfaces of hello shard map manager,</span></span> 
2. <span data-ttu-id="9e1eb-177">Omsluta hello anslutning med hello **DbContext** underklass</span><span class="sxs-lookup"><span data-stu-id="9e1eb-177">Wrap hello connection with hello **DbContext** subclass</span></span>
3. <span data-ttu-id="9e1eb-178">Skicka hello anslutningen till hello **DbContext** basera klasser tooensure all hello bearbetning på hello EF sida samt händer.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-178">Pass hello connection down into hello **DbContext** base classes tooensure all hello processing on hello EF side happens as well.</span></span> 

<span data-ttu-id="9e1eb-179">hello följande kodexempel illustrerar den här metoden.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-179">hello following code example illustrates this approach.</span></span> <span data-ttu-id="9e1eb-180">(Den här koden är också i hello tillhörande Visual Studio-projekt)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-180">(This code is also in hello accompanying Visual Studio project)</span></span>

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed toohello proper shard by hello shard map manager. 
        // Note that hello base class c'tor call will fail for an open connection
        // if migrations need toobe done and SQL credentials are used. This is hello reason for hello 
        // separation of c'tors into hello data-dependent routing case (this c'tor) and hello internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map toobroker a validated connection for hello given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a><span data-ttu-id="9e1eb-181">Huvudpunkter</span><span class="sxs-lookup"><span data-stu-id="9e1eb-181">Main points</span></span>
* <span data-ttu-id="9e1eb-182">En ny konstruktor ersätter hello standardkonstruktor i hello DbContext underklass</span><span class="sxs-lookup"><span data-stu-id="9e1eb-182">A new constructor replaces hello default constructor in hello DbContext subclass</span></span> 
* <span data-ttu-id="9e1eb-183">nya hello-konstruktorn har hello-argument som krävs för data beroende Routning via klientbibliotek för elastisk databas:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-183">hello new constructor takes hello arguments that are required for data dependent routing through elastic database client library:</span></span>
  
  * <span data-ttu-id="9e1eb-184">hello Fragmentera kartan tooaccess hello data beroende routning gränssnitt,</span><span class="sxs-lookup"><span data-stu-id="9e1eb-184">hello shard map tooaccess hello data-dependent routing interfaces,</span></span>
  * <span data-ttu-id="9e1eb-185">hello horisontell partitionering viktiga tooidentify hello shardlet</span><span class="sxs-lookup"><span data-stu-id="9e1eb-185">hello sharding key tooidentify hello shardlet,</span></span>
  * <span data-ttu-id="9e1eb-186">en anslutningssträng med hello autentiseringsuppgifter för hello data beroende routning anslutning toohello Fragmentera.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-186">a connection string with hello credentials for hello data-dependent routing connection toohello shard.</span></span> 
* <span data-ttu-id="9e1eb-187">hello anropet toohello basklass konstruktorn tar en detour i en statisk metod som utför alla hello steg krävs för data-beroende routning.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-187">hello call toohello base class constructor takes a detour into a static method that performs all hello steps necessary for data-dependent routing.</span></span> 
  
  * <span data-ttu-id="9e1eb-188">Den använder hello OpenConnectionForKey anrop av hello elastisk Databasgränssnitt på hello Fragmentera kartan tooestablish en öppen anslutning.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-188">It uses hello OpenConnectionForKey call of hello elastic database client interfaces on hello shard map tooestablish an open connection.</span></span>
  * <span data-ttu-id="9e1eb-189">hello Fragmentera kartan skapar hello öppen anslutning toohello Fragmentera som innehåller hello shardlet för hello angivna horisontell partitionering nyckel.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-189">hello shard map creates hello open connection toohello shard that holds hello shardlet for hello given sharding key.</span></span>
  * <span data-ttu-id="9e1eb-190">Öppna anslutningen skickas tillbaka toohello basklass konstruktorn för DbContext tooindicate att den här anslutningen är toobe som används av EF i stället för att låta EF automatiskt skapa en ny anslutning.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-190">This open connection is passed back toohello base class constructor of DbContext tooindicate that this connection is toobe used by EF instead of letting EF create a new connection automatically.</span></span> <span data-ttu-id="9e1eb-191">Det här sättet hello-anslutning har taggats av hello elastisk databas klienten API så att den kan garantera konsekvens under Fragmentera kartan hanteringsåtgärder.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-191">This way hello connection has been tagged by hello elastic database client API so that it can guarantee consistency under shard map management operations.</span></span>

<span data-ttu-id="9e1eb-192">Använd hello nya konstruktor för DbContext-underklass i stället för hello standardkonstruktor i koden.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-192">Use hello new constructor for your DbContext subclass instead of hello default constructor in your code.</span></span> <span data-ttu-id="9e1eb-193">Här är ett exempel:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-193">Here is an example:</span></span> 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

<span data-ttu-id="9e1eb-194">hello nya konstruktorn öppnar hello anslutning toohello Fragmentera som lagrar hello data för hello shardlet identifieras av hello värdet för **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-194">hello new constructor opens hello connection toohello shard that holds hello data for hello shardlet identified by hello value of **tenantid1**.</span></span> <span data-ttu-id="9e1eb-195">Hej koden i hello **med** block förblir oförändrad tooaccess hello **DbSet** för bloggar med EF på hello Fragmentera för **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-195">hello code in hello **using** block stays unchanged tooaccess hello **DbSet** for blogs using EF on hello shard for **tenantid1**.</span></span> <span data-ttu-id="9e1eb-196">Detta ändrar semantik för hello koden i hello med block så att alla databasåtgärder nu omfång toohello en Fragmentera där **tenantid1** sparas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-196">This changes semantics for hello code in hello using block such that all database operations are now scoped toohello one shard where **tenantid1** is kept.</span></span> <span data-ttu-id="9e1eb-197">Till exempel en LINQ-fråga över hello bloggar **DbSet** skulle bara returnera bloggar som lagras på hello aktuella Fragmentera, men inte hello de som lagras på andra delar.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-197">For instance, a LINQ query over hello blogs **DbSet** would only return blogs stored on hello current shard, but not hello ones stored on other shards.</span></span>  

#### <a name="transient-faults-handling"></a><span data-ttu-id="9e1eb-198">Tillfälliga problem hantering</span><span class="sxs-lookup"><span data-stu-id="9e1eb-198">Transient faults handling</span></span>
<span data-ttu-id="9e1eb-199">hello Microsoft Patterns & praxis gruppmedlemmarna publicerade hello [hello tillfälliga fel hanterar programmet Block](https://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-199">hello Microsoft Patterns & Practices team published hello [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span></span> <span data-ttu-id="9e1eb-200">hello biblioteket används med elastisk skalbarhet klientbiblioteket i kombination med EF.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-200">hello library is used with elastic scale client library in combination with EF.</span></span> <span data-ttu-id="9e1eb-201">Se dock till att alla tillfälligt undantag returnerar tooa plats där vi kan se till att nya hello-konstruktor som används efter ett tillfälligt fel så att alla nya anslutningsförsök görs med hjälp av hello-konstruktorer som vi har tweaked.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-201">However, ensure that any transient exception returns tooa place where we can ensure that hello new constructor is being used after a transient fault so that any new connection attempt is made using hello constructors we have tweaked.</span></span> <span data-ttu-id="9e1eb-202">En anslutning toohello korrekt Fragmentera inte är säkert och det finns inga garantier hello anslutning underhålls annars som ändringarna toohello Fragmentera karta visas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-202">Otherwise, a connection toohello correct shard is not guaranteed, and there are no assurances hello connection is maintained as changes toohello shard map occur.</span></span> 

<span data-ttu-id="9e1eb-203">hello följande kodexempel illustrerar hur en SQL-återförsöksprincip kan användas runt hello nya **DbContext** underklasskonstruktorer:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-203">hello following code sample illustrates how a SQL retry policy can be used around hello new **DbContext** subclass constructors:</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

<span data-ttu-id="9e1eb-204">**SqlDatabaseUtils.SqlRetryPolicy** i hello koden ovan har definierats som en **SqlDatabaseTransientErrorDetectionStrategy** med ett återförsöksvärde på 10 och 5 sekunder väntetid mellan återförsök.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="9e1eb-205">Den här metoden är liknande toohello vägledning för EF och användarinitierad transaktioner (se [begränsningar med du försöker köra strategier (och senare EF6)](http://msdn.microsoft.com/data/dn307226).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-205">This approach is similar toohello guidance for EF and user-initiated transactions (see [Limitations with Retrying Execution Strategies (EF6 onwards)](http://msdn.microsoft.com/data/dn307226).</span></span> <span data-ttu-id="9e1eb-206">Båda situationer kräver att programmet hello styr hello scope toowhich hello tillfälligt undantag returnerar: tooeither öppna hello transaktion eller återskapa hello kontext från hello rätt konstruktor som använder hello elastisk databas (som visas) klientbiblioteket.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-206">Both situations require that hello application program controls hello scope toowhich hello transient exception returns: tooeither reopen hello transaction, or (as shown) recreate hello context from hello proper constructor that uses hello elastic database client library.</span></span>

<span data-ttu-id="9e1eb-207">hello måste toocontrol där tillfälligt undantag ta oss tillbaka i omfånget utesluter också hello användning av hello inbyggda **SqlAzureExecutionStrategy** som medföljer EF.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-207">hello need toocontrol where transient exceptions take us back in scope also precludes hello use of hello built-in **SqlAzureExecutionStrategy** that comes with EF.</span></span> <span data-ttu-id="9e1eb-208">**SqlAzureExecutionStrategy** skulle öppna en anslutning utan att använda **OpenConnectionForKey** och därför kringgå alla hello-verifieringen som utförs som en del av hello **OpenConnectionForKey** anropa.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-208">**SqlAzureExecutionStrategy** would reopen a connection but not use **OpenConnectionForKey** and therefore bypass all hello validation that is performed as part of hello **OpenConnectionForKey** call.</span></span> <span data-ttu-id="9e1eb-209">Hello kodexempel används i stället hello inbyggda **DefaultExecutionStrategy** som medföljer också EF.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-209">Instead, hello code sample uses hello built-in **DefaultExecutionStrategy** that also comes with EF.</span></span> <span data-ttu-id="9e1eb-210">I motsats för**SqlAzureExecutionStrategy**, den fungerar korrekt i kombination med hello återförsöksprincip tillfälliga fel hanterar.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-210">As opposed too**SqlAzureExecutionStrategy**, it works correctly in combination with hello retry policy from Transient Fault Handling.</span></span> <span data-ttu-id="9e1eb-211">hello körningsprincipen är inställd i hello **ElasticScaleDbConfiguration** klass.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-211">hello execution policy is set in hello **ElasticScaleDbConfiguration** class.</span></span> <span data-ttu-id="9e1eb-212">Observera att vi valt inte toouse **DefaultSqlExecutionStrategy** eftersom föreslås toouse **SqlAzureExecutionStrategy** om tillfälligt undantag inträffar - som skulle leda toowrong beteende enligt beskrivningen.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-212">Note that we decided not toouse **DefaultSqlExecutionStrategy** since it suggests toouse **SqlAzureExecutionStrategy** if transient exceptions occur - which would lead toowrong behavior as discussed.</span></span> <span data-ttu-id="9e1eb-213">Mer information om hello annan retry principer och EF finns [Connection Resiliency i EF](http://msdn.microsoft.com/data/dn456835.aspx).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-213">For more information on hello different retry policies and EF, see [Connection Resiliency in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span></span>     

#### <a name="constructor-rewrites"></a><span data-ttu-id="9e1eb-214">Konstruktorn omskrivningar</span><span class="sxs-lookup"><span data-stu-id="9e1eb-214">Constructor rewrites</span></span>
<span data-ttu-id="9e1eb-215">hello kodexemplen ovan visar hello standard konstruktorn skriver krävs för ditt program i ordning toouse data beroende routning med hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-215">hello code examples above illustrate hello default constructor re-writes required for your application in order toouse  data dependent routing with hello Entity Framework.</span></span> <span data-ttu-id="9e1eb-216">den här metoden tooother konstruktorer är en generalisering hello i den följande tabellen.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-216">hello following table generalizes this approach tooother constructors.</span></span> 

| <span data-ttu-id="9e1eb-217">Aktuella konstruktor</span><span class="sxs-lookup"><span data-stu-id="9e1eb-217">Current Constructor</span></span> | <span data-ttu-id="9e1eb-218">Omskrivet konstruktor för data</span><span class="sxs-lookup"><span data-stu-id="9e1eb-218">Rewritten Constructor for data</span></span> | <span data-ttu-id="9e1eb-219">Grundläggande konstruktor</span><span class="sxs-lookup"><span data-stu-id="9e1eb-219">Base Constructor</span></span> | <span data-ttu-id="9e1eb-220">Anteckningar</span><span class="sxs-lookup"><span data-stu-id="9e1eb-220">Notes</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="9e1eb-221">MyContext()</span><span class="sxs-lookup"><span data-stu-id="9e1eb-221">MyContext()</span></span> |<span data-ttu-id="9e1eb-222">ElasticScaleContext (ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-222">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="9e1eb-223">DbContext (DbConnection bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-223">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="9e1eb-224">hello anslutningen behöver toobe en funktion av hello Fragmentera karta och hello data beroende routning nyckel.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-224">hello connection needs toobe a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="9e1eb-225">Du behöver tooby pass automatisk anslutning skapande av EF och i stället använda hello Fragmentera kartan toobroker hello anslutning.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-225">You need tooby-pass automatic connection creation by EF and instead use hello shard map toobroker hello connection.</span></span> |
| <span data-ttu-id="9e1eb-226">MyContext(string)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-226">MyContext(string)</span></span> |<span data-ttu-id="9e1eb-227">ElasticScaleContext (ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-227">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="9e1eb-228">DbContext (DbConnection bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-228">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="9e1eb-229">hello anslutningen är en funktion av hello Fragmentera karta och hello data beroende routning nyckel.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-229">hello connection is a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="9e1eb-230">Fasta databasrollen namn eller anslutningssträngen fungerar inte som de hoppa över verifieringen av hello Fragmentera kartan.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-230">A fixed database name or connection string will not work as they by-pass validation by hello shard map.</span></span> |
| <span data-ttu-id="9e1eb-231">MyContext(DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-231">MyContext(DbCompiledModel)</span></span> |<span data-ttu-id="9e1eb-232">ElasticScaleContext (ShardMap TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="9e1eb-233">DbContext (DbConnection DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-233">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="9e1eb-234">hello anslutning skapas för hello anges Fragmentera karta och horisontell partitionering nyckeln med hello mallen.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-234">hello connection will get created for hello given shard map and sharding key with hello model provided.</span></span> <span data-ttu-id="9e1eb-235">hello kompilerade modellen skickas toohello grundläggande c'tor.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-235">hello compiled model will be passed on toohello base c’tor.</span></span> |
| <span data-ttu-id="9e1eb-236">MyContext (DbConnection bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-236">MyContext(DbConnection, bool)</span></span> |<span data-ttu-id="9e1eb-237">ElasticScaleContext (ShardMap TKey, bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-237">ElasticScaleContext(ShardMap, TKey, bool)</span></span> |<span data-ttu-id="9e1eb-238">DbContext (DbConnection bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-238">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="9e1eb-239">hello anslutning måste härledas från hello Fragmentera karta och hello nyckeln toobe.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-239">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="9e1eb-240">Det går inte att ange indata (såvida inte dessa indata har redan använder hello Fragmentera karta och hello nyckel).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-240">It cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="9e1eb-241">hello booleskt värde skickas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-241">hello Boolean will be passed on.</span></span> |
| <span data-ttu-id="9e1eb-242">MyContext (sträng, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-242">MyContext(string, DbCompiledModel)</span></span> |<span data-ttu-id="9e1eb-243">ElasticScaleContext (ShardMap TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="9e1eb-244">DbContext (DbConnection DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-244">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="9e1eb-245">hello anslutning måste härledas från hello Fragmentera karta och hello nyckeln toobe.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-245">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="9e1eb-246">Det går inte att ange indata (såvida inte dessa indata använde hello Fragmentera karta och hello nyckel).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-246">It cannot be provided as an input (unless that input was using hello shard map and hello key).</span></span> <span data-ttu-id="9e1eb-247">hello kompilerade modellen skickas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-247">hello compiled model will be passed on.</span></span> |
| <span data-ttu-id="9e1eb-248">MyContext (ObjectContext bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-248">MyContext(ObjectContext, bool)</span></span> |<span data-ttu-id="9e1eb-249">ElasticScaleContext (ShardMap TKey ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span></span> |<span data-ttu-id="9e1eb-250">DbContext (ObjectContext bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-250">DbContext(ObjectContext, bool)</span></span> |<span data-ttu-id="9e1eb-251">hello nya konstruktorn måste tooensure eventuella i hello ObjectContext skickas som indata är ändrats tooa anslutning hanteras av elastisk skalbarhet.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-251">hello new constructor needs tooensure that any connection in hello ObjectContext passed as an input is re-routed tooa connection managed by Elastic Scale.</span></span> <span data-ttu-id="9e1eb-252">En detaljerad beskrivning av ObjectContexts ligger utanför hello i det här dokumentet.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-252">A detailed discussion of ObjectContexts is beyond hello scope of this document.</span></span> |
| <span data-ttu-id="9e1eb-253">MyContext (DbConnection DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-253">MyContext(DbConnection, DbCompiledModel,bool)</span></span> |<span data-ttu-id="9e1eb-254">ElasticScaleContext (ShardMap TKey DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span></span> |<span data-ttu-id="9e1eb-255">DbContext (DbConnection DbCompiledModel, bool;)</span><span class="sxs-lookup"><span data-stu-id="9e1eb-255">DbContext(DbConnection, DbCompiledModel, bool);</span></span> |<span data-ttu-id="9e1eb-256">hello anslutning måste härledas från hello Fragmentera karta och hello nyckeln toobe.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-256">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="9e1eb-257">hello-anslutningen kan inte anges som indata (såvida inte dessa indata har redan använder hello Fragmentera karta och hello nyckel).</span><span class="sxs-lookup"><span data-stu-id="9e1eb-257">hello connection cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="9e1eb-258">Modellen och booleskt värde skickas toohello basklasskonstruktor.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-258">Model and Boolean are passed on toohello base class constructor.</span></span> |

## <a name="shard-schema-deployment-through-ef-migrations"></a><span data-ttu-id="9e1eb-259">Fragmentera schemat distribution via EF migrering</span><span class="sxs-lookup"><span data-stu-id="9e1eb-259">Shard schema deployment through EF migrations</span></span>
<span data-ttu-id="9e1eb-260">Schemahantering av automatiska är i syfte att underlätta tillhandahålls av hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-260">Automatic schema management is a convenience provided by hello Entity Framework.</span></span> <span data-ttu-id="9e1eb-261">Hello gäller program med elastiska Databasverktyg är vill vi tooretain den här funktionen tooautomatically etablera hello schemat toonewly skapade shards när databaserna läggs toohello delat program.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-261">In hello context of applications using elastic database tools, we want tooretain this capability tooautomatically provision hello schema toonewly created shards when databases are added toohello sharded application.</span></span> <span data-ttu-id="9e1eb-262">Det är tooincrease kapaciteten på hello datanivå för delat program som använder EF hello primära användningsfall.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-262">hello primary use case is tooincrease capacity at hello data tier for sharded applications using EF.</span></span> <span data-ttu-id="9e1eb-263">Förlita dig på EFS funktioner för schemahantering av minskar hello databasen administration arbete med ett delat program som bygger på EF.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-263">Relying on EF’s capabilities for schema management reduces hello database administration effort with a sharded application built on EF.</span></span> 

<span data-ttu-id="9e1eb-264">Schemat distribution via EF migreringar fungerar bäst med **inte öppnats anslutningar**.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-264">Schema deployment through EF migrations works best on **unopened connections**.</span></span> <span data-ttu-id="9e1eb-265">Detta är däremot toohello scenario för data beroende routning som förlitar sig på hello öppnas anslutning som tillhandahålls av hello elastisk databas klienten API.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-265">This is in contrast toohello scenario for data dependent routing that relies on hello opened connection provided by hello elastic database client API.</span></span> <span data-ttu-id="9e1eb-266">En annan skillnad hello konsekvenskontroll krävs: när önskvärt tooensure konsekvenskontroll för alla data beroende routning anslutningar tooprotect mot samtidiga Fragmentera kartan manipulering, det är inte ett problem med inledande schema distribution tooa ny databas som har ännu inte har registrerats i hello Fragmentera kartan och har inte allokerats toohold shardlets.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-266">Another difference is hello consistency requirement: While desirable tooensure consistency for all data-dependent routing connections tooprotect against concurrent shard map manipulation, it is not a concern with initial schema deployment tooa new database that has not yet been registered in hello shard map, and not yet been allocated toohold shardlets.</span></span> <span data-ttu-id="9e1eb-267">Vi kan därför förlitar sig på vanlig databasanslutningar för den här scenarier som skillnad från toodata-beroende routning.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-267">We can therefore rely on regular database connections for this scenarios, as opposed toodata-dependent routing.</span></span>  

<span data-ttu-id="9e1eb-268">Detta leder tooan metod där schemat distribution via EF migreringar är direkt kopplade till hello registrering av nya hello-databasen som en Fragmentera hello programmet Fragmentera kartan.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-268">This leads tooan approach where schema deployment through EF migrations is tightly coupled with hello registration of hello new database as a shard in hello application’s shard map.</span></span> <span data-ttu-id="9e1eb-269">Detta är beroende av hello följande krav:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-269">This relies on hello following prerequisites:</span></span> 

* <span data-ttu-id="9e1eb-270">hello-databasen har redan skapats.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-270">hello database has already been created.</span></span> 
* <span data-ttu-id="9e1eb-271">hello-databasen är tom, det innehåller inget användarschema och inga användardata.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-271">hello database is empty - it holds no user schema and no user data.</span></span>
* <span data-ttu-id="9e1eb-272">hello databasen tillgängliga inte ännu via hello elastisk databas-klientens API: er för data-beroende routning.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-272">hello database cannot yet be accessed through hello elastic database client APIs for data-dependent routing.</span></span> 

<span data-ttu-id="9e1eb-273">När dessa krav är uppfyllda, kan vi skapa en vanlig icke öppnade **SqlConnection** tookick av EF migrering för distribution av schema.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-273">With these prerequisites in place, we can create a regular un-opened **SqlConnection** tookick off EF migrations for schema deployment.</span></span> <span data-ttu-id="9e1eb-274">hello följande kodexempel illustrerar den här metoden.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-274">hello following code sample illustrates this approach.</span></span> 

        // Enter a new shard - i.e. an empty database - toohello shard map, allocate a first tenant tooit  
        // and kick off EF intialization of hello database toodeploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext tootrigger migrations and schema deployment for hello new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query tooengage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register hello mapping of hello tenant toohello shard in hello shard map. 
            // After this step, data-dependent routing on hello shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 


<span data-ttu-id="9e1eb-275">Det här exemplet visar hello metoden **RegisterNewShard** att registren hello Fragmentera hello Fragmentera kartan distribuerar hello schemat via EF migreringar och lagrar en mappning av en nyckel toohello Fragmentera för horisontell partitionering.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-275">This sample shows hello method **RegisterNewShard** that registers hello shard in hello shard map, deploys hello schema through EF migrations, and stores a mapping of a sharding key toohello shard.</span></span> <span data-ttu-id="9e1eb-276">Det är beroende av en konstruktor med hello **DbContext** underklass (**ElasticScaleContext** i hello exemplet) som tar en SQL-anslutningssträng som indata.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-276">It relies on a constructor of hello **DbContext** subclass (**ElasticScaleContext** in hello sample) that takes a SQL connection string as input.</span></span> <span data-ttu-id="9e1eb-277">hello-koden för den här konstruktorn är enkel, som följande exempel visar hello:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-277">hello code of this constructor is straight-forward, as hello following example shows:</span></span> 

        // C'tor toodeploy schema and migrations tooa new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that hello schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 

<span data-ttu-id="9e1eb-278">En kan ha använt hello version av hello-konstruktor som ärvts från hello basklass.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-278">One might have used hello version of hello constructor inherited from hello base class.</span></span> <span data-ttu-id="9e1eb-279">Men hello kod måste tooensure som standard initieraren för EF hello används vid anslutning.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-279">But hello code needs tooensure that hello default initializer for EF is used when connecting.</span></span> <span data-ttu-id="9e1eb-280">Därför hello kort detour till hello statisk metod innan anrop till hello basklasskonstruktor med hello anslutningssträngen.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-280">Hence hello short detour into hello static method before calling into hello base class constructor with hello connection string.</span></span> <span data-ttu-id="9e1eb-281">Observera att hello registrering av shards ska köras i en annan app domän eller processen tooensure som hello initieraren inställningar för EF inte står i konflikt.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-281">Note that hello registration of shards should run in a different app domain or process tooensure that hello initializer settings for EF do not conflict.</span></span> 

## <a name="limitations"></a><span data-ttu-id="9e1eb-282">Begränsningar</span><span class="sxs-lookup"><span data-stu-id="9e1eb-282">Limitations</span></span>
<span data-ttu-id="9e1eb-283">hello-metoder som beskrivs i det här dokumentet medför några begränsningar:</span><span class="sxs-lookup"><span data-stu-id="9e1eb-283">hello approaches outlined in this document entail a couple of limitations:</span></span> 

* <span data-ttu-id="9e1eb-284">EF-program som använder **LocalDb** toomigrate tooa vanlig SQL Server-databas måste först innan du använder klientbibliotek för elastisk databas.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-284">EF applications that use **LocalDb** first need toomigrate tooa regular SQL Server database before using elastic database client library.</span></span> <span data-ttu-id="9e1eb-285">Skala ut ett program via delning med elastisk skalbarhet är inte möjligt med **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-285">Scaling out an application through sharding with Elastic Scale is not possible with **LocalDb**.</span></span> <span data-ttu-id="9e1eb-286">Observera att utveckling kan fortfarande använda **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-286">Note that development can still use **LocalDb**.</span></span> 
* <span data-ttu-id="9e1eb-287">Alla ändringar toohello program som implicerar databasen schemaändringar måste toogo via EF migreringar på alla delar.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-287">Any changes toohello application that imply database schema changes need toogo through EF migrations on all shards.</span></span> <span data-ttu-id="9e1eb-288">hello exempelkod för det här dokumentet visar inte hur toodo detta.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-288">hello sample code for this document does not demonstrate how toodo this.</span></span> <span data-ttu-id="9e1eb-289">Överväg att använda Update-databasen med en ConnectionString parametern tooiterate över alla delar; eller extrahera hello T-SQL-skript för hello väntande migrering med hjälp av Update-databas med hello - skript och tillämpa hello T-SQL-skriptet tooyour delar.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-289">Consider using Update-Database with a ConnectionString parameter tooiterate over all shards; or extract hello T-SQL script for hello pending migration using Update-Database with hello -Script option and apply hello T-SQL script tooyour shards.</span></span>  
* <span data-ttu-id="9e1eb-290">Få en begäran, förutsätts att alla dess databasbearbetning ingår i en enda Fragmentera som identifieras av hello horisontell partitionering nyckel som tillhandahålls av hello-begäran.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-290">Given a request, it is assumed that all of its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="9e1eb-291">Men har detta antagande inte alltid värdet true.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-291">However, this assumption does not always hold true.</span></span> <span data-ttu-id="9e1eb-292">Till exempel när det är inte möjligt toomake en nyckel för horisontell partitionering som är tillgängliga.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-292">For example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="9e1eb-293">tooaddress detta, hello klientbiblioteket tillhandahåller hello **MultiShardQuery** klassen som implementerar en anslutning abstraktion för frågor över flera delar.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-293">tooaddress this, hello client library provides hello **MultiShardQuery** class that implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="9e1eb-294">Lär dig toouse hello **MultiShardQuery** i kombination med EF ligger utanför hello i det här dokumentet</span><span class="sxs-lookup"><span data-stu-id="9e1eb-294">Learning toouse hello **MultiShardQuery** in combination with EF is beyond hello scope of this document</span></span>

## <a name="conclusion"></a><span data-ttu-id="9e1eb-295">Slutsats</span><span class="sxs-lookup"><span data-stu-id="9e1eb-295">Conclusion</span></span>
<span data-ttu-id="9e1eb-296">Via hello steg som beskrivs i det här dokumentet, EF program kan använda hello elastisk databas klienten bibliotekets kapaciteten för data beroende routning av eftersom konstruktorerna i hello **DbContext** underklasser som används i hello EF programmet.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-296">Through hello steps outlined in this document, EF applications can use hello elastic database client library's capability for data dependent routing by refactoring constructors of hello **DbContext** subclasses used in hello EF application.</span></span> <span data-ttu-id="9e1eb-297">Den här gränsen hello ändringar krävs toothose platser där **DbContext** klasser finns redan.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-297">This limits hello  changes required toothose places where **DbContext** classes already exist.</span></span> <span data-ttu-id="9e1eb-298">EF program kan dessutom fortsätta toobenefit från schemat för automatisk distribution genom att kombinera hello steg som anropar hello nödvändiga EF migrering med hello registrering av nya delar och avbildningar i hello Fragmentera kartan.</span><span class="sxs-lookup"><span data-stu-id="9e1eb-298">In addition, EF applications can continue toobenefit from automatic schema deployment by combining hello steps that invoke hello necessary EF migrations with hello registration of new shards and mappings in hello shard map.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png
