---
title: "Konfigurera geo-replikering för Azure SQL Database med Transact-SQL | Microsoft Docs"
description: "Konfigurera geo-replikering för Azure SQL Database med Transact-SQL"
services: sql-database
documentationcenter: 
author: CarlRabeler
manager: jhubbard
editor: 
ms.assetid: d94d89a6-3234-46c5-8279-5eb8daad10ac
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 04/14/2017
ms.author: carlrab
ms.openlocfilehash: e5011c1c67e051616d53621b72e46ba894ca3c02
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 07/11/2017
---
# <a name="configure-active-geo-replication-for-azure-sql-database-with-transact-sql"></a><span data-ttu-id="3bfca-103">Konfigurera aktiv geo-replikering för Azure SQL Database med Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="3bfca-103">Configure active geo-replication for Azure SQL Database with Transact-SQL</span></span>

<span data-ttu-id="3bfca-104">Den här artikeln visar hur du konfigurerar aktiv geo-replikering för en Azure SQL-databas med Transact-SQL.</span><span class="sxs-lookup"><span data-stu-id="3bfca-104">This article shows you how to configure active geo-replication for an Azure SQL Database with Transact-SQL.</span></span>

<span data-ttu-id="3bfca-105">Om du vill initiera redundans med Transact-SQL finns [initiera en planerad eller oplanerad växling vid fel för Azure SQL-databas med Transact-SQL](sql-database-geo-replication-failover-transact-sql.md).</span><span class="sxs-lookup"><span data-stu-id="3bfca-105">To initiate failover using Transact-SQL, see [Initiate a planned or unplanned failover for Azure SQL Database with Transact-SQL](sql-database-geo-replication-failover-transact-sql.md).</span></span>

> [!NOTE]
> <span data-ttu-id="3bfca-106">När du använder aktiv geo-replikering (läsbara sekundärservrar) för katastrofåterställning bör du konfigurera en redundansväxlingsgrupp för alla databaser i ett program för att aktivera automatiskt och transparent redundans.</span><span class="sxs-lookup"><span data-stu-id="3bfca-106">When you use active geo-replication (readable secondaries) for disaster recovery you should configure a failover group for all databases within an application to enable automatic and transparent failover.</span></span> <span data-ttu-id="3bfca-107">Den här funktionen är i förhandsgranskningen.</span><span class="sxs-lookup"><span data-stu-id="3bfca-107">This feature is in preview.</span></span> <span data-ttu-id="3bfca-108">Mer information finns i [automatisk redundans grupper och geo-replikering](sql-database-geo-replication-overview.md).</span><span class="sxs-lookup"><span data-stu-id="3bfca-108">For more information see [Auto-failover groups and geo-replication](sql-database-geo-replication-overview.md).</span></span>
> 
> 

<span data-ttu-id="3bfca-109">Så här konfigurerar du aktiv geo-replikering med hjälp av Transact-SQL, behöver du följande:</span><span class="sxs-lookup"><span data-stu-id="3bfca-109">To configure active geo-replication using Transact-SQL, you need the following:</span></span>

* <span data-ttu-id="3bfca-110">En Azure-prenumeration</span><span class="sxs-lookup"><span data-stu-id="3bfca-110">An Azure subscription</span></span>
* <span data-ttu-id="3bfca-111">En logisk Azure SQL Database-server <MyLocalServer> och en SQL-databas <MyDB> -den primära databasen som du vill replikera</span><span class="sxs-lookup"><span data-stu-id="3bfca-111">A logical Azure SQL Database server <MyLocalServer> and a SQL database <MyDB> - The primary database that you want to replicate</span></span>
* <span data-ttu-id="3bfca-112">En eller flera logiska Azure SQL Database-servrar < MySecondaryServer(n) > - logiska servrar som ska vara partnerservrar där du skapar sekundära databaser</span><span class="sxs-lookup"><span data-stu-id="3bfca-112">One or more logical Azure SQL Database servers <MySecondaryServer(n)> - The logical servers that will be the partner servers in which you will create secondary databases</span></span>
* <span data-ttu-id="3bfca-113">En inloggning som är DBManager på primärt</span><span class="sxs-lookup"><span data-stu-id="3bfca-113">A login that is DBManager on the primary</span></span>
* <span data-ttu-id="3bfca-114">Har db_ownership för den lokala databasen som du kommer att geo-replikering</span><span class="sxs-lookup"><span data-stu-id="3bfca-114">Have db_ownership of the local database that you will geo-replicate</span></span>
* <span data-ttu-id="3bfca-115">Vara DBManager på partner-servrar som du vill konfigurera geo-replikering</span><span class="sxs-lookup"><span data-stu-id="3bfca-115">Be DBManager on the partner server(s) to which you will configure geo-replication</span></span>
* <span data-ttu-id="3bfca-116">Den senaste versionen av SQL Server Management Studio (SSMS)</span><span class="sxs-lookup"><span data-stu-id="3bfca-116">The newest version of SQL Server Management Studio (SSMS)</span></span>

> [!IMPORTANT]
> <span data-ttu-id="3bfca-117">Det rekommenderas att du alltid använder den senaste versionen av Management Studio för att förbli synkroniserad med uppdateringar av Microsoft Azure och SQL Database.</span><span class="sxs-lookup"><span data-stu-id="3bfca-117">It is recommended that you always use the latest version of Management Studio to remain synchronized with updates to Microsoft Azure and SQL Database.</span></span> <span data-ttu-id="3bfca-118">[Uppdatera SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span><span class="sxs-lookup"><span data-stu-id="3bfca-118">[Update SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span></span>
> 
> 

## <a name="add-secondary-database"></a><span data-ttu-id="3bfca-119">Lägg till sekundära databas</span><span class="sxs-lookup"><span data-stu-id="3bfca-119">Add secondary database</span></span>
<span data-ttu-id="3bfca-120">Du kan använda den **ALTER DATABASE** instruktionen för att skapa en sekundär geo-replikerade databas på en partner.</span><span class="sxs-lookup"><span data-stu-id="3bfca-120">You can use the **ALTER DATABASE** statement to create a geo-replicated secondary database on a partner server.</span></span> <span data-ttu-id="3bfca-121">Du kan köra den här instruktionen i master-databasen på den server som innehåller databasen som ska replikeras.</span><span class="sxs-lookup"><span data-stu-id="3bfca-121">You execute this statement on the master database of the server containing the database to be replicated.</span></span> <span data-ttu-id="3bfca-122">Georeplikerad (”primära databasen”) har samma namn som databasen håller på att replikeras och kommer som standard har samma tjänst-nivå som den primära databasen.</span><span class="sxs-lookup"><span data-stu-id="3bfca-122">The geo-replicated database (the "primary database") will have the same name as the database being replicated and will, by default, have the same service level as the primary database.</span></span> <span data-ttu-id="3bfca-123">Den sekundära databasen kan vara läsbart eller inte kan läsas och kan vara en enskild databas eller i en elastisk pool.</span><span class="sxs-lookup"><span data-stu-id="3bfca-123">The secondary database can be readable or non-readable, and can be a single database or in an elastic pool.</span></span> <span data-ttu-id="3bfca-124">Mer information finns i [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) och [tjänstnivåer](sql-database-service-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="3bfca-124">For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](sql-database-service-tiers.md).</span></span>
<span data-ttu-id="3bfca-125">När den sekundära databasen skapas och dirigeras börjar data replikeras asynkront från den primära databasen.</span><span class="sxs-lookup"><span data-stu-id="3bfca-125">After the secondary database is created and seeded, data will begin replicating asynchronously from the primary database.</span></span> <span data-ttu-id="3bfca-126">Stegen nedan beskriver hur du konfigurerar geo-replikering med Management Studio.</span><span class="sxs-lookup"><span data-stu-id="3bfca-126">The steps below describe how to configure geo-replication using Management Studio.</span></span> <span data-ttu-id="3bfca-127">Steg för att skapa icke-läsbar och läsbara sekundärservrar som en enskild databas eller i en elastisk pool tillhandahålls.</span><span class="sxs-lookup"><span data-stu-id="3bfca-127">Steps to create non-readable and readable secondaries, either as a single database or in an elastic pool, are provided.</span></span>

> [!NOTE]
> <span data-ttu-id="3bfca-128">Om det finns en databas på den angivna partnerservern med samma namn som den primära databasen kommer kommandot misslyckas.</span><span class="sxs-lookup"><span data-stu-id="3bfca-128">If a database exists on the specified partner server with the same name as the primary database the command will fail.</span></span>
> 

### <a name="add-readable-secondary-single-database"></a><span data-ttu-id="3bfca-129">Lägga till läsbar sekundärserver (en databas)</span><span class="sxs-lookup"><span data-stu-id="3bfca-129">Add readable secondary (single database)</span></span>
<span data-ttu-id="3bfca-130">Använd följande steg för att skapa en läsbar sekundärserver som en enskild databas.</span><span class="sxs-lookup"><span data-stu-id="3bfca-130">Use the following steps to create a readable secondary as a single database.</span></span>

1. <span data-ttu-id="3bfca-131">Anslut till din logiska Azure SQL Database-server i Management Studio.</span><span class="sxs-lookup"><span data-stu-id="3bfca-131">In Management Studio, connect to your Azure SQL Database logical server.</span></span>
2. <span data-ttu-id="3bfca-132">Öppna mappen databaser, expandera den **systemdatabaser** mappen, högerklicka på **master**, och klicka sedan på **ny fråga**.</span><span class="sxs-lookup"><span data-stu-id="3bfca-132">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="3bfca-133">Använd följande **ALTER DATABASE** instruktionen för att göra en lokal databas geo-replikering primära med en läsbar sekundär databas på en sekundär server.</span><span class="sxs-lookup"><span data-stu-id="3bfca-133">Use the following **ALTER DATABASE** statement to make a local database into a geo-replication primary with a readable secondary database on a secondary server.</span></span>
   
        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer2> WITH (ALLOW_CONNECTIONS = ALL);
4. <span data-ttu-id="3bfca-134">Klicka på **Kör** att köra frågan.</span><span class="sxs-lookup"><span data-stu-id="3bfca-134">Click **Execute** to run the query.</span></span>

### <a name="add-readable-secondary-elastic-pool"></a><span data-ttu-id="3bfca-135">Lägga till läsbar sekundärserver (elastisk pool)</span><span class="sxs-lookup"><span data-stu-id="3bfca-135">Add readable secondary (elastic pool)</span></span>
<span data-ttu-id="3bfca-136">Använd följande steg för att skapa en läsbar sekundärserver i en elastisk pool.</span><span class="sxs-lookup"><span data-stu-id="3bfca-136">Use the following steps to create a readable secondary in an elastic pool.</span></span>

1. <span data-ttu-id="3bfca-137">Anslut till din logiska Azure SQL Database-server i Management Studio.</span><span class="sxs-lookup"><span data-stu-id="3bfca-137">In Management Studio, connect to your Azure SQL Database logical server.</span></span>
2. <span data-ttu-id="3bfca-138">Öppna mappen databaser, expandera den **systemdatabaser** mappen, högerklicka på **master**, och klicka sedan på **ny fråga**.</span><span class="sxs-lookup"><span data-stu-id="3bfca-138">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="3bfca-139">Använd följande **ALTER DATABASE** instruktionen för att göra en lokal databas geo-replikering primära med en läsbar sekundär databas på en sekundär server i en elastisk pool.</span><span class="sxs-lookup"><span data-stu-id="3bfca-139">Use the following **ALTER DATABASE** statement to make a local database into a geo-replication primary with a readable secondary database on a secondary server in an elastic pool.</span></span>
   
        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer4> WITH (ALLOW_CONNECTIONS = ALL
           , SERVICE_OBJECTIVE = ELASTIC_POOL (name = MyElasticPool2));
4. <span data-ttu-id="3bfca-140">Klicka på **Kör** att köra frågan.</span><span class="sxs-lookup"><span data-stu-id="3bfca-140">Click **Execute** to run the query.</span></span>

## <a name="remove-secondary-database"></a><span data-ttu-id="3bfca-141">Ta bort sekundära databas</span><span class="sxs-lookup"><span data-stu-id="3bfca-141">Remove secondary database</span></span>
<span data-ttu-id="3bfca-142">Du kan använda den **ALTER DATABASE** permanent avsluta replikering samarbetet mellan en sekundär databas och dess primära-uttryck.</span><span class="sxs-lookup"><span data-stu-id="3bfca-142">You can use the **ALTER DATABASE** statement to permanently terminate the replication partnership between a secondary database and its primary.</span></span> <span data-ttu-id="3bfca-143">Den här instruktionen körs i master-databasen som den primära databasen finns.</span><span class="sxs-lookup"><span data-stu-id="3bfca-143">This statement is executed on the master database on which the primary database resides.</span></span> <span data-ttu-id="3bfca-144">När relationen avslutning blir den sekundära databasen en vanlig skrivskyddad databas.</span><span class="sxs-lookup"><span data-stu-id="3bfca-144">After the relationship termination, the secondary database becomes a regular read-write database.</span></span> <span data-ttu-id="3bfca-145">Om anslutningen till sekundära databasen är skadad kommandot lyckas, men sekundärt blir oskyddad när anslutningen har återställts.</span><span class="sxs-lookup"><span data-stu-id="3bfca-145">If the connectivity to secondary database is broken the command succeeds but the secondary will become read-write after connectivity is restored.</span></span> <span data-ttu-id="3bfca-146">Mer information finns i [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) och [tjänstnivåer](sql-database-service-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="3bfca-146">For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](sql-database-service-tiers.md).</span></span>

<span data-ttu-id="3bfca-147">Använd följande steg för att ta bort georeplikerad sekundära från ett partnerskap geo-replikering.</span><span class="sxs-lookup"><span data-stu-id="3bfca-147">Use the following steps to remove geo-replicated secondary from a geo-replication partnership.</span></span>

1. <span data-ttu-id="3bfca-148">Anslut till din logiska Azure SQL Database-server i Management Studio.</span><span class="sxs-lookup"><span data-stu-id="3bfca-148">In Management Studio, connect to your Azure SQL Database logical server.</span></span>
2. <span data-ttu-id="3bfca-149">Öppna mappen databaser, expandera den **systemdatabaser** mappen, högerklicka på **master**, och klicka sedan på **ny fråga**.</span><span class="sxs-lookup"><span data-stu-id="3bfca-149">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="3bfca-150">Använd följande **ALTER DATABASE** instruktionen för att ta bort en sekundär geo-replikerade.</span><span class="sxs-lookup"><span data-stu-id="3bfca-150">Use the following **ALTER DATABASE** statement to remove a geo-replicated secondary.</span></span>
   
        ALTER DATABASE <MyDB>
           REMOVE SECONDARY ON SERVER <MySecondaryServer1>;
4. <span data-ttu-id="3bfca-151">Klicka på **Kör** att köra frågan.</span><span class="sxs-lookup"><span data-stu-id="3bfca-151">Click **Execute** to run the query.</span></span>

## <a name="monitor-active-geo-replication-configuration-and-health"></a><span data-ttu-id="3bfca-152">Övervakarkonfiguration aktiv geo-replikering och hälsa</span><span class="sxs-lookup"><span data-stu-id="3bfca-152">Monitor active geo-replication configuration and health</span></span>

<span data-ttu-id="3bfca-153">Övervakningsaktiviteter är övervakning av geo-replikering konfiguration och övervakning av hälsotillstånd för replikering av data.</span><span class="sxs-lookup"><span data-stu-id="3bfca-153">Monitoring tasks include monitoring of the geo-replication configuration and monitoring data replication health.</span></span>  <span data-ttu-id="3bfca-154">Du kan använda den **sys.dm_geo_replication_links** dynamisk hanteringsvy i huvuddatabasen för att returnera information om alla befintliga replikeringslänkar för varje databas på den logiska Azure SQL Database-servern.</span><span class="sxs-lookup"><span data-stu-id="3bfca-154">You can use the **sys.dm_geo_replication_links** dynamic management view in the master database to return information about all exiting replication links for each database on the Azure SQL Database logical server.</span></span> <span data-ttu-id="3bfca-155">Den här vyn innehåller en rad för varje replikeringslänk mellan primära och sekundära databaser.</span><span class="sxs-lookup"><span data-stu-id="3bfca-155">This view contains a row for each of the replication link between primary and secondary databases.</span></span> <span data-ttu-id="3bfca-156">Du kan använda den **sys.dm_replication_link_status** dynamisk hanteringsvy att returnera en rad för varje Azure SQL Database som för närvarande används i en replikeringslänk för replikering.</span><span class="sxs-lookup"><span data-stu-id="3bfca-156">You can use the **sys.dm_replication_link_status** dynamic management view to return a row for each Azure SQL Database that is currently engaged in a replication replication link.</span></span> <span data-ttu-id="3bfca-157">Detta inkluderar både primära och sekundära databaser.</span><span class="sxs-lookup"><span data-stu-id="3bfca-157">This includes both primary and secondary databases.</span></span> <span data-ttu-id="3bfca-158">Om mer än en kontinuerlig replikeringslänk finns för en viss primär databas i den här tabellen innehåller en rad för varje relationerna.</span><span class="sxs-lookup"><span data-stu-id="3bfca-158">If more than one continuous replication link exists for a given primary database, this table contains a row for each of the relationships.</span></span> <span data-ttu-id="3bfca-159">Vyn har skapats i alla databaser, inklusive logiska master.</span><span class="sxs-lookup"><span data-stu-id="3bfca-159">The view is created in all databases, including the logical master.</span></span> <span data-ttu-id="3bfca-160">Dock returnerar frågor till den här vyn i den logiska master en tom uppsättning.</span><span class="sxs-lookup"><span data-stu-id="3bfca-160">However, querying this view in the logical master returns an empty set.</span></span> <span data-ttu-id="3bfca-161">Du kan använda den **sys.dm_operation_status** dynamisk hanteringsvy och visa status för alla databas-åtgärder, inklusive statusen för länkar för databasreplikering.</span><span class="sxs-lookup"><span data-stu-id="3bfca-161">You can use the **sys.dm_operation_status** dynamic management view to show the status for all database operations including the status of the replication links.</span></span> <span data-ttu-id="3bfca-162">Mer information finns i [sys.geo_replication_links (Azure SQL Database)](https://msdn.microsoft.com/library/mt575501.aspx), [sys.dm_geo_replication_link_status (Azure SQL Database)](https://msdn.microsoft.com/library/mt575504.aspx), och [sys.dm_operation_status (Azure SQL Databas)](https://msdn.microsoft.com/library/dn270022.aspx).</span><span class="sxs-lookup"><span data-stu-id="3bfca-162">For more information, see [sys.geo_replication_links (Azure SQL Database)](https://msdn.microsoft.com/library/mt575501.aspx), [sys.dm_geo_replication_link_status (Azure SQL Database)](https://msdn.microsoft.com/library/mt575504.aspx), and [sys.dm_operation_status (Azure SQL Database)](https://msdn.microsoft.com/library/dn270022.aspx).</span></span>

<span data-ttu-id="3bfca-163">Använd följande steg för att övervaka ett partnerskap för aktiv geo-replikering.</span><span class="sxs-lookup"><span data-stu-id="3bfca-163">Use the following steps to monitor an active geo-replication partnership.</span></span>

1. <span data-ttu-id="3bfca-164">Anslut till din logiska Azure SQL Database-server i Management Studio.</span><span class="sxs-lookup"><span data-stu-id="3bfca-164">In Management Studio, connect to your Azure SQL Database logical server.</span></span>
2. <span data-ttu-id="3bfca-165">Öppna mappen databaser, expandera den **systemdatabaser** mappen, högerklicka på **master**, och klicka sedan på **ny fråga**.</span><span class="sxs-lookup"><span data-stu-id="3bfca-165">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="3bfca-166">Använd följande instruktion om du vill visa alla databaser med geo-replikeringslänkar.</span><span class="sxs-lookup"><span data-stu-id="3bfca-166">Use the following statement to show all databases with geo-replication links.</span></span>
   
        SELECT database_id, start_date, modify_date, partner_server, partner_database, replication_state_desc, role, secondary_allow_connections_desc FROM sys.geo_replication_links;
4. <span data-ttu-id="3bfca-167">Klicka på **Kör** att köra frågan.</span><span class="sxs-lookup"><span data-stu-id="3bfca-167">Click **Execute** to run the query.</span></span>
5. <span data-ttu-id="3bfca-168">Öppna mappen databaser, expandera den **systemdatabaser** mappen, högerklicka på **MyDB**, och klicka sedan på **ny fråga**.</span><span class="sxs-lookup"><span data-stu-id="3bfca-168">Open the Databases folder, expand the **System Databases** folder, right-click on **MyDB**, and then click **New Query**.</span></span>
6. <span data-ttu-id="3bfca-169">Använder följande instruktion för att visa replikering beräkningstider och senaste replikeringen tid för min sekundära MyDB-databaser.</span><span class="sxs-lookup"><span data-stu-id="3bfca-169">Use the following statement to show the replication lags and last replication time of my secondary databases of MyDB.</span></span>
   
        SELECT link_guid, partner_server, last_replication, replication_lag_sec FROM sys.dm_geo_replication_link_status
7. <span data-ttu-id="3bfca-170">Klicka på **Kör** att köra frågan.</span><span class="sxs-lookup"><span data-stu-id="3bfca-170">Click **Execute** to run the query.</span></span>
8. <span data-ttu-id="3bfca-171">Använd följande instruktion om du vill visa de senaste geo-replikering åtgärder som associeras med databasen MyDB.</span><span class="sxs-lookup"><span data-stu-id="3bfca-171">Use the following statement to show the most recent geo-replication operations associated with database MyDB.</span></span>
   
        SELECT * FROM sys.dm_operation_status where major_resource_id = 'MyDB'
        ORDER BY start_time DESC
9. <span data-ttu-id="3bfca-172">Klicka på **Kör** att köra frågan.</span><span class="sxs-lookup"><span data-stu-id="3bfca-172">Click **Execute** to run the query.</span></span>

## <a name="next-steps"></a><span data-ttu-id="3bfca-173">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="3bfca-173">Next steps</span></span>
* <span data-ttu-id="3bfca-174">Mer information om växling vid fel grupper och aktiv geo-replikering finns - [redundans grupper](sql-database-geo-replication-overview.md)</span><span class="sxs-lookup"><span data-stu-id="3bfca-174">To learn more about failover groups and active geo-replication, see - [Failover groups](sql-database-geo-replication-overview.md)</span></span>
* <span data-ttu-id="3bfca-175">En översikt över verksamhetskontinuitet och scenarier finns [översikt över verksamhetskontinuitet](sql-database-business-continuity.md)</span><span class="sxs-lookup"><span data-stu-id="3bfca-175">For a business continuity overview and scenarios, see [Business continuity overview](sql-database-business-continuity.md)</span></span>

