---
title: aaaQuery delat Azure SQL-databaser | Microsoft Docs
description: "Köra frågor över delar med hello klientbibliotek för elastisk databas."
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: a4379c15-f213-4026-ab6f-a450ee9d5758
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/12/2016
ms.author: torsteng
ms.openlocfilehash: a1f0763935a6807b74aa9dec477714e8d117417d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="multi-shard-querying"></a><span data-ttu-id="94949-103">Flera Fragmentera frågor</span><span class="sxs-lookup"><span data-stu-id="94949-103">Multi-shard querying</span></span>
## <a name="overview"></a><span data-ttu-id="94949-104">Översikt</span><span class="sxs-lookup"><span data-stu-id="94949-104">Overview</span></span>
<span data-ttu-id="94949-105">Med hello [elastisk Databasverktyg](sql-database-elastic-scale-introduction.md), kan du skapa delat databaslösningar.</span><span class="sxs-lookup"><span data-stu-id="94949-105">With hello [Elastic Database tools](sql-database-elastic-scale-introduction.md), you can create sharded database solutions.</span></span> <span data-ttu-id="94949-106">**Flera Fragmentera frågar** används för aktiviteter som samling/rapportering av användningsdata som kräver att du kör en fråga som sträcker sig över flera delar.</span><span class="sxs-lookup"><span data-stu-id="94949-106">**Multi-shard querying** is used for tasks such as data collection/reporting that require running a query that stretches across several shards.</span></span> <span data-ttu-id="94949-107">(Skiljer sig från detta för[data beroende routning](sql-database-elastic-scale-data-dependent-routing.md), som utför alla arbete på en enda Fragmentera.)</span><span class="sxs-lookup"><span data-stu-id="94949-107">(Contrast this too[data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md), which performs all work on a single shard.)</span></span> 

1. <span data-ttu-id="94949-108">Hämta en [ **RangeShardMap** ](https://msdn.microsoft.com/library/azure/dn807318.aspx) eller [ **ListShardMap** ](https://msdn.microsoft.com/library/azure/dn807370.aspx) med hello [ **TryGetRangeShardMap** ](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), hello [ **TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), eller hello [ **GetShardMap** ](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) metod.</span><span class="sxs-lookup"><span data-stu-id="94949-108">Get a [**RangeShardMap**](https://msdn.microsoft.com/library/azure/dn807318.aspx) or [**ListShardMap**](https://msdn.microsoft.com/library/azure/dn807370.aspx) using hello [**TryGetRangeShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), hello [**TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), or hello [**GetShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) method.</span></span> <span data-ttu-id="94949-109">Se [ **konstruera en ShardMapManager** ](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) och [ **får en RangeShardMap eller ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span><span class="sxs-lookup"><span data-stu-id="94949-109">See [**Constructing a ShardMapManager**](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) and [**Get a RangeShardMap or ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span></span>
2. <span data-ttu-id="94949-110">Skapa en  **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)**  objekt.</span><span class="sxs-lookup"><span data-stu-id="94949-110">Create a **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)** object.</span></span>
3. <span data-ttu-id="94949-111">Skapa en  **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="94949-111">Create a **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span></span> 
4. <span data-ttu-id="94949-112">Ange hello  **[egenskapen CommandText](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)**  tooa T-SQL-kommandot.</span><span class="sxs-lookup"><span data-stu-id="94949-112">Set hello **[CommandText property](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)** tooa T-SQL command.</span></span>
5. <span data-ttu-id="94949-113">Köra hello kommandot genom att anropa hello  **[ExecuteReader metoden](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="94949-113">Execute hello command by calling hello **[ExecuteReader method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span></span>
6. <span data-ttu-id="94949-114">Visa hello resultat med hjälp av hello  **[MultiShardDataReader klassen](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="94949-114">View hello results using hello **[MultiShardDataReader class](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span></span> 

## <a name="example"></a><span data-ttu-id="94949-115">Exempel</span><span class="sxs-lookup"><span data-stu-id="94949-115">Example</span></span>
<span data-ttu-id="94949-116">hello följande kod visar hello användning av flera Fragmentera fråga med hjälp av en viss **ShardMap** med namnet *myShardMap*.</span><span class="sxs-lookup"><span data-stu-id="94949-116">hello following code illustrates hello usage of multi-shard querying using a given **ShardMap** named *myShardMap*.</span></span> 

    using (MultiShardConnection conn = new MultiShardConnection( 
                                        myShardMap.GetShards(), 
                                        myShardConnectionString) 
          ) 
    { 
    using (MultiShardCommand cmd = conn.CreateCommand())
           { 
            cmd.CommandText = "SELECT c1, c2, c3 FROM ShardedTable"; 
            cmd.CommandType = CommandType.Text; 
            cmd.ExecutionOptions = MultiShardExecutionOptions.IncludeShardNameColumn; 
            cmd.ExecutionPolicy = MultiShardExecutionPolicy.PartialResults; 

            using (MultiShardDataReader sdr = cmd.ExecuteReader()) 
                { 
                    while (sdr.Read())
                        { 
                            var c1Field = sdr.GetString(0); 
                            var c2Field = sdr.GetFieldValue<int>(1); 
                            var c3Field = sdr.GetFieldValue<Int64>(2);
                        } 
                 } 
           } 
    } 


<span data-ttu-id="94949-117">En viktigaste skillnaden är hello konstruktionen av flera Fragmentera anslutningar.</span><span class="sxs-lookup"><span data-stu-id="94949-117">A key difference is hello construction of multi-shard connections.</span></span> <span data-ttu-id="94949-118">Där **SqlConnection** körs på en enskild databas hello **MultiShardConnection** tar en ***samling shards*** som indata.</span><span class="sxs-lookup"><span data-stu-id="94949-118">Where **SqlConnection** operates on a single database, hello **MultiShardConnection** takes a ***collection of shards*** as its input.</span></span> <span data-ttu-id="94949-119">Fyll i hello samling shards från en Fragmentera karta.</span><span class="sxs-lookup"><span data-stu-id="94949-119">Populate hello collection of shards from a shard map.</span></span> <span data-ttu-id="94949-120">hello-frågan körs sedan på hello samling shards med **UNION ALL** semantik tooassemble ett övergripande resultat.</span><span class="sxs-lookup"><span data-stu-id="94949-120">hello query is then executed on hello collection of shards using **UNION ALL** semantics tooassemble a single overall result.</span></span> <span data-ttu-id="94949-121">Du kan också hello namnet på hello Fragmentera där hello raden härstammar från kan läggas till toohello utdata med hello **ExecutionOptions** -egenskapen i kommandot.</span><span class="sxs-lookup"><span data-stu-id="94949-121">Optionally, hello name of hello shard where hello row originates from can be added toohello output using hello **ExecutionOptions** property on command.</span></span> 

<span data-ttu-id="94949-122">Observera hello anrop för**myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="94949-122">Note hello call too**myShardMap.GetShards()**.</span></span> <span data-ttu-id="94949-123">Den här metoden hämtar alla delar i hello Fragmentera mappning och ger ett enkelt sätt toorun en fråga över alla relevanta databaser.</span><span class="sxs-lookup"><span data-stu-id="94949-123">This method retrieves all shards from hello shard map and provides an easy way toorun a query across all relevant databases.</span></span> <span data-ttu-id="94949-124">hello samling shards för en fråga med flera Fragmentera kan anpassas ytterligare genom att utföra en LINQ fråga över hello datainsamling som returnerades från hello anrop för**myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="94949-124">hello collection of shards for a multi-shard query can be refined further by performing a LINQ query over hello collection returned from hello call too**myShardMap.GetShards()**.</span></span> <span data-ttu-id="94949-125">I kombination med hello ofullständiga resultat princip har hello aktuella kapaciteten i flera Fragmentera frågar utformad toowork bra för flera in toohundreds av shards.</span><span class="sxs-lookup"><span data-stu-id="94949-125">In combination with hello partial results policy, hello current capability in multi-shard querying has been designed toowork well for tens up toohundreds of shards.</span></span>

<span data-ttu-id="94949-126">En begränsning med flera Fragmentera frågar är för närvarande hello bristande verifieringen av delar och shardlets som efterfrågas.</span><span class="sxs-lookup"><span data-stu-id="94949-126">A limitation with multi-shard querying is currently hello lack of validation for shards and shardlets that are queried.</span></span> <span data-ttu-id="94949-127">Data dependent routning verifierar att en given Fragmentera tillhör hello Fragmentera kartan för närvarande hello frågor till, men flera Fragmentera frågor utför inte den här kontrollen.</span><span class="sxs-lookup"><span data-stu-id="94949-127">While data-dependent routing verifies that a given shard is part of hello shard map at hello time of querying, multi-shard queries do not perform this check.</span></span> <span data-ttu-id="94949-128">Detta kan leda toomulti Fragmentera frågor som körs på databaser som har tagits bort från hello Fragmentera kartan.</span><span class="sxs-lookup"><span data-stu-id="94949-128">This can lead toomulti-shard queries running on databases that have  been removed from hello shard map.</span></span>

## <a name="multi-shard-queries-and-split-merge-operations"></a><span data-ttu-id="94949-129">Flera Fragmentera frågor och dela merge-operationer</span><span class="sxs-lookup"><span data-stu-id="94949-129">Multi-shard queries and split-merge operations</span></span>
<span data-ttu-id="94949-130">Flera Fragmentera frågor bekräftar inte om shardlets på hello databas deltar i pågående dela merge-åtgärder.</span><span class="sxs-lookup"><span data-stu-id="94949-130">Multi-shard queries do not verify whether shardlets on hello queried database are participating in ongoing split-merge operations.</span></span> <span data-ttu-id="94949-131">(Se [skalning verktyget hello elastisk databas dela sammanslagna](sql-database-elastic-scale-overview-split-and-merge.md).) Detta kan leda tooinconsistencies där rader från hello samma shardlet visa för flera databaser i hello samma flera Fragmentera fråga.</span><span class="sxs-lookup"><span data-stu-id="94949-131">(See [Scaling using hello Elastic Database split-merge tool](sql-database-elastic-scale-overview-split-and-merge.md).) This can lead tooinconsistencies where rows from hello same shardlet show for multiple databases in hello same multi-shard query.</span></span> <span data-ttu-id="94949-132">Tänk på att dessa begränsningar och Överväg tömmer pågående delade dokument och förändringar toohello Fragmentera kartan när du utför flera Fragmentera frågor.</span><span class="sxs-lookup"><span data-stu-id="94949-132">Be aware of these limitations and consider draining ongoing split-merge operations and changes toohello shard map while performing multi-shard queries.</span></span>

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

## <a name="see-also"></a><span data-ttu-id="94949-133">Se även</span><span class="sxs-lookup"><span data-stu-id="94949-133">See also</span></span>
<span data-ttu-id="94949-134">**[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)**  klasser och metoder.</span><span class="sxs-lookup"><span data-stu-id="94949-134">**[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)** classes and methods.</span></span>

<span data-ttu-id="94949-135">Hantera shards med hello [klientbibliotek för elastisk databas](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="94949-135">Manage shards using hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="94949-136">Innehåller ett namnområde som kallas [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) som ger hello möjlighet tooquery flera delar med hjälp av en enskild fråga och resultat.</span><span class="sxs-lookup"><span data-stu-id="94949-136">Includes a  namespace called [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) that provides hello ability tooquery multiple shards using a single query and result.</span></span> <span data-ttu-id="94949-137">Det ger en frågar abstraktion över en mängd shards.</span><span class="sxs-lookup"><span data-stu-id="94949-137">It provides a querying abstraction over a collection of shards.</span></span> <span data-ttu-id="94949-138">Det ger också alternativa körningsprinciper, i synnerhet ofullständiga resultat, toodeal med fel vid fråga över flera delar.</span><span class="sxs-lookup"><span data-stu-id="94949-138">It also provides alternative execution policies, in particular partial results, toodeal with failures when querying over many shards.</span></span>  

