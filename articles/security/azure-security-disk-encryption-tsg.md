---
title: "Azure Disk Encryption felsökning | Microsoft Docs"
description: "Den här artikeln innehåller felsökningstips för Microsoft Azure Disk Encryption för Windows och Linux virtuella IaaS-datorer."
services: security
documentationcenter: na
author: deventiwari
manager: avibm
editor: yuridio
ms.assetid: ce0e23bd-07eb-43af-a56c-aa1a73bdb747
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/27/2017
ms.author: devtiw
ms.openlocfilehash: 5f482a92b8fcd71a1b767fcc5741bc57605997ea
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 08/29/2017
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a><span data-ttu-id="9f0fd-103">Felsökningsguide för Azure Disk Encryption</span><span class="sxs-lookup"><span data-stu-id="9f0fd-103">Azure Disk Encryption Troubleshooting Guide</span></span>

<span data-ttu-id="9f0fd-104">Den här guiden är för arbetet för IT-proffs, information security analytiker och molnet administratörer vars organisationer som använder Azure disk encryption och måste vägledning för att felsöka diskkryptering relaterade problem.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-104">This guide is for information technology (IT) professionals, information security analysts, and cloud administrators whose organizations are using Azure disk encryption and need guidance to troubleshoot disk-encryption related issues.</span></span>

## <a name="troubleshooting-linux-os-disk-encryption"></a><span data-ttu-id="9f0fd-105">Felsökning av Linux OS-diskkryptering</span><span class="sxs-lookup"><span data-stu-id="9f0fd-105">Troubleshooting Linux OS disk encryption</span></span>

<span data-ttu-id="9f0fd-106">Linux OS-diskkryptering måste demontera OS-enheten innan du kör med fullständig disk krypteringsprocessen.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-106">Linux OS disk encryption must unmount the OS drive prior to running it through the full disk encryption process.</span></span>   <span data-ttu-id="9f0fd-107">Om inte ett felmeddelande för ”det gick inte att demontera efter...”</span><span class="sxs-lookup"><span data-stu-id="9f0fd-107">If it cannot, an error message of "failed to unmount after…"</span></span> <span data-ttu-id="9f0fd-108">Felmeddelandet är sannolikt att.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-108">error message is likely to occur.</span></span>

<span data-ttu-id="9f0fd-109">Detta är troligen när OS-diskkryptering görs på en målmiljön VM som har ändrats eller har ändrats från dess stöds lager galleriet avbildning.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-109">This is most likely when OS disk encryption is attempted on a target VM environment that has been modified or changed from its supported stock gallery image.</span></span>  <span data-ttu-id="9f0fd-110">Exempel på avvikelser från stöds avbildningen, som kan störa tilläggets möjlighet att demontera OS-enhet:</span><span class="sxs-lookup"><span data-stu-id="9f0fd-110">Examples of deviations from the supported image, which can interfere with the extension’s ability to unmount the OS drive include:</span></span>
- <span data-ttu-id="9f0fd-111">Anpassade avbildningar som matchar inte längre ett filsystem som stöds och/eller partitioneringsschema.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-111">Customized images that no longer match a supported file system and/or partitioning scheme.</span></span>
- <span data-ttu-id="9f0fd-112">Anpassade avbildningar med program, till exempel antivirusprogram, Docker, SAP, MongoDB eller Apache Cassandra körs i OS före kryptering.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-112">Customized images with applications such as antivirus, Docker, SAP, MongoDB, or Apache Cassandra running in the OS prior to encryption.</span></span>  <span data-ttu-id="9f0fd-113">Dessa program är svåra att avsluta och när de behåller öppna filreferenser på OS-enhet på enheten kan inte omonterade orsakar fel.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-113">These applications are difficult to terminate, and when they retain open file handles to the OS drive, the drive cannot be unmounted, causing failure.</span></span>
- <span data-ttu-id="9f0fd-114">Anpassade skript som körs i Stäng tid närhet till steget kryptering kan påverka och orsaka det här felet.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-114">Custom scripts that run in close time proximity to the encryption step can interfere and cause this failure.</span></span> <span data-ttu-id="9f0fd-115">Detta kan inträffa när en Resource Manager-mall definierar flera tillägg för att köra samtidigt, eller när tillägget för anpassat skript eller annan åtgärd som körs samtidigt för diskkryptering.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-115">This can happen when a Resource Manager template defines multiple extensions to execute simultaneously, or when a custom script extension or other action is run simultaneously to disk encryption.</span></span>   <span data-ttu-id="9f0fd-116">Serialisering och isolera sådana åtgärder kan lösa problemet.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-116">Serializing and isolating such steps may resolve the issue.</span></span>
- <span data-ttu-id="9f0fd-117">När SELinux inte har inaktiverats innan du aktiverar kryptering, misslyckas koppla från steget.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-117">When SELinux has not been disabled prior to enabling encryption, the unmount step fails.</span></span>  <span data-ttu-id="9f0fd-118">SELinux kan aktiveras igen efter kryptering har slutförts.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-118">SELinux can be re-enabled after encryption has completed.</span></span>
- <span data-ttu-id="9f0fd-119">När OS-disken använder ett LVM schema (även om det finns stöd för diskar begränsad LVM data LVM OS-disken är inte)</span><span class="sxs-lookup"><span data-stu-id="9f0fd-119">When the OS disk is using an LVM scheme (although limited LVM data disk support is available, LVM OS disk is not)</span></span>
- <span data-ttu-id="9f0fd-120">När minimikraven på minne är inte uppfyllda (7GB rekommenderas för OS-diskkryptering)</span><span class="sxs-lookup"><span data-stu-id="9f0fd-120">When minimum memory requirements are not met (7GB is suggested for OS disk encryption)</span></span>
- <span data-ttu-id="9f0fd-121">När dataenheter har rekursivt monteras under /mnt/ katalog eller varandra (till exempel /mnt/data1, /mnt/data2, /data3 + /data3/data4 osv.)</span><span class="sxs-lookup"><span data-stu-id="9f0fd-121">When data drives have been recursively mounted under /mnt/ directory, or each other (for example, /mnt/data1, /mnt/data2, /data3 + /data3/data4, etc.)</span></span>
- <span data-ttu-id="9f0fd-122">När andra Azure Disk Encryption [krav](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) för Linux är inte uppfyllda</span><span class="sxs-lookup"><span data-stu-id="9f0fd-122">When other Azure Disk Encryption [prerequisites](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) for Linux are not met</span></span>

## <a name="unable-to-encrypt"></a><span data-ttu-id="9f0fd-123">Det gick inte att kryptera</span><span class="sxs-lookup"><span data-stu-id="9f0fd-123">Unable to encrypt</span></span>

<span data-ttu-id="9f0fd-124">I vissa fall har Linux diskkryptering verkar ha fastnat i ”OS-disken kryptering igång” och SSH inaktiverats.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-124">In some cases, the Linux disk encryption appears to be stuck at "OS disk encryption started" and SSH is disabled.</span></span> <span data-ttu-id="9f0fd-125">Den här processen kan ta mellan 3-16 timmar att slutföra en bild lager galleriet.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-125">This process can take between 3-16 hours to complete on a stock gallery image.</span></span>  <span data-ttu-id="9f0fd-126">Om flera TB datadiskar läggs kan processen ta dagar.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-126">If multi-TB size data disks are added, the process may take days.</span></span> <span data-ttu-id="9f0fd-127">Linux-Operativsystemdatorn disk encryption sekvensen demonterar enhetens OS tillfälligt och utför block för block kryptering av hela OS-disken innan ommontering i det kryptera tillståndet.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-127">The Linux OS disk encryption sequence unmounts the OS drive temporarily, and performs block by block encryption of the entire OS disk, before remounting it in its encrypted state.</span></span>   <span data-ttu-id="9f0fd-128">Till skillnad från Azure Disk Encryption i Windows tillåter Linux-diskkryptering inte samtidig användning av den virtuella datorn medan kryptering pågår.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-128">Unlike Azure Disk Encryption on Windows, Linux Disk Encryption does not allow concurrent use of the VM while the encryption is in progress.</span></span>  <span data-ttu-id="9f0fd-129">Prestandaegenskaperna för den virtuella datorn, inklusive storleken på disken och om lagringskontot backas upp av standard- eller premium (SSD) lagring kan avsevärt påverka den tid som krävs till fullständig kryptering.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-129">The performance characteristics of the VM, including the size of the disk and whether the storage account is backed by standard or premium (SSD) storage, can greatly influence the time required to complete encryption.</span></span>

<span data-ttu-id="9f0fd-130">Om du vill kontrollera status för fältet ProgressMessage som returnerades från den [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) kommando kan användas.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-130">To check status, the ProgressMessage field returned from the [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) command can be polled.</span></span>   <span data-ttu-id="9f0fd-131">När OS-enheten krypteras den virtuella datorn försätts i tillståndet underhåll och SSH också inaktiveras för att förhindra eventuella avbrott i den pågående processen.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-131">While the OS drive is being encrypted, the VM enters a servicing state, and SSH is also disabled to prevent any disruption to the ongoing process.</span></span>  <span data-ttu-id="9f0fd-132">EncryptionInProgress rapporteras för flesta av tiden medan kryptering pågår, följt av flera timmar senare med en VMRestartPending meddelande där uppmanas att starta om den virtuella datorn.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-132">EncryptionInProgress will be reported for the majority of the time while encryption is in progress, followed several hours later with a VMRestartPending message prompting to restart the VM.</span></span>  <span data-ttu-id="9f0fd-133">Exempel:</span><span class="sxs-lookup"><span data-stu-id="9f0fd-133">For example:</span></span>


```
PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot the VM
```

<span data-ttu-id="9f0fd-134">När du uppmanas att starta om den virtuella datorn efter att starta om den virtuella datorn och ger 2 – 3 minuter för datorn startats och sista stegen utförs på måldatorn, visar statusmeddelandet att kryptering slutligen har slutförts.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-134">Once prompted to reboot the VM, and after restarting the VM, and giving 2-3 minutes for the reboot and for final steps to be performed on the target, the status message will indicate that encryption has finally completed.</span></span>   <span data-ttu-id="9f0fd-135">När det här meddelandet är tillgänglig, förväntas den krypterade enheten OS vara redo för användning och för den virtuella datorn att användas igen.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-135">Once this message is available, the encrypted OS drive is expected to be ready for use and for the VM to be usable again.</span></span>

<span data-ttu-id="9f0fd-136">I fall där den här sekvensen inte påträffades, eller om boot information, pågående meddelande eller andra felindikatorer rapportera att OS-kryptering misslyckades mitt i den här processen (till exempel om du ser felet ”Det gick inte att demontera” som beskrivs i den här guiden), rekommenderas att återställa den virtuella datorn till ögonblicksbild eller säkerhetskopior som gjorts omedelbart före kryptering.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-136">In cases where this sequence was not seen, or if boot information, progress message, or other error indicators report that OS encryption has failed in the middle of this process (for example if you are seeing the "failed to unmount" error described in this guide), it is recommended to restore the VM back to the snapshot or backup taken immediately prior to encryption.</span></span>  <span data-ttu-id="9f0fd-137">Innan nästa försök rekommenderas att omvärdera egenskaperna för den virtuella datorn och se till att alla krav är uppfyllda.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-137">Prior to the next attempt, it is suggested to re-evaluate the characteristics of the VM and ensure that all prerequisites are satisfied.</span></span>

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a><span data-ttu-id="9f0fd-138">Felsöka Azure Disk Encryption bakom en brandvägg</span><span class="sxs-lookup"><span data-stu-id="9f0fd-138">Troubleshooting Azure Disk Encryption behind a Firewall</span></span>
<span data-ttu-id="9f0fd-139">När anslutningen är begränsad av en brandvägg, proxy krav eller grupp (NSG) för nätverkssäkerhet, kan möjligheten att utföra uppgifter som krävs av tillägget avbrytas.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-139">When connectivity is restricted by a firewall, proxy requirement, or network security group (NSG) settings, the ability of the extension to perform needed tasks can be disrupted.</span></span>   <span data-ttu-id="9f0fd-140">Detta kan resultera i statusmeddelanden, till exempel ”tillståndets status är inte tillgänglig på den virtuella datorn” och i förväntade scenarier som inte kan slutföras.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-140">This can result in status messages such as "Extension status not available on the VM" and in expected scenarios failing to finish.</span></span>  <span data-ttu-id="9f0fd-141">Avsnitten som följer har några vanliga brandväggsproblem som du kan undersöka.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-141">The sections that follow has some common firewall issues that you may investigate.</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="9f0fd-142">Nätverkssäkerhetsgrupper</span><span class="sxs-lookup"><span data-stu-id="9f0fd-142">Network security groups</span></span>
<span data-ttu-id="9f0fd-143">En grupp för nätverkssäkerhet tillämpas fortfarande måste tillåta slutpunkten att uppfylla dokumenterade nätverkskonfigurationen [krav](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) för diskkryptering.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-143">Any network security group settings applied must still allow the endpoint to meet the documented network configuration [prerequisites](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) for disk encryption.</span></span>

### <a name="azure-keyvault-behind-firewall"></a><span data-ttu-id="9f0fd-144">Azure Keyvault bakom brandväggen</span><span class="sxs-lookup"><span data-stu-id="9f0fd-144">Azure Keyvault behind firewall</span></span>
<span data-ttu-id="9f0fd-145">Den virtuella datorn måste kunna komma åt nyckelvalvet.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-145">The VM must be able to access key vault.</span></span> <span data-ttu-id="9f0fd-146">Referera till hjälp med åtkomst till viktiga fel finns bakom en brandvägg som underhålls av den [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) team.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-146">Refer to guidance on access to key fault from behind a firewall that is maintained by the [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) team.</span></span>

### <a name="linux-package-management-behind-firewall"></a><span data-ttu-id="9f0fd-147">Linux-paketet management bakom brandväggen</span><span class="sxs-lookup"><span data-stu-id="9f0fd-147">Linux package management behind firewall</span></span>
<span data-ttu-id="9f0fd-148">Azure Disk Encryption för Linux bygger på mål-distribution systemet för pakethantering att installera nödvändiga komponenter innan du aktiverar kryptering vid körning.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-148">At run time, Azure Disk Encryption for Linux relies on the target distribution’s package management system to install needed prerequisite components prior to enabling encryption.</span></span>  <span data-ttu-id="9f0fd-149">Brandväggsinställningar förhindrar att den virtuella datorn från att kunna ladda ned och installera komponenterna, förväntas efterföljande försök.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-149">If firewall settings prevent the VM from being able to download and install these components, then subsequent failures are expected.</span></span>    <span data-ttu-id="9f0fd-150">Hur du konfigurerar detta kan variera av distribution.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-150">The steps to configure this may vary by distribution.</span></span>  <span data-ttu-id="9f0fd-151">På Red Hat säkerställer att prenumerationen manager och yum har ställts in korrekt det är viktigt att när en proxyserver krävs.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-151">On Red Hat, when a proxy is required, ensuring that subscription-manager and yum are set up properly is vital.</span></span>  <span data-ttu-id="9f0fd-152">Se [detta](https://access.redhat.com/solutions/189533) Red Hat support-artikeln om det här avsnittet.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-152">See [this](https://access.redhat.com/solutions/189533) Red Hat support article on this topic.</span></span>  

## <a name="troubleshooting-windows-server-2016-server-core"></a><span data-ttu-id="9f0fd-153">Felsöka Windows Server 2016 Server Core</span><span class="sxs-lookup"><span data-stu-id="9f0fd-153">Troubleshooting Windows Server 2016 Server Core</span></span>

<span data-ttu-id="9f0fd-154">Bdehdcfg-komponenten är inte tillgängligt som standard på Windows Server 2016 Server Core.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-154">On Windows Server 2016 Server Core, the bdehdcfg component is not available by default.</span></span> <span data-ttu-id="9f0fd-155">Den här komponenten krävs av Azure Disk Encryption.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-155">This component is required by Azure Disk Encryption.</span></span>

<span data-ttu-id="9f0fd-156">För att lösa problemet, kopiera följande 4 filer från en Windows Server 2016 Data Center VM till mappen c:\windows\system32 för Server Core-avbildningen:</span><span class="sxs-lookup"><span data-stu-id="9f0fd-156">To workaround this issue, copy the following 4 files from a Windows Server 2016 Data Center VM to the c:\windows\system32 folder of the Server Core image:</span></span>

```
bdehdcfg.exe
bdehdcfglib.dll
bdehdcfglib.dll.mui
bdehdcfg.exe.mui
```

<span data-ttu-id="9f0fd-157">Kör sedan följande kommando:</span><span class="sxs-lookup"><span data-stu-id="9f0fd-157">Then, run the following command:</span></span>

```
bdehdcfg.exe -target default
```

<span data-ttu-id="9f0fd-158">Detta skapar en partition 550MB och sedan efter en omstart, du kan använda Diskpart Kontrollera volymerna och fortsätta.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-158">This will create a 550MB system partition and then after a reboot, you can use Diskpart to check the volumes, and proceed.</span></span>  

<span data-ttu-id="9f0fd-159">Exempel:</span><span class="sxs-lookup"><span data-stu-id="9f0fd-159">For example:</span></span>

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```
## <a name="see-also"></a><span data-ttu-id="9f0fd-160">Se även</span><span class="sxs-lookup"><span data-stu-id="9f0fd-160">See also</span></span>
<span data-ttu-id="9f0fd-161">I det här dokumentet du lära dig mer om några vanliga problem i Azure disk encryption och hur du felsöker.</span><span class="sxs-lookup"><span data-stu-id="9f0fd-161">In this document, you learned more about some common issues in Azure disk encryption, and how to troubleshoot.</span></span> <span data-ttu-id="9f0fd-162">Mer information om den här tjänsten och dess funktioner:</span><span class="sxs-lookup"><span data-stu-id="9f0fd-162">For more information about this service and its capability read:</span></span>

- [<span data-ttu-id="9f0fd-163">Tillämpa diskkryptering i Azure Security Center</span><span class="sxs-lookup"><span data-stu-id="9f0fd-163">Apply disk encryption in Azure Security Center</span></span>](https://docs.microsoft.com/azure/security-center/security-center-apply-disk-encryption)
- [<span data-ttu-id="9f0fd-164">Kryptera en virtuell Azure-dator</span><span class="sxs-lookup"><span data-stu-id="9f0fd-164">Encrypt an Azure Virtual Machine</span></span>](https://docs.microsoft.com/azure/security-center/security-center-disk-encryption)
- [<span data-ttu-id="9f0fd-165">Azure Data kryptering i vila</span><span class="sxs-lookup"><span data-stu-id="9f0fd-165">Azure Data Encryption-at-Rest</span></span>](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)
