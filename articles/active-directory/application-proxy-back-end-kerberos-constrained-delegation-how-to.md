---
title: "Så här konfigurerar du ett Application Proxy-program att använda Kerberos-begränsad delegering | Microsoft Docs"
description: "Hur du konfigurerar Kerberos-begränsad delegering för ett program för Azure AD Application Proxy."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="d81ef-103">Så här konfigurerar du ett Application Proxy-program att använda Kerberos-begränsad delegering</span><span class="sxs-lookup"><span data-stu-id="d81ef-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="d81ef-104">Metoderna för att uppnå SSO till publicerade program något kan variera från program och ett av alternativen som Azure Application Proxy innehåller direkt, är Kerberos-begränsad delegering (KCD).</span><span class="sxs-lookup"><span data-stu-id="d81ef-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="d81ef-105">Detta är där en värd för anslutningen är konfigurerad för att utföra begränsad kerberos-autentisering till backend-program för användare.</span><span class="sxs-lookup"><span data-stu-id="d81ef-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="d81ef-106">Den faktiska proceduren för att aktivera KCD är relativt enkla och kräver normalt inte fler än en förståelse av de olika komponenter och autentiseringsflödet som underlättar enkel inloggning.</span><span class="sxs-lookup"><span data-stu-id="d81ef-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="d81ef-107">Hitta bra informationskällor för att felsöka scenarier där KCD SSO inte fungerar som förväntat, kan vara null-optimerad.</span><span class="sxs-lookup"><span data-stu-id="d81ef-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="d81ef-108">Därför försöker den här artikeln ger en enda åtkomstpunkt för referens som bör underlätta felsökning och automatisk reparera några av de vanligaste problem som vi finns.</span><span class="sxs-lookup"><span data-stu-id="d81ef-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="d81ef-109">Erbjuder ytterligare vägledning för att diagnostisera komplexa och skadade för implementering samtidigt.</span><span class="sxs-lookup"><span data-stu-id="d81ef-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="d81ef-110">Observera att den här artikeln gör följande antaganden:</span><span class="sxs-lookup"><span data-stu-id="d81ef-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="d81ef-111">Azure Application Proxy har distribuerats enligt våra [dokumentationen](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) och allmän åtkomst till icke KCD program fungerar som förväntat.</span><span class="sxs-lookup"><span data-stu-id="d81ef-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="d81ef-112">Publicerade målprogrammet baseras på IIS och Microsofts implementering av kerberos.</span><span class="sxs-lookup"><span data-stu-id="d81ef-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="d81ef-113">Server- och värdar placeras i en enda Active Directory-domän.</span><span class="sxs-lookup"><span data-stu-id="d81ef-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="d81ef-114">Detaljerad information om mellan domäner och skogar scenarier finns i vår [KCD whitepaper](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="d81ef-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="d81ef-115">Programmet har publicerats i en Azure-klient med förautentisering aktiverade och användare förväntas att autentisera till Azure via formulärbaserad autentisering.</span><span class="sxs-lookup"><span data-stu-id="d81ef-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="d81ef-116">Rich-klient autentiseringsscenarier omfattas inte av den här artikeln, men läggas på någon punkt i framtiden.</span><span class="sxs-lookup"><span data-stu-id="d81ef-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="d81ef-117">Krav</span><span class="sxs-lookup"><span data-stu-id="d81ef-117">Prerequisites</span></span>

<span data-ttu-id="d81ef-118">Azure Application Proxy kan distribueras till nästan alla typer av infrastruktur eller miljön och arkitekturerna säkert variera mellan olika företag.</span><span class="sxs-lookup"><span data-stu-id="d81ef-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="d81ef-119">En av de vanligaste orsakerna till KCD relaterade problem inte är miljöer, men ganska enkelt att konfigurationer eller allmänna tillsyn.</span><span class="sxs-lookup"><span data-stu-id="d81ef-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="d81ef-120">Därför våra är alltid att starta genom att kontrollera att du har uppfyllt alla krav som anges i vår main [med KCD enkel inloggning med Application Proxy-artikel](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) innan du startar felsökning.</span><span class="sxs-lookup"><span data-stu-id="d81ef-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="d81ef-121">Särskilt avsnittet om hur du konfigurerar KCD på 2012R2, eftersom det använder ett helt olika sätt att konfigurera KCD på tidigare versioner av Windows, utan även när du är uppmärksam på flera saker:</span><span class="sxs-lookup"><span data-stu-id="d81ef-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="d81ef-122">Det är inte ovanligt att en domänmedlemsserver att öppna en dialogruta med säker kanal med en specifik domänkontrollant.</span><span class="sxs-lookup"><span data-stu-id="d81ef-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="d81ef-123">Flytta sedan till en annan dialogruta samtidigt, så att anslutningen värdar vanligtvis inte begränsas till att kunna kommunicera med endast specifika lokala plats domänkontrollanter.</span><span class="sxs-lookup"><span data-stu-id="d81ef-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="d81ef-124">Liknar ovan punkten över domäner scenarier som förlitar sig på referenser som en värd för anslutningen till domänkontrollanter som finns utanför nätverket perimeternätverket.</span><span class="sxs-lookup"><span data-stu-id="d81ef-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="d81ef-125">I det här fallet är det lika viktigt att se till att du även tillåter trafik och senare till domänkontrollanter som representerar andra respektive domäner eller annan delegering misslyckas.</span><span class="sxs-lookup"><span data-stu-id="d81ef-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="d81ef-126">Om möjligt bör bör du inte släpps alla aktiva IP-adresser/ID: N mellan värddatorer för anslutningen och domänkontrollanter, eftersom dessa ibland över påträngande och störa core RPC-trafik</span><span class="sxs-lookup"><span data-stu-id="d81ef-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="d81ef-127">Så mycket som vi vill att snabbt lösa problem och effektivt, det kan ta tid, så om möjligt du försök och testa delegering i den enklaste av scenarier.</span><span class="sxs-lookup"><span data-stu-id="d81ef-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="d81ef-128">Flera variabler du införa, Ju mer du kan behöva tävla med.</span><span class="sxs-lookup"><span data-stu-id="d81ef-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="d81ef-129">Till exempel begränsa testningen till en enskild koppling kan spara värdefull tid och ytterligare kopplingar kan läggas till efter problemen har lösts.</span><span class="sxs-lookup"><span data-stu-id="d81ef-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="d81ef-130">Vissa miljöfaktorer kan även bidra till ett ärende så igen om möjligt försök och minimera arkitektur för att en minsta för testning.</span><span class="sxs-lookup"><span data-stu-id="d81ef-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="d81ef-131">Till exempel felkonfigurerad intern brandvägg ACL: er är inte ovanliga, om möjligt har all trafik från en koppling får rakt igenom domänkontrollanter och backend-programmet.</span><span class="sxs-lookup"><span data-stu-id="d81ef-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="d81ef-132">Det absoluta enklast att placera kopplingar är faktiskt så nära sina mål kan vara.</span><span class="sxs-lookup"><span data-stu-id="d81ef-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="d81ef-133">Med en brandvägg lö infogad medan testning bara lägger till onödiga komplexitet och kan bara förlänga din undersökningar.</span><span class="sxs-lookup"><span data-stu-id="d81ef-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="d81ef-134">Så, vad som utgör en KCD problemet ändå?</span><span class="sxs-lookup"><span data-stu-id="d81ef-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="d81ef-135">Det flera klassiska indikationer på KCD SSO misslyckas och de första tecknen på ett problem vanligtvis manifest sig själva i webbläsaren.</span><span class="sxs-lookup"><span data-stu-id="d81ef-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![Felaktig KCD-konfigurationsfel](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Auktoriseringen misslyckades på grund av saknade behörigheter](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="d81ef-138">alla de bär samma symtom på att utföra en enkel inloggning inte och därför neka användaråtkomst till programmet.</span><span class="sxs-lookup"><span data-stu-id="d81ef-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="d81ef-139">Felsökning</span><span class="sxs-lookup"><span data-stu-id="d81ef-139">Troubleshooting</span></span>

<span data-ttu-id="d81ef-140">Hur du sedan felsöka beror på problemet och observeras symptom.</span><span class="sxs-lookup"><span data-stu-id="d81ef-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="d81ef-141">Innan kommer alla skulle ytterligare föreslår vi följande länkar, eftersom de innehåller användbar information som du inte får ännu har komma över:</span><span class="sxs-lookup"><span data-stu-id="d81ef-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="d81ef-142">Felsökning av problem med Application Proxy och felmeddelanden</span><span class="sxs-lookup"><span data-stu-id="d81ef-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="d81ef-143">Kerberos-fel och problem</span><span class="sxs-lookup"><span data-stu-id="d81ef-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="d81ef-144">Arbeta med enkel inloggning när lokalt och i molnet identiteter är inte identiska</span><span class="sxs-lookup"><span data-stu-id="d81ef-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="d81ef-145">Om du har den här långt, sedan viktigaste problemet definitivt finns.</span><span class="sxs-lookup"><span data-stu-id="d81ef-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="d81ef-146">Du behöver gräva djupare, så starta genom att avgränsa flödet in i tre olika steg som du kan felsöka.</span><span class="sxs-lookup"><span data-stu-id="d81ef-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="d81ef-147">**Förautentisering av klient** – den externa användaren autentiserar till Azure via en webbläsare.</span><span class="sxs-lookup"><span data-stu-id="d81ef-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="d81ef-148">Att kunna autentisera före till Azure är absolut nödvändigt för KCD SSO till funktionen.</span><span class="sxs-lookup"><span data-stu-id="d81ef-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="d81ef-149">Detta bör testas och åtgärdas först om det uppstår några problem.</span><span class="sxs-lookup"><span data-stu-id="d81ef-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="d81ef-150">Observera att förautentisering steg har ingen relation till KCD eller publicerade program.</span><span class="sxs-lookup"><span data-stu-id="d81ef-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="d81ef-151">Det bör vara ganska enkelt att korrigera skillnader genom förstånd kontrollerar ämne kontot finns i Azure och att det har inaktiverats/inte blockeras.</span><span class="sxs-lookup"><span data-stu-id="d81ef-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="d81ef-152">Felsvar i webbläsaren är vanligtvis tillräckligt beskrivande att förstå orsaken.</span><span class="sxs-lookup"><span data-stu-id="d81ef-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="d81ef-153">Du kan också kontrollera vår andra felsöka dokumentation för att kontrollera om du är osäker.</span><span class="sxs-lookup"><span data-stu-id="d81ef-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="d81ef-154">**Delegering service** – Azure Proxy-anslutningen att få en kerberos-tjänstbiljett från en KDC (Kerberos Distribution Center) åt användare.</span><span class="sxs-lookup"><span data-stu-id="d81ef-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="d81ef-155">Extern kommunikation mellan klienten och Azure klientdelen bör har ingen betydelse KCD över huvud taget, andra än att säkerställa att det fungerar.</span><span class="sxs-lookup"><span data-stu-id="d81ef-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="d81ef-156">Det här är så Azure Proxy-tjänst kan tillhandahållas med ett giltigt användar-ID som användas för att få en kerberos-biljett.</span><span class="sxs-lookup"><span data-stu-id="d81ef-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="d81ef-157">Utan den här KCD är inte möjligt och skulle misslyckas.</span><span class="sxs-lookup"><span data-stu-id="d81ef-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="d81ef-158">Som tidigare nämnts innehåller felmeddelanden webbläsare normalt vissa tecken på varför saker inte.</span><span class="sxs-lookup"><span data-stu-id="d81ef-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="d81ef-159">Se till att notera aktivitets-ID och tidsstämpel i svaret när detta att du kan korrelera funktionssätt faktiska händelser i händelseloggen Azure Proxy.</span><span class="sxs-lookup"><span data-stu-id="d81ef-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Felaktig KCD-konfigurationsfel](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="d81ef-161">Och motsvarande poster visas i händelseloggen skulle ses som händelser 13019 eller 12027.</span><span class="sxs-lookup"><span data-stu-id="d81ef-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="d81ef-162">Du kan hitta connector händelseloggarna i **program- och tjänstloggar** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span><span class="sxs-lookup"><span data-stu-id="d81ef-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Händelsen 13019 från Application Proxy-händelseloggen](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Händelsen 12027 från Application Proxy-händelseloggen](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="d81ef-165">Använd en A-post i din interna DNS för programmets adress och inte en CNAME-post</span><span class="sxs-lookup"><span data-stu-id="d81ef-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="d81ef-166">Nytt bekräfta att kopplingen värden har beviljats behörighet att delegera till den avsedda målkonto SPN och **Använd valfritt autentiseringsprotokoll** är markerad.</span><span class="sxs-lookup"><span data-stu-id="d81ef-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="d81ef-167">Detta beskrivs i vår huvudsakliga [SSO configuration artikel](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span><span class="sxs-lookup"><span data-stu-id="d81ef-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="d81ef-168">Kontrollera att det finns bara en instans av SPN finns i AD genom att utfärda en **setspn - x** från en kommandotolk på alla värddatorer för medlem av domänen</span><span class="sxs-lookup"><span data-stu-id="d81ef-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="d81ef-169">Kontrollera om en domänprincip tillämpas ska begränsa den [max storlek på kerberos-utfärdade token](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), vilket kan detta förhindra kopplingen från att erhålla ett token om befunnits vara mycket</span><span class="sxs-lookup"><span data-stu-id="d81ef-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="d81ef-170">En spårning i nätverket som avbildar utbyten mellan connector-värd och en domän KDC blir bästa nästa steg att få mer låg nivå information om problemen.</span><span class="sxs-lookup"><span data-stu-id="d81ef-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="d81ef-171">Du hittar det i [ingående felsöka papper](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="d81ef-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="d81ef-172">Du bör se en händelse i loggarna om att autentiseringen misslyckades på grund av det program som returnerar ett 401 om biljetter ser bra ut.</span><span class="sxs-lookup"><span data-stu-id="d81ef-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="d81ef-173">Detta tyder oftast som målprogrammet avvisa din biljett, så gå vidare med följande nästa steg.</span><span class="sxs-lookup"><span data-stu-id="d81ef-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="d81ef-174">**Målprogrammet** -konsumenter av kerberos-biljetten som tillhandahålls av kopplingen</span><span class="sxs-lookup"><span data-stu-id="d81ef-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="d81ef-175">I det här skedet förväntas kopplingen har skickat en kerberos-tjänstbiljett till serverdelen, som en rubrik i den första programbegäran.</span><span class="sxs-lookup"><span data-stu-id="d81ef-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="d81ef-176">Med hjälp av programmets Intern URL som definierats i portalen, verifiera att programmet är tillgänglig direkt från webbläsaren på värden för anslutningen.</span><span class="sxs-lookup"><span data-stu-id="d81ef-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="d81ef-177">Sedan du logga in utan problem.</span><span class="sxs-lookup"><span data-stu-id="d81ef-177">Then you can login successfully.</span></span> <span data-ttu-id="d81ef-178">Information om hur du gör detta finns på sidan connector felsökning.</span><span class="sxs-lookup"><span data-stu-id="d81ef-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="d81ef-179">Bekräfta att autentiseringen mellan webbläsaren och programmet använder kerberos, genom att göra något av följande fortfarande på connector-värden:</span><span class="sxs-lookup"><span data-stu-id="d81ef-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="d81ef-180">Köra verktyg för utveckling (**F12**) i Internet Explorer eller Använd [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) från connector-värden.</span><span class="sxs-lookup"><span data-stu-id="d81ef-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="d81ef-181">Gå till det program som använder intern URL och inspektera de erbjudna WWW auktorisering huvuden som returnerades i svaret från programmet, så som antingen förhandla eller kerberos finns.</span><span class="sxs-lookup"><span data-stu-id="d81ef-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="d81ef-182">En efterföljande kerberos-blob som returneras i svaret från webbläsaren till programmet normalt börjar med **YII**, så det här är en bra indikation på kerberos som i play.</span><span class="sxs-lookup"><span data-stu-id="d81ef-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="d81ef-183">NTLM å andra sidan börja alltid med **TlRMTVNTUAAB**, som läser NTLMSSP när avkoda från Base64.</span><span class="sxs-lookup"><span data-stu-id="d81ef-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="d81ef-184">Om du ser **TlRMTVNTUAAB** i början av blob, det innebär att Kerberos **inte** tillgängliga.</span><span class="sxs-lookup"><span data-stu-id="d81ef-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="d81ef-185">Om du inte ser detta Kerberos sannolikt tillgängliga.</span><span class="sxs-lookup"><span data-stu-id="d81ef-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="d81ef-186">Anteckning om med Fiddler, den här metoden kräver tillfälligt inaktivera utökat skydd på programmets konfiguration i IIS.</span><span class="sxs-lookup"><span data-stu-id="d81ef-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![Webbläsarfönster Nätverkskontroll](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="d81ef-188">*Bild:* eftersom det inte börjar med TIRMTVNTUAAB, detta är ett exempel som att Kerberos är tillgänglig.</span><span class="sxs-lookup"><span data-stu-id="d81ef-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="d81ef-189">Detta är ett exempel på en Kerberos-Blob som inte börjar med YII.</span><span class="sxs-lookup"><span data-stu-id="d81ef-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="d81ef-190">Ta bort NTLM tillfälligt från listan med providers på IIS-webbplats och åtkomst app direkt från Internet Explorer på värden för anslutningen.</span><span class="sxs-lookup"><span data-stu-id="d81ef-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="d81ef-191">Du ska kunna komma åt programmet med hjälp av Kerberos endast med NTLM inte längre i listan med providers.</span><span class="sxs-lookup"><span data-stu-id="d81ef-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="d81ef-192">Om detta misslyckas sedan som tyder på att det finns ett problem med programmets konfiguration och Kerberos-autentisering fungerar inte.</span><span class="sxs-lookup"><span data-stu-id="d81ef-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="d81ef-193">Om Kerberos inte finns, är Kontrollera programmets autentiseringsinställningarna i IIS för att se till att förhandla listas översta med NTLM under den.</span><span class="sxs-lookup"><span data-stu-id="d81ef-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="d81ef-194">(Inte förhandla: kerberos eller Negotiate: PKU2U).</span><span class="sxs-lookup"><span data-stu-id="d81ef-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="d81ef-195">Fortsätt bara om Kerberos fungerar.</span><span class="sxs-lookup"><span data-stu-id="d81ef-195">Only continue if Kerberos is functional.</span></span>

   ![Windows autentiseringsproviders](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="d81ef-197">Med Kerberos- och NTLM på plats kan du tillfälligt inaktivera nu förautentisering för programmet i portalen.</span><span class="sxs-lookup"><span data-stu-id="d81ef-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="d81ef-198">Se om du kan komma åt den från internet med hjälp av den externa Webbadressen.</span><span class="sxs-lookup"><span data-stu-id="d81ef-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="d81ef-199">Du ska bli ombedd att autentisera och ska kunna göra det med samma konto som används i föregående steg.</span><span class="sxs-lookup"><span data-stu-id="d81ef-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="d81ef-200">Om inte det här tyder på problem med backend-programmet och inte KCD alls.</span><span class="sxs-lookup"><span data-stu-id="d81ef-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="d81ef-201">Nu återaktivera förautentisering i portalen och autentisering via Azure genom att försöka ansluta till programmet via extern URL.</span><span class="sxs-lookup"><span data-stu-id="d81ef-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="d81ef-202">Om enkel inloggning har misslyckats bör du se felmeddelandet otillåtna i webbläsaren, samt händelsen 13022 i loggen:</span><span class="sxs-lookup"><span data-stu-id="d81ef-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="d81ef-203">*Microsoft AAD Application Proxy Connector autentisera inte användaren eftersom backend-servern svarar på Kerberos autentiseringsförsök med ett HTTP 401-fel.*</span><span class="sxs-lookup"><span data-stu-id="d81ef-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![HTTTP 401 förbjudet fel](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="d81ef-205">Kontrollera IIS-program så konfigurerade programpoolen är konfigurerad för att använda samma konto som SPN har konfigurerats mot i AD, genom att navigera i IIS som på bilden nedan</span><span class="sxs-lookup"><span data-stu-id="d81ef-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![IIS-konfigurationsfönstret](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="d81ef-207">När du känner till identiteten konfigureras definitivt problemet följande från en kommandotolk för att se till att det här kontot med SPN i fråga.</span><span class="sxs-lookup"><span data-stu-id="d81ef-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="d81ef-208">Till exempel **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="d81ef-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![SetSPN-kommandofönster](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="d81ef-210">Kontrollera att SPN definieras programinställningar i portalen är samma SPN som är konfigurerad mot AD-målkonto används av programpoolen app</span><span class="sxs-lookup"><span data-stu-id="d81ef-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![SPN-konfigurationen i Azure Portal](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="d81ef-212">Gå till IIS och välj den **Konfigurationsredigeraren** för programmet och gå till **system.webServer/security/authentication/windowsAuthentication** du se till att  **UseAppPoolCredentials** har angetts till true</span><span class="sxs-lookup"><span data-stu-id="d81ef-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![IIS-konfiguration app pooler autentiseringsuppgifter alternativet](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="d81ef-214">När är användbart i bättre prestanda för Kerberos-åtgärder, lämnar Kernel-läge har aktiverats även gör biljett för den begärda tjänsten som ska dekrypteras med hjälp av datorkontot.</span><span class="sxs-lookup"><span data-stu-id="d81ef-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="d81ef-215">Detta kallas även det lokala systemet så har det angetts till true break KCD när programmet ligger över flera servrar i en grupp.</span><span class="sxs-lookup"><span data-stu-id="d81ef-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="d81ef-216">Som en ytterligare kontroll du även vill inaktivera den **utökad** skydd för.</span><span class="sxs-lookup"><span data-stu-id="d81ef-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="d81ef-217">Det har förekommit påträffade scenarier där detta har visat för att bryta KCD när aktiverat i mycket specifika konfigurationer där ett program publiceras som en undermapp för standardwebbplatsen.</span><span class="sxs-lookup"><span data-stu-id="d81ef-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="d81ef-218">Den här själva har konfigurerats för anonym autentisering, lämnar hela dialogrutorna nedtonat tyder på underordnade objekt inte kan ärva active inställningar.</span><span class="sxs-lookup"><span data-stu-id="d81ef-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="d81ef-219">Men där möjliga alltid rekommenderar vi med alternativet är aktiverat, så av alla menat testa, men glöm inte att återställa den till aktiverad.</span><span class="sxs-lookup"><span data-stu-id="d81ef-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="d81ef-220">Dessa ytterligare kontroller bör ha spärra du spåra att börja använda ditt publicerade program.</span><span class="sxs-lookup"><span data-stu-id="d81ef-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="d81ef-221">Du kan gå vidare och få igång ytterligare kopplingar som också har konfigurerats för att delegera, men om saker är ingen ytterligare sedan skulle föreslår vi en läsning av våra mer ingående tekniska genomgången [fullständig guide för felsökning av Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="d81ef-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="d81ef-222">Om du är fortfarande inte vidare problemet gärna stöd mer än hjälpa och fortsätta härifrån.</span><span class="sxs-lookup"><span data-stu-id="d81ef-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="d81ef-223">Skapa ett supportärende direkt i portalen och våra tekniker ska nå ut till dig.</span><span class="sxs-lookup"><span data-stu-id="d81ef-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="d81ef-224">Andra scenarier</span><span class="sxs-lookup"><span data-stu-id="d81ef-224">Other scenarios</span></span>

-   <span data-ttu-id="d81ef-225">Azure Application Proxy begär en Kerberos-biljett innan du skickar en begäran till ett program.</span><span class="sxs-lookup"><span data-stu-id="d81ef-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="d81ef-226">Vissa 3 partsprogram, till exempel Tableau Server som inte den här metoden för att autentisera och snarare förväntar sig mer konventionella förhandlingarna som äger rum.</span><span class="sxs-lookup"><span data-stu-id="d81ef-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="d81ef-227">Den första begäranden är anonyma, så att programmet att svara med autentiseringstyper stöder via ett 401.</span><span class="sxs-lookup"><span data-stu-id="d81ef-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="d81ef-228">Dubbla hopp autentisering - ofta används i scenarier där ett program nivåer, med en serverdelen och front end båda kräver autentisering, till exempel SQL Reporting Services.</span><span class="sxs-lookup"><span data-stu-id="d81ef-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d81ef-229">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="d81ef-229">Next steps</span></span>
[<span data-ttu-id="d81ef-230">Konfigurera kerberos-begränsad delegering (KCD) på en hanterad domän</span><span class="sxs-lookup"><span data-stu-id="d81ef-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
