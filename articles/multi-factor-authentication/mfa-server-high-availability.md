---
title: "aaaConfigure Azure MFA-Server för hög tillgänglighet | Microsoft Docs"
description: "Distribuera flera instanser av Azure Multi-Factor Authentication-Server i konfigurationer som ger hög tillgänglighet."
services: multi-factor-authentication
keywords: Azure MFA
documentationcenter: 
author: MicrosoftGuyJFlo
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/23/2017
ms.author: joflore
ms.reviewer: alexwe
ms.custom: it-pro
ms.openlocfilehash: 8c6b1921c734c7a7273e443b3591fbbb15cd5e6c
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/06/2017
---
# <a name="configure-azure-multi-factor-authentication-server-for-high-availability"></a><span data-ttu-id="360e8-104">Konfigurera Azure Multi-Factor Authentication-servern för hög tillgänglighet</span><span class="sxs-lookup"><span data-stu-id="360e8-104">Configure Azure Multi-Factor Authentication Server for high availability</span></span>

<span data-ttu-id="360e8-105">tooachieve hög tillgänglighet med Azure MFA för Server-distribution måste toodeploy flera MFA-servrar.</span><span class="sxs-lookup"><span data-stu-id="360e8-105">tooachieve high-availability with your Azure Server MFA deployment, you need toodeploy multiple MFA servers.</span></span> <span data-ttu-id="360e8-106">Det här avsnittet innehåller information om en belastningsutjämnad design tooachieve dina mål för hög tillgänglighet i du Azure MFS Server-distributionen.</span><span class="sxs-lookup"><span data-stu-id="360e8-106">This section provides information on a load-balanced design tooachieve your high availability targets in you Azure MFS Server deployment.</span></span>

## <a name="mfa-server-overview"></a><span data-ttu-id="360e8-107">Översikt över MFA-Server</span><span class="sxs-lookup"><span data-stu-id="360e8-107">MFA Server overview</span></span>

<span data-ttu-id="360e8-108">hello Azure MFA-servertjänst består av flera komponenter som visas i följande diagram hello:</span><span class="sxs-lookup"><span data-stu-id="360e8-108">hello Azure MFA Server service architecture comprises several components as shown in hello following diagram:</span></span>

 ![Arkitekturen för MFA-Server](./media/mfa-server-high-availability/mfa-ha-architecture.png)

<span data-ttu-id="360e8-110">En MFA-Server är en Windows-Server som har hello Azure Multi-Factor Authentication-programvaran.</span><span class="sxs-lookup"><span data-stu-id="360e8-110">An MFA Server is a Windows Server that has hello Azure Multi-Factor Authentication software installed.</span></span> <span data-ttu-id="360e8-111">Hej MFA-Server-instansen måste aktiveras av hello MFA-tjänsten i Azure toofunction.</span><span class="sxs-lookup"><span data-stu-id="360e8-111">hello MFA Server instance must be activated by hello MFA Service in Azure toofunction.</span></span> <span data-ttu-id="360e8-112">Mer än en MFA-Server kan vara installerad lokalt.</span><span class="sxs-lookup"><span data-stu-id="360e8-112">More than one MFA Server can be installed on-premises.</span></span>

<span data-ttu-id="360e8-113">hello första MFA-Server som är installerad är hello huvudservern MFA vid aktivering av hello Azure MFA-tjänsten som standard.</span><span class="sxs-lookup"><span data-stu-id="360e8-113">hello first MFA Server that is installed is hello master MFA Server upon activation by hello Azure MFA Service by default.</span></span> <span data-ttu-id="360e8-114">hello master MFA-server har en skrivbar kopia av hello PhoneFactor.pfdata databas.</span><span class="sxs-lookup"><span data-stu-id="360e8-114">hello master MFA server has a writeable copy of hello PhoneFactor.pfdata database.</span></span> <span data-ttu-id="360e8-115">Efterföljande installationer av instanser av MFA-Server kallas slaves.</span><span class="sxs-lookup"><span data-stu-id="360e8-115">Subsequent installations of instances of MFA Server are known as slaves.</span></span> <span data-ttu-id="360e8-116">Hej MFA slaves har en replikerad skrivskyddad kopia av hello PhoneFactor.pfdata databas.</span><span class="sxs-lookup"><span data-stu-id="360e8-116">hello MFA slaves have a replicated read-only copy of hello PhoneFactor.pfdata database.</span></span> <span data-ttu-id="360e8-117">MFA-servrarna replikerar information med hjälp av Remote Procedure Call (RPC).</span><span class="sxs-lookup"><span data-stu-id="360e8-117">MFA servers replicate information using Remote Procedure Call (RPC).</span></span> <span data-ttu-id="360e8-118">Alla MFA-servrarna måste gemensamt antingen vara domänanslutna eller fristående tooreplicate information.</span><span class="sxs-lookup"><span data-stu-id="360e8-118">All MFA Severs must collectively either be domain joined or standalone tooreplicate information.</span></span>

<span data-ttu-id="360e8-119">Både MFA master och slav MFA-servrar kommunicerar med hello MFA-tjänsten när tvåfaktorsautentisering krävs.</span><span class="sxs-lookup"><span data-stu-id="360e8-119">Both MFA master and slave MFA Servers communicate with hello MFA Service when two-factor authentication is required.</span></span> <span data-ttu-id="360e8-120">Till exempel när en användare försöker toogain tooan tillämpning som kräver tvåfaktorsautentisering, hello användaren först autentiseras genom en identitetsleverantör, till exempel Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="360e8-120">For example, when a user attempts toogain access tooan application that requires two-factor authentication, hello user will first be authenticated by an identity provider, such as Active Directory (AD).</span></span>

<span data-ttu-id="360e8-121">Efter en lyckad autentisering med AD hello MFA-servern kommunicerar med hello MFA-tjänsten.</span><span class="sxs-lookup"><span data-stu-id="360e8-121">After successful authentication with AD, hello MFA Server will communicate with hello MFA Service.</span></span> <span data-ttu-id="360e8-122">Hej MFA-servern väntar på meddelanden från hello MFA-tjänsten tooallow eller neka hello användarprogram åtkomst toohello.</span><span class="sxs-lookup"><span data-stu-id="360e8-122">hello MFA Server waits for notification from hello MFA Service tooallow or deny hello user access toohello application.</span></span>

<span data-ttu-id="360e8-123">Om hello MFA huvudservern kopplas från autentiseringar kan fortfarande bearbetas, men åtgärder som kräver ändringar toohello MFA databasen kan inte bearbetas.</span><span class="sxs-lookup"><span data-stu-id="360e8-123">If hello MFA master server goes offline, authentications can still be processed, but operations that require changes toohello MFA database cannot be processed.</span></span> <span data-ttu-id="360e8-124">(Exempel: hello tillägg av användare, självbetjäning pinkodsändringar och ändra information om användare)</span><span class="sxs-lookup"><span data-stu-id="360e8-124">(Examples include: hello addition of users, self-service PIN changes, and changing user information)</span></span>

## <a name="deployment"></a><span data-ttu-id="360e8-125">Distribution</span><span class="sxs-lookup"><span data-stu-id="360e8-125">Deployment</span></span>

<span data-ttu-id="360e8-126">Överväg att hello följande viktiga punkter för belastningsutjämning Azure MFA-Server och dess relaterade komponenter.</span><span class="sxs-lookup"><span data-stu-id="360e8-126">Consider hello following important points for load balancing Azure MFA Server and its related components.</span></span>

* <span data-ttu-id="360e8-127">**Med hög tillgänglighet för RADIUS-standard tooachieve**.</span><span class="sxs-lookup"><span data-stu-id="360e8-127">**Using RADIUS standard tooachieve high availability**.</span></span> <span data-ttu-id="360e8-128">Om du använder Azure MFA-servrar som RADIUS-servrar konfigurera du eventuellt en MFA-Server som en primär RADIUS-mål för autentisering och andra Azure MFA-servrar som mål för sekundära autentiseringen.</span><span class="sxs-lookup"><span data-stu-id="360e8-128">If you are using Azure MFA Servers as RADIUS servers, you can potentially configure one MFA Server as a primary RADIUS authentication target and other Azure MFA Servers as secondary authentication targets.</span></span> <span data-ttu-id="360e8-129">Den här metoden tooachieve hög tillgänglighet kan dock inte finnas praktiska eftersom du måste vänta tills en timeout-period toooccur när autentisering misslyckas på hello mål för primär autentisering innan du kan autentiseras mot hello sekundära autentiseringen mål.</span><span class="sxs-lookup"><span data-stu-id="360e8-129">However, this method tooachieve high availability may not be practical because you must wait for a time-out period toooccur when authentication fails on hello primary authentication target before you can be authenticated against hello secondary authentication target.</span></span> <span data-ttu-id="360e8-130">Det är effektivare tooload saldo hello RADIUS-trafik mellan hello RADIUS-klienten och hello RADIUS-servrar (i det här fallet hello Azure MFA-servrar som fungerar som RADIUS-servrar) så att du kan konfigurera hello RADIUS-klienter med en enskild URL som de kan pekar på.</span><span class="sxs-lookup"><span data-stu-id="360e8-130">It is more efficient tooload balance hello RADIUS traffic between hello RADIUS client and hello RADIUS Servers (in this case, hello Azure MFA Servers acting as RADIUS servers) so that you can configure hello RADIUS clients with a single URL that they can point to.</span></span>
* <span data-ttu-id="360e8-131">**Behöver befordra toomanually MFA slaves**.</span><span class="sxs-lookup"><span data-stu-id="360e8-131">**Need toomanually promote MFA slaves**.</span></span> <span data-ttu-id="360e8-132">Om hello Azure MFA huvudservern kopplas från fortsätta hello Azure MFA sekundärservrar tooprocess MFA begäranden.</span><span class="sxs-lookup"><span data-stu-id="360e8-132">If hello master Azure MFA server goes offline, hello secondary Azure MFA Servers continue tooprocess MFA requests.</span></span> <span data-ttu-id="360e8-133">Dock tills en huvudserver MFA finns tillgänglig, Domänadministratörer kan inte lägga till användare eller ändra inställningar för MFA och användare kan inte göra ändringar på hello användarportalen.</span><span class="sxs-lookup"><span data-stu-id="360e8-133">However, until a master MFA server is available, admins can not add users or modify MFA settings, and users can not make changes using hello user portal.</span></span> <span data-ttu-id="360e8-134">Uppgradera en MFA-slavserver toohello rollen är alltid en manuell process.</span><span class="sxs-lookup"><span data-stu-id="360e8-134">Promoting an MFA slave toohello master role is always a manual process.</span></span>
* <span data-ttu-id="360e8-135">**Avskiljbarhet komponenter**.</span><span class="sxs-lookup"><span data-stu-id="360e8-135">**Separability of components**.</span></span> <span data-ttu-id="360e8-136">hello Azure MFA-Server består av flera komponenter som kan installeras på hello samma Windows Server-instans eller på olika instanser.</span><span class="sxs-lookup"><span data-stu-id="360e8-136">hello Azure MFA Server comprises several components that can be installed on hello same Windows Server instance or on different instances.</span></span> <span data-ttu-id="360e8-137">Dessa komponenter omfattar hello Användarportalen, Mobilappwebbtjänsten och hello ADFS-kort (agent).</span><span class="sxs-lookup"><span data-stu-id="360e8-137">These components include hello User Portal, Mobile App Web Service, and hello ADFS adapter (agent).</span></span> <span data-ttu-id="360e8-138">Den här Avskiljbarhet gör det möjligt toouse hello Web Application Proxy toopublish hello Användarportalen och Mobile App-webbservern från hello perimeternätverk.</span><span class="sxs-lookup"><span data-stu-id="360e8-138">This separability makes it possible toouse hello Web Application Proxy toopublish hello User Portal and Mobile App Web Server from hello perimeter network.</span></span> <span data-ttu-id="360e8-139">En sådan konfiguration lägger till toohello övergripande säkerheten för din design, som visas i följande diagram hello.</span><span class="sxs-lookup"><span data-stu-id="360e8-139">Such a configuration adds toohello overall security of your design, as shown in hello following diagram.</span></span> <span data-ttu-id="360e8-140">Hej MFA Användarportalen och Mobile App-webbserver kan också distribueras i belastningsutjämnade konfigurationer med hög tillgänglighet.</span><span class="sxs-lookup"><span data-stu-id="360e8-140">hello MFA User Portal and Mobile App Web Server may also be deployed in HA load-balanced configurations.</span></span>

   ![MFA-servern med ett perimeternätverk](./media/mfa-server-high-availability/mfasecurity.png)

* <span data-ttu-id="360e8-142">**Engångslösenord (OTP) via SMS (aka enkelriktad SMS) kräver hello Fäst sessioner om trafiken är belastningsutjämnad**.</span><span class="sxs-lookup"><span data-stu-id="360e8-142">**One-time password (OTP) over SMS (aka one-way SMS) requires hello use of sticky sessions if traffic is load-balanced**.</span></span> <span data-ttu-id="360e8-143">Enkelriktad SMS är ett alternativ för autentisering som orsakar hello MFA-Server toosend hello användare ett SMS med ett Engångslösenord.</span><span class="sxs-lookup"><span data-stu-id="360e8-143">One-way SMS is an authentication option that causes hello MFA Server toosend hello users a text message containing an OTP.</span></span> <span data-ttu-id="360e8-144">hello användaren anger hello OTP i en uppmaningsfönstret toocomplete hello MFA-kontrollen.</span><span class="sxs-lookup"><span data-stu-id="360e8-144">hello user enters hello OTP in a prompt window toocomplete hello MFA challenge.</span></span> <span data-ttu-id="360e8-145">Om du belastningsutjämna Azure MFA servrar måste hello samma server som hanteras hello inledande autentiseringsförfrågan vara hello-server som tar emot hälsningsmeddelande för Engångslösenord från hello användaren. Om en annan MFA-servern tar emot hello Engångslösenord svar, misslyckas hello autentiseringsfråga.</span><span class="sxs-lookup"><span data-stu-id="360e8-145">If you load balance Azure MFA Servers, hello same server that served hello initial authentication request must be hello server that receives hello OTP message from hello user; if another MFA Server receives hello OTP reply, hello authentication challenge fails.</span></span> <span data-ttu-id="360e8-146">Mer information finns i [en gång lösenord via SMS läggs tooAzure MFA-Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server).</span><span class="sxs-lookup"><span data-stu-id="360e8-146">For more information, see [One Time Password over SMS Added tooAzure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server).</span></span>
* <span data-ttu-id="360e8-147">**Utjämning av nätverksbelastning distributioner av hello Användarportalen och Mobilappwebbtjänsten kräver Fäst sessioner**.</span><span class="sxs-lookup"><span data-stu-id="360e8-147">**Load-Balanced deployments of hello User Portal and Mobile App Web Service require sticky sessions**.</span></span> <span data-ttu-id="360e8-148">Om du är belastningsutjämning hello MFA Användarportalen och hello Mobilappwebbtjänsten, måste varje session toostay på hello samma server.</span><span class="sxs-lookup"><span data-stu-id="360e8-148">If you are load-balancing hello MFA User Portal and hello Mobile App Web Service, each session needs toostay on hello same server.</span></span>

## <a name="high-availability-deployment"></a><span data-ttu-id="360e8-149">Distribution med hög tillgänglighet</span><span class="sxs-lookup"><span data-stu-id="360e8-149">High-availability deployment</span></span>

<span data-ttu-id="360e8-150">hello visar följande diagram en fullständig HA belastningsutjämnade implementering av Azure MFA och dess komponenter, tillsammans med AD FS för referens.</span><span class="sxs-lookup"><span data-stu-id="360e8-150">hello following diagram shows a complete HA load-balanced implementation of Azure MFA and its components, along with ADFS for reference.</span></span>

 ![Azure MFA-servern HA implementering](./media/mfa-server-high-availability/mfa-ha-deployment.png)

<span data-ttu-id="360e8-152">Obs hello följande objekt för hello motsvarande numrerade område i hello föregående diagram.</span><span class="sxs-lookup"><span data-stu-id="360e8-152">Note hello following items for hello correspondingly numbered area of hello preceding diagram.</span></span>

1. <span data-ttu-id="360e8-153">hello två Azure MFA servrar (MFA1 och MFA2) är att läsa in belastningsutjämnade (mfaapp.contoso.com) och är konfigurerade toouse en statisk port (4443) tooreplicate hello PhoneFactor.pfdata databas.</span><span class="sxs-lookup"><span data-stu-id="360e8-153">hello two Azure MFA Servers (MFA1 and MFA2) are load balanced (mfaapp.contoso.com) and are configured toouse a static port (4443) tooreplicate hello PhoneFactor.pfdata database.</span></span> <span data-ttu-id="360e8-154">hello webbtjänst-SDK har installerats på varje hello MFA-Server tooenable kommunikation via TCP-port 443 med hello ADFS-servrar.</span><span class="sxs-lookup"><span data-stu-id="360e8-154">hello Web Service SDK is installed on each of hello MFA Server tooenable communication over TCP port 443 with hello ADFS servers.</span></span> <span data-ttu-id="360e8-155">Hej MFA-servrar distribueras i en tillståndslös konfiguration för Utjämning av nätverksbelastning.</span><span class="sxs-lookup"><span data-stu-id="360e8-155">hello MFA servers are deployed in a stateless load-balanced configuration.</span></span> <span data-ttu-id="360e8-156">Men om du vill ha toouse Engångslösenord via SMS måste du använda tillståndskänsliga belastningsutjämning.</span><span class="sxs-lookup"><span data-stu-id="360e8-156">However, if you wanted toouse OTP over SMS, you must use stateful load balancing.</span></span>
   <span data-ttu-id="360e8-157">![Azure MFA-Server - App-servern hög tillgänglighet](./media/mfa-server-high-availability/mfaapp.png)</span><span class="sxs-lookup"><span data-stu-id="360e8-157">![Azure MFA Server - App server HA](./media/mfa-server-high-availability/mfaapp.png)</span></span>

   > [!NOTE]
   > <span data-ttu-id="360e8-158">Eftersom RPC använder dynamiska portar, rekommenderas inte tooopen brandväggar in toohello intervallet för dynamiska portar som RPC kan användaren använda.</span><span class="sxs-lookup"><span data-stu-id="360e8-158">Because RPC uses dynamic ports, it is not recommended tooopen firewalls up toohello range of dynamic ports that RPC can potentially use.</span></span> <span data-ttu-id="360e8-159">Om du har en brandvägg **mellan** MFA programservrar, du bör konfigurera hello MFA-Server toocommunicate på en statisk port för hello replikeringstrafik mellan underordnade och master-servrar och öppna som port i brandväggen.</span><span class="sxs-lookup"><span data-stu-id="360e8-159">If you have a firewall **between** your MFA application servers, you should configure hello MFA Server toocommunicate on a static port for hello replication traffic between slave and master servers and open that port on your firewall.</span></span> <span data-ttu-id="360e8-160">Du kan tvinga hello statisk port genom att skapa ett DWORD-registervärde på ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` kallas ```Pfsvc_ncan_ip_tcp_port``` och inställningsvärde hello tooan tillgänglig statisk port.</span><span class="sxs-lookup"><span data-stu-id="360e8-160">You can force hello static port by creating a DWORD registry value at ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` called ```Pfsvc_ncan_ip_tcp_port``` and setting hello value tooan available static port.</span></span> <span data-ttu-id="360e8-161">Anslutningar initieras alltid av hello slavserver MFA servrar toohello master, hello statisk port krävs endast för hello master, men eftersom du kan flytta en slav toobe hello master när som helst, bör du ange hello statisk port på alla servrar för MFA.</span><span class="sxs-lookup"><span data-stu-id="360e8-161">Connections are always initiated by hello slave MFA Servers toohello master, hello static port is only required on hello master, but since you can promote a slave toobe hello master at any time, you should set hello static port on all MFA Servers.</span></span>

2. <span data-ttu-id="360e8-162">Användaren Portal/MFA Mobilapp hello två servrar (MFA-UP-MAS1 och MFA-UP-MAS2) belastningsutjämnas i en **stateful** configuration (mfa.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="360e8-162">hello two User Portal/MFA Mobile App servers (MFA-UP-MAS1 and MFA-UP-MAS2) are load balanced in a **stateful** configuration (mfa.contoso.com).</span></span> <span data-ttu-id="360e8-163">Kom ihåg att Fäst sessioner är ett krav för belastningsutjämning hello MFA Användarportalen och Mobile App Service.</span><span class="sxs-lookup"><span data-stu-id="360e8-163">Recall that sticky sessions are a requirement for load balancing hello MFA User Portal and Mobile App Service.</span></span>
   <span data-ttu-id="360e8-164">![Azure MFA-Server - Användarportalen och mobila Apptjänst hög tillgänglighet](./media/mfa-server-high-availability/mfaportal.png)</span><span class="sxs-lookup"><span data-stu-id="360e8-164">![Azure MFA Server - User Portal and Mobile App Service HA](./media/mfa-server-high-availability/mfaportal.png)</span></span>
3. <span data-ttu-id="360e8-165">hello AD FS-servergrupp är belastningen belastningsutjämnade och publicerade toohello Internet via belastningsutjämnade AD FS-proxyservrar i hello perimeternätverk.</span><span class="sxs-lookup"><span data-stu-id="360e8-165">hello ADFS Server farm is load balanced and published toohello Internet through load-balanced ADFS proxies in hello perimeter network.</span></span> <span data-ttu-id="360e8-166">Varje AD FS-servern använder hello AD FS agent toocommunicate med hello Azure MFA-servrar med en enda belastningsutjämnade URL (mfaapp.contoso.com) via TCP-port 443.</span><span class="sxs-lookup"><span data-stu-id="360e8-166">Each ADFS Server uses hello ADFS agent toocommunicate with hello Azure MFA Servers using a single load-balanced URL (mfaapp.contoso.com) over TCP port 443.</span></span>

## <a name="next-steps"></a><span data-ttu-id="360e8-167">Nästa steg</span><span class="sxs-lookup"><span data-stu-id="360e8-167">Next steps</span></span>

* [<span data-ttu-id="360e8-168">Installera och konfigurera Azure MFA-Server</span><span class="sxs-lookup"><span data-stu-id="360e8-168">Install and configure Azure MFA Server</span></span>](multi-factor-authentication-get-started-server.md)
